<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>AWS Lambda + API Gateway Binary Response 예제 | Dev Star SJ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="AWS,Lambda,APIGateway" />
    
    <meta name="description" content="AWS Lambda + API Gateway Binary Response 예제API Gateway의 Binary Response가 가능하기 때문에 이미지 파일(png, jpg)나 pdf 다운로드 같은걸 Lambda를 이용해서 구현이 가능하다.AWS 에서 제공해주는 예제는 AWS Compute Blog에 있는 Binary Support for API Inte">
<meta name="keywords" content="AWS,Lambda,APIGateway">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS Lambda + API Gateway Binary Response 예제">
<meta property="og:url" content="http://DevStarSJ.github.io/2017/04/08/AWS-Lambda-BinaryResponse/index.html">
<meta property="og:site_name" content="Dev Star SJ">
<meta property="og:description" content="AWS Lambda + API Gateway Binary Response 예제API Gateway의 Binary Response가 가능하기 때문에 이미지 파일(png, jpg)나 pdf 다운로드 같은걸 Lambda를 이용해서 구현이 가능하다.AWS 에서 제공해주는 예제는 AWS Compute Blog에 있는 Binary Support for API Inte">
<meta property="og:image" content="http://devstarsj.github.io/images/br1.png">
<meta property="og:updated_time" content="2017-04-23T08:21:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AWS Lambda + API Gateway Binary Response 예제">
<meta name="twitter:description" content="AWS Lambda + API Gateway Binary Response 예제API Gateway의 Binary Response가 가능하기 때문에 이미지 파일(png, jpg)나 pdf 다운로드 같은걸 Lambda를 이용해서 구현이 가능하다.AWS 에서 제공해주는 예제는 AWS Compute Blog에 있는 Binary Support for API Inte">
<meta name="twitter:image" content="http://devstarsj.github.io/images/br1.png">
    

    
        <link rel="alternate" href="/" title="Dev Star SJ" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">DevStarSJ</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/AWS/">AWS</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/AWS/Lambda/">Lambda</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/C/">C#</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/C/ASP-NET/">ASP.NET</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/C/ASP-NET-Core/">ASP.NET Core</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/C/C/">C#</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Database/">Database</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Database/Oracle/">Oracle</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Database/SQLP/">SQLP</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/DevOps/">DevOps</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/JavaScript/Node-JS/">Node.JS</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/JavaScript/TypeScript/">TypeScript</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Tips/">Tips</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Tips/macOS/">macOS</a></li></ul></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/AWS/">AWS</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/AWS/Lambda/">Lambda</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-AWS-Lambda-BinaryResponse" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        AWS Lambda + API Gateway Binary Response 예제
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2017/04/08/AWS-Lambda-BinaryResponse/" class="article-date">
            <time datetime="2017-04-07T15:00:00.000Z" itemprop="datePublished">2017-04-08</time>
        </a>
    </div>

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/APIGateway/">APIGateway</a>, <a class="tag-link" href="/tags/AWS/">AWS</a>, <a class="tag-link" href="/tags/Lambda/">Lambda</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h1 id="AWS-Lambda-API-Gateway-Binary-Response-예제"><a href="#AWS-Lambda-API-Gateway-Binary-Response-예제" class="headerlink" title="AWS Lambda + API Gateway Binary Response 예제"></a>AWS Lambda + API Gateway Binary Response 예제</h1><p><strong>API Gatewa</strong>y의 Binary Response가 가능하기 때문에 이미지 파일(png, jpg)나 pdf 다운로드 같은걸 <strong>Lambda</strong>를 이용해서 구현이 가능하다.<br>AWS 에서 제공해주는 예제는 AWS Compute Blog에 있는 <a href="https://aws.amazon.com/blogs/compute/binary-support-for-api-integrations-with-amazon-api-gateway" target="_blank" rel="external">Binary Support for API Integrations with Amazon API Gateway</a> 란 포스팅이 있는데 이것을 읽고 실제로 구현을 하기에는 조금 부족하다.</p>
<p>그래서 바로 사용 가능한 예제 코드를 작성해 보았다.</p>
<p>이번에 회사(직방)에서 <code>html to pdf</code> API 내재화 (예전에는 외부 유료 서비스 사용) 작업을 진행하면서 Binary Response에 대해서 경험을 하게 되었다.<br>그 과정에서 많은 삽질(?)을 하게 되었는데, 이런 예제 코드만 하나 검색으로 찾을 수 있었어도 시간을 많이 아낄수 있었을 꺼란 생각이 들었다.</p>
<h2 id="1-Lambda-코드-작성"><a href="#1-Lambda-코드-작성" class="headerlink" title="1. Lambda 코드 작성"></a>1. Lambda 코드 작성</h2><p>Node.JS를 이용해서 작성하였다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">"use strict"</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div><div class="line"><span class="keyword">const</span> qs = <span class="built_in">require</span>(<span class="string">"querystring"</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> FILE = &#123;</div><div class="line">    <span class="attr">JPG</span>: <span class="string">"test.jpg"</span>,</div><div class="line">    <span class="attr">PNG</span>: <span class="string">"test.png"</span>,</div><div class="line">    <span class="attr">PDF</span>: <span class="string">"test.pdf"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> CONTENT_TYPE = &#123;</div><div class="line">    <span class="attr">JPG</span>: <span class="string">"image/jpg"</span>,</div><div class="line">    <span class="attr">PNG</span>: <span class="string">"image/png"</span>,</div><div class="line">    <span class="attr">PDF</span>: <span class="string">"application/pdf"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">    <span class="built_in">console</span>.info(<span class="built_in">JSON</span>.stringify(event,<span class="literal">null</span>,<span class="number">2</span>));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> qs = event.queryStringParameters || &#123;&#125;;</div><div class="line">    <span class="keyword">const</span> path = event.pathParameters.proxy;</div><div class="line">    <span class="keyword">const</span> body = getBody(event);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> KEY = path.indexOf(<span class="string">"jpg"</span>) &gt;= <span class="number">0</span> ? <span class="string">"JPG"</span> :</div><div class="line">                path.indexOf(<span class="string">"png"</span>) &gt;= <span class="number">0</span> ? <span class="string">"PNG"</span> :</div><div class="line">                                           <span class="string">"PDF"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> content = fs.readFileSync(FILE[KEY]);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> response = &#123;</div><div class="line">        <span class="attr">statusCode</span>: <span class="number">200</span>,</div><div class="line">        <span class="attr">headers</span>: &#123;</div><div class="line">            <span class="string">"Content-Type"</span>: CONTENT_TYPE[KEY],</div><div class="line">            <span class="string">"Content-Disposition"</span>: <span class="string">`inline; filename="<span class="subst">$&#123;FILE[KEY]&#125;</span>"`</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">body</span>: <span class="keyword">new</span> Buffer(content).toString(<span class="string">"base64"</span>),</div><div class="line">        <span class="attr">isBase64Encoded</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    callback(<span class="literal">null</span>, response);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBody</span>(<span class="params">event</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!event.body)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> rawBody = event.isBase64Encoded ? <span class="keyword">new</span> Buffer(event.body, <span class="string">"base64"</span>).toString() : event.body;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> body = event.headers[<span class="string">"Content-Type"</span>] === <span class="string">"application/x-www-form-urlencoded"</span> ?</div><div class="line">        qs.parse(rawBody) : rawBody;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> body;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>코드 대해서는 간략하게만 설명하겠다.</p>
<p>경로상에 <code>pdf</code>, <code>png</code>, <code>jpg</code> 가 있는 경우 각각 그 예제 바이너리를 리턴해주는 간단한 API다.</p>
<p>API Gateway의 Lambda Proxy Integration를 이용해서 <code>event</code>를 받을 예정이다.<br>예전에는 <code>{proxy+}</code> 리소스를 사용해야지만 프락시 통합이 사용가능했지만, 이제는 각각의 리소스, 메서드를 직접 지정하더라도 프락스 통합 사용이 가능하므로 이걸 사용하지 않을 이유가 없다.</p>
<p>이번 예제에서 <code>body</code>를 사용하지는 않을 예정이라 <code>getBody</code> 함수가 사실상 필요는 없지만, 바이너리로 <code>body</code>를 받을 경우에는 해당 코드를 참고해서 처리하면 된다.</p>
<p><img src="/images/br1.png" alt=""></p>
<p>위 그림과 같이 <code>isBase64Encoded</code> 값을 보고 <code>body</code>를 인코딩 해줘야 한다.<br>인코딩 여부를 우리가 정할 수 있는지는 잘 모르겠지만, API Gateway에서 알아서 판단하여 인코딩 해주는것 같다.<br>여러 번의 테스트를 해보니 <code>isBase64Encoded</code>가 <em>false</em>로 계속 전달되다가 API Gateway deploy 이후 <em>true</em>로 바뀐적도 있다.</p>
<p>JavaScript에서의 switch-case 문에 대한 구현은 개인적으로 위와 같이 Object를 만들어서 key-value pair를 활용하는게 깔끔해 보인다.</p>
<h2 id="2-Lambda-배포"><a href="#2-Lambda-배포" class="headerlink" title="2. Lambda 배포"></a>2. Lambda 배포</h2><p>위 작성한 코드와 <code>test.jpg</code>, <code>test.png</code>, <code>test.pdf</code> 를 같은 폴더에 복사한 뒤 같이 압축해 주자.</p>
<p><img src="images/BinaryResponse.01.png" alt=""></p>
<blockquote>
<p>zip -r test.zip .</p>
</blockquote>
<p>그리고 AWS Lambda Console로 가서 <strong>binaryTest</strong> 란 이름으로 Function을 생성하자.</p>
<p>런타임은 <strong>Node.js 6.10</strong> 을 선택하고 해당 압축파일을 업로딩하자.</p>
<p>다른 설정은 적당히 알아서 하면 된다.</p>
<p>이 예제는 S3나 다른 AWS 상의 리소스를 사용하지 않으니 <strong>Role</strong> 설정도 따로 복잡하게 할 것이 없다.</p>
<p>단, 메모리와 타임아웃은 적당히 여유있게 주길 바란다.<br>바이너리 처리 자체가 파일을 읽고, 쓰는 작업이 필요하기 때문에 메모리가 많이 필요 할 수도 있고, 시간도 생각보다 오래 걸릴수 있기 때문이다.</p>
<h2 id="3-API-Gateway-생성-및-설정"><a href="#3-API-Gateway-생성-및-설정" class="headerlink" title="3. API Gateway 생성 및 설정"></a>3. API Gateway 생성 및 설정</h2><h3 id="3-1-일단-API-생성"><a href="#3-1-일단-API-생성" class="headerlink" title="3.1 일단 API 생성"></a>3.1 일단 API 생성</h3><p><img src="images/BinaryResponse.02.png" alt=""></p>
<p>그냥 <code>binaryTest</code>로 하나 생성한다.</p>
<h3 id="3-2-리소스-추가"><a href="#3-2-리소스-추가" class="headerlink" title="3.2 리소스 추가"></a>3.2 리소스 추가</h3><p><code>Action</code> -&gt; <code>Create Method</code> 를 누른 뒤 <code>proxy resource</code>를 체크하고 <code>Create Resource</code>를 눌러주자.</p>
<p><img src="images/BinaryResponse.03.png" alt=""></p>
<p>이번 예제에서는 모든 경로에 대해서 하나의 Lambda를 실행시킬 것이다.<br>단, 이 방법은 유효하지 않은 경로 등에 대해서도 모두 Lambda를 실행시키게 되므로 쓸데없는 비용이 발생 할 수도 있다는건 알아둬야 한다.<br>Lambda에서 처리 가능한 경로에 대해서만 호출을 할 것이라면 리소스를 유효한 것만 따로 생성하는게 좋다.</p>
<p>해당 프락시 리소스에서 실행시킬 Lambda를 설정해 주자.</p>
<p><img src="images/BinaryResponse.04.png" alt="image"></p>
<p>위에서 생성한 binaryTest Lambda Function으로 설정하자.</p>
<h3 id="3-3-Binary-Support-추가"><a href="#3-3-Binary-Support-추가" class="headerlink" title="3.3 Binary Support 추가"></a>3.3 Binary Support 추가</h3><p>API Gateway 상의 <code>Binary Support</code> 탭을 눌러서 들어가자.</p>
<p><img src="images/BinaryResponse.05.png" alt="image"></p>
<p>해당 API를 호출할 때 <code>headers</code>에서 <code>Accept</code>로 요청하는 형태들에 대해서 미리 정의해 줘야 한다.</p>
<p>만약 브라우저에서 url로 바로 호출할 것이라면 <code>*/*</code>를 추가해 줘야 한다.</p>
<p>그 밖의 다른 곳에서 요청시 <code>Accept</code>로 명시해주는 형태에 대해서 추가를 해줘야 <code>API Gateway</code>에서 바이너리 형태로 응답을 제공한다.</p>
<h3 id="3-4-배포"><a href="#3-4-배포" class="headerlink" title="3.4 배포"></a>3.4 배포</h3><p>다시 <code>Resources</code> 탭으로 가서 <code>Actions</code> -&gt; <code>Deploy API</code>를 눌러서 배포를 하자.</p>
<p><img src="images/BinaryResponse.06.png" alt=""></p>
<p>그냥 늘 하던데로 <code>prod</code>라는 이름으로 배포를 했다.</p>
<h2 id="4-테스트"><a href="#4-테스트" class="headerlink" title="4. 테스트"></a>4. 테스트</h2><p>배포를 하면 <strong>url</strong>이 생성된다.</p>
<p><img src="images/BinaryResponse.07.png" alt=""></p>
<p>이 url 뒤에 <code>/pdf</code> , <code>/png</code> , <code>/jpg</code>를 붙여서 호출하여 바이너리 다운로드가 정상적으로 되는지 확인해 보자.</p>
<p>브라우저에서 직접 호출하면 바로 화면에 나타나겠고, <code>curl</code> 이나 <code>POSTMAN</code>을 사용할려면 <code>header</code>에 <code>Accept</code>값을 넣어서 호출하면 된다.</p>
<blockquote>
<p>curl -X GET -H “{Accept:application/pdf}”  <a href="https://xxx/prod/pdf" target="_blank" rel="external">https://xxx/prod/pdf</a> &gt; test.pdf</p>
</blockquote>
<p>POSTMAN의 경우 이미지는 바로 화면에 보여주지만, pdf는 정상적으로 보여주지 못한다.</p>
<h1 id="Lambda-Binary-작업-Tip-Native-Module-사용"><a href="#Lambda-Binary-작업-Tip-Native-Module-사용" class="headerlink" title="Lambda Binary 작업 Tip(?) : Native Module 사용"></a>Lambda Binary 작업 Tip(?) : Native Module 사용</h1><p>Lambda로 binary response 작업을 할려면 몇가지만 미리 알아두더라도 삽질(?) 할 시간을 아낄 수 있다.</p>
<h3 id="Lambda가-실행되는-환경은-Linux-이다"><a href="#Lambda가-실행되는-환경은-Linux-이다" class="headerlink" title="Lambda가 실행되는 환경은 Linux 이다."></a>Lambda가 실행되는 환경은 Linux 이다.</h3><p><a href="http://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html" target="_blank" rel="external">Lambda Execution Environment and Available Libraries</a> 에서 정확한 정보를 확인할 수 있다.</p>
<h3 id="Lambda에-50mb-정도의-디스크-사용이-가능하다"><a href="#Lambda에-50mb-정도의-디스크-사용이-가능하다" class="headerlink" title="Lambda에 50mb 정도의 디스크 사용이 가능하다."></a>Lambda에 50mb 정도의 디스크 사용이 가능하다.</h3><p><code>/tmp</code> 폴더내에 파일을 임시로 저장하고 사용하는게 가능하다.<br>하지만 Lambda가 warm start로 실행될 경우 이미 만들어진 Lambda를 재사용하므로 해당 폴더에 임시로 만들어 놓은 파일은 계속 남아있게 된다.<br>임시로 파일을 만들어서 활용할 경우 동일한 이름을 사용해서 항상 덮어쓰거나 아니면 해당 파일을 다 사용한 후에는 지워주는 코드를 넣어주도록 하자.</p>
<h3 id="Native-Module을-사용할-경우"><a href="#Native-Module을-사용할-경우" class="headerlink" title="Native Module을 사용할 경우"></a>Native Module을 사용할 경우</h3><p>바이너리 응답을 주는 기능 구현을 위해서는 native module을 사용하는 경우가 많다.</p>
<p>native module를 사용한다면, 기본적으로 아래와 같은 과정으로 개발을 할 것이다.</p>
<ul>
<li>해당 native module을 설치한다. (macos의 경우 brew를 사용)</li>
<li>해당 모듈의 wrapper npm이 있는지 검색한다.</li>
<li>있다면 그걸 활용한다.</li>
<li>없다면 직접 shell에서 실행시켜주는 wrapper를 구현해서 사용한다.</li>
</ul>
<p>이걸 Lambda로 배포하려면 해당 native module을 같이 배포해야한다.<br>그래서 아래 과정이 추가된다.</p>
<ul>
<li>wrapper npm을 활용한 경우라면 그 소스코드를 살펴보면서 해당 모듈을 시스템 상에 설치된 것을 사용하는지, 아니면 npm으로 설치할때 같이 다운로드 되는지 살펴본다.</li>
<li>시스템상 설치된 것을 사용한다면 native module의 실행파일을 압축해 본다.</li>
<li>압축 후 용량이 50mb가 넘으면 포기한다. ㅠㅠ</li>
<li>50 mb 이하라면 Lambda 를 배포할 폴더 아래에 해당 파일을 복사한다.</li>
<li>옮긴 실행 파일을 실행하도록 wrapper를 수정한다.</li>
</ul>
<p>여기서 반드시 명싱해야 할것은 Lambda의 실행환경은 Linux이다.  </p>
<p>지금 내 개발환경이 macos인 경우 이것을 그대로 Lambda로 배포하면 실행이 안된다.  </p>
<p>해당 native module을 Linux용으로 바꿔서 배포해야한다.</p>
<ul>
<li>wrapper npm에서 native module을 같이 다운로드 받게 되어 있다면, 코드를 살펴보자.<ul>
<li>분명 OS 타입별로 각각 다른 파일을 다운로드 하는 분기 코드가 있을 것이다. 그걸 보고 Linux용 실행파일을 다운로드 받자.</li>
</ul>
</li>
<li>시스템 상에 설치된 실행파일을 사용하는 경우라면 따로 Linux용을 다운로드 받자.</li>
<li>로컬에서 테스트로 실행시켜볼 환경과 Lambda로 배포할 환경을 따로 만들어야 한다.<ul>
<li>배포 스크립트를 만들면 편하다.<ul>
<li>폴더 생성</li>
<li>Lambda 코드 복사</li>
<li><code>npm i --only=production</code></li>
<li>native module을 linux 용으로 복사</li>
<li>배포</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="OS에-따라-Native-Module의-결과가-다를-수-있다"><a href="#OS에-따라-Native-Module의-결과가-다를-수-있다" class="headerlink" title="OS에 따라 Native Module의 결과가 다를 수 있다."></a>OS에 따라 Native Module의 결과가 다를 수 있다.</h3><p>같은 native module이라도 각 OS별로 다르게 동작할 수 있다.<br>이 사실을 모르고 결과물을 개발 환경에 맞춰서 진행하다보면 Lambda 배포 후 결과가 다른걸 보고 또 다시 삽질을 해야할 수 있다.<br>그러니 일단 동작하는게 확인되면 Lambda로 배포한 후 그 결과를 확인해보고 진행하는게 좋다.</p>
<h2 id="마치며…"><a href="#마치며…" class="headerlink" title="마치며…"></a>마치며…</h2><p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="&#109;&#x61;&#105;&#108;&#116;&#111;&#x3a;&#x73;&#x65;&#x6f;&#x6b;&#106;&#111;&#111;&#110;&#x2e;&#x79;&#117;&#110;&#64;&#x67;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#109;">&#x73;&#x65;&#x6f;&#x6b;&#106;&#111;&#111;&#110;&#x2e;&#x79;&#117;&#110;&#64;&#x67;&#109;&#97;&#x69;&#x6c;&#x2e;&#99;&#111;&#109;</a>  </p>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://DevStarSJ.github.io/2017/04/08/AWS-Lambda-BinaryResponse/" data-id="cj1y8gsqj001rft7bmz3cl77h" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://www.facebook.com/seokjoon.yun.9" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="https://plus.google.com/u/1/108379332089647292574" target="_blank">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/DevStarSJ" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/03/26/Lambda.Chatbot.01/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2017/04/23/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Hello World</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/23/hello-world/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2017/04/23/hello-world/" class="title">Hello World</a></p>
                            <p class="item-date"><time datetime="2017-04-23T08:21:19.000Z" itemprop="datePublished">2017-04-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/08/AWS-Lambda-BinaryResponse/" class="thumbnail">
    
    
        <span style="background-image:url(/images/br1.png)" alt="AWS Lambda + API Gateway Binary Response 예제" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/AWS/">AWS</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a></p>
                            <p class="item-title"><a href="/2017/04/08/AWS-Lambda-BinaryResponse/" class="title">AWS Lambda + API Gateway Binary Response 예제</a></p>
                            <p class="item-date"><time datetime="2017-04-07T15:00:00.000Z" itemprop="datePublished">2017-04-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/26/Lambda.Chatbot.01/" class="thumbnail">
    
    
        <span style="background-image:url(https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.01.png?raw=true)" alt="AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/AWS/">AWS</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a></p>
                            <p class="item-title"><a href="/2017/03/26/Lambda.Chatbot.01/" class="title">AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기</a></p>
                            <p class="item-date"><time datetime="2017-03-25T15:00:00.000Z" itemprop="datePublished">2017-03-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/19/Lambda.invoke.Lambda/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/AWS/">AWS</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a></p>
                            <p class="item-title"><a href="/2017/03/19/Lambda.invoke.Lambda/" class="title">Lambda에서 Lambda를 호출하는 방법</a></p>
                            <p class="item-date"><time datetime="2017-03-18T15:00:00.000Z" itemprop="datePublished">2017-03-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/11/Lambda.Tips.01/" class="thumbnail">
    
    
        <span style="background-image:url(https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Tips.01.01.png?raw=true)" alt="AWS Lambda 사용에 관련된 Tip" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/AWS/">AWS</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a></p>
                            <p class="item-title"><a href="/2017/03/11/Lambda.Tips.01/" class="title">AWS Lambda 사용에 관련된 Tip</a></p>
                            <p class="item-date"><time datetime="2017-03-10T15:00:00.000Z" itemprop="datePublished">2017-03-11</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/">AWS</a><span class="category-list-count">14</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/Lambda/">Lambda</a><span class="category-list-count">14</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C#</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C/ASP-NET/">ASP.NET</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/ASP-NET-Core/">ASP.NET Core</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/C/">C#</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">23</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Database/Oracle/">Oracle</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/SQLP/">SQLP</a><span class="category-list-count">21</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/Node-JS/">Node.JS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/TypeScript/">TypeScript</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tips/">Tips</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tips/macOS/">macOS</a><span class="category-list-count">1</span></li></ul></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/APIGateway/">APIGateway</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET/">ASP.NET</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET-Core/">ASP.NET Core</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/">AWS</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/">CI/CD</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda/">Lambda</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-JS/">Node.JS</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLP/">SQLP</a><span class="tag-list-count">23</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Serverless/">Serverless</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS/">macOS</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/APIGateway/" style="font-size: 16.67px;">APIGateway</a> <a href="/tags/ASP-NET/" style="font-size: 15.56px;">ASP.NET</a> <a href="/tags/ASP-NET-Core/" style="font-size: 13.33px;">ASP.NET Core</a> <a href="/tags/AWS/" style="font-size: 17.78px;">AWS</a> <a href="/tags/C/" style="font-size: 18.89px;">C#</a> <a href="/tags/CI-CD/" style="font-size: 11.11px;">CI/CD</a> <a href="/tags/Database/" style="font-size: 20px;">Database</a> <a href="/tags/DevOps/" style="font-size: 11.11px;">DevOps</a> <a href="/tags/JavaScript/" style="font-size: 12.22px;">JavaScript</a> <a href="/tags/Lambda/" style="font-size: 17.78px;">Lambda</a> <a href="/tags/Node-JS/" style="font-size: 14.44px;">Node.JS</a> <a href="/tags/Oracle/" style="font-size: 20px;">Oracle</a> <a href="/tags/Python/" style="font-size: 12.22px;">Python</a> <a href="/tags/SQLP/" style="font-size: 20px;">SQLP</a> <a href="/tags/Serverless/" style="font-size: 12.22px;">Serverless</a> <a href="/tags/TypeScript/" style="font-size: 11.11px;">TypeScript</a> <a href="/tags/macOS/" style="font-size: 10px;">macOS</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2017 Yun Seok-joon</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://DevStarSJ.github.io/2017/04/08/AWS-Lambda-BinaryResponse/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
