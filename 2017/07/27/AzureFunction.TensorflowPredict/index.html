<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Using Tensorflow Predict on Azure Function | Dev Star SJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Using Tensorflow Predict on Azure Function 참고사항 똑같은 구성으로 AWS에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.  Deploy Tensorflow Docker Image to AWS ECS Using Tensorflow Predict on AWS Lambda Function  이 작업을 시작하게 된 이유와">
<meta name="keywords" content="C#,Azure,AzureFileStorage,Tensorflow,MachineLearning,AzureFunction">
<meta property="og:type" content="article">
<meta property="og:title" content="Using Tensorflow Predict on Azure Function">
<meta property="og:url" content="http://DevStarSJ.github.io/2017/07/27/AzureFunction.TensorflowPredict/index.html">
<meta property="og:site_name" content="Dev Star SJ">
<meta property="og:description" content="Using Tensorflow Predict on Azure Function 참고사항 똑같은 구성으로 AWS에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.  Deploy Tensorflow Docker Image to AWS ECS Using Tensorflow Predict on AWS Lambda Function  이 작업을 시작하게 된 이유와">
<meta property="og:image" content="http://devstarsj.github.io/images/azure.function.01.png">
<meta property="og:image" content="http://devstarsj.github.io/images/azure.function.02.png">
<meta property="og:image" content="http://devstarsj.github.io/images/azure.function.03.png">
<meta property="og:image" content="http://devstarsj.github.io/images/azure.function.04.png">
<meta property="og:image" content="http://devstarsj.github.io/images/azure.function.05.png">
<meta property="og:updated_time" content="2017-07-27T08:15:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Using Tensorflow Predict on Azure Function">
<meta name="twitter:description" content="Using Tensorflow Predict on Azure Function 참고사항 똑같은 구성으로 AWS에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.  Deploy Tensorflow Docker Image to AWS ECS Using Tensorflow Predict on AWS Lambda Function  이 작업을 시작하게 된 이유와">
<meta name="twitter:image" content="http://devstarsj.github.io/images/azure.function.01.png">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-104294646-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dev Star SJ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://DevStarSJ.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-AzureFunction.TensorflowPredict" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/27/AzureFunction.TensorflowPredict/" class="article-date">
  <time datetime="2017-07-27T06:57:00.000Z" itemprop="datePublished">2017-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Azure/">Azure</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Using Tensorflow Predict on Azure Function
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Using Tensorflow Predict on Azure Function</h1>
<h2>참고사항</h2>
<p>똑같은 구성으로 <strong>AWS</strong>에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/ecs.tensorflow.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to AWS ECS</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a></li>
</ul>
<p>이 작업을 시작하게 된 이유와 개념적인 구성에 대한 설명은 위 Link의 글들을 참고하길 바란다
즉 학습, 저장, 서비스 를 어떻게 동작시키는 것을 목적으로 하였는지에 대한 설명은 이 글에서는 생략하겠다.</p>
<p>Azure에 구성을 한 것은 이 글 포함 2개의 글이 있다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureContainer.TensorflowDockerImage.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to Azure</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureFunction.TensorflowPredict.md" target="_blank" rel="external">Using Tensorflow Predict on Azure Function</a></li>
</ul>
<h2>왜 이런 생각을 ???</h2>
<p>앞서 <strong>Azure Container Service</strong>에서 <strong>Tensorflow</strong>를 이용하여 학습을 진행하여 그 결과를 <strong>Azure File Storage</strong>에 저장하는 방법에 대해서 글을 적었다.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureContainer.TensorflowDockerImage.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to Azure</a></p>
<p>학습 결과를 <strong>Azure File Storage</strong>에 남긴 이유는 크게 2가지였다.</p>
<ul>
<li>하나는 다음에 학습을 진행할때 해당 값을 이용하여 계속해서 학습을 진행 할 경우를 대비하자는 것이고,</li>
<li>다른 하나는 학습 결과 데이터를 이용해서 예측하는 서비스를 제공하는데 사용하려는 목적이다.</li>
</ul>
<h2>Azure Function에 Tensorflow 배포 ?</h2>
<p>먼저 <strong>Tensorflow</strong>를 <strong>AWS Lambda</strong>에 배포하는것은 안된다고 <strong>AWS Lambda</strong> 관련 글에 남긴적이 있다.
그럼 <strong>Azure Function</strong>에는 가능할까 ?</p>
<p>아직 끝까지 가보지는 않았지만, 가능하리라 판단된다. 하지만 쉽지 않을 것이다.</p>
<p>왜냐면 <strong>Azure Function</strong>의 경우에는 실행 환경을 커스터마이징하는게 가능하다. 기본적으로 제공해주는 것과 다른 버전의 <strong>Python</strong>설치도 가능하다. 하지만 실제로 테스트해보니 엄청 손이 많이 가는 작업이다. <strong>Python 3.6</strong>이 수행되도록 설치를 하였으나 <strong>pip</strong>가 동작하지 않았다. 아마 이것또한 따로 설치해 줘야 할것이다. 이런 식으로 하나하나 설치하다보면 언젠가는 <strong>tensorflow</strong> 실행까지 가능하도록 구축이 될 것이다. 만약 이게 업무였다면 끝까지 파고들어서 설치까지 진행했겠지만, 단순 테스트용으로 그렇게까지 하고 싶지는 않아서 그냥 더 이상 진행하지 않았다.</p>
<p>더 이상 진행하지 않은 이유가 하나 더 있는데, 아직 <strong>Azure Function</strong>에서 <strong>Python</strong>으로 작업하는게 아직까진 자연스럽지 않다. <strong>C#</strong> 이나 <strong>Node.JS</strong>의 경우에는 최초 실행되는 코드가 함수로 감싸져 있고, Http로 전달한 querystirng, body 정보 같은게 해당 함수의 인자로 전달되는데, <strong>Python</strong>의 경우는 최초 실행되는 코드가 따로 함수로 감싸져 있지 않고, 그냥 파일의 처음부터 실행되며, 요청한 값들을 <code>os.environ</code>에서 직접 가져와야 한다. 아직까지 정식으로 <strong>Python</strong>을 지원한다기보다는 그냥 Preview 정도의 느낌이다.</p>
<p>그래서 가장 <code>Azure</code>에서 자연스럽게 동작할 **C#**으로 작성을 하였다. 파일 형식이 <code>.cs</code>가 아니라 <code>.csx</code>인데, 이 부분도 솔직히 조금 불편했다. 그래서 결국에는 <strong>ConsoleApplication Project</strong>를 하나 생성하여서 거기서 작업을 다 한뒤에 <code>.csx</code>파일로 옮겼다.</p>
<p>먼저 <strong>Azure Function</strong> 을 생성해 보겠다.</p>
<h2>Azure Function 생성</h2>
<ul>
<li>우측 상단 <code>+ New</code> 클릭
<ul>
<li><code>Web + Mobile &gt;</code> 범주에 속하기는 하나 많이 사용하지 않는지 기본 목록에는 나오지 않고, <code>See all</code>을 눌러야지만 나온다.</li>
<li>그냥 검색으로 <code>Function</code>을 입력해서 선택한 후 <code>Create</code>를 누르자.
<ul>
<li><code>App Name</code> : (ex. predictcs)</li>
<li><code>Resource Group</code> : 그냥 기존에 생성해 놓은것으로 같이 쓰도록 설정</li>
<li><code>Location</code> : <code>Japan West</code> 그나마 거리 가까운것 중에 가장 저렴한 것으로 설정</li>
<li><code>Storage</code> : 그냥 기존에 생성해 놓은것으로 같이 쓰도록 설정</li>
<li><code>Create</code>를 눌루서 생성</li>
<li><img src="/images/azure.function.01.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>그럼 대쉬보드 상에서 생성되는 것을 볼 수 있다. 생성이 끝나면 바로 설정 창으로 이동된다.</p>
<ul>
<li><code>Functions +</code>에서 <code>+</code>를 눌러서 새로 생성
<ul>
<li><code>Webhook + API</code>, <code>CSharp</code>이 default로 선택되어 있음.</li>
<li>그냥 <code>Create this function</code>을 눌러서 생성</li>
</ul>
</li>
</ul>
<p>그럼 자동으로 기본적인 <code>Hello World</code>같은 코드가 작성되어 있다.</p>
<p>우측 상단의 <code>Get Function URL</code>을 눌러서 호출 가능한 주소를 확인하자.</p>
<p><img src="/images/azure.function.02.png" alt=""></p>
<p>해당 URL을 복사해서 Browser 주소창에 붙인후 뒤에 <code>&amp;Name=Luna</code>를 추가해서 호출하면 결과 확인이 가능하다.</p>
<p><img src="/images/azure.function.03.png" alt=""></p>
<p>이제 코드를 작성해 보자.</p>
<h2>C# 으로 작성된 Predict 제공 코드</h2>
<p>참고로 아래 코드는 <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a>에서 작성한 <strong>Python</strong>코드를 <strong>C#</strong> 으로 옮긴 코드이다.
물론 <strong>AWS S3</strong>에서 파일을 다운로드 받는 것을 <strong>Azure File Storage</strong>에서 받는 것으로 수정하였다.</p>
<p><strong>Azure Function</strong>의 경우 **C#**의 <strong>nuget</strong>으로 제공되는 패키지들의 설치가 가능하다는 점이 좋았다.</p>
<p>먼저 사용한 <strong>nuget</strong> 들을 <code>project.json</code>파일에 정의해야 한다. 해당 파일이 생성되어 있지 않다면 만들어야 한다.</p>
<p><img src="/images/azure.function.04.png" alt=""></p>
<h3>project.json</h3>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"frameworks"</span>: &#123;</div><div class="line">    <span class="attr">"net46"</span>:&#123;</div><div class="line">		<span class="attr">"dependencies"</span>: &#123;</div><div class="line">			<span class="attr">"MathNet.Numerics"</span>: <span class="string">"3.20.0"</span>,</div><div class="line">			<span class="attr">"Microsoft.Azure.KeyVault.Core"</span>: <span class="string">"2.0.4"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.Edm"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.OData"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.Services.Client"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.WindowsAzure.ConfigurationManager"</span>:<span class="string">"3.2.3"</span>,</div><div class="line">			<span class="attr">"Newtonsoft.Json"</span>:<span class="string">"10.0.3"</span>,</div><div class="line">			<span class="attr">"System.ComponentModel.EventBasedAsync"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Dynamic.Runtime"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Linq.Queryable"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Net.Requests"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Spatial"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"WindowsAzure.Storage"</span>:<span class="string">"8.2.0"</span></div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>run.csx</h3>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Net;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> MathNet.Numerics.LinearAlgebra;</div><div class="line"><span class="keyword">using</span> MathNet.Numerics.LinearAlgebra.Double;</div><div class="line"><span class="keyword">using</span> Microsoft.Azure;</div><div class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage;</div><div class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage.File;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">object</span>&gt; <span class="title">Run</span>(<span class="params">HttpRequestMessage req, TraceWriter log</span>)</span></div><div class="line">&#123;</div><div class="line">	log.Info(<span class="string">$"C# HTTP trigger function processed a request. RequestUri=<span class="subst">&#123;req.RequestUri&#125;</span>"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">string</span> xStr = req.GetQueryNameValuePairs().FirstOrDefault(q =&gt; q.Key == <span class="string">"x"</span>).Value;</div><div class="line">	<span class="keyword">double</span>[] x1 = JsonConvert.DeserializeObject&lt;<span class="keyword">double</span>[]&gt;(xStr);</div><div class="line">	<span class="keyword">var</span> x2 = Convert2D(x1);</div><div class="line"></div><div class="line">	PredictModel model = <span class="keyword">await</span> GetPredictModel(ConnectionString, ShareName, ResultFile);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> W = DenseMatrix.OfArray(model.W);</div><div class="line">	<span class="keyword">var</span> X = DenseMatrix.OfArray(x2);</div><div class="line">	<span class="keyword">var</span> H = ArrayAdd(X.Multiply(W).Row(<span class="number">0</span>).AsArray(), model.b);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> sigmoid = H.Select(Sigmoid);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> response = <span class="keyword">new</span> ResponseModel();</div><div class="line">	response.rating = Softmax(sigmoid).ToArray();</div><div class="line">	response.answer = Argmax(response.rating);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">var</span> jsonResponse = JsonConvert.SerializeObject(response);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> HttpResponseMessage(HttpStatusCode.OK)</div><div class="line">	&#123;</div><div class="line">		Content = <span class="keyword">new</span> StringContent(jsonResponse, Encoding.UTF8, <span class="string">"application/json"</span>)</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ConnectionString = <span class="string">"DefaultEndpointsProtocol=https;AccountName=[NAME];AccountKey=[KEY];EndpointSuffix=[...]"</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ShareName = <span class="string">"tensorflow-savedata"</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ResultFile = <span class="string">"result.json"</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PredictModel</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[,] W &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[] b &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResponseModel</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> answer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[] rating &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;<span class="keyword">double</span>&gt; <span class="title">Softmax</span>(<span class="params">IEnumerable&lt;<span class="keyword">double</span>&gt; M, <span class="keyword">double</span> t = <span class="number">1.0</span></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> E = M.Select(x =&gt; Math.Exp(x / t));</div><div class="line">	<span class="keyword">var</span> total = E.Sum();</div><div class="line">	<span class="keyword">return</span> E.Select(x =&gt; x / total);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">Sigmoid</span>(<span class="params"><span class="keyword">double</span> z</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">1</span> / (<span class="number">1</span> + Math.Pow(Math.E, <span class="number">-1.0</span> * z));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Argmax</span>(<span class="params">IEnumerable&lt;<span class="keyword">double</span>&gt; M</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> max_num = <span class="number">-1.0</span>;</div><div class="line">	<span class="keyword">var</span> max_index = <span class="number">-1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M.Count(); i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">var</span> y = M.ElementAt(i);</div><div class="line">		<span class="keyword">if</span> (y &gt; max_num)</div><div class="line">		&#123;</div><div class="line">			max_num = y;</div><div class="line">			max_index = i;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> max_index;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">double</span>[,] Convert2D(<span class="keyword">double</span>[] d1)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> d2 = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1</span>, d1.Length];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; d1.Length; i++)</div><div class="line">	&#123;</div><div class="line">		d2[<span class="number">0</span>, i] = d1[i];</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> d2;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span>[] <span class="title">ArrayAdd</span>(<span class="params"><span class="keyword">double</span>[] A, <span class="keyword">double</span>[] B</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> A.Select((a, i) =&gt; a + B[i]).ToArray();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task&lt;PredictModel&gt; <span class="title">GetPredictModel</span>(<span class="params"><span class="keyword">string</span> connectionString, <span class="keyword">string</span> shareName, <span class="keyword">string</span> fileName</span>)</span></div><div class="line">&#123;</div><div class="line">	CloudStorageAccount storageAccount = CreateStorageAccountFromConnectionString(connectionString);</div><div class="line">	CloudFileClient fileClient = storageAccount.CreateCloudFileClient();</div><div class="line">	CloudFileShare share = fileClient.GetShareReference(shareName);</div><div class="line"></div><div class="line">	<span class="keyword">try</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">await</span> share.CreateIfNotExistsAsync();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">throw</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	CloudFileDirectory root = share.GetRootDirectoryReference();</div><div class="line">	CloudFile file = root.GetFileReference(fileName);</div><div class="line"></div><div class="line">	<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65535</span>];</div><div class="line">	<span class="keyword">await</span> file.DownloadToByteArrayAsync(buffer, <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> strJson = System.Text.Encoding.Default.GetString(buffer);</div><div class="line">	<span class="keyword">return</span> JsonConvert.DeserializeObject&lt;PredictModel&gt;(strJson);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CloudStorageAccount <span class="title">CreateStorageAccountFromConnectionString</span>(<span class="params"><span class="keyword">string</span> storageConnectionString</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">try</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> CloudStorageAccount.Parse(storageConnectionString);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception e)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">throw</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ConnectionString</code>는 해당 <code>Azure Storage</code>에 가서 <code>Access Key</code>를 누르면 확인이 가능하다. 그것을 입력해준다.</p>
<p>그런 다음 호출 URL을 복사하고 그 뒤에다가 <code>&amp;x=[0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0]</code>값을 추가한 뒤 브라우저로 호출을 해보자.</p>
<p><img src="/images/azure.function.05.png" alt=""></p>
<p>제대로 응답이 오는게 확인이 가능하다.</p>
<h2>Tensorflow 학습 코드</h2>
<p>참고로 이 코드는 <a href="https://www.youtube.com/watch?v=BS6O0zOGX4E&amp;list=PLlMkM4tgfjnLSOjrEJN31gZATbcj_MpUm" target="_blank" rel="external">김성훈 교수님의 모두를 위한 딥러닝 강좌</a> 에서 소개된 코드를 이용하였다.</p>
<p>동물의 여러가지 특징들에 대해서 입력받아서 이 동물의 종류가 무엇인가에 대한 학습데이터이다.</p>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/zoo" target="_blank" rel="external">https://archive.ics.uci.edu/ml/machine-learning-databases/zoo</a> 에서 해당 데이터 내용에 대해서 확인이 가능하다.</p>
<p>여기에는 김성훈 교수님이 미리 만들어 놓은 <a href="https://github.com/hunkim/DeepLearningZeroToAll/blob/master/data-04-zoo.csv" target="_blank" rel="external">data-04-zoo.csv</a> 파일을 이용하겠다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/27/AzureFunction.TensorflowPredict/" data-id="cjov28bog002a5b7br3mq3v6e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFileStorage/">AzureFileStorage</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFunction/">AzureFunction</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/08/01/Devops.AWS.Jenkins.Win/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ASP.NET Web Project를 EC2 or Elastic BeanStalk에 배포하는 Jenkins 시스템 구축
        
      </div>
    </a>
  
  
    <a href="/2017/07/26/AzureContainer.TensorflowDockerImage/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Deploy Tensorflow Docker Image to Azure</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    <!-- Featured Tags -->

  
    <!-- Short About -->
<section class="visible-md visible-lg">
    <h5><a href="/about/">ABOUT ME</a></h5>
    <div class="short-about">

        

        

        <!-- SNS Link -->
        <ul class="list-inline">
            
            
            

            

            

            
            
            
            
        </ul>
    </div>
</section>

  
    
  <h5>RECENT POSTS</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="/2018/11/24/aws-batch-tutorial/">Introduce to AWS Batch</a>
        </li>
      
        <li>
          <a href="/2018/11/04/kaggle.coursera.competition.03.02/">Coursera Kaggle 강의(How to win a data science competition) week 3,4 Advanced Feature Engineering 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/kaggle.coursera.competition.04.02/">Coursera Kaggle 강의(How to win a data science competition) week 4-4 Ensemble 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/kaggle.coursera.competition.04.01/">Coursera Kaggle 강의(How to win a data science competition) week 4-1 Hyperparameter Tuning 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/181030.data.philosophy/">데이터를 철학하다</a>
        </li>
      
    </ul>
  </div>

  
    <!-- Friends Blog -->

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Yun Seok-joon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>