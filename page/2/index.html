<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Dev Star SJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Sharing the common developer&apos;s try-on">
<meta property="og:type" content="website">
<meta property="og:title" content="Dev Star SJ">
<meta property="og:url" content="http://DevStarSJ.github.io/page/2/index.html">
<meta property="og:site_name" content="Dev Star SJ">
<meta property="og:description" content="Sharing the common developer&apos;s try-on">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dev Star SJ">
<meta name="twitter:description" content="Sharing the common developer&apos;s try-on">
  
    <link rel="alternate" href="/atom.xml" title="Dev Star SJ" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dev Star SJ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">DevStarSJ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://DevStarSJ.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-aws-sagemaker-hpt-tutorial" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/15/aws-sagemaker-hpt-tutorial/" class="article-date">
  <time datetime="2018-09-15T01:39:00.000Z" itemprop="datePublished">2018-09-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/SageMaker/">SageMaker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/15/aws-sagemaker-hpt-tutorial/">Using AWS SageMaker to Tune Hyperparameter of XG-Boost</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Using AWS SageMaker to Tune Hyperparameter of XG-Boost</h1>
<p><strong>AWS SageMaker</strong>를 이용한 XG-Boost 하이퍼파라미터 최적화 방법 소개</p>
<h2>1. Introduction to AWS SageMaker</h2>
<p><strong>AWS SageMaker</strong>는 머신러닝을 빠르게 구축, 학습 및 배포 할 수 있는 완전관리형 플랫폼이다. 이 서비스에 대한 자세한 설명은 AWS 공식 페이지 링크로 대신하겠다.</p>
<p><a href="https://aws.amazon.com/sagemaker" target="_blank" rel="external">Amazon SageMaker</a></p>
<h2>2. 하이퍼파라미터 튜닝에 SageMaker를 사용한 이유</h2>
<p>Hyperparameter tuning은 굉장히 힘들고 오랜 시간이 걸리는 작업이다.
Scikit-learn의 GridSearchCV를 사용해서도 할 수 있다.
Scikit-learn과 SageMaker의 가장 큰 차이 점에 대해서 먼저 이야기해야 겠다.</p>
<p>Scikit-learn의 GridSearchCV는 우리가 입력한 Hyperparameter들에 대해서 모든 경우의 수를 다 테스트하여 그 중 가장 성능이 좋은 것을 결과로 준다. 해당 모델에서 지원하는 모든 Hyperparameter에 대해서 다 설정이 가능한 것이 가장 큰 장점이다. (SageMaker는 그렇지 아니하다.) 대신 Continuous Range 형식으로 값을 줄 수가 없다. 0.2 ~ 0.4 사이 값이라고 값을 줄 수가 없고, [0.2, 0.25, 0.3, 0.35, 0.4] 식으로 특정 값들을 줘야 한다. 그리고 우리가 준 Hyperparameter의 모든 경우에 대해서 다 학습을 한다. 만약 5개의 Hyperparameter에 대해서 5가지 값을 줬다면, <code>pow(5, 5) = 3125</code>번의 학습을 해야만 한다. 하지만, 어떠어떠한 값으로 테스트를 할지에 대해서 우리의 의도를 명확하게 설정할 수 있는건 큰 장점이다.</p>
<p>SageMaker를 이용할 경우에는 위에 설명한 것들과는 모두 다 반대되는 특징을 가진다. 모든 Hyperparameter에 대해서 설정이 가능하지 않다. SageMaker에서 지원해주는 Hyperparameter가 정해져 있다. 그래서 learning-rate에 대해서 값을 변경해보면서 하고 싶어도 그건 불가능하다. (이게 가장 큰 불만점이다.) 대신 Continuous Range로 값을 줄 수가 있다. 물론 SageMaker에서 이러이러한 값은 Continuous Range, 다른건 Integer Range, 다른건 Static한 값으로 고정, 이런 식으로 미리 정의가 되어 있다. 그래서 훨씬 편리하다. 이 경우 모든 경우의 수는 당연히 무한대이기 때문에 총 몇번의 학습을 해야 최적의 Model을 알 수 있는지에 대해서는 어느 누구도 장담을 못한다. 그래서 SageMaker는 <code>당신이 입력한 경우에 대해서는 이게 최적이야.</code> 라고는 답을 못준다. 대신 <code>당신이 입력한 경우에 대해서 우리가 100번을 테스트 해본 결과 이게 최적이야.</code> 라고 답변을 준다.</p>
<p>이게 좀 별로인것 같지만, 나에겐 생각보다 괜찮은 방법인것 같다. 왜냐면 최적의 Model을 알때까지 기다릴 필요가 없다. <code>일단 500번을 시도해서 나에게 그중 Best Model을 줘.</code> 그럼 난 해당 Model로 일단 Learning 및 Predict를 진행을 하고, 이번에 나온 <code>Best Model</code>을 보고 Hyperparameter의 범위를 좀 더 좁힌 뒤 다시 500번의 테스트를 실행시킬 수 있다. 이런 식으로 지속적으로 Model의 개선이 가능하다. (우리는 지속적으로 비용을 지불해야 하고...) AWS는 진짜 천재인것 같다. 이런식으로 우리의 지갑을 털어가다니... (물론 내 지갑은 아니다. 회사일이니 회사 계정으로...)</p>
<h2>3. Tutorial</h2>
<p>SageMaker를 이용해서 Hyperparameter Tuning 하는 과정을 살펴보겠다.
SageMaker에서는 일반적인 Training 및 학습시킨 Model을 배포하는 기능까지 제공하지만 그건 여기서 소개하지 않겠다.
왜냐면 난 그 기능을 사용하고 있지 않다. SageMaker에서 지원해주는 instance가 EC2에서 생성가능한 것들보다는 한단계 아래의 것들이다.</p>
<p>예제로 XG-Boost를 이용할건데, 다른 알고리즘에 대해서도 과정이 똑같을 것이라 판단된다.</p>
<p><code>AWS Console</code>에서 선택을 해서 작업을 할 수도 있지만, 이번 예제에서는 그러지 않고 <code>Jupyter Notebook</code> 상에서 진행하겠다.</p>
<h3>3.1 지원해주는 Algorithm 및 Hyperparameter 확인하기</h3>
<p><code>SageMaker</code>에서 우리가 무엇을 할 수 있는지 확인을 하기 위헤서 일단 <code>AWS Console</code>로 들어가 보겠다.</p>
<p>먼저 SageMaker의 <code>Hyperparameter tuning job</code> 탭으로 가서 우측 상단의 <code>Create hyperparameter tuning job</code> 을 눌러보자.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.01.png" alt=""></p>
<p><code>Job settings</code>의 <code>Hyperparameter tuning job name</code>에는 아무 글자나 입력을 하고</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.02.png" alt=""></p>
<p><code>Training job configuration</code>의 <code>Algorithm</code>을 눌러보면 지원되는 알고리즘의 목록이 나온다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.03.png" alt=""></p>
<p>여기서는 <code>XGBoost</code>를 선택하면 아래에 CloudWatch 상에 생성된 Metric에 대해서 나오는데, 다음에 입력해야할 train, validation 방법에 대한 힌트를 얻을 수 있다.</p>
<p><code>Next</code>를 누르면 다음 페이지에서 조정 가능한 Hyperparameter 들의 목록 및 어떤 값들을 넣을 수 있는지 확인이 가능하다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.04.png" alt="">
<img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.05.png" alt="">
<img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.06.png" alt=""></p>
<p>여기서 선택을 하고 <code>Next</code>로 가면서 계속해서 진행을 해도 가능하겠지만, 일단 여기까지만 확인하고 나가자.</p>
<h3>3.2 예제 코드 확인하기</h3>
<p>AWS에서 예제 코드들을 이미 제공을 해주고 있다.</p>
<p><a href="https://github.com/awslabs/amazon-sagemaker-examples" target="_blank" rel="external">Amazon SageMaker Examples</a></p>
<p>위 Link에서 내용을 확인 할 수도 있고, <code>SageMaker</code> 상에서 <code>Notebook Instance</code>를 생성 한 뒤</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.07.png" alt=""></p>
<p>그 곳에서 예제코드를 <code>Notebook</code>상에 만들어서 직접 실행 할 수도 있다.</p>
<p>하지만 한 번은 저 예제를 실행해야 한다. 그것도 <code>SageMaker</code>상의 <code>Notebook Instance</code>상에서. 왜냐면 <code>RoleArn</code>을 알아야 하기 때문이다. 그걸 알고 있다면 이 과정을 생략해도 된다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.08.png" alt=""></p>
<p><code>hpo_xgboost_direct_marketing_sagemaker_APIs.ipynb</code>의 <code>use</code>를 누르면 해당 노트북이 <code>Instance</code>상에 복사된다.</p>
<p>노트북이 열리면 첫번째 cell을 실행 한 뒤 role 값에 대해서 확인을 한다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.09.png" alt=""></p>
<p>해당 문자열이 <code>RoleArn</code>이다. 이제 이것만 알면 <code>SageMaker</code>상의 <code>Notebook Instance</code>가 아닌 어느 PC에서도 작업이 가능해진다.</p>
<p>이 예제 파일에서 하는 일을 간단히 소개하자면 다음의 과정을 보여 준다.</p>
<ul>
<li><code>Boto3</code>, <code>SageMaker</code> 패키지를 이용하여 접속</li>
<li>train, validation에 사용할 데이터 생성 : csv 형식</li>
<li>해당 파일 s3에 업로딩</li>
<li>Hyperparameter Job 생성 및 실행</li>
<li>현재 실행상태 확인</li>
</ul>
<p>앞으로 진행할 Tutorial도 해당 코드를 참고해서 작성한 것이다.</p>
<h3>3.3 train, validation data를 S3에 업로딩</h3>
<p>먼저 데이터를 S3에 업로딩해야한다. SageMaker를 사용하기 위해서 필수적으로 진행해야한다. 왜냐면 SageMaker는 S3에서 csv 파일로 읽어오는 방법만 현재 지원하기 때문이다.</p>
<p>해당 과정에 대해서는 따로 설명하지 않겠다. 기존 데이터를 이러한 형식으로 만드는 방법은 위에서 소개한 예제 코드에 자세히 나와있다. 꼭 그렇게 진행하지 않고 다른 방법으로 진행하여 S3에 직접 업로딩해도 된다. 단 아래의 규칙을 지켜야 한다.</p>
<ul>
<li>csv파일로 생성해야 한다.</li>
<li>csv 파일의 경우 header가 없어야 하며, 첫번째 column값이 <code>y(정답)</code>이고 그 다음부터 <code>X(features)</code>값들을 쭉 나열하면 된다.</li>
<li>train, validation 각각을 별도 폴더에 저장을 해야 한다. <code>SageMaker</code>에서는 해당 폴더 내에 있는 csv 파일들을 읽어서 사용한다.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.10.png" alt="">
<img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.11.png" alt=""></p>
<p>가능하면 같은 폴더 아래에 각각 <code>train</code>, <code>validation</code>이라는 이름의 폴더로 만들어 놓도록 하자.
왜냐면 그렇게 만들었다는 가정하에 아래 과정들을 진행할 것이기 때문이다.</p>
<h3>3.4 Hyperparameter Tuning Job 생성</h3>
<p>이제 <code>Jupyter Notebook</code> 으로 <code>Hyperparameter Tuning Job</code>을 생성해서 실행하는 코드를 소개하겠다.</p>
<p>먼저 <code>boto3와 sagemaker</code>가 설치되어 있어야 한다.</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span> pip install boto3, sagemaker</div></pre></td></tr></table></figure></p>
<p>이제 <code>Jupyer Notebook</code>에서 노트북 파일을 만든 뒤 아래 과정대로 cell에 입력하고 실행해보자.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sagemaker</div><div class="line"><span class="keyword">import</span> boto3</div><div class="line"></div><div class="line">session = boto3.Session(profile_name=<span class="string">'my_profile'</span>) <span class="comment">#~/.aws/profile에 정의해 놓은 AWS Profile Name</span></div><div class="line">region = session.region_name    </div><div class="line">smclient = session.client(<span class="string">'sagemaker'</span>)</div></pre></td></tr></table></figure></p>
<p><code>boto3</code>를 이용하여 <code>SageMaker clinet</code>를 생성한 것이다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">tuning_job_config = &#123;</div><div class="line">    <span class="string">"ParameterRanges"</span>: &#123;</div><div class="line">      <span class="string">"CategoricalParameterRanges"</span>: [],</div><div class="line">      <span class="string">"ContinuousParameterRanges"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"0.9999"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"0.0001"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"alpha"</span>,            </div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"0.9999"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"0.0001"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"eta"</span>,</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"20"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"1"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"min_child_weight"</span>,</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"0.9999"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"0.0001"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"colsample_bytree"</span>,            </div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"0.9999"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"0.0001"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"subsample"</span>,            </div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      <span class="string">"IntegerParameterRanges"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"30"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"5"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"max_depth"</span>,</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          <span class="string">"MaxValue"</span>: <span class="string">"2000"</span>,</div><div class="line">          <span class="string">"MinValue"</span>: <span class="string">"100"</span>,</div><div class="line">          <span class="string">"Name"</span>: <span class="string">"num_round"</span>,</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"ResourceLimits"</span>: &#123;</div><div class="line">      <span class="string">"MaxNumberOfTrainingJobs"</span>: <span class="number">100</span>,</div><div class="line">      <span class="string">"MaxParallelTrainingJobs"</span>: <span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"Strategy"</span>: <span class="string">"Bayesian"</span>,</div><div class="line">    <span class="string">"HyperParameterTuningJobObjective"</span>: &#123;</div><div class="line">      <span class="string">"MetricName"</span>: <span class="string">"validation:mae"</span>,</div><div class="line">      <span class="string">"Type"</span>: <span class="string">"Minimize"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><code>Tuning</code>할 <code>Hyperparameter</code>에 대한 정의이다. 앞서 <code>3.1</code>에서 확인한 값들을 이용하여 정의하자.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sagemaker.amazon.amazon_estimator <span class="keyword">import</span> get_image_uri</div><div class="line">training_image = get_image_uri(region, <span class="string">'xgboost'</span>)</div><div class="line"></div><div class="line">bucket = <span class="string">'test-luna'</span> <span class="comment">#S3 Bucket Name. </span></div><div class="line">prefix = <span class="string">'sagemaker'</span> <span class="comment"># S3 Bucket에 test, validation 폴더가 생성된 상위 폴더까지의 path</span></div><div class="line"></div><div class="line">s3_input_train = <span class="string">'s3://&#123;&#125;/&#123;&#125;/train/'</span>.format(bucket, prefix)</div><div class="line">s3_input_validation =<span class="string">'s3://&#123;&#125;/&#123;&#125;/validation/'</span>.format(bucket, prefix)</div><div class="line">s3_output = <span class="string">"s3://&#123;&#125;/&#123;&#125;/output"</span>.format(bucket,prefix)</div><div class="line"></div><div class="line">role = <span class="string">'arn:aws:iam::luna:role/service-role/AmazonSageMaker-ExecutionRole-20180915T103456'</span> <span class="comment"># 3.2에서 확인한 RoleArn</span></div></pre></td></tr></table></figure></p>
<p><code>Hyperparameter Tuning Job</code>에서 사용할 값들이다.</p>
<ul>
<li><code>training_image</code> : training에 사용할 알고리즘의 ECS 이미지 url이다. AWS에서 제공을 해준다. Custom Image를 이용해서도 가능하지만, 그럴 경우 AWS 공식문서를 확인해서 interface를 맞춰서 생성해야 한다.</li>
<li><code>s3_input_train</code>, <code>s3_input_validation</code>, <code>s3_output</code> : <code>S3</code>상에서의 train, validation 데이터가 저장된 경로, train 결과를 저장할 경로</li>
<li><code>role</code> : <code>SageMaker</code>를 실행할 권한이 있는 Role의 Arn</li>
</ul>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">training_job_definition = &#123;</div><div class="line">    <span class="string">"AlgorithmSpecification"</span>: &#123;</div><div class="line">      <span class="string">"TrainingImage"</span>: training_image,</div><div class="line">      <span class="string">"TrainingInputMode"</span>: <span class="string">"File"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"InputDataConfig"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"ChannelName"</span>: <span class="string">"train"</span>,</div><div class="line">        <span class="string">"CompressionType"</span>: <span class="string">"None"</span>,</div><div class="line">        <span class="string">"ContentType"</span>: <span class="string">"csv"</span>,</div><div class="line">        <span class="string">"DataSource"</span>: &#123;</div><div class="line">          <span class="string">"S3DataSource"</span>: &#123;</div><div class="line">            <span class="string">"S3DataDistributionType"</span>: <span class="string">"FullyReplicated"</span>,</div><div class="line">            <span class="string">"S3DataType"</span>: <span class="string">"S3Prefix"</span>,</div><div class="line">            <span class="string">"S3Uri"</span>: s3_input_train</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"ChannelName"</span>: <span class="string">"validation"</span>,</div><div class="line">        <span class="string">"CompressionType"</span>: <span class="string">"None"</span>,</div><div class="line">        <span class="string">"ContentType"</span>: <span class="string">"csv"</span>,</div><div class="line">        <span class="string">"DataSource"</span>: &#123;</div><div class="line">          <span class="string">"S3DataSource"</span>: &#123;</div><div class="line">            <span class="string">"S3DataDistributionType"</span>: <span class="string">"FullyReplicated"</span>,</div><div class="line">            <span class="string">"S3DataType"</span>: <span class="string">"S3Prefix"</span>,</div><div class="line">            <span class="string">"S3Uri"</span>: s3_input_validation</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"OutputDataConfig"</span>: &#123;</div><div class="line">      <span class="string">"S3OutputPath"</span>: s3_output</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"ResourceConfig"</span>: &#123;</div><div class="line">      <span class="string">"InstanceCount"</span>: <span class="number">1</span>,</div><div class="line">      <span class="string">"InstanceType"</span>: <span class="string">"ml.c4.8xlarge"</span>,</div><div class="line">      <span class="string">"VolumeSizeInGB"</span>: <span class="number">10</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"RoleArn"</span>: role,</div><div class="line">    <span class="string">"StaticHyperParameters"</span>: &#123;</div><div class="line">      <span class="string">"objective"</span>: <span class="string">'reg:linear'</span>,</div><div class="line">      <span class="string">"learning_rate"</span>: <span class="string">'0.1'</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"StoppingCondition"</span>: &#123;</div><div class="line">      <span class="string">"MaxRuntimeInSeconds"</span>: <span class="number">43200</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>Hyperparameter Tuning Job</code>에 대한 정의이다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">smclient.create_hyper_parameter_tuning_job(</div><div class="line">    HyperParameterTuningJobName   = tuning_job_name,</div><div class="line">    HyperParameterTuningJobConfig = tuning_job_config,</div><div class="line">    TrainingJobDefinition         = training_job_definition)</div></pre></td></tr></table></figure></p>
<p><code>Hyperparameter Tuning Job</code>을 생성하여 실행하는 코드다.</p>
<p>실행을 하면 <code>AWS Console</code>에서 실행 중인 것을 확인 가능하다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.12.png" alt=""></p>
<p>실행 상태를 코드로 확인하려면 아래와 같이 실행하면 된다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">smclient.describe_hyper_parameter_tuning_job(</div><div class="line">    HyperParameterTuningJobName=tuning_job_name)</div></pre></td></tr></table></figure></p>
<p>그 중 중요한 것 몇가지만 소개하자면</p>
<ul>
<li><code>HyperParameterTuningJobStatus</code> : 현재 상태 InProgress, Completed, Failed, Stopped ...</li>
<li><code>BestTrainingJob</code> : 현재까지 시도한 것중 가장 <code>Best Model</code>의 정보, 수행시간, <code>Hyperparameter</code> 정보 등등...</li>
</ul>
<p>나머지 값들은 직접 확인하여도 어렵지 않게 이해가 가능하다.</p>
<p><code>Best Model</code>의 정보는 작업 중 혹은 작업종료 후에 <code>AWS Console</code>에서도 확인이 가능하다.</p>
<p><img src="https://raw.githubusercontent.com/DevStarSJ/Study/master/Blog/Cloud/AWS/images/aws.sagemaker.13.png" alt=""></p>
<p><code>SageMaker</code>에서 바로 <code>Create model</code>을 이용해서 작업이 가능하지만, 내 경우에는 작업은 따로 EC2를 생성하여 하였다. 그 이유는 아직 <code>SageMaker</code>에서 생성 가능한 instance의 성능이 EC2에서 생성가능한 것에 비해서 좋지 않아서 이다. 예를 들면 2018-09-15 현재 c시리즈 기준으로 <code>EC2</code>에서는 <code>c5.18xlarge</code> 까지 생성이 가능하지만, <code>SageMaker</code>에는 <code>ml.c4.8xlarge</code>가 가장 성능이 좋은 instance이다.</p>
<h2>4. 맺음말</h2>
<p><code>SageMaker</code>를 사용해서 <code>Hyperparameter Tuning</code>을 하는 과정을 살펴보았다.
해당 작업을 업무에 실제로 사용해본 소감으로는 아주 편리했다.
하지만 Tuning 하고 싶은 값 중 아직 static으로만 입력이 가능한 것이 있어서 한편으로 아쉬움이 크다.
처음 사용할 경우 많은 부분들에 Limit가 걸려 있어서, support를 이용해서 늘려달라고 요청을 해야 한다.
그 과정이 대략 이틀 정도 걸렸다. 어느 정도 비용은 발생하지만 지속적으로 <code>Model</code>을 개선할 수 있는 것은 큰 장점이다.</p>
<p>혹시 질문사항이 있으면 언제든 댓글로 남겨주면 아는 한도 내에서는 답변을 드리겠다. 하지만 아직 <code>SageMaker</code>를 많은 부분에 사용하고 있지는 않아서 위 설명한 범위를 벗어나는 일반 <code>Model</code>의 학습 및 배포에 대해서는 현재로서는 <code>SageMaker</code>를 이용해서 할 계획이 없어서 답변이 가능할지에 대해서 현재로서는 미지수이다.</p>
<h2>마치며...</h2>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2018/09/15/aws-sagemaker-hpt-tutorial/" data-id="cjov1wtqv0084jw7b2km36v9q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HyperparameterTuning/">HyperparameterTuning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SageMaker/">SageMaker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XGBoost/">XGBoost</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-aws-serverless-express" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/06/aws-serverless-express/" class="article-date">
  <time datetime="2017-08-06T01:07:00.000Z" itemprop="datePublished">2017-08-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/06/aws-serverless-express/">aws-serverless-express 소개</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>aws-serverless-express 소개</h1>
<h2>aws-serverless-express ?</h2>
<p><a href="https://github.com/awslabs/aws-serverless-express" target="_blank" rel="external">aws-serverless-express</a> ?<br>
이름부터 좀 괴랄하다.</p>
<ul>
<li>aws : <a href="https://aws.amazon.com" target="_blank" rel="external">Amazon Web Service</a></li>
<li>aws-serverless : AWS에서 제공해주는 serverless니깐 <a href="https://aws.amazon.com/lambda/details" target="_blank" rel="external">AWS Lambda</a> 라고 추측이 가능하다.</li>
<li>aws-serverless-express: AWS Lambda에서 Express를 ? Node.js의 Web Framework인 그 <a href="http://expressjs.com" target="_blank" rel="external">Express</a>인가 ?</li>
</ul>
<p>그 Express가 맞다.</p>
<p><strong>aws-serverless-express</strong>는 기존에 Express로 동작하는 Web App을 그대로 AWS Lambda에서 동작하게 하는 Framework이다.</p>
<h2>aws-serverless-express 왜 써야하지 ?</h2>
<p><strong>aws-serverless-express</strong>는 어떤 장점이 있길래 써야 할까 ?
여기에 대해서 곰곰히 생각해보았다.</p>
<p>솔직히 <strong>AWS Lambda</strong>에 대해서 그 동안 쭉 작업을 해온 입장에서 <strong>aws-serverless-express</strong>로 작업을 처음 했을때 드는 생각은 다음과 같았다.</p>
<ul>
<li>사용 전
<ul>
<li>이거 없이도 이미 잘 쓰고 있다.</li>
<li>굳이 <strong>aws-serverless-express</strong>를 왜 써야하는지 모르겠다.</li>
</ul>
</li>
<li>사용 후
<ul>
<li>이미 작성해 놓은 코드 들이 싹~ 필요없어 진다.
<ul>
<li>Route 기능</li>
<li>event를 전달받아서 해주는 전처리 기능들</li>
<li>Lambda Proxy Integration에 대한 구조들</li>
<li>Binary Response를 위해서 base64로 encoding하는 작업들</li>
</ul>
</li>
<li>기존에 Test를 위해서 <strong>Lambda</strong>에서 <strong>API Gateway</strong>로 부터 전달받은 <strong>event</strong>를 <code>console.log</code>를 이용해서 <strong>CloudWatch</strong>에 출력한 후 그걸 Local PC에 저장해두고 수정해가면서 했었는데, 일단 이걸 이제는 못쓰게 된다.</li>
<li>handler의 3번째 인자인 <code>callback</code>이 사라졌다. 기존 코드들 응답하는 것들을 다 수정해야 한다. 오류에 대한 처리 코드들 역시 다 수정해야 한다.</li>
</ul>
</li>
</ul>
<p>이 정도가 작업을 처음 했을때 드는 생각이었다.
이건 내 생각이었고, 그럼 그 특징들에 대해서 느낀 점들은 다음과 같다.</p>
<h3>1. <strong>Express</strong>로 작성된 코드들을 전혀 고치지 않고 <strong>AWS Lambda</strong>에서 동작하도록 하는게 가능하다.</h3>
<p>정말이다. <strong>aws-severless-express</strong>를 <code>npm</code>으로 설치하고 예제에서 제공해주는 <code>lambda.js</code>만 추가하면 끝이다.
단, 기존의 <code>app.js</code> 파일을 <code>app.js</code>, <code>app.local.js</code>로 나누어야 한다.
<code>app.js</code>에는 app 설정 및 route 지정에 대한 내용만 남겨두고, <code>app.listen(port)</code> 이 한 줄만 <code>app.local.js</code>로 옮겨 놓으면 된다.
<code>lambda.js</code>와 <code>app.local.js</code>는 프로젝트마다 차이가 거의 없는 고정된 코드로 만들어도 될 정도로 아주 간단하다.</p>
<h3>2. <strong>AWS Lambda</strong>의 event 구조에 대해서 알필요 없이 <strong>Express</strong>의 <strong>Request</strong>에서 필요한 값들을 읽어서 작업하면 된다.</h3>
<p>기존에 <strong>AWS Lambda</strong>에서 작업할 경우 Template로 event를 정의한 경우 아래와 같은 형태로 전달된다.
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "body-json": &#123;&#125;,</div><div class="line">    "params": &#123;</div><div class="line">      "path": &#123;</div><div class="line">        "name": "Luna"</div><div class="line">      &#125;,</div><div class="line">      "querystring": &#123;&#125;,</div><div class="line">      "header": &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    "stage-variables": &#123;&#125;,</div><div class="line">    "context": &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "context": &#123;</div><div class="line">    "callbackWaitsForEmptyEventLoop": true,</div><div class="line">    "logGroupName": "/aws/lambda/testLambda-luna",</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>하지만 요즘은 대부분 <strong>Lambda Proxy Integration</strong>를 사용하기 때문에 주로 아래와 같은 형태의 event를 전달받는다.</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "event": &#123;</div><div class="line">        "resource": "/&#123;proxy+&#125;",</div><div class="line">        "path": "/test",</div><div class="line">        "httpMethod": "GET",</div><div class="line">        "headers": &#123;</div><div class="line">            ...</div><div class="line">            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36",</div><div class="line">        &#125;,</div><div class="line">        "queryStringParameters": &#123;</div><div class="line">            "name": "Luna",</div><div class="line">            "id": "123"</div><div class="line">        &#125;,</div><div class="line">        "pathParameters": &#123;</div><div class="line">            "proxy": "test"</div><div class="line">        &#125;,</div><div class="line">        "stageVariables": null,</div><div class="line">        "requestContext": &#123;</div><div class="line">            ...</div><div class="line">            &#125;,</div><div class="line">            "resourcePath": "/&#123;proxy+&#125;",</div><div class="line">            "httpMethod": "GET",</div><div class="line">        &#125;,</div><div class="line">        "body": null,</div><div class="line">        "isBase64Encoded": false</div><div class="line">    &#125;,</div><div class="line">    "context": &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>AWS Lambda</strong>에서 작업하기 위해서는 이런 구조들에 대해서 파악을 하고 작업을 해야한다.
<strong>aws-serverless-express</strong>에서는 이런것에 대해서 알 필요가 없이 Framework단에서 이런 event를 <strong>Express</strong>의 <strong>Request</strong> 타입으로 전달해준다.
<strong>Lambda</strong>에서 작업하기 위해서 event 형태에 대해서 배울 필요가 없어진다.
<strong>Node.js</strong> 개발자들이 <strong>AWS Lambda</strong> 개발을 하기위한 러닝커브가 많이 줄어든 것이다.</p>
<p><strong>Request</strong> 뿐만 아니라 <strong>Response</strong> 또한 <strong>Express</strong>와 동일하게 작업이 가능하다.
Error 발생 사항에 대한 statusCode 전달 형태, Binary Response일 경우 Base64로 Encoding하여 body에 string 형태로 저장 등 Lambda만의 방식으로 작업을 할 필요가 없어진다.</p>
<h3>3. <strong>AWS Lambda</strong>에 Deploy하지 않고도 Local PC에서 <strong>Express</strong>로 실행시켜서 API 테스트가 가능하다.</h3>
<p>기존에는 Lambda Handler 함수에 <strong>event, context, callback</strong> 인자를 테스트용으로 생성하여 만들어서 전달하는 식으로 테스트를 하였다.
<strong>event</strong>는 실제 Lambda 상에서 CloudWatch로 출력한 내용을 복사한 뒤 그걸 수정하여 별도 <em>JSON</em> 파일로 저장을 하여서 활용을 하였으며,
<strong>callback</strong>은 2번째 인자로 전달받은 값을 화면에 <code>JSON.stringify</code>로 이쁘게 출력해주는 식으로 작성을 하여서 전달하였다.
<strong>context</strong>는 아에 사용을 하지 않아서 그냥 <code>null</code>로 전달하였다.
이런 식으로 실행을 해가면서 테스트를 했었는데, <strong>aws-serverless-express</strong>를 사용할 경우에는 그냥 <code>app.local.js</code>를 실행해서 <strong>Express</strong> 서버를 띄운 뒤 <em>Web Browser</em>나 <em>Postman</em>, <em>crul</em> 등으로 Request가 가능해진다.</p>
<p>위 3가지 특징들로 인하여 <strong>AWS Lambda</strong> 경험이 전혀 없는 <strong>Node.js</strong>의 <strong>Express</strong>로 Web Server를 개발하던 분들이 쉽게 작업이 가능해진다. 관련 개발자를 구하기도 좀 더 쉬워질 것이다.</p>
<p>위 특징은 <strong>AWS Lambda</strong>를 경험한 적이 없는 사람의 경우에 와닿는 이야기다. 그럼 <strong>AWS Lambda</strong>에서 작업이 능숙한 사람들 입장에서 한번 보자.</p>
<h3>1. Route 코드 작업을 직접하지 않아도 된다.</h3>
<p><strong>Express</strong> 방식을 그대로 사용하면 된다.
<strong>API Gateway</strong>에서 <code>{proxy+}</code> 설정 방법에 따라 전달되는 <code>event</code>의 path parameter 가 달라지는 것도 신경쓰지 않아도 된다.
엄밀히 말하면 신경쓰지 않아도 되는거라기 보다는 <strong>Express</strong> 방식대로 작업하면 된다.</p>
<p>내가 작성한 코드가 많이 사라진다는건 어떤 의미일까 ?
이미 많은 사람들에게 검증된 코드들의 비중이 올라가고 내가 직접 작성한 코드가 적어지면 그만큼 버그 발생 가능성도 줄어드는 것으로 봐도 된다.
여기에 대해서는 반대 의견도 많긴 하지만, 이건 각자 판단에 맡기겠다.
이러한 기반 동작에 대한 코드들에 대해서 신경을 덜쓰고 그만큼 서비스 코드들에 대해서 더 작업 및 테스트 시간을 할애할수 있으면 더 좋지 않을까 ?</p>
<p>그럼에도 불구하고, 별로 그러기 싫다면 ??? 기존에 작업해 놓은 코드들을 수정하기가 죽어도 싫다면 ???</p>
<p><code>Request.headers.x-apigateway-event</code>에 <strong>API Gateway</strong>의 event 값이 urlencoded 상태로 저장되어 있다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&apos;x-apigateway-event&apos;: &apos;%7B%22resource%22%3A%22%2Fic%2F%7Bproxy%2B%7D%22%2C%22path%22%3A%22%2Fic%2Fusers%2F146150%2Fphotos%2Fuploads%2F0dce50a5319e92ee0700becde219bf0700003138.JPG%22%2C%22httpMethod%22%3A%22GET%22%2C%22headers%22%3A%7B%22Accept%22%3A%22text%2Fhtml%2Capplication%2Fxhtml%2Bxml%2Capplication%2Fxml%3Bq%3D0.9%2Cimage%2Fwebp%2Cimage%2Fapng%2C*%2F*%3Bq%3D0.8%22%2C%22Accept-Encoding%22%3A%22gzip%2C%20deflate%2C%20br%22%2C%22Accept-Language%22%3A%22ko-KR%2Cko%3Bq%3D0.8%2Cen-US%3Bq%3D0.6%2Cen%3Bq%3D0...</div></pre></td></tr></table></figure></p>
<p>그냥 이걸 decoding하여 기존 코드에 event로 전달하면 된다.</p>
<h3>2, Response 쪽 코드는 바뀌어야 한다.</h3>
<p>이건 어쩔수 없다. 기존 <code>callback</code>을 사용할 수 있는 방법은 없다. 그럼에도 불구하고 기존 코드를 고치기 싫다면 <strong>Express</strong>의 <strong>Response</strong>를 이용해서 응답하는 <code>callback</code> 함수를 직접 만들어서 기존 handler로 전달해라. 선택은 본인의 몫이다.</p>
<p><strong>Binary Response</strong>에 대해서 base64로 encode한 string값을 body에 저장하여 callback 함수의 2번째 인자로 전달하는게 편하면 그렇게 하면 된다.</p>
<h4>Lambda의 Binary Response</h4>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> content = fs.readFileSync(result.filename);</div><div class="line"><span class="keyword">const</span> response = &#123;</div><div class="line">    <span class="attr">statusCode</span>: <span class="number">200</span>,</div><div class="line">    <span class="attr">headers</span>: &#123;</div><div class="line">        <span class="string">"Content-Type"</span>: result.contentType</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">body</span>: <span class="keyword">new</span> Buffer(content).toString(<span class="string">"base64"</span>),</div><div class="line">    <span class="attr">isBase64Encoded</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">callback(<span class="literal">null</span>, response);</div></pre></td></tr></table></figure></p>
<h4>Express의 Binary Response</h4>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">res.header(<span class="string">'Content-Type'</span>, result.contentType)</div><div class="line">   .sendFile(result.filename);</div></pre></td></tr></table></figure></p>
<p>어느 코드가 더 작성도 편하고, 읽기도 편하게 보이는가 ?</p>
<h3>3. Error 처리 코드를 변경할 수 있다.</h3>
<p>이건 변경되어야 하는게 아니라 변경 할 수 있다고 썼다.
그렇다고 기존 <code>callback</code>을 그대로 쓸수 있다는 말은 아니다.</p>
<p>기존에 <code>callback</code>을 계속 인자로 전달하여 Error가 발생한 곳에서 실행을 했던 코드라면 <code>callback</code> 대신 <code>Response</code>를 계속 전달하여 <code>res.status(500).json({});</code>로 수정하면 된다.</p>
<p>Error를 최상단의 <code>catch { ... }</code>로 전달 받은뒤 처리하는 형태였다면 그것 역시 <code>callback</code>대신 <code>Response</code>로 변경하는 작업만 해주면 된다.</p>
<p><strong>Express</strong>에는 이 방법 외에도 <code>app.use</code>에 Middleware로 등록해 놓는 것도 가능하다.</p>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="function">(<span class="params">err, req: Request, res: Response, next: NextFunction</span>) =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.info(<span class="string">"error status = "</span>, err.status);</div><div class="line">    <span class="keyword">if</span> (err.status &amp;&amp; err.status &lt; <span class="number">500</span>) &#123;</div><div class="line">        <span class="built_in">console</span>.info(<span class="string">"ExpectedError = "</span> + err);</div><div class="line">        res.status(err.status).json(err);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.info(<span class="string">"InternalServerError = "</span> + err);</div><div class="line">        <span class="keyword">if</span> (!err)</div><div class="line">            err = &#123;status:<span class="number">599</span>&#125;</div><div class="line">        raygun.Send(err);</div><div class="line">        res.status(err.status).json(err);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>위 코드 형식으로 <code>app.js</code> 또는 <code>app.ts</code>에 등록해 두고 모든 Error를 여기서 처리하는 것도 가능하다.
단, 해당 app의 <strong>Route</strong>를 사용하는 것에 대해서만 처리가 가능하다. 만약 <strong>Route</strong> 되는 과정에서 따로 <strong>class</strong>를 생성하여 자체 <strong>Route</strong>를 가지는 곳으로 <strong>Request</strong>를 전달하여 처리하는 형태로 작성된 코드라면 해당 <strong>Route</strong>상의 Middleware로 등록하여야 한다.
어느게 더 좋은 방식이라는건 없다. 이건 설계의 문제이기 때문에 거기에 따라서 작업을 하면 된다.</p>
<p><a href="http://expressjs.com/guide/error-handling.html" target="_blank" rel="external">http://expressjs.com/guide/error-handling.html</a>에 Express Error Handling에 대한 내용이 있긴한데 그리 자세하지는 않다.</p>
<h3>4. API Gateway StageVariable 사용이 조금 불편해진다.</h3>
<p>이건 <strong>Express</strong>에는 없는 개념이라 어쩔 수 없다.
위에도 잠깐 언급했듯 <code>Request.headers.x-apigateway-event</code>에 <strong>API Gateway</strong>의 event 값이 urlencoded 상태로 저장되어 있다.
이 값을 다시 decode하여 <code>stageVariables</code>의 값을 읽어야 한다.</p>
<h3>5. Lambda의 Environment variables는 쉽게 사용이 가능하다.</h3>
<p><code>.env</code>라는 파일에 <code>KEY=VALUE</code> 형태로 값들을 저장해 놓은 뒤 아래와 같이 사용이 가능하다.</p>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dotenv <span class="keyword">from</span> <span class="string">"dotenv"</span>;</div><div class="line">dotenv.config(&#123; path: <span class="string">".env"</span> &#125;);</div><div class="line"><span class="keyword">const</span> a = process.env.KEY;</div></pre></td></tr></table></figure></p>
<p>그럼 Lambda 상에서와 동일하게 세팅해두고 Local PC에서 테스트가 가능하다.</p>
<h2>3. 예제 코드</h2>
<p>예제 코드를 따로 작성하려고 생각했었는데, 제공해주는 예제 코드가 너무나도 괜찮아서 따로 작성하지는 않겠다.</p>
<p><a href="https://github.com/awslabs/aws-serverless-express/tree/master/example" target="_blank" rel="external">https://github.com/awslabs/aws-serverless-express/tree/master/example</a></p>
<p>위 Link 예제를 다운받아서 실행하면서 코드를 보면 쉽게 이해가 된다.</p>
<p><strong>Lambda</strong> 배포시 실행할 함수를 <code>lambda.handler</code>로 설정해야 한다.</p>
<p>Local PC에서 테스트 할때는 <code>app.local.js</code>를 실행하면 된다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node app.local.js</div></pre></td></tr></table></figure></p>
<p>Error Handling 부분이 빠져 있는데, 그건 위에 설명하면서 적어놓은 코드 조각으로 충분할 거라 생각된다.</p>
<p>API Gateway 와 Lambda의 연결에 대해서는 예전에 포스팅 해놓은 글을 참고해 주길 바란다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
</ul>
<p>그냥 <code>{proxy+}</code>로 배포를 하면 된다. path 별로 다른 <strong>Lambda</strong>를 실행하고 싶을 경우에도 기존과 동일하게 작업하면 된다.</p>
<h2>4. TypeScript로 작성할 경우 참고할 내용들</h2>
<p>주로 작업을 <strong>TypeScript</strong>로 많이 하는 편이라 거기에 관련된 Tip들만 몇개 적어보겠다.</p>
<h3>1. <strong>Express</strong>용 Type에 대해서 정의하고 싶을 경우</h3>
<p>express의 types를 설치</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install @types/express --save-dev</div></pre></td></tr></table></figure></p>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;Router , Request , Response , NextFunction&#125;  <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> asyncify <span class="keyword">from</span> <span class="string">"express-asyncify"</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> app = asyncify(express());</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> app;</div><div class="line"></div><div class="line">app.get(<span class="string">'/v1/*'</span>, index);</div><div class="line"></div><div class="line">app.get(<span class="string">'/v2/*'</span>, <span class="function">(<span class="params">req: Request, res: Response, next: NextFunction</span>) =&gt;</span> &#123;</div><div class="line">    req.query.version = v2;</div><div class="line">    next();</div><div class="line">&#125;, index);</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">req: Request, res: Response, next: NextFunction</span>) </span>&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>위 코드와 같은 Type을 사용할 수 있다.</p>
<h3>2. 예제 js 코드를 ts로 고칠 경우 requre -&gt; import로 수정</h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</div></pre></td></tr></table></figure></p>
<p>위 코드와 동일하게 동작하게 하려면 아래와 같이 수정해야 한다.</p>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</div></pre></td></tr></table></figure></p>
<p>패키지로 제공받는 코드의 경우는 저렇게 사용하면 되며, 내가 작성한 코드는 <code>default</code> 키워드를 이용 할 수 있다.</p>
<h4>app.ts</h4>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123;Request , Response , NextFunction&#125;  <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">'express'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> asyncify <span class="keyword">from</span> <span class="string">"express-asyncify"</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cors <span class="keyword">from</span> <span class="string">'cors'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> app = asyncify(express());</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> app;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h4>lambda.ts</h4>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> awsServerlessExpress <span class="keyword">from</span> <span class="string">'aws-serverless-express'</span>;</div><div class="line"><span class="keyword">import</span> * <span class="keyword">as</span> awsServerlessExpressMiddleware <span class="keyword">from</span> <span class="string">'aws-serverless-express/middleware'</span>;</div><div class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">'./app'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> binaryMimeTypes = [</div><div class="line">    <span class="string">'application/json'</span>,</div><div class="line">    <span class="string">'image/jpeg'</span>,</div><div class="line">    <span class="string">'image/png'</span>,</div><div class="line">    <span class="string">'image/jpg'</span>,</div><div class="line">    <span class="string">'image/webp'</span></div><div class="line">];</div><div class="line"></div><div class="line">app.use(awsServerlessExpressMiddleware.eventContext());</div><div class="line"><span class="keyword">const</span> server = awsServerlessExpress.createServer(app, <span class="literal">null</span>, binaryMimeTypes);</div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> handler = <span class="function">(<span class="params">event, context</span>) =&gt;</span> awsServerlessExpress.proxy(server, event, context);</div></pre></td></tr></table></figure></p>
<h4>app.local.ts</h4>
<p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">'./app'</span>;</div><div class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</div><div class="line"></div><div class="line">app.listen(port);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">`listening on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</div></pre></td></tr></table></figure></p>
<p>위에 적어놓은 <code>app.local.ts</code>, <code>lambda.ts</code>는 거의 수정할 필요가 없다.
단 <code>lambda.ts</code>에서 <code>binaryMimeTypes</code>는 제공해주는 <code>Content-Type</code>에 맞게 추가 및 삭제하면 된다.</p>
<p><code>app.ts</code>의 경우에도 해당 코드 아래에 <code>app.use</code>를 통한 Middleware 설정 및 <code>app.get</code>, <code>app.post</code> 등의 Route 설정을 하면 된다.</p>
<h2>마치며...</h2>
<p>그 동안 <strong>AWS Lambda</strong> 관련 작업을 많이해서 사실상 <strong>aws-serverless-express</strong> 없이도 작업하는데 큰 불편함이 없었다.
처음에는 <strong>Lambda</strong>에 배포하지 않고도 Local PC에서 Browser로 접속해서 테스트가 가능하는 점에서 시작하였다.
작업을 조금씩 하다보니 예전에 작성해 놓은 코드들이 많이 삭제되어야 해서 시원섭한한 느낌적인 느낌을 받았으며,
<strong>Express</strong> 형태에 맞게 수정되어야 할 코드들이 많이 생겨서 여간 귀찮은게 아니었다.
하지만 삭제 및 수정되어야 할 코드들은 대부분 중요한 로직 코드가 아니라서 앞으로 유지보수 차원에서 생각하자면 오히려 앞으로 코드 읽기도 편해지고, 버그가 발생한 가능성이 있는 코드를 보는 측면에서 생각하더라도 훨씬 봐야할 코드 량이 줄어들게 된다.</p>
<p>난 사실 <strong>Express</strong>에 대한 경험이 없고 바로 <strong>Lambda</strong>로 <strong>Node.js</strong> 및 <strong>TypeScript</strong> 작업을 처음 시작한 경우인데, <strong>aws-serverless-express</strong>를 사용하면서 <strong>Express</strong>를 경험하게 되어서 이제 <strong>Express</strong>를 이용한 <strong>Node.js</strong> Server 개발에 대한 기술도 확보하게 된 셈이다.</p>
<p>새로 합류하시는 분들에게도 <strong>Lambda</strong> 작업시 편리할 것 같단 생각이 든다.</p>
<p>아직 <strong>aws-serverless-express</strong>로 작업한 시간이 그리 길지 않으므로, 아직 확인되지 않은 사항들이 있을 수 있다.
새로운 공유할 사항이 발견되면 해당 글을 수정 또는 추가 글을 올리는 등의 방법으로 공유할 예정이다.</p>
<p>혹시 질문할 내용이 있는 경우에는 언제든지 문의해주길 바란다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/08/06/aws-serverless-express/" data-id="cjov1wtqt007zjw7boovm8blv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Serverless/">Serverless</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Devops.AWS.Jenkins.Win" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/01/Devops.AWS.Jenkins.Win/" class="article-date">
  <time datetime="2017-08-01T08:00:00.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/01/Devops.AWS.Jenkins.Win/">ASP.NET Web Project를 EC2 or Elastic BeanStalk에 배포하는 Jenkins 시스템 구축</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>ASP.NET Web Project를 EC2 or Elastic BeanStalk에 배포하는 Jenkins 시스템 구축</h1>
<h2>1. EC2 생성</h2>
<ul>
<li>ec2 생성
<ul>
<li><strong>Visual Studio</strong>를 설치할려면 최소 2.5GB이상의 메모리 (t2.medium)</li>
<li><strong>MSBuild</strong>만 설치할 것이라면 훨씬 작은 것도 가능. 1G 메모리를 가진 (t2.micro)</li>
<li>Security Group 에 8080 포트에 접속 허용 ip 대역 설정</li>
</ul>
</li>
</ul>
<h2>2. 필요한 설치 파일들</h2>
<ul>
<li>
<p>Copy files to ec2</p>
<ul>
<li>Jenkins : <a href="https://jenkins.io/download" target="_blank" rel="external">https://jenkins.io/download</a></li>
<li>MSBuild Tools
<ul>
<li>MSBuild Tools 2015 기준 : <a href="https://www.microsoft.com/ko-kr/download/details.aspx?id=48159" target="_blank" rel="external">https://www.microsoft.com/ko-kr/download/details.aspx?id=48159</a></li>
<li>AWS CLI : <a href="http://docs.aws.amazon.com/cli/latest/userguide/awscli-install-windows.html#install-msi-on-windows" target="_blank" rel="external">http://docs.aws.amazon.com/cli/latest/userguide/awscli-install-windows.html#install-msi-on-windows</a></li>
<li>AWS Tools and SDK : <a href="https://aws.amazon.com/ko/visualstudio" target="_blank" rel="external">https://aws.amazon.com/ko/visualstudio</a></li>
<li>Git : <a href="https://git-scm.com/download/win" target="_blank" rel="external">https://git-scm.com/download/win</a></li>
<li>Microsoft Web Deploy v3.6 <a href="https://www.microsoft.com/en-us/download/details.aspx?id=43717" target="_blank" rel="external">https://www.microsoft.com/en-us/download/details.aspx?id=43717</a></li>
<li>만약 TypeScript를 썼다면 ? <a href="https://www.microsoft.com/en-us/download/confirmation.aspx?id=48593" target="_blank" rel="external">https://www.microsoft.com/en-us/download/confirmation.aspx?id=48593</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>설치 : 전부다</p>
</li>
<li>
<p>Visual Studio를 설치할 경우 Web 설치가 아닌 offline 설치용 ISO를 구해야함</p>
</li>
</ul>
<h2>3. MSBuild 실행 확인</h2>
<ul>
<li>
<p>MSBuild.exe 가 실행될수 있도록 환경변수에 PATH 등록
<img src="/images/msbuild.03.png" alt=""></p>
</li>
<li>
<p>이제 빌드가 정상적으로 되는지 확인</p>
</li>
<li>
<p>혹시 안되면 Visual Studio 가 설치된 PC의 <code>MSbuild</code> 폴더 내부를 전부 다 복사</p>
</li>
<li>
<p>대부분 문제가 되는건 <code>MSBuild</code> 자체보다는 <code>Web Deploy</code> 설치 및 버전이 문제가 됨</p>
</li>
<li>
<p>참고그림 : Web Deploy 설치전 ec2와 Visual Studio가 설치된 개발PC의 폴더 내용들</p>
</li>
</ul>
<p><img src="/images/msbuild.01.png" alt="">
<img src="/images/msbuild.02.png" alt=""></p>
<h2>4. AWS Deploy 확인</h2>
<p>이제 빌드가 정상적으로 되는건 확인 단, Deploy가 안됨</p>
<p><code>aws configure --profile 프로파일명</code> 식으로 AWS 프로파일 등록</p>
<p>디플로이까지 성공 확인</p>
<h2>5. Jenkins 설치 후 item 등록</h2>
<p>이하 생략...</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/08/01/Devops.AWS.Jenkins.Win/" data-id="cjov1wtos004djw7bwg04o8yh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI-CD/">CI/CD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jenkins/">Jenkins</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-AzureFunction.TensorflowPredict" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/27/AzureFunction.TensorflowPredict/" class="article-date">
  <time datetime="2017-07-27T06:57:00.000Z" itemprop="datePublished">2017-07-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Azure/">Azure</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/27/AzureFunction.TensorflowPredict/">Using Tensorflow Predict on Azure Function</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Using Tensorflow Predict on Azure Function</h1>
<h2>참고사항</h2>
<p>똑같은 구성으로 <strong>AWS</strong>에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/ecs.tensorflow.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to AWS ECS</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a></li>
</ul>
<p>이 작업을 시작하게 된 이유와 개념적인 구성에 대한 설명은 위 Link의 글들을 참고하길 바란다
즉 학습, 저장, 서비스 를 어떻게 동작시키는 것을 목적으로 하였는지에 대한 설명은 이 글에서는 생략하겠다.</p>
<p>Azure에 구성을 한 것은 이 글 포함 2개의 글이 있다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureContainer.TensorflowDockerImage.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to Azure</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureFunction.TensorflowPredict.md" target="_blank" rel="external">Using Tensorflow Predict on Azure Function</a></li>
</ul>
<h2>왜 이런 생각을 ???</h2>
<p>앞서 <strong>Azure Container Service</strong>에서 <strong>Tensorflow</strong>를 이용하여 학습을 진행하여 그 결과를 <strong>Azure File Storage</strong>에 저장하는 방법에 대해서 글을 적었다.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureContainer.TensorflowDockerImage.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to Azure</a></p>
<p>학습 결과를 <strong>Azure File Storage</strong>에 남긴 이유는 크게 2가지였다.</p>
<ul>
<li>하나는 다음에 학습을 진행할때 해당 값을 이용하여 계속해서 학습을 진행 할 경우를 대비하자는 것이고,</li>
<li>다른 하나는 학습 결과 데이터를 이용해서 예측하는 서비스를 제공하는데 사용하려는 목적이다.</li>
</ul>
<h2>Azure Function에 Tensorflow 배포 ?</h2>
<p>먼저 <strong>Tensorflow</strong>를 <strong>AWS Lambda</strong>에 배포하는것은 안된다고 <strong>AWS Lambda</strong> 관련 글에 남긴적이 있다.
그럼 <strong>Azure Function</strong>에는 가능할까 ?</p>
<p>아직 끝까지 가보지는 않았지만, 가능하리라 판단된다. 하지만 쉽지 않을 것이다.</p>
<p>왜냐면 <strong>Azure Function</strong>의 경우에는 실행 환경을 커스터마이징하는게 가능하다. 기본적으로 제공해주는 것과 다른 버전의 <strong>Python</strong>설치도 가능하다. 하지만 실제로 테스트해보니 엄청 손이 많이 가는 작업이다. <strong>Python 3.6</strong>이 수행되도록 설치를 하였으나 <strong>pip</strong>가 동작하지 않았다. 아마 이것또한 따로 설치해 줘야 할것이다. 이런 식으로 하나하나 설치하다보면 언젠가는 <strong>tensorflow</strong> 실행까지 가능하도록 구축이 될 것이다. 만약 이게 업무였다면 끝까지 파고들어서 설치까지 진행했겠지만, 단순 테스트용으로 그렇게까지 하고 싶지는 않아서 그냥 더 이상 진행하지 않았다.</p>
<p>더 이상 진행하지 않은 이유가 하나 더 있는데, 아직 <strong>Azure Function</strong>에서 <strong>Python</strong>으로 작업하는게 아직까진 자연스럽지 않다. <strong>C#</strong> 이나 <strong>Node.JS</strong>의 경우에는 최초 실행되는 코드가 함수로 감싸져 있고, Http로 전달한 querystirng, body 정보 같은게 해당 함수의 인자로 전달되는데, <strong>Python</strong>의 경우는 최초 실행되는 코드가 따로 함수로 감싸져 있지 않고, 그냥 파일의 처음부터 실행되며, 요청한 값들을 <code>os.environ</code>에서 직접 가져와야 한다. 아직까지 정식으로 <strong>Python</strong>을 지원한다기보다는 그냥 Preview 정도의 느낌이다.</p>
<p>그래서 가장 <code>Azure</code>에서 자연스럽게 동작할 **C#**으로 작성을 하였다. 파일 형식이 <code>.cs</code>가 아니라 <code>.csx</code>인데, 이 부분도 솔직히 조금 불편했다. 그래서 결국에는 <strong>ConsoleApplication Project</strong>를 하나 생성하여서 거기서 작업을 다 한뒤에 <code>.csx</code>파일로 옮겼다.</p>
<p>먼저 <strong>Azure Function</strong> 을 생성해 보겠다.</p>
<h2>Azure Function 생성</h2>
<ul>
<li>우측 상단 <code>+ New</code> 클릭
<ul>
<li><code>Web + Mobile &gt;</code> 범주에 속하기는 하나 많이 사용하지 않는지 기본 목록에는 나오지 않고, <code>See all</code>을 눌러야지만 나온다.</li>
<li>그냥 검색으로 <code>Function</code>을 입력해서 선택한 후 <code>Create</code>를 누르자.
<ul>
<li><code>App Name</code> : (ex. predictcs)</li>
<li><code>Resource Group</code> : 그냥 기존에 생성해 놓은것으로 같이 쓰도록 설정</li>
<li><code>Location</code> : <code>Japan West</code> 그나마 거리 가까운것 중에 가장 저렴한 것으로 설정</li>
<li><code>Storage</code> : 그냥 기존에 생성해 놓은것으로 같이 쓰도록 설정</li>
<li><code>Create</code>를 눌루서 생성</li>
<li><img src="/images/azure.function.01.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>그럼 대쉬보드 상에서 생성되는 것을 볼 수 있다. 생성이 끝나면 바로 설정 창으로 이동된다.</p>
<ul>
<li><code>Functions +</code>에서 <code>+</code>를 눌러서 새로 생성
<ul>
<li><code>Webhook + API</code>, <code>CSharp</code>이 default로 선택되어 있음.</li>
<li>그냥 <code>Create this function</code>을 눌러서 생성</li>
</ul>
</li>
</ul>
<p>그럼 자동으로 기본적인 <code>Hello World</code>같은 코드가 작성되어 있다.</p>
<p>우측 상단의 <code>Get Function URL</code>을 눌러서 호출 가능한 주소를 확인하자.</p>
<p><img src="/images/azure.function.02.png" alt=""></p>
<p>해당 URL을 복사해서 Browser 주소창에 붙인후 뒤에 <code>&amp;Name=Luna</code>를 추가해서 호출하면 결과 확인이 가능하다.</p>
<p><img src="/images/azure.function.03.png" alt=""></p>
<p>이제 코드를 작성해 보자.</p>
<h2>C# 으로 작성된 Predict 제공 코드</h2>
<p>참고로 아래 코드는 <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a>에서 작성한 <strong>Python</strong>코드를 <strong>C#</strong> 으로 옮긴 코드이다.
물론 <strong>AWS S3</strong>에서 파일을 다운로드 받는 것을 <strong>Azure File Storage</strong>에서 받는 것으로 수정하였다.</p>
<p><strong>Azure Function</strong>의 경우 **C#**의 <strong>nuget</strong>으로 제공되는 패키지들의 설치가 가능하다는 점이 좋았다.</p>
<p>먼저 사용한 <strong>nuget</strong> 들을 <code>project.json</code>파일에 정의해야 한다. 해당 파일이 생성되어 있지 않다면 만들어야 한다.</p>
<p><img src="/images/azure.function.04.png" alt=""></p>
<h3>project.json</h3>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"frameworks"</span>: &#123;</div><div class="line">    <span class="attr">"net46"</span>:&#123;</div><div class="line">		<span class="attr">"dependencies"</span>: &#123;</div><div class="line">			<span class="attr">"MathNet.Numerics"</span>: <span class="string">"3.20.0"</span>,</div><div class="line">			<span class="attr">"Microsoft.Azure.KeyVault.Core"</span>: <span class="string">"2.0.4"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.Edm"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.OData"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.Data.Services.Client"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"Microsoft.WindowsAzure.ConfigurationManager"</span>:<span class="string">"3.2.3"</span>,</div><div class="line">			<span class="attr">"Newtonsoft.Json"</span>:<span class="string">"10.0.3"</span>,</div><div class="line">			<span class="attr">"System.ComponentModel.EventBasedAsync"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Dynamic.Runtime"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Linq.Queryable"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Net.Requests"</span>:<span class="string">"4.3.0"</span>,</div><div class="line">			<span class="attr">"System.Spatial"</span>:<span class="string">"5.8.2"</span>,</div><div class="line">			<span class="attr">"WindowsAzure.Storage"</span>:<span class="string">"8.2.0"</span></div><div class="line">		&#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>run.csx</h3>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Net;</div><div class="line"><span class="keyword">using</span> System.Collections.Generic;</div><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Linq;</div><div class="line"><span class="keyword">using</span> System.Text;</div><div class="line"><span class="keyword">using</span> MathNet.Numerics.LinearAlgebra;</div><div class="line"><span class="keyword">using</span> MathNet.Numerics.LinearAlgebra.Double;</div><div class="line"><span class="keyword">using</span> Microsoft.Azure;</div><div class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage;</div><div class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage.File;</div><div class="line"><span class="keyword">using</span> Newtonsoft.Json;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task&lt;<span class="keyword">object</span>&gt; <span class="title">Run</span>(<span class="params">HttpRequestMessage req, TraceWriter log</span>)</span></div><div class="line">&#123;</div><div class="line">	log.Info(<span class="string">$"C# HTTP trigger function processed a request. RequestUri=<span class="subst">&#123;req.RequestUri&#125;</span>"</span>);</div><div class="line"></div><div class="line">	<span class="keyword">string</span> xStr = req.GetQueryNameValuePairs().FirstOrDefault(q =&gt; q.Key == <span class="string">"x"</span>).Value;</div><div class="line">	<span class="keyword">double</span>[] x1 = JsonConvert.DeserializeObject&lt;<span class="keyword">double</span>[]&gt;(xStr);</div><div class="line">	<span class="keyword">var</span> x2 = Convert2D(x1);</div><div class="line"></div><div class="line">	PredictModel model = <span class="keyword">await</span> GetPredictModel(ConnectionString, ShareName, ResultFile);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> W = DenseMatrix.OfArray(model.W);</div><div class="line">	<span class="keyword">var</span> X = DenseMatrix.OfArray(x2);</div><div class="line">	<span class="keyword">var</span> H = ArrayAdd(X.Multiply(W).Row(<span class="number">0</span>).AsArray(), model.b);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> sigmoid = H.Select(Sigmoid);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> response = <span class="keyword">new</span> ResponseModel();</div><div class="line">	response.rating = Softmax(sigmoid).ToArray();</div><div class="line">	response.answer = Argmax(response.rating);</div><div class="line"></div><div class="line"></div><div class="line">	<span class="keyword">var</span> jsonResponse = JsonConvert.SerializeObject(response);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> HttpResponseMessage(HttpStatusCode.OK)</div><div class="line">	&#123;</div><div class="line">		Content = <span class="keyword">new</span> StringContent(jsonResponse, Encoding.UTF8, <span class="string">"application/json"</span>)</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ConnectionString = <span class="string">"DefaultEndpointsProtocol=https;AccountName=[NAME];AccountKey=[KEY];EndpointSuffix=[...]"</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ShareName = <span class="string">"tensorflow-savedata"</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">string</span> ResultFile = <span class="string">"result.json"</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PredictModel</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[,] W &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[] b &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResponseModel</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">int</span> answer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">double</span>[] rating &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;<span class="keyword">double</span>&gt; <span class="title">Softmax</span>(<span class="params">IEnumerable&lt;<span class="keyword">double</span>&gt; M, <span class="keyword">double</span> t = <span class="number">1.0</span></span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> E = M.Select(x =&gt; Math.Exp(x / t));</div><div class="line">	<span class="keyword">var</span> total = E.Sum();</div><div class="line">	<span class="keyword">return</span> E.Select(x =&gt; x / total);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">Sigmoid</span>(<span class="params"><span class="keyword">double</span> z</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">1</span> / (<span class="number">1</span> + Math.Pow(Math.E, <span class="number">-1.0</span> * z));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Argmax</span>(<span class="params">IEnumerable&lt;<span class="keyword">double</span>&gt; M</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> max_num = <span class="number">-1.0</span>;</div><div class="line">	<span class="keyword">var</span> max_index = <span class="number">-1</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M.Count(); i++)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">var</span> y = M.ElementAt(i);</div><div class="line">		<span class="keyword">if</span> (y &gt; max_num)</div><div class="line">		&#123;</div><div class="line">			max_num = y;</div><div class="line">			max_index = i;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> max_index;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">double</span>[,] Convert2D(<span class="keyword">double</span>[] d1)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">var</span> d2 = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1</span>, d1.Length];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; d1.Length; i++)</div><div class="line">	&#123;</div><div class="line">		d2[<span class="number">0</span>, i] = d1[i];</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> d2;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">double</span>[] <span class="title">ArrayAdd</span>(<span class="params"><span class="keyword">double</span>[] A, <span class="keyword">double</span>[] B</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> A.Select((a, i) =&gt; a + B[i]).ToArray();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task&lt;PredictModel&gt; <span class="title">GetPredictModel</span>(<span class="params"><span class="keyword">string</span> connectionString, <span class="keyword">string</span> shareName, <span class="keyword">string</span> fileName</span>)</span></div><div class="line">&#123;</div><div class="line">	CloudStorageAccount storageAccount = CreateStorageAccountFromConnectionString(connectionString);</div><div class="line">	CloudFileClient fileClient = storageAccount.CreateCloudFileClient();</div><div class="line">	CloudFileShare share = fileClient.GetShareReference(shareName);</div><div class="line"></div><div class="line">	<span class="keyword">try</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">await</span> share.CreateIfNotExistsAsync();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">throw</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	CloudFileDirectory root = share.GetRootDirectoryReference();</div><div class="line">	CloudFile file = root.GetFileReference(fileName);</div><div class="line"></div><div class="line">	<span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65535</span>];</div><div class="line">	<span class="keyword">await</span> file.DownloadToByteArrayAsync(buffer, <span class="number">0</span>);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> strJson = System.Text.Encoding.Default.GetString(buffer);</div><div class="line">	<span class="keyword">return</span> JsonConvert.DeserializeObject&lt;PredictModel&gt;(strJson);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CloudStorageAccount <span class="title">CreateStorageAccountFromConnectionString</span>(<span class="params"><span class="keyword">string</span> storageConnectionString</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">try</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> CloudStorageAccount.Parse(storageConnectionString);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception e)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">throw</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ConnectionString</code>는 해당 <code>Azure Storage</code>에 가서 <code>Access Key</code>를 누르면 확인이 가능하다. 그것을 입력해준다.</p>
<p>그런 다음 호출 URL을 복사하고 그 뒤에다가 <code>&amp;x=[0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0]</code>값을 추가한 뒤 브라우저로 호출을 해보자.</p>
<p><img src="/images/azure.function.05.png" alt=""></p>
<p>제대로 응답이 오는게 확인이 가능하다.</p>
<h2>Tensorflow 학습 코드</h2>
<p>참고로 이 코드는 <a href="https://www.youtube.com/watch?v=BS6O0zOGX4E&amp;list=PLlMkM4tgfjnLSOjrEJN31gZATbcj_MpUm" target="_blank" rel="external">김성훈 교수님의 모두를 위한 딥러닝 강좌</a> 에서 소개된 코드를 이용하였다.</p>
<p>동물의 여러가지 특징들에 대해서 입력받아서 이 동물의 종류가 무엇인가에 대한 학습데이터이다.</p>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/zoo" target="_blank" rel="external">https://archive.ics.uci.edu/ml/machine-learning-databases/zoo</a> 에서 해당 데이터 내용에 대해서 확인이 가능하다.</p>
<p>여기에는 김성훈 교수님이 미리 만들어 놓은 <a href="https://github.com/hunkim/DeepLearningZeroToAll/blob/master/data-04-zoo.csv" target="_blank" rel="external">data-04-zoo.csv</a> 파일을 이용하겠다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/27/AzureFunction.TensorflowPredict/" data-id="cjov1wtnl0027jw7b35s23z1h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFileStorage/">AzureFileStorage</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFunction/">AzureFunction</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-AzureContainer.TensorflowDockerImage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/26/AzureContainer.TensorflowDockerImage/" class="article-date">
  <time datetime="2017-07-26T08:41:00.000Z" itemprop="datePublished">2017-07-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Azure/">Azure</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/26/AzureContainer.TensorflowDockerImage/">Deploy Tensorflow Docker Image to Azure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Deploy Tensorflow Docker Image to Azure</h1>
<h2>참고사항</h2>
<p>똑같은 구성으로 <strong>AWS</strong>에 배포하는 글은 이전에 작성한게 있으니 참고하면 된다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/ecs.tensorflow.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to AWS ECS</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a></li>
</ul>
<p>이 작업을 시작하게 된 이유와 개념적인 구성에 대한 설명은 위 Link의 글들을 참고하길 바란다
즉 학습, 저장, 서비스 를 어떻게 동작시키는 것을 목적으로 하였는지에 대한 설명은 이 글에서는 생략하겠다.</p>
<p>Azure에 구성을 한 것은 이 글 포함 2개의 글이 있다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureContainer.TensorflowDockerImage.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to Azure</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureFunction.TensorflowPredict.md" target="_blank" rel="external">Using Tensorflow Predict on Azure Function</a></li>
</ul>
<h2>구성</h2>
<p>이 글에서 다룰 내용은 위 Link에서 구성한 시스템을 <strong>Microsoft Azure</strong>에 그대로 구현하는 것을 그 목적으로 하였다. 최대한 <strong>AWS</strong>용으로 작성한 코드들을 그대로 쓸려고 노력하였으나 플랫폼 특성상 바뀐점이 있다. 크게 바뀐건 <strong>AWS Lambda</strong>에는 <strong>Python</strong>으로 예측 코드를 작성하였는데,<strong>Azure Function</strong>은 <strong>C#</strong> 으로 작성하였다. 그 이유는 뒤에 따로 설명하겠다.</p>
<h3>사용한 Azure Service</h3>
<ul>
<li><a href="https://azure.microsoft.com/services/storage/files" target="_blank" rel="external">Azure File Storage</a> : 학습 데이터, 학습 결과를 저장</li>
<li><a href="https://azure.microsoft.com/services/container-registry" target="_blank" rel="external">Azure Container Registry</a> : 학습을 진행하는 Tensorflow Docker Image를 Upload할 공간</li>
<li><a href="https://azure.microsoft.com/services/container-service" target="_blank" rel="external">Azure Container Service</a> : Tensorflow Docker Image를 실행하는 환경</li>
<li><a href="https://azure.microsoft.com/services/functions" target="_blank" rel="external">Azure Function</a> : 예측 결과 제공 API</li>
</ul>
<h2>Tensorflow 학습 코드</h2>
<p>참고로 이 코드는 <a href="https://www.youtube.com/watch?v=BS6O0zOGX4E&amp;list=PLlMkM4tgfjnLSOjrEJN31gZATbcj_MpUm" target="_blank" rel="external">김성훈 교수님의 모두를 위한 딥러닝 강좌</a> 에서 소개된 코드를 이용하였다.</p>
<p>동물의 여러가지 특징들에 대해서 입력받아서 이 동물의 종류가 무엇인가에 대한 학습데이터이다.</p>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/zoo" target="_blank" rel="external">https://archive.ics.uci.edu/ml/machine-learning-databases/zoo</a> 에서 해당 데이터 내용에 대해서 확인이 가능하다.</p>
<p>여기에는 김성훈 교수님이 미리 만들어 놓은 <a href="https://github.com/hunkim/DeepLearningZeroToAll/blob/master/data-04-zoo.csv" target="_blank" rel="external">data-04-zoo.csv</a> 파일을 이용하겠다.</p>
<h2>Azure File Storage 생성</h2>
<p>Azure Portal(<a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>)로 진입한다.</p>
<ul>
<li>우측 상단 <code>+ New</code> 클릭
<ul>
<li><code>Storage &gt;</code> 선택
<ul>
<li><code>Storage Account blob, file, table, queue</code> 선택</li>
<li><img src="/images/azure.file.01.png" alt="">
<ul>
<li><code>Name</code>: storage 이름 입력 (ex. tensorflowstorage)</li>
<li><code>Replication</code> : 일단 테스트라 잴싼거 <code>LRS</code> 선택, 실제 서비스라면 접속 지역 분포에 맞게 적절하게 알맞은 것으로 선택</li>
<li><code>Resource Group</code> : 새로 만들던지 이미 있는것을 사용하던지 판단하여 입력</li>
<li><code>Location</code> : 기본적으로는 <code>East US</code>가 되어있는데, 해당 region과 비용도 같으면서 좀 더 가까운 <code>Japan West</code>로 선택했음</li>
<li><img src="/images/azure.file.02.png" alt=""></li>
<li><code>Pin to dashboard</code>를 선택하면 대쉬보드에 아이콘이 생성되어서 쉽게 진입이 가능하다.</li>
<li><code>Create</code>를 눌러서 생성 한 후 다 생성되기를 기다린다.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>생성이 끝나면 대쉬보드 화면에 아이콘이 하나 추가된다.</p>
<p><img src="/images/azure.file.03.png" alt=""></p>
<p>해당 아이콘을 눌러서 들어간다.</p>
<p><code>Overview</code> -&gt; <code>Files</code>을 눌러서 들어간 후 File Storage를 하나 생성한다.</p>
<p><img src="/images/azure.file.04.png" alt=""></p>
<ul>
<li><code>+File share</code> 를 선택
<ul>
<li>Name : 원하는 Share Name을 설정 (ex. tensorflow-savedata)</li>
<li>Quota : 테스트니깐 최소값 1GB로 설정</li>
</ul>
</li>
</ul>
<p><code>OK</code>를 클릭하면 바로 생성 된다.</p>
<p><img src="/images/azure.file.05.png" alt=""></p>
<p>생성된 Share 로 들어가서 일단 수동으로 파일을 1개 Upload 한다.</p>
<ul>
<li><code>data-04-zoo.csv</code>를 <strong>Azure File Storage</strong>에 업로드</li>
</ul>
<p>굳이 지금 할 필요는 없지만 생성한 <strong>Azure Storage</strong> 처음 화면으로 가서 <code>Account Name</code>, <code>Account Key</code>와 <code>ConnectionString</code>을 확인한다.
<strong>Docker</strong> 에서 실행할 Tensorflow 코드 및 <strong>Azure Function</strong>에서 수행할 예측 서비스 코드에서 필요하다.</p>
<p><img src="/images/azure.file.06.png" alt=""></p>
<h2>Azure Container Service 생성</h2>
<p><strong>Azure Cloud</strong>에서 <strong>Docker Image</strong>를 실행하기 위해서 필요한 서비스다.
실행할 환경으로 생성 한 후에 <strong>Azure Container Registry</strong>에 <strong>Docker Image</strong>를 업로드 한 후 그것을 실행할 용도로 사용된다.</p>
<p>Azure Portal(<a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>)로 진입한다.</p>
<ul>
<li>우측 상단 <code>+ New</code> 클릭
<ul>
<li><code>Containers &gt;</code> 선택
<ul>
<li><code>Azure Container Service</code> 선택</li>
<li><img src="/images/azure.cs.01.png" alt="">
<ul>
<li>
<ol>
<li>Basics</li>
</ol>
<ul>
<li><code>Name</code>: (ex. acs-tensorflow)</li>
<li><code>Resource Group</code> : 비어있는 Recource Group를 요구함. 기존에 생성해 놓은 Recource Group 중 빈 것이 없다면 새로 생성.</li>
<li><code>Location</code> : <code>Japan West</code>는 아직 지원하지 않는다. <code>East US</code>로 일단 생성</li>
<li><img src="/images/azure.cs.02.png" alt=""></li>
</ul>
</li>
<li>
<ol start="2">
<li>Master configuration</li>
</ol>
<ul>
<li><code>Ochestrator</code> : DC/OS, Kubernetes, Swarm 중 선택이 가능한데, 사실 각 특징에 대해서 잘 모른다. 그냥 <code>Swarm</code>으로 선택. (각 방식별 접속 방법이 조금씩 다름)</li>
<li><code>DNS name prefix</code> : 접속시 필요한 url에 추가되는 값이다. Portal에 url 확인이 가능하니 신경쓰지 않아도 된다.</li>
<li><code>User name</code> : 원하는 사용자명을 입력</li>
<li><code>SSH public key</code> : 오른쪽 <code>i</code> 아이콘을 누르면 Windows, Linux/Mac 에서 ssh 생성하는 방법이 나온다. 그대로 수행한 후 public key 값을 입력하면 된다.</li>
<li><img src="/images/azure.cs.03.png" alt=""></li>
</ul>
</li>
<li>
<ol start="3">
<li>Agent configuration</li>
</ol>
<ul>
<li>실행할 환경을 설정한다. 일단 테스트라 가장 싼것으로 찾아보려 했으나... ;;;</li>
<li><img src="/images/azure.cs.04.png" alt=""></li>
</ul>
</li>
<li>Summary 창을 보고 확인을 누르면 Dashboard에 생성된다. 시간이 좀 걸리니 기다려야 한다.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>Azure Container Registry 생성</h2>
<p>Azure Portal(<a href="https://portal.azure.com" target="_blank" rel="external">https://portal.azure.com</a>)로 진입한다.</p>
<ul>
<li>우측 상단 <code>+ New</code> 클릭
<ul>
<li><code>Containers &gt;</code> 선택
<ul>
<li><code>Azure Container Register</code> 선택
<ul>
<li><code>Registry name Name</code>: (ex. acrtensorflow)
<ul>
<li><code>Resource Group</code> : 이미 사용중인 Recource Group을 선택해도 됨.</li>
<li><code>Location</code> : <code>East US</code>로 일단 생성</li>
<li><img src="/images/azure.cr.01.png" alt=""></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>거의 바로 만들어 진다.</p>
<p>해당 메뉴로 들어가서 <code>Access keys</code>를 누른후  <code>Admin user</code>를 <code>Enable</code>로 선택하면 접속에 필요한 <strong>Username</strong>과 <strong>password</strong> 확인이 가능하다.</p>
<p><img src="/images/azure.cr.02.png" alt=""></p>
<p>일단 여기까지 진행한 후 Docker Image를 생성하는 단계로 넘어가겠다.</p>
<h2>Tensorflow 실행 코드 작성</h2>
<p>작업할 폴더를 하나 생성하여 그 안에 아래 작업들을 진행한다.</p>
<ul>
<li>코드를 실행할 위치에 <code>saver</code>라는 폴더 생성 (<code>mkdir saver</code>)</li>
</ul>
<h4>run.py</h4>
<p><strong>Python 3.6</strong>으로 작성되었으며 <code>Azure File Storage</code>에서 학습데이터를 다운받아서 <strong>Tensorflow</strong>로 학습 후 그 결과를 <strong>Tensorflow Saver File</strong>, <strong>JSON 파일</strong> 형식으로 <code>Azure File Storage</code>에 다시 업로드하는 작업을 수행하는 코드이다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> azure.storage.file <span class="keyword">import</span> FileService</div><div class="line"></div><div class="line">SAVER = <span class="string">"saver"</span></div><div class="line">SAVER_FOLDER = <span class="string">"./"</span> + SAVER</div><div class="line">TRAIN_DATA = <span class="string">"data-04-zoo.csv"</span></div><div class="line">RESULT_FILE = <span class="string">'result.json'</span></div><div class="line">FILE_SHARE = <span class="string">'tensorflow-savedata'</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    os.remove(SAVER_FOLDER + <span class="string">"/"</span> + file);</div><div class="line"></div><div class="line">file_service = FileService(account_name=<span class="string">'[NAME]'</span>, account_key=<span class="string">'[KEY]'</span>)</div><div class="line"></div><div class="line">file_service.get_file_to_path(FILE_SHARE, <span class="keyword">None</span>, TRAIN_DATA, TRAIN_DATA)</div><div class="line">file_service.create_directory(FILE_SHARE, SAVER);</div><div class="line"></div><div class="line">xy = np.loadtxt(TRAIN_DATA, delimiter=<span class="string">','</span>, dtype=np.float32)</div><div class="line">x_data = xy[:,<span class="number">0</span>:<span class="number">-1</span>]</div><div class="line">y_data = xy[:,[<span class="number">-1</span>]]</div><div class="line">nb_classes = <span class="number">7</span></div><div class="line"></div><div class="line">X = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">16</span>])</div><div class="line">Y = tf.placeholder(tf.int32, [<span class="keyword">None</span>, <span class="number">1</span>])</div><div class="line"></div><div class="line">Y_one_hot = tf.one_hot(Y, nb_classes)</div><div class="line">Y_one_hot = tf.reshape(Y_one_hot, [<span class="number">-1</span>, nb_classes])</div><div class="line"></div><div class="line">W = tf.Variable(tf.random_normal([<span class="number">16</span>, nb_classes]), name=<span class="string">'weight'</span>)</div><div class="line">b = tf.Variable(tf.random_normal([nb_classes]), name=<span class="string">'bias'</span>)</div><div class="line"></div><div class="line">logits = tf.matmul(X,W) + b</div><div class="line">hypothesis = tf.nn.softmax(logits)</div><div class="line">cost_i = tf.nn.softmax_cross_entropy_with_logits(logits=logits, labels=Y_one_hot)</div><div class="line">cost = tf.reduce_mean(cost_i)</div><div class="line">optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.1</span>).minimize(cost)</div><div class="line"></div><div class="line">prediction = tf.argmax(hypothesis, <span class="number">1</span>)</div><div class="line">correct_prediction = tf.equal(prediction, tf.argmax(Y_one_hot, <span class="number">1</span>))</div><div class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line"></div><div class="line">saver = tf.train.Saver()</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">    sess.run(tf.global_variables_initializer())</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">2001</span>):</div><div class="line">        sess.run(optimizer, feed_dict=&#123;X: x_data, Y: y_data&#125;)</div><div class="line">        <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</div><div class="line">            print(step, sess.run([cost, accuracy], feed_dict=&#123;X: x_data, Y: y_data&#125;))</div><div class="line"></div><div class="line">    saver.save(sess,<span class="string">"./saver/save.&#123;&#125;.ckpt"</span>.format(datetime.datetime.now().strftime(<span class="string">"%Y-%m-%d_%H%M%S"</span>)))</div><div class="line">    saver.save(sess,<span class="string">"./saver/save.last.ckpt"</span>)</div><div class="line"></div><div class="line">    pred = sess.run(prediction, feed_dict=&#123;X: x_data&#125;)</div><div class="line"></div><div class="line">    pw, pb = sess.run([W, b])</div><div class="line">    result = &#123;<span class="string">'W'</span>: pw.tolist(), <span class="string">'b'</span>: pb.tolist()&#125;</div><div class="line">    print(result)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> open(RESULT_FILE, <span class="string">'w'</span>) <span class="keyword">as</span> outfile:</div><div class="line">        json.dump(result, outfile)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> p, y <span class="keyword">in</span> zip(pred, y_data.flatten()):</div><div class="line">        print(<span class="string">"[&#123;&#125;] Prediction: &#123;&#125; True Y: &#123;&#125;"</span>.format(p == int(y), p, int(y)))</div><div class="line"></div><div class="line">file_service.create_file_from_path(FILE_SHARE, <span class="keyword">None</span>, RESULT_FILE, RESULT_FILE)</div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    print(file)</div><div class="line">    file_service.create_file_from_path(FILE_SHARE, <span class="string">"saver"</span>, file, SAVER_FOLDER + <span class="string">"/"</span> + file)</div><div class="line">``` </div><div class="line"></div><div class="line">PC에 tensorflow ,numpy, azure가 설치된 상태라면 바로 실행해볼수도 있다.</div></pre></td></tr></table></figure></p>
<p>pip install tensorflow numpy azure</p>
<p>python run.py
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## Docker 이미지 생성</div><div class="line"></div><div class="line">Docker 설치방법에 대해서는 따로 설명하지 않겠다.</div><div class="line"></div><div class="line">위에서 작업한 폴더에 `Dokerfile`을 생성한다.</div><div class="line"></div><div class="line">#### Dockerfile</div><div class="line">```Dockerfile</div><div class="line">FROM python:3</div><div class="line"></div><div class="line">RUN pip install tensorflow azure numpy</div><div class="line"></div><div class="line">WORKDIR /usr/src/app</div><div class="line"></div><div class="line">COPY . .</div><div class="line"></div><div class="line">CMD [ &quot;python&quot;, &quot;./run.py&quot; ]</div></pre></td></tr></table></figure></p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t tensorflow-azure .</div></pre></td></tr></table></figure></p>
<p>커맨드를 입력하면 Docker Image가 생성된다. 시간이 많이 걸리는 작업이니 미리 실행해 두고 다음단계로 진행하는 것을 추천한다.</p>
<h2>Azure Container Registry에 Docker Image 업로드</h2>
<p>생성해둔 <strong>Azure Container Registry</strong>에 들어가서 <code>Quick Start</code> 버튼을 누르면 업로드에 필요한 명령어 들이 나온다.</p>
<p><img src="/images/azure.cr.02.png" alt=""></p>
<ul>
<li>3번 항목의 Login을 수행한다.
<ul>
<li><code>docker login acrtensorflow.azurecr.io</code>
<ul>
<li><code>Access keys</code>에서 확인한 <strong>Username</strong>과 <strong>password</strong>로 접속</li>
</ul>
</li>
</ul>
</li>
<li>4번 항목을 참고하여 좀 전에 만들어 놓은 <strong>Docker Image</strong>를 <strong>Tag</strong> 하고 <strong>Push</strong> 하는 과정을 수행한다.
<ul>
<li><code>docker tag tensorflow-azure acrtensorflow.azurecr.io/tensorflow-azure</code></li>
<li><code>docker push acrtensorflow.azurecr.io/tensorflow-azure</code></li>
</ul>
</li>
</ul>
<p>이제 <strong>Docker Image</strong>가 <strong>Azure Container Registry</strong> 업로딩 되었다.</p>
<p>5번 항목에 있는 <strong>pull</strong> 명령어는 <strong>Docker Container Servie</strong>에 접속한 후 실행하면 된다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker pull acrtensorflow.azurecr.io/tensorflow-azure</div><div class="line"></div><div class="line">docker run acrtensorflow.azurecr.io/tensorflow-azure</div></pre></td></tr></table></figure></p>
<h2>Azure Container Service에서 Docker Image 실행</h2>
<p><a href="https://docs.microsoft.com/ko-kr/azure/container-service/container-service-connect" target="_blank" rel="external">https://docs.microsoft.com/ko-kr/azure/container-service/container-service-connect</a></p>
<p>위 Link를 참고해서 생성한 <strong>Azure Container Service</strong>의 설정에 맞게끔 접속하면 된다.</p>
<p>참고로 위에 설정한 값으로 접속을 하려면 아래 명령어로 접속이 가능하다. (ssh 파일 위치를 <code>~/.ssh</code> 에 생성했다고 가정)</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh -fNL 2375:localhost:2375 -p 2200 sj@acsmgmt.eastus.cloudapp.azure.com -i ~/.ssh/sj</div><div class="line"></div><div class="line">export DOCKER_HOST=:2375</div></pre></td></tr></table></figure></p>
<p>이제 <code>docker images</code>를 입력하면 내 PC 의 목록이 아닌 <strong>Azure Container Service</strong> 상에서의 목록이 출력된다.</p>
<p>아직 한번도 <strong>Azure Container Service</strong>에서 <strong>Docker Image</strong>를 가져오지 않았다면 일단 로그인하여서 가져와야 한다.</p>
<ul>
<li><code>docker login acrtensorflow.azurecr.io</code>
<ul>
<li><code>Access keys</code>에서 확인한 <strong>Username</strong>과 <strong>password</strong>로 접속</li>
</ul>
</li>
<li><code>docker pull acrtensorflow.azurecr.io/tensorflow-azure</code></li>
</ul>
<p>이제 실행을 해보자.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run acrtensorflow.azurecr.io/tensorflow-azure</div></pre></td></tr></table></figure></p>
<p>이제 내 PC가 아니라 <strong>Azure Cloud</strong> 상에서 실행이 되는 것이다.</p>
<p>실행 후 <strong>Azure File Storage</strong> 에 파일들이 정상적으로 생성되었는지 확인해보면 된다.</p>
<h3>다음글 : Azure Function으로 예측 서비스 제공하기</h3>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/Azure/AzureFunction.TensorflowPredict.md" target="_blank" rel="external">Using Tensorflow Predict on Azure Function</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/26/AzureContainer.TensorflowDockerImage/" data-id="cjov1wtng001zjw7be9i654o0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureContainerRegistry/">AzureContainerRegistry</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureContainerService/">AzureContainerService</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AzureFileStorage/">AzureFileStorage</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-lambda.tensorflow" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/18/lambda.tensorflow/" class="article-date">
  <time datetime="2017-07-18T07:37:00.000Z" itemprop="datePublished">2017-07-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/18/lambda.tensorflow/">Using Tensorflow Predict on AWS Lambda Function</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Using Tensorflow Predict on AWS Lambda Function</h1>
<h2>왜 이런 생각을 ???</h2>
<p>앞서 <strong>AWS ECS</strong>에서 <strong>Tensorflow</strong>를 이용하여 학습을 진행하여 그 결과를 <strong>S3</strong>에 저장하는 방법에 대해서 글을 적었다.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/ecs.tensorflow.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to AWS ECS</a></p>
<p>학습 결과를 <strong>S3</strong>에 남긴 이유는 크게 2가지였다.</p>
<ul>
<li>하나는 다음에 학습을 진행할때 해당 값을 이용하여 계속해서 학습을 진행 할 경우를 대비하자는 것이고,</li>
<li>다른 하나는 학습 결과 데이터를 이용해서 예측하는 서비스를 제공하는데 사용하려는 목적이다.</li>
</ul>
<h2>Lambda에 Tensorflow 배포 ?</h2>
<p><strong>Tensorflow</strong>를 <strong>AWS Lambda</strong>에서 서비스 가능할까 ? 결론부터 말하자면 안된다.</p>
<ul>
<li>맥북에서 <strong>Tensorflow</strong>용 예제 코드를 하나 작성 한 뒤 해당 폴더를 압축하니 용량이 <em>43 MB</em> 정도 되었다.</li>
</ul>
<p><img src="/images/tensorflow.deploy.png" alt=""></p>
<p>하지만 Lambda에 올려서 실행을 하니 matrix 연산에 사용하는 함수에서 오류가 발생한다. 내부적으로 사용하는 <strong>numpy</strong> 모듈이 해당 OS에서만 동작하도록 배포되는것 같다.</p>
<p>그래서 Docker Image에 <strong>Tensorflow</strong>를 설치해서 압축도 해보고 <strong>EC2</strong>를 Linux용으로 하나 생성하여서 그곳에 Python 3.6을 설치하고 예제코드를 작성한 뒤 해당 폴더를 압축해봤는데 두 경우 모두 용량이 <em>61 MB</em> 가 넘었다.</p>
<p><img src="/images/tensorflow.linux.deploy.png" alt=""></p>
<p><strong>AWS Lambda</strong>의 경우 코드를 <em>50 MB</em> 이하로만 대포가 가능하다.</p>
<p>결국 안된다는 말이다.</p>
<p>페이스북 친구분들의 답변을 보니 <strong>Theano Backend</strong> 나 <strong>MXNet</strong> 등은 <strong>Lambda</strong>에서 서비스가 가능하다는 답변이 있다.</p>
<p><img src="/images/lambda.ml.png" alt=""></p>
<p>하지만 이번 포스팅의 목적은 <code>Tensorflow로 학습된 결과를 어떻게 Lambda를 이용해서 가볍게 서비스 할 것인가</code> 이다.</p>
<p>물론 ECS나 EC2를 이용해서 정적 서버로 Tensorflow를 서비스하는건 가능하다. 너무나도 쉽게 가능하다.</p>
<h2>안된다면서 어떻게 ???</h2>
<p>일단 <strong>Lambda</strong>에서 <strong>Tensorflow</strong>를 배포할 수가 없다.
하지만 이미 <strong>Tensorflow</strong>를 이용해서 학습을 하는 시스템을 구축해 둔 상황이다.</p>
<p><strong>Tensorflow</strong>의 학습 원리를 잘 생각해보자. <strong>Tensorflow</strong>에 대해서가 아니라 일반적인 <strong>Machine Learning</strong> 관련 학습을 해보신 분들은 관련 수식들에 대해서 본적이 있을 것이다.</p>
<ul>
<li>입력값 출력값의 개수에 따라서 <strong>Matrix 연산</strong></li>
<li><code>Classify</code>의 경우에는 <strong>sigmoid</strong>, <strong>softmax</strong> 등의 수식이 필요</li>
<li><code>Deep Learning</code>의 경우 위 2가지 수식을 계속해서 반복하면 됨</li>
</ul>
<p>위에 나열된 정도의 수식만 구현하면 예측이 가능하다.</p>
<p><strong>Optimize Algorithm</strong> 이라던지, <strong>Cost</strong> 계산, <strong>Gradient Descent</strong>와 같이 미분 연산이 들어가는 복잡한 것은 예측할때는 필요가 없으며, 학습할때 필요한 연산들이다.</p>
<p>어차피 예측하는 것만 서비스로 제공할꺼라 관련 수식을 구현하는건 그리 어렵지 않다.</p>
<p><code>밑바닥부터 시작하는...</code>이라는 책들에 관련 수식들이 다 나와 있으며, 김성훈 교수님 동영상에도 나온다.</p>
<p>일단 여기서 사용하기위한 연산에 대해서는 내가 작성해 놓은 코드도 있다.</p>
<p><a href="https://github.com/DevStarSJ/functional.py/blob/master/linear.py" target="_blank" rel="external">https://github.com/DevStarSJ/functional.py/blob/master/linear.py</a></p>
<p>이걸 이용하면 아주 가벼운 코드로도 예측해주는 서비스 제공이 가능하다.</p>
<h2>Docker Image 수정</h2>
<p>기존에 배포한 <strong>Docker Image</strong> 는 <strong>Tensorflow</strong> 학습 결과 파일을 그대로 <strong>S3</strong>에 저장한다. 예측 서비스를 제공할 <strong>Lambda</strong>에는 <strong>Tensorflow</strong>가 없으므로 해당 파일의 데이터를 활용하지 못한다. 그렇다면 학습 결과를 일반적인 형태(<strong>JSON</strong>이라던지... 아니면 <strong>JSON</strong>이라던지... 하이튼 <strong>JSON</strong>이라던지 !)로  <strong>S3</strong> 에 저장해주는 것으로 코드를 수정하자.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/ecs.tensorflow.md" target="_blank" rel="external">Deploy Tensorflow Docker Image to AWS ECS</a></p>
<p>배포 과정은 위 포스팅에 다 정리해 두었다.</p>
<h4>run.py (Docker Image)</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> boto3</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">SAVER_FOLDER = <span class="string">"./saver"</span></div><div class="line">BUCKET = <span class="string">'BUCKET NAME'</span></div><div class="line">TRAIN_DATA = <span class="string">"data-04-zoo.csv"</span></div><div class="line">RESULT_FILE = <span class="string">'result.json'</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    os.remove(SAVER_FOLDER + <span class="string">"/"</span> + file);</div><div class="line"></div><div class="line">s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">s3_client.download_file(BUCKET, TRAIN_DATA, TRAIN_DATA)</div><div class="line"></div><div class="line">xy = np.loadtxt(TRAIN_DATA, delimiter=<span class="string">','</span>, dtype=np.float32)</div><div class="line">x_data = xy[:,<span class="number">0</span>:<span class="number">-1</span>]</div><div class="line">y_data = xy[:,[<span class="number">-1</span>]]</div><div class="line">nb_classes = <span class="number">7</span></div><div class="line"></div><div class="line">X = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">16</span>])</div><div class="line">Y = tf.placeholder(tf.int32, [<span class="keyword">None</span>, <span class="number">1</span>])</div><div class="line"></div><div class="line">Y_one_hot = tf.one_hot(Y, nb_classes)</div><div class="line">Y_one_hot = tf.reshape(Y_one_hot, [<span class="number">-1</span>, nb_classes])</div><div class="line"></div><div class="line">W = tf.Variable(tf.random_normal([<span class="number">16</span>, nb_classes]), name=<span class="string">'weight'</span>)</div><div class="line">b = tf.Variable(tf.random_normal([nb_classes]), name=<span class="string">'bias'</span>)</div><div class="line"></div><div class="line">logits = tf.matmul(X,W) + b</div><div class="line">hypothesis = tf.nn.softmax(logits)</div><div class="line">cost_i = tf.nn.softmax_cross_entropy_with_logits(logits=logits, labels=Y_one_hot)</div><div class="line">cost = tf.reduce_mean(cost_i)</div><div class="line">optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.1</span>).minimize(cost)</div><div class="line"></div><div class="line"></div><div class="line">prediction = tf.argmax(hypothesis, <span class="number">1</span>)</div><div class="line">correct_prediction = tf.equal(prediction, tf.argmax(Y_one_hot, <span class="number">1</span>))</div><div class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line"></div><div class="line">saver = tf.train.Saver()</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">    sess.run(tf.global_variables_initializer())</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">2001</span>):</div><div class="line">        sess.run(optimizer, feed_dict=&#123;X: x_data, Y: y_data&#125;)</div><div class="line">        <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</div><div class="line">            print(step, sess.run([cost, accuracy], feed_dict=&#123;X: x_data, Y: y_data&#125;))</div><div class="line"></div><div class="line">    saver.save(sess,<span class="string">"./saver/save.&#123;&#125;.ckpt"</span>.format(datetime.datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)))</div><div class="line">    saver.save(sess,<span class="string">"./saver/save.last.ckpt"</span>)</div><div class="line"></div><div class="line">    pred = sess.run(prediction, feed_dict=&#123;X: x_data&#125;)</div><div class="line"></div><div class="line">    pw, pb = sess.run([W, b])</div><div class="line">    result = &#123;<span class="string">'W'</span>: pw.tolist(), <span class="string">'b'</span>: pb.tolist()&#125;</div><div class="line">    print(result)</div><div class="line"></div><div class="line">    <span class="keyword">with</span> open(RESULT_FILE, <span class="string">'w'</span>) <span class="keyword">as</span> outfile:</div><div class="line">        json.dump(result, outfile)</div><div class="line"></div><div class="line">s3_client.upload_file(RESULT_FILE, <span class="string">'dev-tensorflow-savedata'</span>, RESULT_FILE)</div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    print(file)</div><div class="line">    s3_client.upload_file(SAVER_FOLDER + <span class="string">"/"</span> + file, <span class="string">'dev-tensorflow-savedata'</span>, file)</div></pre></td></tr></table></figure></p>
<p><code>run.py</code> 파일을 위와 같이 수정한 뒤 Repository에 push만 새로 해주면 된다.
그럼 해당 Docker Image가 다음부터 실행될 때 새로 바뀐 이미지로 실행된다.</p>
<h2>Lambda Function 작성</h2>
<p>아래 코드로 작성 후 Lambda에 배포한다.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> boto3</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="keyword">import</span> functional <span class="keyword">as</span> F</div><div class="line"><span class="keyword">import</span> linear <span class="keyword">as</span> L</div><div class="line"></div><div class="line">BUCKET_NAME = <span class="string">'BUCKET NAME'</span></div><div class="line">KEY = <span class="string">'result.json'</span></div><div class="line">RESULT_FILE = <span class="string">'/tmp/'</span> + KEY</div><div class="line">S3 = boto3.resource(<span class="string">'s3'</span>)</div><div class="line"></div><div class="line">DEBUG = <span class="keyword">True</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_print</span><span class="params">(obj)</span>:</span></div><div class="line">    <span class="keyword">if</span> DEBUG:</div><div class="line">        print(obj)</div><div class="line">    </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_predict_data</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        S3.Bucket(BUCKET_NAME).download_file(KEY, RESULT_FILE)</div><div class="line">        <span class="keyword">with</span> open(RESULT_FILE) <span class="keyword">as</span> data_file:    </div><div class="line">            <span class="keyword">return</span> json.load(data_file)</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        print(sys.exc_info()[<span class="number">0</span>])</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_x</span><span class="params">(event)</span>:</span></div><div class="line">    get_querystring= F.curryr(F.get)(<span class="string">'queryStringParameters'</span>)</div><div class="line">    get_X = F.curryr(F.get)(<span class="string">'X'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> F.go(event, </div><div class="line">        get_querystring, </div><div class="line">        get_X,</div><div class="line">        <span class="keyword">lambda</span> x: json.loads(x),</div><div class="line">        <span class="keyword">lambda</span> x: [x])</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    debug_print(event)</div><div class="line"></div><div class="line">    predict_data = get_predict_data()</div><div class="line">    debug_print(predict_data)</div><div class="line">    <span class="keyword">if</span> predict_data <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">return</span> &#123;<span class="string">'statusCode'</span>: <span class="number">500</span>&#125;</div><div class="line"></div><div class="line">    X = get_x(event)</div><div class="line">    <span class="keyword">if</span> X <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">return</span> &#123;<span class="string">'statusCode'</span>: <span class="number">404</span>&#125;</div><div class="line"></div><div class="line">    W = predict_data[<span class="string">'W'</span>]</div><div class="line">    b = predict_data[<span class="string">'b'</span>]</div><div class="line"></div><div class="line">    H = L.matadd(L.matmul(X,W)[<span class="number">0</span>],b)</div><div class="line">    S = [L.sigmoid(x) <span class="keyword">for</span> x <span class="keyword">in</span> H]</div><div class="line">    M = L.softmax(S)</div><div class="line">    answer = L.argmax(M)</div><div class="line"></div><div class="line">    debug_print([answer, M])</div><div class="line">    debug_print(sum(M))</div><div class="line"></div><div class="line">    body = &#123; <span class="string">'answer'</span>: answer, <span class="string">'rating'</span>: M &#125;</div><div class="line"></div><div class="line">    response = &#123;</div><div class="line">        <span class="string">'statusCode'</span>: <span class="number">200</span>,</div><div class="line">        <span class="string">'body'</span>: json.dumps(body)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> response</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    event = &#123;<span class="string">"queryStringParameters"</span>: &#123;<span class="string">"X"</span>: <span class="string">"[0,0,1,0,0,1,1,1,1,0,0,1,0,1,0,0]"</span>&#125;&#125;</div><div class="line">    print(handler(event,<span class="keyword">None</span>))</div></pre></td></tr></table></figure></p>
<p><code>function.py</code>, <code>linear.py</code> 파일은 <a href="https://github.com/DevStarSJ/functional.py" target="_blank" rel="external">https://github.com/DevStarSJ/functional.py</a>에서 다운로드가 가능핟. 3개의 파일을 압축하여 <code>Lambda Function</code>으로 배포 후 <code>API Gateway</code>에 연결하면 해당 url을 API로 호출하는것 만으로 서비스 제공이 가능해진다.</p>
<p><code>https://(API Gateway URL)?X=[0,0,0,0,0,1,1,1,1,0,1,1,1,1,1,0]</code></p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"answer"</span>: <span class="number">2</span>,</div><div class="line">     <span class="attr">"rating"</span>: [<span class="number">0.19675508709346667</span>, <span class="number">0.08691888941180405</span>, <span class="number">0.20361211198193085</span>,</div><div class="line">                <span class="number">0.16208064446318374</span>, <span class="number">0.12462949929899679</span>, <span class="number">0.07610383897536456</span>, </div><div class="line">                <span class="number">0.14989992877525316</span></div><div class="line">               ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Lambda</strong> 및 <strong>API Gateway</strong> 배포에 대해서는 예전에 포스팅 한 글들을 참조 바란다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
</ul>
<h2>Tensorflow 학습 코드</h2>
<p>참고로 이 코드는 <a href="https://www.youtube.com/watch?v=BS6O0zOGX4E&amp;list=PLlMkM4tgfjnLSOjrEJN31gZATbcj_MpUm" target="_blank" rel="external">김성훈 교수님의 모두를 위한 딥러닝 강좌</a> 에서 소개된 코드를 이용하였다.</p>
<p>동물의 여러가지 특징들에 대해서 입력받아서 이 동물의 종류가 무엇인가에 대한 학습데이터이다.</p>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/zoo" target="_blank" rel="external">https://archive.ics.uci.edu/ml/machine-learning-databases/zoo</a> 에서 해당 데이터 내용에 대해서 확인이 가능하다.</p>
<p>여기에는 김성훈 교수님이 미리 만들어 놓은 <a href="https://github.com/hunkim/DeepLearningZeroToAll/blob/master/data-04-zoo.csv" target="_blank" rel="external">data-04-zoo.csv</a> 파일을 이용하겠다.</p>
<ul>
<li><code>data-04-zoo.csv</code>를 S3에 업로드</li>
<li>코드를 실행할 위치에 <code>saver</code>라는 폴더 생성 (<code>mkdir saver</code>)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/18/lambda.tensorflow/" data-id="cjov1wtrm009vjw7b69b5z0l9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/S3/">S3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ecs.tensorflow" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/14/ecs.tensorflow/" class="article-date">
  <time datetime="2017-07-13T23:00:00.000Z" itemprop="datePublished">2017-07-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/ECS/">ECS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/14/ecs.tensorflow/">Deploy Tensorflow Docker Image to AWS ECS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Deploy Tensorflow Docker Image to AWS ECS</h1>
<h2>왜 이런 생각을 ???</h2>
<p>Tensorflow 를 이용해서 학습시키는 것에 대한 예제코드는 많이 봐왔지만, 이렇게 학습시켜서 어떻게 서비스를 해야 할까에 대한 의문이 계속 생겼다. 아마 대량의 데이터를 학습해서 그 결과를 데이터베이스 같은데 넣어두고 그것을 읽어서 사용하는게 가장 대표적인 시나리오라 생각된다. 하지만, 그 경우가 아니라 실시간으로 서비스 하려면 어떻게 해야할까란 고민이 들었다. 거기에 관련된 특성들을 생각나는데로 정리해 보자면 다음과 같다.</p>
<ul>
<li>학습 하는데는 긴 시간이 필요로 한다. 언제 끝날지 모른다.</li>
<li>이미 학습된 결과를 가지고 예측만 하는것은 아주 짧은 시간에 가능하다. 실시간 서비스로도 가능한 속도이다.</li>
<li>서비스 제공 중에 새로운 학습 데이터가 생길 경우 서비스를 제공함과 동시에 학습도 이루어 져야 한다.</li>
<li>새로운 데이터로 학습을 하면서 그 결과를 항상 서비스 쪽에서 접근 가능하게 유지한다면 항상 최신 데이터로 서비스가 가능하다.</li>
</ul>
<p>새로 학습을 했으면 그 결과가 올바른지 검증이 필요하다고 생각할 수도 있다. 잘못된 정보를 제공하는건 위험한 일이니깐, 물론 맞는 생각이다. 하지만 지금은 그런 비지니스 적인건 생각하지 않고 일단 어떻게 시스템을 구축하는게 좋은가에 대해서만 고민하도록 하겠다.</p>
<h2>그럼 어떻게 구성을 ???</h2>
<p>크게 3가지 시스템을 생각해야 한다.</p>
<ul>
<li>학습</li>
<li>저장</li>
<li>서비스</li>
</ul>
<h3>학습</h3>
<p>학습의 경우 내 노트북이나 PC에서 돌려도 된다. 아니면 사내에 있는 별도의 ML전용 머신이 있으면 거기서 하면 좋다. 하지만 학습이 장시간에 걸쳐 이루어지는 경우도 생각해서 Cloud에서 실행하는 것을 생각해보자. AWS의 경우라면 EC2를 가장 쉽게 떠올릴 것이다. EC2에서 Tensorflow를 동작시키는 것은 너무나도 쉽고 관련 자료도 검색해보면 많이 나온다. 그래서 그 방법은 사용하지 않겠다. ECS (EC2 Container Service)를 이용해서 Dokcer Image로 만들어서 실행시키는 방법으로 진행해 보겠다. 학습이라는게 컴퓨팅 파워가 중요하다는 측면에서는 Docker Image로 실행하는게 안맞다는 생각도 들지만, 일정 시간마다 주기적으로 Task 실행이 가능하고, 학습을 하지 않아도 되는 시간에는 다른 서비스 이미지들을 Docker로 생성해서 돌릴 수도 있고 배포도 훨씬 편리해서 일단 Docker Image로 배포하는 것으로 방향을 잡았다.</p>
<h3>저장</h3>
<p>저장은 당연힌 S3에 저장을 하는게 가장 효과적이다. 학습 데이터 및 학습된 결과 데이터를 저장하는 하고 학습 결과에 대해서는 그 당시의 결과와 최신 데이터 이름은 고정으로 따로 저장해서 서비스 하는 곳에서는 항상 최신 데이터만을 가져와서 결과를 예측하는 식으로 구상이 가능하다.
만약 특정 시간마다 학습을 시키는 식으로 시스템을 구축한다면 S3에 학습데이터만 넣어주는 식으로 운영이 가능하며, 아니면 S3에 특정 파일을 저장할때마다 트리거를 이용해서 ECS를 실행하게끔 구성을 하면 될 것이다. 만약 트리거에서 바로 ECS 실행이 안된다면 중간에 Lambda를 이용해서 실행하게끔 구성을 하면 된다.</p>
<h3>서비스</h3>
<p>서비스는 EC2나 ECS를 이용한 정적 서버보다는 Lambda를 이용해서 Serverless 구조로 가는 것으로 선택했다. 학습된 데이터를 보고 예측을 하는것은 비교적 간단한 작업이라고 판단했으며, 비용적인 측면이나 관리적인 측면에서 Lambda로 결정했다.</p>
<p>하지만 여기에 조금의 문제가 있는데, 거기에 대해서는 따로 포스팅으로 다루기로 하겠다.</p>
<p>참고로 이번 포스팅에서 서비스 코드 및 방법에 대해서는 다루지 않고 S3와 ECS를 연동하여 학습데이터 및 학습결과를 이용하는 Docker Image를 배포하는 것까지만 다룬다.</p>
<p>서비스 코드에 대해서는 별도로 포스팅 할 예정이다.</p>
<h2>작업전 가정할 상황들</h2>
<ul>
<li>Python 3.6 버전이 개발PC에 설치되어 있다.</li>
<li>Docker가 설치되어 있다.</li>
<li><code>AWS CLI</code>가 설치되어 있다.</li>
<li>배포할 AWS 계정정보에 대해서는 <code>~/.aws/credentials</code>에 <code>[default]</code>로 설정되어 있다. 만약 <code>[default]</code>가 아니라면 명령어에 <code>--profile 프로필명</code> 을 추가로 적어준다는 사실은 알고 있다.</li>
<li><code>S3</code>에 학습데이터 및 그 결과를 저장할 Bucket을 생성해 놓았다.</li>
</ul>
<h2>Tensorflow 학습 코드</h2>
<p>참고로 이 코드는 <a href="https://www.youtube.com/watch?v=BS6O0zOGX4E&amp;list=PLlMkM4tgfjnLSOjrEJN31gZATbcj_MpUm" target="_blank" rel="external">김성훈 교수님의 모두를 위한 딥러닝 강좌</a> 에서 소개된 코드를 이용하였다.</p>
<p>동물의 여러가지 특징들에 대해서 입력받아서 이 동물의 종류가 무엇인가에 대한 학습데이터이다.</p>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/zoo" target="_blank" rel="external">https://archive.ics.uci.edu/ml/machine-learning-databases/zoo</a> 에서 해당 데이터 내용에 대해서 확인이 가능하다.</p>
<p>여기에는 김성훈 교수님이 미리 만들어 놓은 <a href="https://github.com/hunkim/DeepLearningZeroToAll/blob/master/data-04-zoo.csv" target="_blank" rel="external">data-04-zoo.csv</a> 파일을 이용하겠다.</p>
<ul>
<li><code>data-04-zoo.csv</code>를 S3에 업로드</li>
<li>코드를 실행할 위치에 <code>saver</code>라는 폴더 생성 (<code>mkdir saver</code>)</li>
</ul>
<h4>run.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> boto3</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line">SAVER_FOLDER = <span class="string">"./saver"</span></div><div class="line">BUCKET = <span class="string">'S3버킷명칭'</span></div><div class="line">TRAIN_DATA = <span class="string">"data-04-zoo.csv"</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    os.remove(SAVER_FOLDER + <span class="string">"/"</span> + file);</div><div class="line"></div><div class="line">s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">s3_client.download_file(BUCKET, TRAIN_DATA, TRAIN_DATA)</div><div class="line"></div><div class="line">xy = np.loadtxt(TRAIN_DATA, delimiter=<span class="string">','</span>, dtype=np.float32)</div><div class="line">x_data = xy[:,<span class="number">0</span>:<span class="number">-1</span>]</div><div class="line">y_data = xy[:,[<span class="number">-1</span>]]</div><div class="line">nb_classes = <span class="number">7</span></div><div class="line"></div><div class="line">X = tf.placeholder(tf.float32, [<span class="keyword">None</span>, <span class="number">16</span>])</div><div class="line">Y = tf.placeholder(tf.int32, [<span class="keyword">None</span>, <span class="number">1</span>])</div><div class="line"></div><div class="line">Y_one_hot = tf.one_hot(Y, nb_classes)</div><div class="line">Y_one_hot = tf.reshape(Y_one_hot, [<span class="number">-1</span>, nb_classes])</div><div class="line"></div><div class="line">W = tf.Variable(tf.random_normal([<span class="number">16</span>, nb_classes]), name=<span class="string">'weight'</span>)</div><div class="line">b = tf.Variable(tf.random_normal([nb_classes]), name=<span class="string">'bias'</span>)</div><div class="line"></div><div class="line">logits = tf.matmul(X,W) + b</div><div class="line">hypothesis = tf.nn.softmax(logits)</div><div class="line">cost_i = tf.nn.softmax_cross_entropy_with_logits(logits=logits, labels=Y_one_hot)</div><div class="line">cost = tf.reduce_mean(cost_i)</div><div class="line">optimizer = tf.train.GradientDescentOptimizer(learning_rate=<span class="number">0.1</span>).minimize(cost)</div><div class="line"></div><div class="line"></div><div class="line">prediction = tf.argmax(hypothesis, <span class="number">1</span>)</div><div class="line">correct_prediction = tf.equal(prediction, tf.argmax(Y_one_hot, <span class="number">1</span>))</div><div class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div><div class="line"></div><div class="line">saver = tf.train.Saver()</div><div class="line"></div><div class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</div><div class="line">    sess.run(tf.global_variables_initializer())</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">2001</span>):</div><div class="line">        sess.run(optimizer, feed_dict=&#123;X: x_data, Y: y_data&#125;)</div><div class="line">        <span class="keyword">if</span> step % <span class="number">100</span> == <span class="number">0</span>:</div><div class="line">            print(step, sess.run([cost, accuracy], feed_dict=&#123;X: x_data, Y: y_data&#125;))</div><div class="line"></div><div class="line">    saver.save(sess,<span class="string">"./saver/save.&#123;&#125;.ckpt"</span>.format(datetime.datetime.now().strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>)))</div><div class="line">    saver.save(sess,<span class="string">"./saver/save.last.ckpt"</span>)</div><div class="line"></div><div class="line">    pred = sess.run(prediction, feed_dict=&#123;X: x_data&#125;)</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> p, y <span class="keyword">in</span> zip(pred, y_data.flatten()):</div><div class="line">        print(<span class="string">"[&#123;&#125;] Prediction: &#123;&#125; True Y: &#123;&#125;"</span>.format(p == int(y), p, int(y)))</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#s3_client = boto3.client('s3')</span></div><div class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(SAVER_FOLDER):</div><div class="line">    print(file)</div><div class="line">    s3_client.upload_file(SAVER_FOLDER + <span class="string">"/"</span> + file, <span class="string">'dev-tensorflow-savedata'</span>, file)</div><div class="line">``` </div><div class="line"></div><div class="line">PC에 tensorflow ,numpy, boto3가 설치된 상태라면 바로 실행해볼수도 있다.</div></pre></td></tr></table></figure></p>
<p>pip install tensorflow numpy boto3</p>
<p>python run.py
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## Docker 이미지 생성</div><div class="line"></div><div class="line">Dokerfile을 생성한다.</div><div class="line"></div><div class="line">#### Dockerfile</div><div class="line">```Dockerfile</div><div class="line">FROM python:3</div><div class="line"></div><div class="line">RUN pip install tensorflow boto3 numpy</div><div class="line"></div><div class="line">WORKDIR /usr/src/app</div><div class="line"></div><div class="line">COPY . .</div><div class="line"></div><div class="line">CMD [ &quot;python&quot;, &quot;./run.py&quot; ]</div></pre></td></tr></table></figure></p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t tensorflow-test .</div></pre></td></tr></table></figure></p>
<p>커맨드를 입력하면 Docker Image가 생성된다. 시간이 많이 걸리는 작업이니 미리 실행해 두고 다음단계로 진행하는 것을 추천한다.</p>
<h2>EC2 Container Service 설정</h2>
<p>Docker Image를 서비스해주는 AWS 기능이다. EC2 인스턴스를 띄워놓은 상태에서 ECS에 정의한 Docker Image를 수행시 EC2를 할당받아서 수행한다. 하나의 EC2에서 동시에 여러개의 Docker Image 실행이 가능하기때문에 자원을 더 효율적으로 사용할 수 있다.</p>
<p>ECS 설정에 대해서는 자세한 설명은 생략하고 작업 위주로만 순서대로 나열하겠다.</p>
<ul>
<li>웹에서 AWS ECS 콘솔로 접근
<ul>
<li>Clusters 탭 선택
<ul>
<li><img src="/images/ecs.tensorflow.01.png" alt=""></li>
<li>Create Cluster 버튼 클릭
<ul>
<li>Cluster name : <code>test-ecs-cluster</code></li>
<li>EC2 instance type : t2.micro (가장 저렴한 인스턴스이다. 일단 테스트니깐 가장 저렴한걸로 구축하자.)</li>
<li>Networking : VPC, Subnets, Security group 설정 (먼저 설정된게 있으면 그것을 사용하면 되고 아니면 새로 생성)</li>
<li>Container Instance IAM role : S3, CloudWatch 등에 접근이 가능한 Role을 선택 or 생성 (Role 에 AmazonS3FullAccess Policy를 Attach)</li>
<li>Create 버튼 클릭</li>
</ul>
</li>
</ul>
</li>
<li>Repositories 탭 선택
<ul>
<li>Create repository 버튼 클릭
<ul>
<li>Repository name : <code>tensorflow-test</code></li>
<li>Next Step 클릭</li>
<li><code>Build, tag, and push Docker image 의 설명이 나옴</code>
<ul>
<li>AWS CLI 필요가 이미 설치되어 있어야 한다. 터미널 창을 연다.</li>
<li>해당 PC에 AWS 계정이 여러개라면  <code>aws configure</code>를 이용해서 <code>[default]</code> 를 재정의 하던지 <code>aws</code> 명령어에 <code>--profile 프로필명</code>을 뒤에 붙여주어야 한다.</li>
<li>맥이라면 1, Windows라면 2 에 적힌 커맨드를 입력 : ex 맥일 경우 <code>aws ecr get-login --no-include-email --region ap-northeast-1</code>
<ul>
<li>만약 오류가 나면 AWS CLI를 업데이트 해야함</li>
</ul>
</li>
<li>입력후 나온 커맨드를 복사후 실행 (로그인 스크립트)</li>
</ul>
</li>
<li>3번에 적힌 문장 실행 : 도커 빌드 <code>docker build -t tensorflow-test .</code> (하지만 앞에서 미리 실행해 놓았다면 안해도 됨)</li>
<li>위까지 다 성공했으면 4번, 5번을 차례대로 실행 : 태깅하고 Repository에 Push하는 기능이다.</li>
</ul>
</li>
</ul>
</li>
<li>Task Definitions 탭 선택
<ul>
<li>Create new task definition 클릭
<ul>
<li>Task Definition Name : <code>ts-test</code></li>
<li>Task Role : 선택하거나 생성 (Role 에 AmazonS3FullAccess Policy를 Attach)</li>
<li>Add container 클릭
<ul>
<li>Container name : <code>ts-test-container</code></li>
<li>Image : Repository 탭에서 <code>tensorflow-test</code>를 선택하여 <code>Repository URI</code>에 적힌 값을 입력</li>
<li>Memory Limits 설정 : ex) 128</li>
<li>CPU units 설정 : EC2 CPU 1개당 1024 개의 unit 이 생성됨. 할당한 숫자에 비례하여 실행됨</li>
<li>로그를 남기고 싶다면 Log configuration 을 설정해야 한다.
<ul>
<li>Log configuration : <code>awslogs</code>
<ul>
<li>awslogs-group : <code>/aws/ecs/ts-test</code></li>
<li>awslogs-region : 각자 입력 (ex. ap-northeast-1)</li>
</ul>
</li>
</ul>
</li>
<li>Add 클릭</li>
</ul>
</li>
<li>Create 클릭</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>로그를 남기기로 설정했다면 아래와 같이 CloudWatch에 로그를 만들어야 한다.</p>
<ul>
<li>CloudWatch 콘솔로 접근
<ul>
<li>Logs 선택
<ul>
<li>Action -&gt; Create Log Group
<ul>
<li>Name : /aws/ecs/ts-test</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>실행 방법이 여러가지가 있는데 일단 간단하게 콘솔에서 실행해 보겠다.</p>
<ul>
<li>Cluster 선택
<ul>
<li><code>test-ecs-cluster</code> 선택
<ul>
<li>Tasks 탭
<ul>
<li>Run new Task 클릭
<ul>
<li>ts-test 선택</li>
<li>Run Task 버튼 클릭</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>작업이 정상적으로 수행완료가 되었다면 S3에 학습결과가 있는지 확인을 하면 된다.</p>
<p><img src="/images/ecs.tensorflow.04.png" alt=""></p>
<p>CloudWatch에 로그를 남기기로 설정했다면 로그도 확인이 가능하다.</p>
<p><img src="/images/ecs.tensorflow.03.png" alt=""></p>
<h3>다음글 Lambda를 이용하여 예측 서비스 제공하기</h3>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/TensorFlow/ms/lambda.tensorflow.md" target="_blank" rel="external">Using Tensorflow Predict on AWS Lambda Function</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/14/ecs.tensorflow/" data-id="cjov1wtqx0087jw7buk4014pk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ECS/">ECS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda.Deploy.Python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/07/Lambda.Deploy.Python/" class="article-date">
  <time datetime="2017-07-06T23:00:00.000Z" itemprop="datePublished">2017-07-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/07/Lambda.Deploy.Python/">Deploy AWS Lambda using Python</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Deploy Lambda Python</h1>
<p><strong>AWS Lambda</strong>에 Tutorial에 대한 이전 글</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.CSharp.md" target="_blank" rel="external">Lambda C# </a></li>
</ul>
<p>AWS Lambda에서 Python 3.6 runtime을 지원하게 된 이후 Python을 이용해서 Lambda function을 구현하는 일이 더 많아졌다. 하지만 기존에 작업했던 Node.JS 와 Python 사이에는 차이점들이 있어서 개발 과정 및 배포에 대해서 고민을 좀 해야만 했다.</p>
<h2>Node.JS 와 Python의 차이</h2>
<ul>
<li>
<p>외부 라이브러리 사용 (import에 path를 따로 지정하지 않아도 되는 조건)</p>
<ul>
<li>Node.JS
<ul>
<li>npm 설치시 기본적으로 현재 폴더 내에 npm_moudles 폴더를 생성한 후에 설치</li>
<li>packages.json 파일을 이용해서 npm으로 설치한 패키지에 대한 정보를 관리</li>
</ul>
</li>
<li>Python
<ul>
<li>pip 설치시 기본적으로 Global로 설치됨
<ul>
<li><code>pip install [패키지명] -t .</code> 으로 설치하면 현재 폴대 내에 패키지가 설치됨 (파일 구조가 많이 지저분해짐)</li>
</ul>
</li>
<li>requirements.txt 파일을 이용하여 pip로 설치한 패키지에 대한 정보를 관리</li>
</ul>
</li>
</ul>
</li>
<li>
<p>응답 방식</p>
<ul>
<li>Node.JS
<ul>
<li>handler에 세번째 인자로 callback을 전달받아서 그 함수 내에 인자로 Response Data를 넣어서 실행</li>
</ul>
</li>
<li>Python
<ul>
<li>handler 내에서 return으로 Response Data를 전달</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>Python 외부 라이브러리 관리에 대한 고민</h2>
<p>응답 방식에 대해서는 별 다른 고민을 안해도 되지만, 외부 라이브러리 사용 방법에 대해서는 아무리 고민을 해도 완벽하게 깔끔한 방법이 떠오르지 않았다. pip 설치를 특정 폴더내에 넣으려니 import 할때마다 경로를 지정해야하는게 많이 불편했다.</p>
<p>그래서 든 생각이 작업공간과 배포공간을 분리하는 것이다. 기존에 TypeScript Node.JS로 AWS Lambda의 Binary Response 관련 작업을 할때에는 TypeScirpt의 컴파일된 js 파일과 원본 ts 파일에 대한 분리, 로컬에서 개발시에는 macos용 binary shell 실행파일을 사용해야 하며 배포시에는 AWS Lambda에서 실행가능한 linux용 binary shell 실행파일을 배포해야하는 것 등의 이유로 작업공간과 배포공간을 분리하였다.</p>
<p>apex를 이용해서 배포하였으며, 배포시 shell script를 이용하였다.</p>
<p>Python 작업을 할때에는 local에서 개발할때는 모든 pip 패키지들을 Global로 설치(또는 virtualenv를 활용하여 설치)하여 개발을 하였으며 배포할때 필요한 것들에 대해서는 requirements.txt에 기록하여서 해당 폴더 내에서 로컬에 설치한 후에 같이 배포를 하면 되겠단 생각이 들었다.</p>
<p>Global에 설치된 pip가 굉장히 많을텐데, 현재 배포할 AWS Lambda Function에 사용되는 pip 패키지들을 어떻게 requirements.txt에 정리를 할까 ? 이걸 자동으로 해주는게 가능할까 ? 란 생각이 들어서 찾아보니 가능했다.</p>
<p><code>pipreqs</code>(<a href="https://github.com/bndr/pipreqs" target="_blank" rel="external">https://github.com/bndr/pipreqs</a>)를 이용하면 해당 폴더내의 py 파일들에 사용된 외부 라이브러리를 requirements.txt 파일로 자동으로 생성해 준다.</p>
<h3>Installation</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install pipreqs</div></pre></td></tr></table></figure></p>
<h3>Usage</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">        pipreqs [options] &lt;path&gt;</div><div class="line"></div><div class="line">    Options:</div><div class="line">        --use-local           Use ONLY local package info instead of querying PyPI</div><div class="line">        --pypi-server &lt;url&gt;   Use custom PyPi server</div><div class="line">        --proxy &lt;url&gt;         Use Proxy, parameter will be passed to requests library. You can also just set the</div><div class="line">                              environments parameter in your terminal:</div><div class="line">                              $ export HTTP_PROXY=&quot;http://10.10.1.10:3128&quot;</div><div class="line">                              $ export HTTPS_PROXY=&quot;https://10.10.1.10:1080&quot;</div><div class="line">        --debug               Print debug information</div><div class="line">        --ignore &lt;dirs&gt;...    Ignore extra directories</div><div class="line">        --encoding &lt;charset&gt;  Use encoding parameter for file open</div><div class="line">        --savepath &lt;file&gt;     Save the list of requirements in the given file</div><div class="line">        --print               Output the list of requirements in the standard output</div><div class="line">        --force               Overwrite existing requirements.txt</div><div class="line">        --diff &lt;file&gt;         Compare modules in requirements.txt to project imports.</div><div class="line">        --clean &lt;file&gt;        Clean up requirements.txt by removing modules that are not imported in project.</div></pre></td></tr></table></figure></p>
<p>이것도 자동으로 매번 새로 생성하는 것으로 해도 되겠지만, AWS Lambda의 경우 <code>boto3</code>는 기본적으로 설치가 되어 있으므로 deploy할때 같이 올릴 필요가 없다. 더군다나 boto3는 압축을 하여도 6 MB의 용량이므로 꽤나 큰 편이다. 그래서 수동으로 필요할때마다 <code>pipreqs .</code>을 실행항 뒤 <code>boto3</code>를 지워주는 식으로 사용중이다.</p>
<h2>예제 코드</h2>
<p><code>apex</code>가 설치되어 있고 local pc 에 (home)/.aws/credentials에 AWS 접속 정보가 저장되어 있다는 가정 하에 설명하겠다.</p>
<h3>폴더구조</h3>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(작업폴더)</div><div class="line">  - src (소스코드가 저장되어 있는 폴더)</div><div class="line">    - lambda_test (AWS Lambda Function에 대한 작업 폴더)</div><div class="line">      - index.py (예제 코드)</div><div class="line">      - requirements.txt (pip 외부 패키지에 대한 정보)</div><div class="line">      - function.json (apex 배포 설정)</div><div class="line">  - deploy.sh (배포 스크립트)</div><div class="line">  - project.json (apex 배포 설정)</div></pre></td></tr></table></figure></p>
<h3>index.py</h3>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    URL = <span class="string">'http://www.zigbang.com'</span></div><div class="line">    response = requests.get(URL)</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'statusCode'</span> : <span class="number">200</span>,</div><div class="line">             <span class="string">'headers'</span> : &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>&#125;,</div><div class="line">             <span class="string">'body'</span> : response.text &#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    response = handler(<span class="keyword">None</span>, <span class="keyword">None</span>)</div><div class="line">    print(response)</div></pre></td></tr></table></figure></p>
<p>Local에서 <code>python index.py</code> 라고 실행시 html 파일 내용이 출력되면 성공한 것이다.</p>
<h3>requirements.txt</h3>
<p>해당 폴더 내에서 <code>pipreqs .</code>로 실행하면 자동으로 생성된다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">requests==2.14.2</div></pre></td></tr></table></figure></p>
<h3>function.json</h3>
<p>배포 시 Lambda version에 description으로 보여지는 내용을 적어서 배포한다.</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"test depoly"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>project.json</h3>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span>: <span class="string">"test_deploy"</span>,</div><div class="line">  <span class="attr">"nameTemplate"</span>: <span class="string">"&#123;&#123;.Function.Name&#125;&#125;"</span>,</div><div class="line">  <span class="attr">"description"</span>: <span class="string">"Python Lambda Test Deploy"</span>,</div><div class="line">  <span class="attr">"role"</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">"handler"</span>:<span class="string">"index.handler"</span>,</div><div class="line">  <span class="attr">"runtime"</span>:<span class="string">"python3.6"</span>,</div><div class="line">  <span class="attr">"memory"</span>: <span class="number">128</span>,</div><div class="line">  <span class="attr">"timeout"</span>:<span class="number">30</span>,</div><div class="line">  <span class="attr">"region"</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">"vpc"</span>: &#123;</div><div class="line">    <span class="attr">"securityGroups"</span>:[<span class="string">"..."</span>],</div><div class="line">    <span class="attr">"subnets"</span>:[ ... ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>deploy.sh</h3>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rm -rf functions/lambda_test</div><div class="line">cp -rf src/lambda_test functions/lambda_test</div><div class="line">cd functions/lambda_test</div><div class="line">pip install -r requirements.txt -t .</div><div class="line">cd ../..</div><div class="line"></div><div class="line">apex deploy</div></pre></td></tr></table></figure></p>
<p>위 파일을 모두 생성한 후 배포 스크립트를 실행한다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./deploy.sh</div></pre></td></tr></table></figure></p>
<p>그럼 Lambda 가 배포될 것이며, AWS API Gateway로 연결하여 Browser에서 해당 staging의 url을 입력하면 결과를 볼 수 있다.</p>
<p>API Gateway와의 연동 방법에 대해서는 이 Post에서는 생략하겠다. 이 글 맨 위에 해당 Link로 들어가면 안내를 해놓은 글이 있으니 참고하길 바란다.</p>
<p><img src="/images/Lambda.Python.Deploy.01.png" alt=""></p>
<h2>마치며</h2>
<p>Python으로 AWS Lambda에서 작업시 pip로 외부 패키지를 해당 폴더내에 설치를 해야만 해서 작업하는 동안 지저분한 폴더 및 파일들로 인하여 불편했다. 거기서부터 시작하여 나름 깨끗한 개발 환경을 만들고자 했다.</p>
<p>혹시 더 좋은 방법으로 작업하시는 분들은 피드백 부탁드립니다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/07/07/Lambda.Deploy.Python/" data-id="cjov1wtpd005kjw7b43uz22dl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ASPNET.UsingPartialViewAsaComponent" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/24/ASPNET.UsingPartialViewAsaComponent/" class="article-date">
  <time datetime="2017-05-24T06:20:00.000Z" itemprop="datePublished">2017-05-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>►<a class="article-category-link" href="/categories/C/ASP-NET/">ASP.NET</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/24/ASPNET.UsingPartialViewAsaComponent/">Using Partial View as a Component</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2>Using Partial View as a Component</h2>
<p><strong>Partial View</strong>를 이용해서 View의 특정부분을 분리하여 관리가 가능하다.<br>
<strong>Partial View</strong>안에 관련 코드들(script, html...) 들을 모아놓고 그 중 특정 부분만 사용하는 것도 가능하다.<br>
이걸 이용하면 관련된 기능들을 하나의 <strong>Partial View</strong>에 넣어두고 관리하는게 가능해진다.</p>
<p>예를 들어서</p>
<ul>
<li>여러 개의 버튼들을 모아놓은 html</li>
<li>해당 버튼을 눌렀을때 동작하는 script</li>
<li>버튼을 눌렀을때 pop-up 처럼보이게 visible처리되는 div 들...</li>
</ul>
<p>위 3개의 코드들을 각각 별게의 위치에서 불러와야 하는 경우에도 1개의 <strong>Parial View</strong> 파일에 넣어둘 수 있는 방법이 있다.</p>
<h3>_ButtonComponents.cshtml</h3>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">@&#123;</div><div class="line">	var section = ViewData["section"] as string;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">@if (section == "button") &#123;</div><div class="line">	@Model.status</div><div class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_ok"</span>&gt;</span></div><div class="line">        ...</div><div class="line">	<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn_select"</span>&gt;</span></div><div class="line">        ...</div><div class="line">	<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">@if (section == "script") &#123;</div><div class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line">        ...</div><div class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">@if (section == "popup") &#123;</div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"statusModal"</span> <span class="attr">class</span>=<span class="string">"modal"</span> <span class="attr">style</span>=<span class="string">"width:300px; top: 400px;"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-content"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"modal-header"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">h3</span>&gt;</span>선택<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"select"</span> <span class="attr">style</span>=<span class="string">"display: inline-block; width: 280px;"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">selected</span>&gt;</span>선택<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span>확2<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group align-right"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"select_ok"</span>&gt;</span>확인<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"select_cancel"</span>&gt;</span>취소<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>위와 같이 선언된 <strong>Partial View</strong> 를 보면 <code>section</code>값이 <code>script</code> , <code>button</code>, <code>popup</code>인 3개의 영역으로 이루어져 있다. 이제 사용하는 곳에서 <code>section</code>값을 함께 전달하여 원하는 부분의 코드만 불러오면 된다.</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">@model Models.SampleViewModel</div><div class="line">@&#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">@section scripts&#123;</div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">@Html.Partial("_ButtonComponents", Model, new ViewDataDictionary &#123; &#123; "section", "script" &#125; &#125; )</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></div><div class="line">            @Html.Partial("_ButtonComponents", Model, new ViewDataDictionary &#123; &#123; "section", "button" &#125; &#125; )</div><div class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line"></div><div class="line">...</div><div class="line">@Html.Partial("_ButtonComponents", Model, new ViewDataDictionary &#123; &#123; "section", "popup" &#125; &#125;)</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/05/24/ASPNET.UsingPartialViewAsaComponent/" data-id="cjov1wtnc001rjw7bxnuv8mei" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C#</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CSharp.LinqOuterJoin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/24/CSharp.LinqOuterJoin/" class="article-date">
  <time datetime="2017-05-24T01:30:00.000Z" itemprop="datePublished">2017-05-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/C/">C#</a>►<a class="article-category-link" href="/categories/C/C/">C#</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/24/CSharp.LinqOuterJoin/">C# LINQ Outer Join</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2>C# LINQ Outer Join</h2>
<p>LINQ로 outer join 을 하는 방법을 검색해서 나오는 방법들이 대부분 Microsoft 공식 페이지에 나와있는 방법대로 하는 것들인데 문제는 그게 제대로 동작하지 않는다.</p>
<p><a href="https://docs.microsoft.com/en-us/dotnet/articles/csharp/linq/perform-left-outer-joins" target="_blank" rel="external">https://docs.microsoft.com/en-us/dotnet/articles/csharp/linq/perform-left-outer-joins</a></p>
<p>그래서 더 찾아보니 <code>GroupJoin</code> 과 <code>SelectMany</code>를 활용해서 outer join 과 동일한 결과로 표현이 가능한 방법이 있었다.</p>
<ul>
<li><code>GroupJoin</code> : <code>Join</code>을 수행하면서 outer table 기준으로 inner table 의 항목들을 <code>Collection</code>으로 만들어 줌.</li>
<li><code>SelectMany</code> : <code>Select</code>를 수행시 <code>IEnumerable</code>한 항목을 풀어서 수행한다.
좀 더 쉽게 설명하자면 2중 <code>List</code>가 있을 경우 <code>List</code>안의 <code>List</code>를 풀어서 그냥 <code>List</code>로 만들어 준다.
다른 언어의 <strong>rx</strong>의 <code>FlatMap</code>과 동일한 기능다.</li>
</ul>
<p>이 둘을 이용해서 inner table을 <code>GroupJoin</code>으로 수행하면서 그 결과 값이 없는 경우 <code>DefaultOfEmpty</code>를 활용해서 생성한 후 <code>SelectMany</code>로 <code>GroupJoin</code>시 생성되었던 <code>Collection</code>을 flat하게 풀어주면 일반적인 형태의 outer join을 한것과 같은 결과를 얻을 수 있다.</p>
<h3>예제 SQL문</h3>
<p>예제에 사용할 SQL 데이터 이다.<br>
참고로 <strong>Oracle</strong>의 <code>EMP</code>, <code>DEPT</code> 테이블의 내용이며, 아래 SQL 문법은 <strong>MySQL</strong> 용으로 작성되었다.</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> EMP (</div><div class="line">  EMPNO <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> ,</div><div class="line">  ENAME <span class="built_in">VARCHAR</span>(<span class="number">10</span>),</div><div class="line">  JOB <span class="built_in">VARCHAR</span>(<span class="number">9</span>),</div><div class="line">  MGR <span class="built_in">INT</span>,</div><div class="line">  HIREDATE <span class="built_in">DATE</span>,</div><div class="line">  SAL <span class="keyword">DOUBLE</span>,</div><div class="line">  COMM <span class="keyword">DOUBLE</span>,</div><div class="line">  DEPTNO <span class="built_in">INT</span></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7369</span>, <span class="string">'SMITH'</span>,  <span class="string">'CLERK'</span>,     <span class="number">7902</span>, <span class="string">'1980-12-17'</span>,  <span class="number">800</span>, <span class="literal">NULL</span>, <span class="number">20</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7499</span>, <span class="string">'ALLEN'</span>,  <span class="string">'SALESMAN'</span>,  <span class="number">7698</span>, <span class="string">'1981-02-20'</span>,  <span class="number">1600</span>,  <span class="number">300</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7521</span>, <span class="string">'WARD'</span>,   <span class="string">'SALESMAN'</span>,  <span class="number">7698</span>, <span class="string">'1981-02-22'</span>,  <span class="number">1250</span>,  <span class="number">500</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7566</span>, <span class="string">'JONES'</span>,  <span class="string">'MANAGER'</span>,   <span class="number">7839</span>, <span class="string">'1981-04-02'</span>,  <span class="number">2975</span>, <span class="literal">NULL</span>, <span class="number">20</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7654</span>, <span class="string">'MARTIN'</span>, <span class="string">'SALESMAN'</span>,  <span class="number">7698</span>, <span class="string">'1981-09-28'</span>,  <span class="number">1250</span>, <span class="number">1400</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7698</span>, <span class="string">'BLAKE'</span>,  <span class="string">'MANAGER'</span>,   <span class="number">7839</span>, <span class="string">'1981-05-01'</span>,  <span class="number">2850</span>, <span class="literal">NULL</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7782</span>, <span class="string">'CLARK'</span>,  <span class="string">'MANAGER'</span>,   <span class="number">7839</span>, <span class="string">'1981-06-09'</span>,  <span class="number">2450</span>, <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7788</span>, <span class="string">'SCOTT'</span>,  <span class="string">'ANALYST'</span>,   <span class="number">7566</span>, <span class="string">'1982-12-09'</span>, <span class="number">3000</span>, <span class="literal">NULL</span>, <span class="number">20</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7839</span>, <span class="string">'KING'</span>,   <span class="string">'PRESIDENT'</span>, <span class="literal">NULL</span>, <span class="string">'1981-11-17'</span>, <span class="number">5000</span>, <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7844</span>, <span class="string">'TURNER'</span>, <span class="string">'SALESMAN'</span>,  <span class="number">7698</span>, <span class="string">'1981-09-08'</span>,  <span class="number">1500</span>, <span class="literal">NULL</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7876</span>, <span class="string">'ADAMS'</span>,  <span class="string">'CLERK'</span>,     <span class="number">7788</span>, <span class="string">'1983-01-12'</span>, <span class="number">1100</span>, <span class="literal">NULL</span>, <span class="number">20</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7900</span>, <span class="string">'JAMES'</span>,  <span class="string">'CLERK'</span>,     <span class="number">7698</span>, <span class="string">'1981-12-03'</span>,   <span class="number">950</span>, <span class="literal">NULL</span>, <span class="number">30</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7902</span>, <span class="string">'FORD'</span>,   <span class="string">'ANALYST'</span>,   <span class="number">7566</span>, <span class="string">'1981-12-03'</span>,  <span class="number">3000</span>, <span class="literal">NULL</span>, <span class="number">20</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">7934</span>, <span class="string">'MILLER'</span>, <span class="string">'CLERK'</span>,     <span class="number">7782</span>, <span class="string">'1982-01-23'</span>, <span class="number">1300</span>, <span class="literal">NULL</span>, <span class="number">10</span>);</div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> DEPT (</div><div class="line">  DEPTNO <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> ,</div><div class="line">  DNAME <span class="built_in">VARCHAR</span>(<span class="number">14</span>),</div><div class="line">  LOC <span class="built_in">VARCHAR</span>(<span class="number">13</span>)</div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> DEPT <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">'ACCOUNTING'</span>, <span class="string">'NEW YORK'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> DEPT <span class="keyword">VALUES</span> (<span class="number">20</span>, <span class="string">'RESEARCH'</span>,   <span class="string">'DALLAS'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> DEPT <span class="keyword">VALUES</span> (<span class="number">30</span>, <span class="string">'SALES'</span>,      <span class="string">'CHICAGO'</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> DEPT <span class="keyword">VALUES</span> (<span class="number">40</span>, <span class="string">'OPERATIONS'</span>, <span class="string">'BOSTON'</span>);</div></pre></td></tr></table></figure></p>
<p>위까지가 원래 데이터이며, 테스트를 위해서 inner join에 해당하지 않는 데이터를 하나 추가하였다.</p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> EMP <span class="keyword">VALUES</span> (<span class="number">0</span>, <span class="string">'LUNA'</span>, <span class="string">'MASTER'</span>,     <span class="number">7782</span>, <span class="string">'1982-01-23'</span>, <span class="number">1300</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</div></pre></td></tr></table></figure></p>
<h3>LINQ 실행</h3>
<p>테스트를 위해 실행시킨 LINQ 문장은 아래와 같다.</p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> emp = context.EMP.ToList();</div><div class="line"><span class="keyword">var</span> dept = context.DEPT.ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j1 = context.EMP.Join(context.DEPT, e =&gt; e.DEPTNO, d =&gt; d.DEPTNO, (e, d) =&gt; <span class="keyword">new</span> &#123;e, d&#125;).ToList();</div><div class="line"><span class="keyword">var</span> j2 = context.EMP.Join(context.DEPT.DefaultIfEmpty(), e =&gt; e.DEPTNO, d =&gt; d.DEPTNO, (e, d) =&gt; <span class="keyword">new</span> &#123; e, d &#125;).ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j3 = context.EMP.GroupJoin(context.DEPT, e =&gt; e.DEPTNO, d =&gt; d.DEPTNO, (e, d) =&gt; <span class="keyword">new</span> &#123; e, d &#125;).ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j4 = context.DEPT.GroupJoin(context.EMP, d =&gt; d.DEPTNO, e =&gt; e.DEPTNO, (d, e) =&gt; <span class="keyword">new</span> &#123; d, e &#125;).ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j5 = context.EMP.GroupJoin(context.DEPT, e =&gt; e.DEPTNO, d =&gt; d.DEPTNO, (e, d) =&gt; <span class="keyword">new</span> &#123; e, d = d.DefaultIfEmpty() &#125;)</div><div class="line">    .SelectMany(j =&gt; j.d.Select(d =&gt; <span class="keyword">new</span> &#123; j.e, d&#125;))</div><div class="line">    .ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j6 = context.EMP.GroupJoin(context.DEPT, e =&gt; e.DEPTNO, d =&gt; d.DEPTNO, (e, d) =&gt; <span class="keyword">new</span> &#123; e, d = d.FirstOrDefault() &#125;).ToList();</div></pre></td></tr></table></figure></p>
<p><img src="/images/LinqOuterJoin.01.png" alt=""></p>
<p>실행 결과에 대해서 <code>IEnumerable</code>의 <code>Count</code>를 먼저 살펴보자.</p>
<p><strong>EMP</strong> 와 <strong>DEPT</strong>는 테이블에 들어가 있는 레코드 수가 그대로 반영되었다.</p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> j1 = context.EMP.Join(context.DEPT, </div><div class="line">    e =&gt; e.DEPTNO, d =&gt; d.DEPTNO,</div><div class="line">    (e, d) =&gt; <span class="keyword">new</span> &#123;e, d&#125;)</div><div class="line">    .ToList();</div></pre></td></tr></table></figure></p>
<p><strong>j1</strong>은 보통 많이쓰는 <code>Join</code>으로 실행시켰다. inner join을 수행하므로 마지막에 테스트로 넣은 <strong>LUNA</strong>의 경우 <strong>DEPTNO</strong>로 조인이 되지 않아서 14개가 되는게 맞다.</p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> j2 = context.EMP.Join(context.DEPT.DefaultIfEmpty(),</div><div class="line">    e =&gt; e.DEPTNO, d =&gt; d.DEPTNO,</div><div class="line">    (e, d) =&gt; <span class="keyword">new</span> &#123; e, d &#125;)</div><div class="line">    .ToList();</div></pre></td></tr></table></figure></p>
<p><strong>j2</strong>는 Microsoft 공식 문서에 나와있는 방법대로 inner table 쪽에 <code>DefaultIfEmpty</code>를 수행했는데도 14개로 inner join한 것과 같은 결과가 나왔다.</p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> j3 = context.EMP.GroupJoin(context.DEPT,</div><div class="line">    e =&gt; e.DEPTNO, d =&gt; d.DEPTNO,</div><div class="line">    (e, d) =&gt; <span class="keyword">new</span> &#123; e, d &#125;)</div><div class="line">    .ToList();</div></pre></td></tr></table></figure></p>
<p><strong>j3</strong>을 보니 우리가 원하던대로 15개의 결과가 나왔다.
결과를 좀 더 자세히 보니 <strong>LUNA</strong>에 조인된 <code>d</code>가 <code>null</code>로 들어와있다.</p>
<p><img src="/images/LinqOuterJoin.03.png" alt=""></p>
<p>이제 원하는 결과를 얻었다고 생각이되지만, 나머지 항목에 대해서는 <code>d</code>가 <code>Collection</code>으로 되어 있으며 그 안에 <code>DEPT</code>가 1개씩 들어가 있어서 별로 보기에 좋지가 않다.
일단 여기서 넘어가고 아래에서 좀 더 이쁘게 만들어 보겠다.</p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> j4 = context.DEPT.GroupJoin(context.EMP,</div><div class="line">    d =&gt; d.DEPTNO, e =&gt; e.DEPTNO,</div><div class="line">    (d, e) =&gt; <span class="keyword">new</span> &#123; d, e &#125;)</div><div class="line">    .ToList();</div></pre></td></tr></table></figure></p>
<p>위에서 설명한 <code>GroupJoin</code>이 어떻게 동작하는지 보기위해서 <strong>j4</strong>에서는 <code>DEPT</code>를 outer table로 하고 <code>EMP</code>를 inner table로 하여 수행해 보았다.
<code>d</code>에 해당하는 <code>e</code>에 여러개의 <code>EMP</code>가 <code>Collection</code>으로 들어가 있는게 확인 가능하다.</p>
<p><img src="/images/LinqOuterJoin.02.png" alt=""></p>
<p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> j5 = context.EMP.GroupJoin(context.DEPT,</div><div class="line">    e =&gt; e.DEPTNO, d =&gt; d.DEPTNO,</div><div class="line">    (e, d) =&gt; <span class="keyword">new</span> &#123; e, d = d.DefaultIfEmpty() &#125;)</div><div class="line">    .SelectMany(j =&gt; j.d.Select(d =&gt; <span class="keyword">new</span> &#123; j.e, d&#125;))</div><div class="line">    .ToList();</div><div class="line"></div><div class="line"><span class="keyword">var</span> j6 = context.EMP.GroupJoin(context.DEPT,</div><div class="line">    e =&gt; e.DEPTNO, d =&gt; d.DEPTNO,</div><div class="line">    (e, d) =&gt; <span class="keyword">new</span> &#123; e, d = d.FirstOrDefault() &#125;)</div><div class="line">    .ToList();</div></pre></td></tr></table></figure></p>
<p><strong>j5</strong>와 <strong>j6</strong>는 <strong>j3</strong>에서 이쁘지 않았던 모양을 좀 더 사용하기 좋도록 만든 것이다.
<strong>j3</strong>에서 만든 <code>Collection</code>을 풀어서 flat하게 만들어주는게 <strong>j5</strong>, <strong>j6</strong>이다.
이 경우에서는 둘의 결과는 똑같다.</p>
<p><img src="/images/LinqOuterJoin.04.png" alt=""></p>
<p>하지만 모든 경우에 있어서 둘의 결과가 똑같지는 않다.</p>
<p><strong>j5</strong>에서는 <code>EMP</code>에 해당하는 <code>DEPT</code>가 여러 개 있는 경우 그걸 여러개의 결과로 나눠준다.<br>
<strong>j6</strong>에서는 <code>EMP</code>에 해당하는 <code>DEPT</code>가 여러 개가 있더라도 그중 1개만 결과로 남고 나머지는 무시된다.</p>
<p>위에서 생성한 테이블에서는 outer join을 할려는 목적이 <code>DEPT</code>가 1개이거나 없거나 하는 경우라서 <strong>j6</strong>방법으로 사용해도 되지만, 대부분의 경우에는 <strong>j5</strong> 방법대로 해야한다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2017/05/24/CSharp.LinqOuterJoin/" data-id="cjov1wtog003pjw7b6dphb3df" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/">C#</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/">AWS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/ECS/">ECS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/Lambda/">Lambda</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/AWS/SageMaker/">SageMaker</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Azure/">Azure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Book/">Book</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Book/Review/">Review</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C#</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C/ASP-NET/">ASP.NET</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/ASP-NET-Core/">ASP.NET Core</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/C/">C#</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/CPP/">CPP</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/CPP/MFC/">MFC</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/DataScience/">DataScience</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Database/Oracle/">Oracle</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/SQLP/">SQLP</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/Node-JS/">Node.JS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/TypeScript/">TypeScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/DataScience/">DataScience</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/Python/">Python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tips/">Tips</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Tips/JupyterNotebook/">JupyterNotebook</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tips/macOS/">macOS</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET/">ASP.NET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASP-NET-Core/">ASP.NET Core</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWS/">AWS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Azure/">Azure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureContainerRegistry/">AzureContainerRegistry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureContainerService/">AzureContainerService</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureFileStorage/">AzureFileStorage</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AzureFunction/">AzureFunction</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Batch/">Batch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Book/">Book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI-CD/">CI/CD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CPP/">CPP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataScience/">DataScience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DevOps/">DevOps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECS/">ECS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HyperparameterTuning/">HyperparameterTuning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JupyterNotebook/">JupyterNotebook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kaggle/">Kaggle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MFC/">MFC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MachineLearning/">MachineLearning</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Matplotlib/">Matplotlib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-JS/">Node.JS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Review/">Review</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/S3/">S3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SIMD/">SIMD</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLP/">SQLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SageMaker/">SageMaker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Serverless/">Serverless</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ToolkitPro/">ToolkitPro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UAC/">UAC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XGBoost/">XGBoost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/macOS/">macOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/한글폰트/">한글폰트</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/APIGateway/" style="font-size: 15px;">APIGateway</a> <a href="/tags/ASP-NET/" style="font-size: 13.57px;">ASP.NET</a> <a href="/tags/ASP-NET-Core/" style="font-size: 12.14px;">ASP.NET Core</a> <a href="/tags/AWS/" style="font-size: 19.29px;">AWS</a> <a href="/tags/Azure/" style="font-size: 10.71px;">Azure</a> <a href="/tags/AzureContainerRegistry/" style="font-size: 10px;">AzureContainerRegistry</a> <a href="/tags/AzureContainerService/" style="font-size: 10px;">AzureContainerService</a> <a href="/tags/AzureFileStorage/" style="font-size: 10.71px;">AzureFileStorage</a> <a href="/tags/AzureFunction/" style="font-size: 10px;">AzureFunction</a> <a href="/tags/Batch/" style="font-size: 10px;">Batch</a> <a href="/tags/Book/" style="font-size: 16.43px;">Book</a> <a href="/tags/C/" style="font-size: 18.57px;">C#</a> <a href="/tags/CI-CD/" style="font-size: 11.43px;">CI/CD</a> <a href="/tags/CPP/" style="font-size: 13.57px;">CPP</a> <a href="/tags/DataScience/" style="font-size: 15.71px;">DataScience</a> <a href="/tags/Database/" style="font-size: 20px;">Database</a> <a href="/tags/DevOps/" style="font-size: 11.43px;">DevOps</a> <a href="/tags/Docker/" style="font-size: 10.71px;">Docker</a> <a href="/tags/ECS/" style="font-size: 10px;">ECS</a> <a href="/tags/HyperparameterTuning/" style="font-size: 10px;">HyperparameterTuning</a> <a href="/tags/JavaScript/" style="font-size: 11.43px;">JavaScript</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/JupyterNotebook/" style="font-size: 11.43px;">JupyterNotebook</a> <a href="/tags/Kaggle/" style="font-size: 14.29px;">Kaggle</a> <a href="/tags/Lambda/" style="font-size: 17.86px;">Lambda</a> <a href="/tags/MFC/" style="font-size: 13.57px;">MFC</a> <a href="/tags/MachineLearning/" style="font-size: 17.14px;">MachineLearning</a> <a href="/tags/Matplotlib/" style="font-size: 10px;">Matplotlib</a> <a href="/tags/Node-JS/" style="font-size: 12.86px;">Node.JS</a> <a href="/tags/Node-js/" style="font-size: 10px;">Node.js</a> <a href="/tags/Oracle/" style="font-size: 20px;">Oracle</a> <a href="/tags/Python/" style="font-size: 16.43px;">Python</a> <a href="/tags/Review/" style="font-size: 16.43px;">Review</a> <a href="/tags/S3/" style="font-size: 10px;">S3</a> <a href="/tags/SIMD/" style="font-size: 10px;">SIMD</a> <a href="/tags/SQLP/" style="font-size: 20px;">SQLP</a> <a href="/tags/SageMaker/" style="font-size: 10px;">SageMaker</a> <a href="/tags/Serverless/" style="font-size: 12.14px;">Serverless</a> <a href="/tags/Tensorflow/" style="font-size: 12.14px;">Tensorflow</a> <a href="/tags/ToolkitPro/" style="font-size: 10.71px;">ToolkitPro</a> <a href="/tags/TypeScript/" style="font-size: 10.71px;">TypeScript</a> <a href="/tags/UAC/" style="font-size: 10px;">UAC</a> <a href="/tags/XGBoost/" style="font-size: 10px;">XGBoost</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/macOS/" style="font-size: 10px;">macOS</a> <a href="/tags/한글폰트/" style="font-size: 10px;">한글폰트</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/24/aws-batch-tutorial/">Introduce to AWS Batch</a>
          </li>
        
          <li>
            <a href="/2018/11/04/kaggle.coursera.competition.03.02/">Coursera Kaggle 강의(How to win a data science competition) week 3,4 Advanced Feature Engineering 요약</a>
          </li>
        
          <li>
            <a href="/2018/10/30/kaggle.coursera.competition.04.02/">Coursera Kaggle 강의(How to win a data science competition) week 4-4 Ensemble 요약</a>
          </li>
        
          <li>
            <a href="/2018/10/30/kaggle.coursera.competition.04.01/">Coursera Kaggle 강의(How to win a data science competition) week 4-1 Hyperparameter Tuning 요약</a>
          </li>
        
          <li>
            <a href="/2018/10/30/181030.data.philosophy/">데이터를 철학하다</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Yun Seok-joon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>