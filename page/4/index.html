<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Dev Star SJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Sharing the common developer&apos;s try-on">
<meta property="og:type" content="website">
<meta property="og:title" content="Dev Star SJ">
<meta property="og:url" content="http://DevStarSJ.github.io/page/4/index.html">
<meta property="og:site_name" content="Dev Star SJ">
<meta property="og:description" content="Sharing the common developer&apos;s try-on">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dev Star SJ">
<meta name="twitter:description" content="Sharing the common developer&apos;s try-on">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-104294646-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Dev Star SJ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://DevStarSJ.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Lambda.Packaging.Node" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/27/Lambda.Packaging.Node/" class="article-date">
  <time datetime="2016-11-27T06:54:51.000Z" itemprop="datePublished">2016-11-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/27/Lambda.Packaging.Node/">Lambda Node.JS Packaging</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Lambda Node.JS Packaging</h1>
<p><strong>Labmda</strong>에 <strong>Node.JS</strong>로 구현하는 내용에 대해서는 아래 3개의 Link를 참고해 주세요.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
</ul>
<p>이제껏 1개의 <strong>Node.JS</strong> 파일에 <strong>npm module</strong>을 하나도 사용하지 않은 예제만 살펴보았는데,
실제로 개발할 상황에서는 파일도 여러 개로 나눠서 개발하고 <strong>npm module</strong>도 많이 사용할 경우가 많습니다.
이렇게 개발한 코드들을 어떻게 Lambda로 올리는지 이번 포스팅에서 살펴보도록 하겠습니다.</p>
<p><strong>Lambda 와 API Gateway 연동 #3</strong>까지 구현되어 있다는 가정하에서 진행하겠습니다.</p>
<h2>Node.JS 코드에 npm 사용</h2>
<ul>
<li>이전까지 작업한 코드를 <code>index.js</code>란 이름으로 작업할 폴더에 저장</li>
<li><strong>npm</strong>으로 <strong>lodash</strong> 설치 : <code>npm install lodash</code></li>
<li>코드를 아래와 같이 수정</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">userId</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">userId, header, body</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/test'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">return</span> get(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(_.get(event,<span class="string">'body'</span>));</div><div class="line">      <span class="keyword">const</span> header =  event.headers;</div><div class="line">      <span class="keyword">return</span> post(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.path][event.httpMethod];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>routeMap</strong> 내부에 <code>lodash.get</code> 함수를 사용하는 것으로 코드를 변경하였습니다.</p>
<ul>
<li>zip 파일로 압축 : <code>zip -r ./sample.zip ./</code></li>
</ul>
<h2>Lambda에 zip 파일로 배포</h2>
<p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li><code>Code</code> 탭
<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택</li>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda.packaging.node.01.png?raw=true&quot;&gt;</p>
<h2>확인</h2>
<p><strong>API Gateway</strong>는 변경사항이 없으므로 결과는 <strong>3장</strong>과 똑같이 나옵니다.</p>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>여러 파일을 함께 배포</h2>
<p>이미 <strong>npm module</strong>을 포함하여 베포하였으므로 여러 파일을 묶어서 배포하는게 확인되었지만, 우리가 작성한 소스코드 자체도 나눠서 배포해 보도록 하겠습니다.
위에 작성한 코드를 4개의 파일로 나눠서 올려보겠습니다.</p>
<ul>
<li><code>index.js</code></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./router'</span>);</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>router.js</code></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/test'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'./controllers/test/get'</span>)(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(_.get(event,<span class="string">'body'</span>));</div><div class="line">      <span class="keyword">const</span> header =  event.headers;</div><div class="line">      <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'./controllers/test/post'</span>)(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.path][event.httpMethod];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>/controllers/test/get.js</code></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">userId</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>/controllers/test/post.js</code></li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">userId, header, body</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>npm</strong>으로 <strong>lodash</strong> 설치 : <code>npm install lodash</code></li>
<li>zip 파일로 압축 : <code>zip -r ./sample.zip ./</code></li>
</ul>
<p>위에서와 같은 방법으로 <strong>Lambda</strong>에 배포 후 확인을 해보면 같은 결과가 출력됩니다.</p>
<h2>Lambda에 zip 파일로 배포</h2>
<p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li><code>Code</code> 탭
<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택</li>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
</ul>
<h2>확인</h2>
<p><strong>API Gateway</strong>는 변경사항이 없으므로 결과는 <strong>3장</strong>과 똑같이 나옵니다.</p>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>마치며...</h3>
<p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 여러 파일을 <code>.zip</code>으로 묶어서 함께 배포
<ul>
<li><strong>npm module</strong>을 함께 배포</li>
<li>여러 파일로 작성된 소스코드들을 함께 배포</li>
</ul>
</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>참고</h3>
<ul>
<li>AWS 공식 가이드 : <a href="http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/27/Lambda.Packaging.Node/" data-id="cjov28bpo005r5b7bx913okxz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-JS/">Node.JS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda.Packaging.Python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/24/Lambda.Packaging.Python/" class="article-date">
  <time datetime="2016-11-24T07:54:51.000Z" itemprop="datePublished">2016-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/24/Lambda.Packaging.Python/">Lambda Python Packaging</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Lambda Python Packaging</h1>
<p><strong>AWS Lambda</strong>에 대해 다루는 6번째 글입니다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
</ul>
<p>지난번 글에서 1개의 <strong>Python</strong> 파일로 구현하여 <strong>AWS Lambda</strong>에 올리는 방법에 대해서 다뤘는데,
이번 글에서는 여러 개의 파일로 나뉘어서 구현한 경우와 외부 라이브러리를 <strong>pip</strong>로 설치할 경우 어떻게 해야하는지에 대해서 다뤄보겠습니다.</p>
<h2>Previously on Lambda series</h2>
<p><strong>Lambda</strong>의 생성 및 <strong>API Gateway</strong>와의 연결은 되어 있다는 가정하에 진행하겠습니다.
관련 내용들은 앞의 글들에 다 있지만 읽기 귀찮으시다는 분들을 위해 간략한 따라하기를 살없이 뼈만 추려서 먼저 소개하고 시작하겠습니다.</p>
<h3>Create Lambda</h3>
<ul>
<li><code>AWS</code> 로그인 후 <code>Lambda</code> 탭으로 이동</li>
<li><code>Create a Lambda Function</code> 선택</li>
<li>Select blueprint에서 <code>Blank Function</code> 선택</li>
<li>Configure function 에서 일단 바로 <code>Next</code> 선택 (미리 연결할 API Gateway가 있다면 여기서 연결하면 됨)</li>
<li><code>Configure function</code>에서 함수 정의
<ul>
<li>Name : <code>testLambda-luna</code></li>
<li>Runtime : <code>Python 2.7</code></li>
<li>Code : 아래 소개되어 있는 <code>Python Lambda Code</code>를 입력</li>
<li>Role &amp; Existing role : 일단은 적당히 선택 (만약 Lambda에서 다른 AWS 서비스 RDS, S3 등을 연동할려면 필요)</li>
<li>아래 코드 입력 후 <code>Next</code> 선택</li>
</ul>
</li>
<li><code>Create Function</code> 선택</li>
</ul>
<h3>Set API Gateway</h3>
<ul>
<li><code>AWS</code> 메인 화면으로 이동 후 <code>API Gateway</code> 탭으로 이동</li>
<li><code>Create API</code> 선택
<ul>
<li>API name : <code>testAPI-luna</code></li>
<li><code>Create API</code> 선택</li>
</ul>
</li>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 선택
<ul>
<li><code>Configure as proxy resource</code> 를 체크한 후 <code>Create Resource</code>를 누름</li>
</ul>
</li>
<li><code>ANY</code> 선택
<ul>
<li><code>Integration Request</code> 선택
<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code>
<ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택 후 그냥 <code>prod</code>로 스테이징</li>
</ul>
<h3>Python Lambda Code</h3>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<h2>Python Code 패키징 연습</h2>
<p>새로운 코드를 만드는것 보다는 일단 정상적으로 동작하는 것이 확인된 코드를 파일로 나눠가면서 진행하겠습니다.</p>
<h3>Step 1. 통파일을 그냥 .zip으로 압축하여 올리기</h3>
<p>작업할 폴더를 하나 만듭니다. 일단 <code>packaging.test</code> 라는 이름으로 만들어 보겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir packaging.test</div><div class="line">cd packaging.test</div></pre></td></tr></table></figure></p>
<p>그 안에 원래 <strong>Lambda</strong>에 올려놓은 코드를 그대로 복사하여 <code>index.py</code>로 생성합니다.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<p><code>.zip</code>파일로 압축할 때 해당 <code>index.py</code> 파일이 루트에 위치해야 합니다.
즉, <code>packaging.test</code> 폴더를 압축하는게 아니라 그 안에 들어와서 압축을 해야 합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip sample.zip index.py</div></pre></td></tr></table></figure></p>
<p>이제 <strong>Lambda</strong>에 올리신 후 테스트 해보면 됩니다.
올리는 방법과 테스트 방법은 계속 동일하기 때문에 여기서 한 번만 소개하고 밑에서는 따로 소개하지 않겠습니다.</p>
<p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li>
<p><code>Code</code> 탭</p>
<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택</li>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
<li>
<p><strong>GET</strong> 요청 (브라우저에서 주소 입력) : <code>https://.../prod/test?id=2</code></p>
</li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>POST</strong> 요청 (<strong>POSTMAN</strong>이나 <strong>curl</strong>등을 활용) : URL은 <strong>GET</strong>과 동일</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>Step 2. 파일 나누기</h3>
<p>위의 파일을 2개로 나누어서 올려보겠습니다.
같은 폴더에 <code>router.py</code>파일을 하나 생성 한 후 파일 내용을 아래와 같이 수정해 주세요.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<h4>router.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div></pre></td></tr></table></figure></p>
<p><code>.zip</code> 파일로 압축합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip sample.zip .</div></pre></td></tr></table></figure></p>
<p>코드를 올린 후 테스트 했을 때 똑같은 결과가 나와야 합니다.</p>
<h3>Step 3. 폴더로 나누기</h3>
<p>작업 중인 폴더에 <code>/controllers/test</code>의 2단계의 폴더를 추가 합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir controllers</div><div class="line">cd controllers</div><div class="line">mkdir test</div></pre></td></tr></table></figure></p>
<p>그런 다음 2개의 폴더에 각각 <code>__init__.py</code>라는 파일을 만듭니다.
내용은 아무것도 없는 빈 파일로 생성합니다.
앞으로 작성할 2개의 파일도 미리 생성해 놓겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">touch __init__.py</div><div class="line">cd test</div><div class="line">touch __init__.py</div><div class="line">touch post.py</div><div class="line">touch get.py</div></pre></td></tr></table></figure></p>
<p><code>/controllers/test/</code>안에 <code>post.py</code>, <code>get.py</code>에 기존에 있던 <code>router.py</code>의 내용을 나눠서 수정합니다.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<h4>router.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> controllers.test.get</div><div class="line"><span class="keyword">import</span> controllers.test.post</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: controllers.test.get.handler,</div><div class="line">        <span class="string">'POST'</span>: controllers.test.post.handler</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div></pre></td></tr></table></figure></p>
<h4>controllers/test/post.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div></pre></td></tr></table></figure></p>
<h4>controllers/test/get.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div></pre></td></tr></table></figure></p>
<p><code>index.py</code>가 위치한 폴더로 이동하여 압축을 합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure></p>
<p>코드를 올린 후 테스트 했을 때 똑같은 결과가 나와야 합니다.</p>
<h3>Step 4. 외부 라이브러리를 pip로 설치하여 같이 올리기</h3>
<p>외부 라이브러리 설치를 하기위해서는 주의해야 할 사항들이 몇가지 있습니다.</p>
<p>외부 라이브러리를 해당 폴더 내에 설치하기 위해서는 <code>virtualenv</code>를 사용하여 가상환경을 구성해주는게 편합니다.
그렇지 않으면 이미 해당 라이브러리가 설치된 경우 충돌이 일어 날수가 있어서 설치 자체가 쉽지 않습니다.
그리고 현재 기본적으로 실행되는 <strong>Python</strong>의 버전이 <strong>3.x.x</strong> 버전일 경우에도 문제가 됩니다.
현재 <strong>AWS Lambda</strong>에서 지원하는 <strong>Python</strong>이 <strong>2.7</strong>버전이기 때문입니다.</p>
<p><strong>Python 3</strong>에서도 <code>virtualenv</code> 환경으로 <strong>Python 2.7</strong>로 생성이 가능합니다만, 필자는 구글에서 찾아봐서 몇 번 시도를 해봤는데 계속 실패하더라구요.
그래서 그냥 과감하게 그 당시 기본으로 설치된 **Python 3.5.12 (Conda)**를 날려버렸습니다.
그리고 따로 <strong>Python 공식 페이지</strong>에 들어가서 <strong>2.7.12</strong>와 <strong>3.5.12</strong>를 설치했습니다.
<strong>Python</strong> 설치는 <strong>homebrew</strong> 같은것으로 설치하는 것보다는 그냥 공홈에서 <strong>.pkg</strong> 같은걸로 다운받아서 설치하는게 정신 건강에 좋습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ python -V</div><div class="line">Python 2.7.12</div></pre></td></tr></table></figure></p>
<p>기본 버전이 <strong>2.7.12</strong> 라는 것이 확인되었으니 그냥 <code>virtualenv</code>로 가상환경을 만들면 되겠네요.
먼저 <code>index.py</code>가 위치한 곳으로 이동 후 다음과 같이 입력하여 실행해주세요.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virtualenv myvenv</div></pre></td></tr></table></figure></p>
<p>이제 가상 환경으로 활성화 합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source myvenv/bin/activate</div></pre></td></tr></table></figure></p>
<p>이제 원하는 라이브러리를 로컬로 해당 폴더에 설치하면 됩니다.</p>
<p>예제로 작성할 코드라 가볍고 사용하기 쉬운 <code>requests</code>를 설치해 보도록 하겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install requests -t .</div></pre></td></tr></table></figure></p>
<p>일단은 단순하게 그냥 <code>index.py</code>만 수정해서 <code>requests</code>가 동작하는 코드로 수정 후 올려보도록 하죠.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line"></div><div class="line">    URL = <span class="string">'http://www.tistory.com'</span></div><div class="line">    response = requests.get(URL)</div><div class="line"></div><div class="line">    result[<span class="string">'request_data'</span>] = response.text</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<p>해당 폴더 이하를 몽땅 압축하여 올립니다. (<strong>myvenv</strong> 는 제외하고 싶은데... 어떻게 하는지 잘 모르겠습니다.)</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure></p>
<p>테스트를 하면 <code>request_data</code>안에 데이터들이 추가된 것을 확인 할 수 있습니다.</p>
<h3>Step 5. 좀 더 새련된 패키징 처리</h3>
<p><strong>Step 4</strong>에서 살펴본 내용만으로는 실제 서비스 가능한 수준의 코드를 만드는데는 몇가지 문제가 있습니다.</p>
<ol>
<li>압축파일의 크기가 너무 크다. <code>virtualenv</code>용 파일은 제외하고 압축하고 싶다.</li>
<li><strong>pip</strong>를 이용한 모듈을 로컬에 설치했는데, 그럼 <code>index.py</code>와 <code>router.py</code>같이 루트폴더에 있는 파일들말고 <code>get.py</code>나 <code>post.py</code>같이 서브폴더에 있는 파일에서는 어떻게 모듈들을 사용해야 할까 ?</li>
</ol>
<p>첫번째 문제에 대해서는 저도 맥에서 <code>zip</code>명령어를 사용해서 어떻게 특정 파일/폴더를 빼고 압축을 할수 있는지에 대해서 못찾았습니다.
그래서 그냥 <code>src</code>라는 폴더를 하나 만들어 그 안에서 작업을 하고 해당 폴더 안에서 <code>.zip</code>파일로 패키징해서 올리니 <code>virtualenv</code>관련 파일들은 자연스럽게 빠지게 되었습니다.</p>
<p>두번째 문제에 대해서 부모디렉토리의 모듈에 대해서 접근하는 여러가지 방법을 시도해 봤는데 코드가 많이 지저분해더군요.
코드를 깔끔하게 유지하면서 해결가능한 방법으로는 2가지 정도가 있습니다.</p>
<p><strong>해당 모듈이 사용되는 최하위 폴더에 설치한다.</strong>
이 경우에는 해당 폴더의 상위에서는 모두 사용이 가능합니다.
하지만 그 상위 폴더와 같은 레벨의 다른 폴더에서의 접근은 힘듭니다.
그 폴더에서도 사용하려면 그 폴더내의 어딘가에 또 설치를 하는 방법으로 해결을 해야 합니다.
이 방법은 별로 좋은 방법 같지 않으니 패스하기로 합니다.</p>
<p><strong>최상위 모듈에서 하위 폴더내 모듈에게 전달한다.</strong>
개인적으로 추천하는 방법입니다.
<strong>index.py</strong> 같이 프로그램 내의 시작점에 해당되는 곳에서 사용되는 모든 모듈들의 객체를 선언하여 이것을 하위 폴더내의 모듈을 호출할 때 같이 전달하는 방식입니다.
설명으로만 느낌이 잘 안오실수 있으니 예제 코드로 살펴보겠습니다.</p>
<p>위 <strong>Step 4</strong> 예제를 조금 변경하여 <code>/test</code>경로로 <code>GET</code>방식으로 요청한 경우 쿼리 스트링으로 <code>url</code>값을 받아서 해당 사이트의 내용을 <code>requests</code> 모듈을 이용해서 가져오는 코드로 변경해 보겠습니다.</p>
<p><strong>Step 4</strong>까지 진행되었다는 가정하에 진행할 경우에는 바로 하면 되지만 새로운 폴더에 작업을 하는 경우라면 아래와 같이 <code>virtualenv</code>를 이용한 가상환경으로 들어가서 <code>pip</code>를 로컬로 설치해 주신뒤 코드를 작성해 주세요.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">virtualenv myvenv</div><div class="line">source myvenv/bin/activate</div><div class="line">mkdir src</div><div class="line">cd src</div></pre></td></tr></table></figure></p>
<p>압축할 때 <strong>myvenv</strong>내의 파일들이 같이 압축되지 않도록 작업을 <strong>src</strong>폴더 내에서 하겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir modules</div><div class="line">touch modules/__init__.py</div><div class="line">pip install requests -t modules/</div></pre></td></tr></table></figure></p>
<p>modules을 다른 폴더에서 불러오기 위해서는 해당 폴더내에 <code>__init__.py</code> 파일이 있어야 합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mkdir controllers</div><div class="line">cd controllers</div><div class="line">mkdir test</div><div class="line">touch __init__.py</div><div class="line">cd test</div><div class="line">touch __init__.py</div><div class="line">cd ..</div><div class="line">cd ..</div></pre></td></tr></table></figure></p>
<p><code>index.py</code>에서 <code>requests</code> 모듈에 대한 객체를 선언하여 그것을 <code>/controllers/test/get.py</code>까지 전달하는 코드를 작성해 보겠습니다.</p>
<h4>index.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> modules.requests</div><div class="line"></div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    </div><div class="line">    packages = &#123;&#125;</div><div class="line">    packages[<span class="string">'requests'</span>] = modules.requests</div><div class="line">    </div><div class="line">    result = router(packages, event);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<p><code>router.py</code>에서는 전달받은 <code>packages</code>를 그대로 전달해주는 코드만 추가했습니다.</p>
<h4>router.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> controllers.test.get</div><div class="line"><span class="keyword">import</span> controllers.test.post</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: controllers.test.get.handler,</div><div class="line">        <span class="string">'POST'</span>: controllers.test.post.handler</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(packages, event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(packages, event);</div></pre></td></tr></table></figure></p>
<p><code>post.py</code>에서 외부 모듈을 사용하지는 않지만, 일단 받아줍시다. 공짠데요.</p>
<h4>controllers/test/post.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(packages, event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div></pre></td></tr></table></figure></p>
<p><code>get.py</code>에서는 전달받은 <code>packages</code>에서 <code>requests</code> 객체를 가져와서 사용하는 코드가 추가되었습니다.</p>
<h4>controllers/test/get.py</h4>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(packages, event)</span>:</span></div><div class="line">    requests = packages[<span class="string">'requests'</span>]</div><div class="line">    </div><div class="line">    request_url = event[<span class="string">'queryStringParameters'</span>][<span class="string">'url'</span>]</div><div class="line">    response = requests.get(<span class="string">'http://'</span> + request_url)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'url'</span>: request_url, <span class="string">'text'</span>: response.text &#125; &#125;</div></pre></td></tr></table></figure></p>
<p>이제 <code>index.py</code>가 있는 위치로 와서 압축한 뒤에 <strong>Lambda</strong>에 올려 놓고 테스트 해 보겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure></p>
<p><code>https://본인 Lambda 주소.../prod/test?url=www.naver.com</code> 식으로 브라우저에서 입력하여 결과가 제대로 오는지 확인하시면 됩니다.</p>
<h3>마치며...</h3>
<p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 <strong>Python</strong> 코드를 패키징해서 올리는 방법</li>
<li><strong>vitrualenv</strong>를 활용해서 원하는 폴더에 <strong>pip</strong>로 모듈을 설치하는 방법</li>
<li>로컬에 <strong>pip</strong>로 설치한 모듈들을 서브 폴더내에서도 활용하는 방법</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>참고</h3>
<ul>
<li>AWS 공식 가이드 : <a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/24/Lambda.Packaging.Python/" data-id="cjov28bpr005z5b7bmq6o1gpp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda.Python" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/24/Lambda.Python/" class="article-date">
  <time datetime="2016-11-24T06:54:51.000Z" itemprop="datePublished">2016-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/24/Lambda.Python/">AWS Lambda에 Python Handler 만들기</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>AWS Lambda에 Python Handler 만들기</h1>
<p>AWS Lambda 관련 5번째 포스트 입니다.<br>
지난 글들의 목록은 다음과 같습니다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
</ul>
<p>이번에는 <strong>Python</strong>으로 구현해 보겠습니다.</p>
<h2>Previously on Lambda series</h2>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a>까지 진행되었다는 가정하에 진행하겠습니다.<br>
아직 위 내용들을 보지 않으셨던 분은 아래대로 따라하시면 준비가 끝납니다.</p>
<p>그 과정을 간략하게 살없이 뼈만 간추리면 다음과 같습니다.
관련 내용은 위 포스트 들을 참조해주세요.
그냥 읽어봐서 이해가 안되신다면 한 번 아무생각없이 따라해 보시면 이해가 되실겁니다.</p>
<h3>Create Lambda</h3>
<ul>
<li><code>AWS</code> 로그인 후 <code>Lambda</code> 탭으로 이동</li>
<li><code>Create a Lambda Function</code> 선택</li>
<li>Select blueprint에서 <code>Blank Function</code> 선택</li>
<li>Configure function 에서 일단 바로 <code>Next</code> 선택 (미리 연결할 API Gateway가 있다면 여기서 연결하면 됨)</li>
<li><code>Configure function</code>에서 함수 정의
<ul>
<li>Name : <code>testLambda-luna</code></li>
<li>Runtime : <code>Node.js 4.3</code></li>
<li>Code : 일단 아무거나 입력</li>
<li>Role &amp; Existing role : 일단은 적당히 선택 (만약 Lambda에서 다른 AWS 서비스 RDS, S3 등을 연동할려면 필요)</li>
<li>아래 코드 입력 후 <code>Next</code> 선택</li>
</ul>
</li>
<li><code>Create Function</code> 선택</li>
</ul>
<h3>Set API Gateway</h3>
<ul>
<li><code>AWS</code> 메인 화면으로 이동 후 <code>API Gateway</code> 탭으로 이동</li>
<li><code>Create API</code> 선택
<ul>
<li>API name : <code>testAPI-luna</code></li>
<li><code>Create API</code> 선택</li>
</ul>
</li>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 선택
<ul>
<li><code>Configure as proxy resource</code> 를 체크한 후 <code>Create Resource</code>를 누름</li>
</ul>
</li>
<li><code>ANY</code> 선택
<ul>
<li><code>Integration Request</code> 선택
<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code>
<ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택 후 그냥 <code>prod</code>로 스테이징</li>
</ul>
<h2>Hello Python Lambda Handler</h2>
<p>먼저 가장 기초적인 핸들러를 작성해보록 하죠.</p>
<p>앞서 생성한 <strong>Lambda</strong> 설정에 들어가셔서</p>
<ul>
<li><code>Configuration</code> 탭
<ul>
<li><strong>Runtime</strong> : <code>Python 2.7</code> 선택</li>
<li><strong>Handler</strong> : <code>index.handler</code>라고 되어 있는지 확인</li>
</ul>
</li>
<li><code>Code</code> 탭 으로 와서 아래 코드 입력</li>
</ul>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'event'</span>: str(event), <span class="string">'context'</span>: str(context) &#125;</div></pre></td></tr></table></figure></p>
<p>그런 다음 <strong>API Gateway</strong>의 주소를 브라우저에서 입력하면 오류가 발생합니다.
주소 확인하는 법은 <strong>API Gateway</strong> 설정에서 <strong>Stages</strong>를 눌러서 해당 스테이징(<strong>prod</strong>)를 선택하면 <strong>Invoke URL</strong>에 표시됩니다</p>
<p>그 이유는 현재 <code>{proxy+}</code> 이하로는 <strong>ANY</strong>로 설정된게 있는데 <code>/</code>에는 아무것도 설정된게 없기 때문입니다.</p>
<ul>
<li>좌측 해당 항목에서 <code>Resources</code>로 이동
<ul>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Method</code>를 눌러서 <code>ANY</code>를 생성
<ul>
<li>생성된 <code>ANY</code>를 눌러서
<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code>
<ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
<li><code>Save</code>를 누른 뒤 화면이 바뀌면
<ul>
<li><code>Integration Request</code> 선택</li>
<li><code>Body Mapping Templates</code> 선택
<ul>
<li><code>Add mapping template</code> 선택</li>
<li><code>application/json</code>이라고 입력한 뒤 적용
<ul>
<li><strong>Generate template</strong> : <code>Method Request passthrough</code> 선택</li>
<li><code>Save</code> 선택</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>API Gateway</strong>는 설정 변경 후 반드시 <strong>Deploy</strong>해줘야만 적용됩니다.</p>
<ul>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택 후 그냥 <code>prod</code>로 스테이징</li>
</ul>
<p>이제 다시 <strong>Invoke URL</strong>로 접속하면 뭔가 화면에 결과가 나타나는 것을 볼 수 있습니다.</p>
<p><code>{&quot;event&quot;: &quot;{u'body-json': {}, u'params': {u'path': {}, u'querystring': {}, ...}</code></p>
<p>뭔가 이런 지저분한 모양입니다. <code>u</code>라고 따옴표 앞에 붙은것을 다 지우고 홀따옴표(<code>'</code>)를 쌍따옴표(<code>&quot;</code>)로 수정한 뒤 <strong>JSON</strong> 모양으로 나타내 보면 아래와 같이 됩니다.
우리가 필요한 항목들만 적어봤습니다.</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"event"</span>: &#123;</div><div class="line">    <span class="attr">"body-json"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"params"</span>: &#123;</div><div class="line">      <span class="attr">"path"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"querystring"</span>: &#123;&#125;,</div><div class="line">      <span class="attr">"header"</span>: &#123;</div><div class="line">        <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36"</span>,</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"stage-variables"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"context"</span>: &#123;</div><div class="line">      <span class="attr">"http-method"</span>: <span class="string">"GET"</span>,</div><div class="line">      <span class="attr">"resource-path"</span>: <span class="string">"/"</span>,</div><div class="line">      <span class="attr">"source-ip"</span>: <span class="string">"112.217.228.202"</span>,</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"context"</span>: <span class="string">"&lt;__main__.LambdaContext object at 0x7f629a39aa10&gt;"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Node.JS</strong>와 똑같은 모양으로 나옵니다.<br>
<code>context</code>는 뭔가 <code>dict</code>타입이 아니라서 그대로 출력이 되지 않는군요.
공식문서 (<a href="http://docs.aws.amazon.com/lambda/latest/dg/python-context-object.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/python-context-object.html</a>)를 보시면 <code>context</code> 오브젝트에 대한 자세한 내용이 나옵니다.</p>
<p>이제 기본 <strong>Invoke URL</strong> 뒤에 <code>/test?id=2</code>라고 적은 뒤 브라우저로 요청을 해보겠습니다.</p>
<p>당연히 오류가 발생합니다.</p>
<p><code>{proxy+}</code>로 요청하는 데이터의 형식도 다르며 여기에 대한 응답은 <strong>JSON</strong> 오브젝트 <strong>body</strong>에 <strong>JSON</strong> 형식의 문자열로 전달해야 합니다.</p>
<p><strong>Lambda</strong>쪽 코드를 아래와 같이 수정 후 다시 요청해보면 정상적으로 답변이 오는 것이 확인 됩니다.</p>
<p><strong>POSTMAN</strong>을 통해서 <code>POST</code>로 요청을 해도 정상적으로 답변이 오는 것을 볼 수 있습니다.
(<strong>JSON</strong> 객체형태가 아니기 때문에 출력 형식을 <strong>Text</strong>로 해야 보입니다.)</p>
<p>그래서 JSON 형식으로 응답하도록 코드를 조금 수정해 봤습니다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span> </div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(event) &#125;</div></pre></td></tr></table></figure></p>
<p>이제는 <strong>JSON</strong> 오브젝트로 응답하므로 <strong>POSTMAN</strong>에서도 바로 결과를 볼 수 있습니다.</p>
<h2>Python Routing Example</h2>
<p>조금 더 복잡한 예제를 작성해 보겠습니다.
예제의 내용은 <strong>Node.JS</strong>로 진행한 예제와 같은 것입니다.</p>
<p><code>/test?id=?</code> 라는 주소로 <code>GET</code>, <code>POST</code>요청에 대해서 각각 다른 작업을 하는 코드를 작성해 보겠습니다.</p>
<p>각각 함수에 대한 설명은 <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a> 포스팅을 참고해 주세요.</p>
<p>바로 코드 들어갑니다.</p>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure></p>
<h2>결과 확인</h2>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Node.JS</strong> 와 똑같은 결과로 출력되는 것이 확인 가능합니다.</p>
<h3>마치며...</h3>
<p><strong>Python Packaging</strong>는 나누어서 다음 포스팅에 작성하겠습니다.
간략하게 방법을 설명드리지만 <code>virtualenv</code>로 작업 환경을 만든 뒤 <code>pip install 모듈명 -t 프로젝트폴더</code>로 작업폴더에 모듈을 설치한 뒤 <code>.zip</code>파일로 압축하여 올리시면 됩니다.
(<strong>Node.JS Packaging</strong>과 크게 다르지 않습니다.)</p>
<p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 <strong>Python</strong> 코드로 핸들러 작성</li>
<li><strong>Python</strong>에서 <strong>API Gateway</strong>의 <code>{proxy+}</code>요청에 대하여 구분해서 작업하는 방법</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>참고</h3>
<ul>
<li>AWS 공식 가이드 : <a href="http://docs.aws.amazon.com/lambda/latest/dg/python-programming-model-handler-types.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/python-programming-model-handler-types.html</a></li>
</ul>
<h3>다음글</h3>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/24/Lambda.Python/" data-id="cjov28bpq005v5b7bd2qpd9y2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda+APIGateway.03.Proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/22/Lambda+APIGateway.03.Proxy/" class="article-date">
  <time datetime="2016-11-22T07:54:51.000Z" itemprop="datePublished">2016-11-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/22/Lambda+APIGateway.03.Proxy/">AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기 (3) - Proxy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기 (3)</h1>
<h2>API Gateway Proxy Resource 활용</h2>
<p><strong>API Gateway</strong>에서 각각의 route path(API Gateway에서는 Resource로 불림) 및
http-method(API Gateway에서는 Method로 불림)에 대해서 <strong>Lambda</strong>를 설정하는 것은 여간 번거러운 작업이 아닙니다.
그 경우에 따라 각각 다른 <strong>Lambda</strong>로 연결이 되는 경우라면 당연히 따로 설정을 해야하지만,
하나의 <strong>Lambda</strong>로 연결하는 경우에 대해서라면 필요없는 번거로운 작업이 될 수도 있습니다.
앞 장에서 http-method에 대해서는 <strong>ANY</strong>를 이용해서 같은 <strong>Lambda</strong>로 모두 연결이 가능하도록 작성하였는데,
이번 장에서는 <strong>Proxy Resource</strong>를 이용해서 모든 Resource 및 Method를 같은 Lambda로 연결하는 방법에 대해서 익혀보겠습니다.</p>
<p>전편의 내용을 안다는 가정하에 진행하겠습니다.
처음 이 글부터 보시는 분들은 아래 Link에서 내용을 숙지한 후에 진행해 주세요.</p>
<ul>
<li>Lambda 와 API Gateway 연동 #1 (GET, POST) : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md</a></li>
<li>Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route) : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md</a></li>
</ul>
<h2>API Gateway 에 Proxy Resource 등록</h2>
<p>먼저 <strong>API Gateway</strong>에 등록된 모든 Resource 및 Method를 삭제한 뒤 다음 단계로 진행해주세요.</p>
<ul>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 선택
<ul>
<li><code>Configure as proxy resource</code> 를 체크한 후 <code>Create Resource</code>를 누름</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.proxy.01.png?raw=true&quot;&gt;</p>
<p>그럼 다음 그림과 같이 설정 됩니다.</p>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.proxy.02.png?raw=true&quot;&gt;</p>
<ul>
<li><code>ANY</code> 선택
<ul>
<li><code>Integration Request</code> 선택
<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code>
<ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>모든 설정이 끝났습니다.<br>
앞에서 해왔던 설정 중 mapping template를 설정하지 않았습니다.<br>
해당 설정을 하는 곳을 찾지 못했습니다.<br>
그게 없으면 요청이 어떤 모양으로 오는지 알기 힘든데...<br>
그냥 <strong>Lambda</strong>에서 출력해 보겠습니다.</p>
<p><strong>API Gateway</strong>를 수정했으면 ???<br>
잊지말고 <strong>Deploy</strong>를 해줘야 적용됩니다.</p>
<ul>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택 후 그냥 <code>prod</code>로 스테이징</li>
</ul>
<h2>Lambda에서 요청을 그대로 출력</h2>
<p>2편에서 작성한 코드를 그대로 두고 우선 실행해보도록 하겠습니다.
<strong>API Gateway</strong>의 <strong>Invoke URL</strong>을 그대로 브라우저에서 입력하니 오류가 발생합니다.</p>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"message"</span>:<span class="string">"Missing Authentication Token"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>어라... 안되네요.</p>
<p>다른 분에게 도움을 요청하였더니, body에 JSON 형식의 string을 담아서 응답을 보내야 한다고 합니다.
네. 그렇답니다...</p>
<p><a href="http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html" target="_blank" rel="external">http://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-set-up-simple-proxy.html</a></p>
<p>위 공식문서에 가면 자세한 내용이 있습니다.</p>
<p>그래서 다음과 같이 <strong>hander</strong>를 수정 후 실행해 보았습니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   <span class="comment">//let result = &#123;"event" : event, "context" : context&#125;</span></div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>결과는 똑같이 안됩니다. ;;;<br>
음... 그냥 요청을 그대로 출력해 보겠습니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="comment">//let result = router(event, context);</span></div><div class="line">   <span class="keyword">let</span> result = &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>왜 안될까 생각을 해보니... <strong>API Gateway</strong>상에 설정을 보면 <code>/</code>에는 아무런 method가 추가되어 있지 않고 <code>/{proxy+}</code>에 <strong>ANY</strong>가 등록되어 있습니다.
<strong>Invoke URL</strong>에 뭐라도 더 붙여서 보내니깐 정상적으로 동작합니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://..../prod/test</div></pre></td></tr></table></figure></p>
<p>뭔가 답변이 나옵니다.
좀 더 다양한 정보를 보기 위해서 쿼리스트링도 포함하여 보낸 다음 <strong>JSON</strong>을 살펴보도록 하겠습니다.</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://..../prod/test?id=123;name=Luna</div></pre></td></tr></table></figure></p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "event": &#123;</div><div class="line">        "resource": "/&#123;proxy+&#125;",</div><div class="line">        "path": "/test",</div><div class="line">        "httpMethod": "GET",</div><div class="line">        "headers": &#123;</div><div class="line">            ...</div><div class="line">            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36",</div><div class="line">        &#125;,</div><div class="line">        "queryStringParameters": &#123;</div><div class="line">            "name": "Luna",</div><div class="line">            "id": "123"</div><div class="line">        &#125;,</div><div class="line">        "pathParameters": &#123;</div><div class="line">            "proxy": "test"</div><div class="line">        &#125;,</div><div class="line">        "stageVariables": null,</div><div class="line">        "requestContext": &#123;</div><div class="line">            ...</div><div class="line">            &#125;,</div><div class="line">            "resourcePath": "/&#123;proxy+&#125;",</div><div class="line">            "httpMethod": "GET",</div><div class="line">        &#125;,</div><div class="line">        "body": null,</div><div class="line">        "isBase64Encoded": false</div><div class="line">    &#125;,</div><div class="line">    "context": &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2장 라우팅에서 사용한 변수들의 이름이 바뀌어 있습니다.
위 모양을 보고 그대로 수정을 해주면 되겠네요.
<strong>POST</strong>로 <strong>body</strong>값을 추가하여 보내보도록 하겠습니다.</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "resource": "/&#123;proxy+&#125;",</div><div class="line">    "path": "/test",</div><div class="line">    "httpMethod": "POST",</div><div class="line">    ...</div><div class="line">    "queryStringParameters": &#123;</div><div class="line">      "name": "Luna",</div><div class="line">      "id": "123"</div><div class="line">    &#125;,</div><div class="line">    "pathParameters": &#123;</div><div class="line">      "proxy": "test"</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">    "body": "&#123;\n  \"id\": \"123\",\n  \"age\": \"25\"\n&#125;",</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>Lambda 코드 수정</h2>
<p>위 결과를 보고 2장과 똑같은 기능을 하도록 <strong>Lambda</strong> 쪽의 <strong>Node.JS</strong>코드를 수정하려고 생각해보니
<code>/test/{userId}</code>와 같이 path parameter를 감안하여 path를 생성해주지 않으므로 그대로는 사용을 못하겠고 다르게 처리를 해줘야 합니다.
path parameter를 사용하지 않고 query string을 이용하는 방법도 있겠구요. 아니면 해당 패턴이 되도록 비교문을 이용해서 라우팅해야 합니다.</p>
<p>편의상 query string을 사용하도록 수정하였으며 <code>/</code>로 접근하던 부분은 삭제하였습니다.
코드에 대한 자세한 설명은 2장 포스팅을 참조해 주세요.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">userId</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">userId, header, body</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/test'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.queryStringParameters.id;</div><div class="line">      <span class="keyword">return</span> get(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.queryStringParameters.id;</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(event.body);</div><div class="line">      <span class="keyword">const</span> header =  event.headers;</div><div class="line">      <span class="keyword">return</span> post(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.path][event.httpMethod];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>결과 확인</h2>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>마치며...</h2>
<p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>API Gateway</strong>에서 **{proxy+}**를 여러가지 <strong>path</strong>와 <strong>http-method</strong> 요청을 하나의 <strong>Lambda</strong>로 요청하는 방법</li>
<li>**{proxy+}**로 접근할 경우 <strong>Lambda</strong>에서 필요한 요청값들의 변수명</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>다음글</h3>
<ul>
<li>Lambda Node.JS Packaging : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/22/Lambda+APIGateway.03.Proxy/" data-id="cjov28bpk005c5b7bdqtq1maz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-JS/">Node.JS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda+APIGateway.02.Route" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/22/Lambda+APIGateway.02.Route/" class="article-date">
  <time datetime="2016-11-22T06:54:51.000Z" itemprop="datePublished">2016-11-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/22/Lambda+APIGateway.02.Route/">AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기 (2) - Route</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기 (2)</h1>
<h2>Routing 예제</h2>
<p>Web API를 구현하기 위해서는 여러가지 URL에 대해서 각각 다른 기능을 구현하는것은 필수적입니다.
각각의 URL을 별도의 Lambda로 구현하여 API Gateway에서 연결하는 방법도 있지만 하나의 Lambda에서 처리하는 방법에 대해서 알아 보도록 하겠습니다.
이번에는 전편과는 다르게 약간의 설명을 하면서 진행하겠습니다.
전편의 내용을 안다는 가정하에 진행하겠습니다.
처음 이 글부터 보시는 분들은 아래 Link에서 내용을 숙지한 후에 진행해 주세요.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md</a></p>
<h2>API Gateway 설정</h2>
<p>아래와 같이 API Gateway를 설정해 주세요.</p>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.route.01.png?raw=true&quot;&gt;</p>
<p>1편에서 설정한 Path를 그대로 두셔도 되지만, <strong>ANY</strong> 에 대해서 연습할겸 모든 Resource, Method를 삭제한 후 다음 단계대로 추가해 주세요.</p>
<p><strong>ANY</strong>는 모든 http-method (GET, POST, PUT, DELETE, ...) 를 모두 같은 Lambda로 연결하게 해주는 역할을 합니다.
<strong>ANY</strong>와 같은 위치에 다른 method를 추가하면 그것을 제외한 나머지에 대해서만 <strong>ANY</strong>로 연결합니다.
(ex. <strong>ANY</strong>, <strong>GET</strong>을 같은 위치에 선언하면 <strong>GET</strong>을 제외한 나머지 연결에 대해서는 <strong>ANY</strong>가 처리)</p>
<ul>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Method</code>를 눌러서 <code>ANY</code>를 생성</li>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 눌러서 <code>test</code>를 추가</li>
<li><code>/test</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 눌러서 <code>{userId}</code>를 추가</li>
<li><code>/{userId}</code>에서 <code>Actions</code> -&gt; <code>Create Method</code>를 눌러서 <code>ANY</code>를 생성</li>
</ul>
<p>위까지 한 다음에 <code>ANY</code>로 된 2 곳을 각각 눌러서</p>
<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code>
<ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
</ul>
</li>
<li><code>Save</code>를 누른 뒤 화면이 바뀌면</li>
<li><code>Integration Request</code> 선택
<ul>
<li><code>Body Mapping Templates</code> 선택
<ul>
<li><code>Add mapping template</code> 선택
<ul>
<li><code>application/json</code>이라고 입력한 뒤 적용
<ul>
<li><strong>Generate template</strong> : <code>Method Request passthrough</code> 선택</li>
<li><code>Save</code> 선택</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>API Gateway</strong>는 수정한 후 반드시 Deploy를 해주어야만 적용이 됩니다.
<code>Actions</code> -&gt; <code>Deploy API</code>를 선택하면 <strong>Deployment stage</strong>를 입력하여야하는데 기존에 동일한 이름으로 하면 해당 설정을 덮어쓰게 되며,
<code>[New Stage]</code>를 선택한 후 다른 이름을 입력하면 기존의 설정상태를 남겨둔체 새로운 이름으로 생성이 가능합니다.
앞에서의 예제에서 <strong>prod</strong>로 생성을 하였는데 이번에는 <code>test</code>로 생성해 보겠습니다.
<code>[New Stage]</code>를 선택한 후 <code>test</code>를 입력하고 <code>Deploy</code> 버튼을 누릅니다.</p>
<p><code>Invoke URL</code>에 연결가능한 주소가 나오는데, 기존과 달라진 점이 마지막에 <strong>/prod</strong> 대신에 <strong>/test</strong>가 붙었다는것 밖에 없습니다.
브라우저에서 해당 주소로 접속을 하면 2가지 주소가 다 동작한다는 것이 확인됩니다.
<strong>API Gateway</strong> 상에서도 <strong>Stages</strong> 메뉴로 들어가서 각각의 스테이징 명칭을 누르면 설정된 내용들을 볼 수 있습니다.</p>
<h2>Lambda 의 Node.JS 코드 수정</h2>
<p><strong>API Gateway</strong>에서 여러 경로로 들어오면 요청들을 모두 하나의 <strong>Lambda</strong>로 연결하였으니,
이젠 <strong>Lambda</strong> 상에서 여러 경로에 대해서 각각 다른 기능을 하도록 구현해보겠습니다.</p>
<p>가장 중요한 것이 어떤 경로(<code>resource-path</code>)로 들어왔는지 어떤 메서드(<code>http-method</code>)로 요청했는지에 대해서 알아야 합니다.
<strong>JSON object</strong>로 전달된 <code>event</code> 안에 2가지 정보가 모두 있는데
각각의 위치가 <code>event.context.resource-path</code> 와 <code>event.context.http-method</code>에 있습니다.
그런데 <strong>-</strong>(dash)가 포함된 명칭이 있어서 <strong>.</strong>(dot)을 이용하여 읽으려면 오류가 발생하므로
<code>event.context[&quot;resource-path&quot;]</code> , <code>event.context[&quot;http-method&quot;]</code> 식으로 접근해야 합니다.
<strong>API Gateway</strong>에서의 template에서 <strong>-</strong>(dash)가 없는 명칭으로 수정한 뒤  <strong>.</strong>(dot)을 이용하여 읽어도 됩니다만
일단 여기서는 기본설정 그대로 진행하겠습니다.</p>
<p>3가지 경로에 대해서 각각 기능을 구현해보겠습니다.</p>
<ul>
<li><code>/</code>로 <code>GET</code> 요청 : 요청한 <strong>JSON Object</strong>를 그대로 응답</li>
<li><code>/test/{userId}</code>로 <code>GET</code> 요청 : **{ id: userId, name: &quot;test&quot; }**로 응답</li>
<li><code>/test/{userId}</code>로 <code>POST</code> 요청 : **{ id: userId, header: header, body: body }**로 응답</li>
</ul>
<p>먼저 위 3가지 기능에 대해서 각각 구현을 해보겠습니다.</p>
<p><code>/</code>로 <code>GET</code> 요청에 대해서는 앞 장에서 사용했던 코드 그대로 전달을 하면 됩니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;;</div></pre></td></tr></table></figure></p>
<p><code>/test/{userId}</code>로 <code>GET</code>, <code>POST</code> 요청에 대해서는 각각 <code>get</code>, <code>post</code>라는 이름의 함수로 생성하겠습니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">userId</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">userId, header, body</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>다음 순서로 위 3가지 기능을 담은 <strong>Map</strong>을 생성하겠습니다.
<strong>JavaScript</strong>이기 때문에 그냥 간단하게 <strong>JSON Object</strong>형식으로 생성을 하면 됩니다.
<code>event.context[&quot;resource-path&quot;]</code> -&gt; <code>event.context[&quot;http-method&quot;]</code> -&gt; <code>각각의 기능</code> 순서대로 접근하면 되도록 생성하였습니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">let</span>  result = &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">'/test/&#123;userId&#125;'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.params.path.userId;</div><div class="line">      <span class="keyword">return</span> get(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.params.path.userId;</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(event[<span class="string">"body-json"</span>]);</div><div class="line">      <span class="keyword">const</span> header =  event.params.header;</div><div class="line">      <span class="keyword">return</span> post(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>이제 실질적으로 <strong>Router</strong>기능을 수행하는 함수를 생성해 보겠습니다.
<code>event</code>와 <code>context</code>를 전달받아 <code>routeMap</code>에서 해당 기능들을 수행하고 그 결과를 다시 전달하는게 이 함수 기능의 전부입니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.context[<span class="string">"resource-path"</span>]][event.context[<span class="string">"http-method"</span>]];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>이제 모든 기능 구현은 끝났습니다.
<strong>Lambda</strong>의 진입점인 <code>exports.handler</code>에서 <code>router</code> 함수를 호출해주기만 하면 됩니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>전체 코드</h3>
<p>앞에 설명한 내용들을 실제 소스코드로 작성하면 아래와 같이 됩니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">userId</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">userId, header, body</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">let</span>  result = &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">'/test/&#123;userId&#125;'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.params.path.userId;</div><div class="line">      <span class="keyword">return</span> get(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = event.params.path.userId;</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(event[<span class="string">"body-json"</span>]);</div><div class="line">      <span class="keyword">const</span> header =  event.params.header;</div><div class="line">      <span class="keyword">return</span> post(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.context[<span class="string">"resource-path"</span>]][event.context[<span class="string">"http-method"</span>]];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Lambda</strong>에 위 코드를 입력한 후 저장하면 됩니다.</p>
<h2>결과 확인</h2>
<p><strong>API Gateway</strong>의 <strong>Invoke URL</strong>을 이용하여 호출하여 그 결과값을 확인해 보겠습니다.</p>
<ul>
<li><code>/</code>로 <code>GET</code> 요청 : <strong>Invoke URL</strong> 을 브라우저에 입력</li>
</ul>
<p>요청 JSON을 그대로 응답한 것으로, 앞장에서 살펴본 예제의 결과와 동일하게 나옵니다.</p>
<ul>
<li><code>/test/{userId}</code>로 <code>GET</code> 요청 : <strong>Invoke URL</strong>에 <code>/test/LunaStar</code>를 붙여서 브라우저에 입력</li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"body"</span>: &#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="string">"LunaStar"</span>,</div><div class="line">    <span class="attr">"name"</span>: <span class="string">"test"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>/test/{userId}</code>로 <code>POST</code> 요청 : <strong>POSTMAN</strong>에서 <strong>Invoke URL</strong>에 <code>/test/LunaStar</code>를 붙이고 적당히 header, body를 입력하여 요청</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "LunaStar",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "&#123;\"id\":\"123\",\"age\":\"25\"&#125;"</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>마치며...</h3>
<p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>API Gateway</strong>에서 <strong>ANY</strong>를 이용해서 여러가지 <strong>http-method</strong> 요청을 하나의 <strong>Lambda</strong>로 요청하는 방법</li>
<li><strong>API Gateway</strong>에서 <strong>Staging</strong>을 나누어 <strong>Deploy</strong>하여 각각의 <strong>Staging</strong>으로 접근하는 방법</li>
<li><strong>Lambda</strong>내에서 요청한 <strong>URL</strong> 및 <strong>http-method</strong> 별로 다른 작업을 하는 <strong>Node.JS</strong> 코드 작성법</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>다음글</h3>
<ul>
<li>Lambda 와 API Gateway 연동 #3 (Proxy Resource) : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/22/Lambda+APIGateway.02.Route/" data-id="cjov28bpi00585b7b0ozyq6d8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-JS/">Node.JS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Lambda+APIGateWay.01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/22/Lambda+APIGateWay.01/" class="article-date">
  <time datetime="2016-11-22T05:54:51.000Z" itemprop="datePublished">2016-11-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/AWS/">AWS</a>►<a class="article-category-link" href="/categories/AWS/Lambda/">Lambda</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/22/Lambda+APIGateWay.01/">AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기</h1>
<p><strong><a href="https://aws.amazon.com/ko/lambda/details" target="_blank" rel="external">AWS Lambda</a></strong> 란 코드를 AWS 내에 올려두고 필요할 때에만 해당 코드를 실행해주는 서비스를 말합니다.
서버를 24시간 가동시키게 아니라, 그냥 해당 코드가 실행되면서 사용하는 컴퓨팅 시간에 대해서만 과금을 하는 방식입니다.
즉, 서버없이 서비스를 할 수 있는 편리한 구조면서도 실제로 코드가 동작하는 만큼만 과금이 되다보니 보통의 경우 서버를 띄워놓는거보다 훨씬 저렴한 비용으로 서비가 가능하며 스케일링에 대한 관리를 해줄 필요가 없습니다.</p>
<p>람다에 올려둔 코드는 AWS 내의 다른 서비스에서 이벤트 형식으로 해당 코드가 실행되게 할 수 있는데, <strong><a href="https://aws.amazon.com/ko/api-gateway" target="_blank" rel="external">API Gateway</a></strong> 를 붙이면 웹서비스로 활용이 가능합니다.</p>
<p>이 두가지 AWS의 서비스를 이용해서 서버없이 API 서비스를 구축하는 튜토리얼을 진행하겠습니다. 아무 생각없이 그냥 따라하시다 보면 그 과정과 원하는 값을 전달하고 받는 것에 대해서 이해가 되실 겁니다.</p>
<h2>Lambda 생성</h2>
<ul>
<li><code>AWS</code> 로그인 후 <code>Lambda</code> 탭으로 이동</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.01.png?raw=true&quot;&gt;</p>
<ul>
<li><code>Create a Lambda Function</code> 선택</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.02.png?raw=true&quot;&gt;</p>
<ul>
<li>Select blueprint에서 <code>Blank Function</code> 선택</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.03.png?raw=true&quot;&gt;</p>
<ul>
<li>Configure function 에서 일단 바로 <code>Next</code> 선택 (미리 연결할 API Gateway가 있다면 여기서 연결하면 됨)</li>
<li><code>Configure function</code>에서 함수 정의
<ul>
<li>Name : <code>testLambda-luna</code></li>
<li>Runtime : <code>Node.js 4.3</code></li>
<li>Code : 아래 코드를 입력
<ul>
<li>참고로 <code>callback(null, result);</code>와 <code>context.succeed(result);</code>는 둘 다 결과를 return 해주는 코드로 아무거나 사용해도 됨</li>
</ul>
</li>
<li>Role &amp; Existing role : 일단은 적당히 선택 (만약 Lambda에서 다른 AWS 서비스 RDS, S3 등을 연동할려면 필요)</li>
<li>아래 코드 입력 후 <code>Next</code> 선택</li>
</ul>
</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> result = &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;</div><div class="line">    context.succeed(result);</div><div class="line">    <span class="comment">//callback(null, result);</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>Create Function</code> 선택</li>
<li><code>Action</code> -&gt; <code>Configure test event</code> 선택</li>
<li>원하는 값으로 수정 후 <code>Save and test</code> 선택하면 아래와 같이 나옴.</li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"event"</span>: &#123;</div><div class="line">    <span class="attr">"key3"</span>: <span class="string">"value3"</span>,</div><div class="line">    <span class="attr">"key2"</span>: <span class="string">"value2"</span>,</div><div class="line">    <span class="attr">"key1"</span>: <span class="string">"value1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"context"</span>: &#123;</div><div class="line">    <span class="attr">"callbackWaitsForEmptyEventLoop"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"logGroupName"</span>: <span class="string">"/aws/lambda/testLambda-luna"</span>,</div><div class="line">    <span class="attr">"logStreamName"</span>: <span class="string">"2016/11/16/[$LATEST]3906ef41b5df4f1d89c6501dda78253c"</span>,</div><div class="line">    <span class="attr">"functionName"</span>: <span class="string">"testLambda-luna"</span>,</div><div class="line">    <span class="attr">"memoryLimitInMB"</span>: <span class="string">"128"</span>,</div><div class="line">    <span class="attr">"functionVersion"</span>: <span class="string">"$LATEST"</span>,</div><div class="line">    <span class="attr">"invokeid"</span>: <span class="string">"be8f2961-aba7-11e6-8ffb-6d91b83819cf"</span>,</div><div class="line">    <span class="attr">"awsRequestId"</span>: <span class="string">"be8f2961-aba7-11e6-8ffb-6d91b83819cf"</span>,</div><div class="line">    <span class="attr">"invokedFunctionArn"</span>: <span class="string">"arn:aws:lambda:ap-northeast-1:768556645518:function:testLambda-luna"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>만약 <code>name</code>이란 값을 <code>event</code>로 넘겨서 <code>Hello</code> + <code>name</code> 을 출력하고 싶다면 위 Lambda Code를 아래와 같이 수정</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> result = &#123;<span class="string">"event"</span> : event, <span class="string">"context"</span> : context&#125;</div><div class="line">    <span class="keyword">let</span> name = event.name || <span class="string">'no name'</span>;</div><div class="line">    context.succeed(<span class="string">'Hello '</span> + name);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<ul>
<li>그런 다음 <code>Configure test event</code>에 <code>name</code>을 넣어주면 아래와 같이 출력됨.</li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"name"</span> : <span class="string">"Luna"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;Hello Luna&quot;</div></pre></td></tr></table></figure></p>
<h2>API Gateway 생성 &amp; Lambda 연결</h2>
<ul>
<li><code>AWS</code> 메인 화면으로 이동 후 <code>API Gateway</code> 탭으로 이동</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.04.png?raw=true&quot;&gt;</p>
<ul>
<li><code>Create API</code> 선택
<ul>
<li>API name : <code>testAPI-luna</code></li>
<li><code>Create API</code> 선택</li>
</ul>
</li>
<li><code>Actions</code> -&gt; <code>Create Resource</code> 선택 (API Path를 추가)
<ul>
<li>Resource name : <code>test</code></li>
<li>Resource Path : <code>test</code></li>
<li><code>Create Resource</code> 선택</li>
</ul>
</li>
<li><code>/test</code>가 선택된 상태에서 <code>Actions</code> -&gt; <code>Create Resource</code> 선택
<ul>
<li>Resource name : <code>name</code></li>
<li>Resource Path : <code>{name}</code> (Path Variable 추가)</li>
<li><code>Create Resource</code> 선택</li>
</ul>
</li>
<li><code>/{name}</code>이 선택된 상태에서 <code>Actions</code> -&gt; <code>Create Method</code> 선택
<ul>
<li><code>GET</code> 선택 후 확인
<ul>
<li>Lambda Region : 람다를 생성한 region 선택</li>
<li>Lambda Function : <code>testLambda-luna</code> (좀 전에 생성한 람다명 입력)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.05.png?raw=true&quot;&gt;</p>
<ul>
<li><code>Integration Request</code> 선택
<ul>
<li><code>Body Mapping Templates</code> 선택
<ul>
<li><code>Add mapping template</code> 선택
<ul>
<li><code>application/json</code> 입력
<ul>
<li><code>No, use current settings</code> 선택</li>
</ul>
</li>
<li>Generate template: <code>Method Request passthrough</code> 선택
<ul>
<li><code>Save</code> 선택</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>/test/{name} [GET]</code> 선택
<ul>
<li><code>TEST</code> 선택
<ul>
<li>Path {name} : 원하는 값 입력</li>
<li><code>Test</code> 버튼 선택</li>
<li>아래와 같이 출력되면 성공</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "body-json": &#123;&#125;,</div><div class="line">    "params": &#123;</div><div class="line">      "path": &#123;</div><div class="line">        "name": "Luna"</div><div class="line">      &#125;,</div><div class="line">      "querystring": &#123;&#125;,</div><div class="line">      "header": &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    "stage-variables": &#123;&#125;,</div><div class="line">    "context": &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "context": &#123;</div><div class="line">    "callbackWaitsForEmptyEventLoop": true,</div><div class="line">    "logGroupName": "/aws/lambda/testLambda-luna",</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>배포</h2>
<ul>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택
<ul>
<li>Deployment Stage : <code>[New Stage]</code> 선택</li>
<li>Stage name : <code>prod</code> 입력</li>
<li><code>Deploy</code> 버튼 선택</li>
<li><code>Invoke URL</code> 복사</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.06.png?raw=true&quot;&gt;</p>
<h2>테스트</h2>
<ul>
<li><code>Invoke URL</code> + <code>/test/luna</code> 로 Web Browser에서 주소 입력</li>
<li>위 <strong>JSON</strong> 같은 모양으로 출력되면 성공</li>
<li><code>Invoke URL</code> + <code>/test/luna?id=345;dept=개발팀</code>과 같이 <strong>QueryString</strong> 을 포함하여 호출
<ul>
<li>아래와 같이 <strong>querystring</strong> 에서 확인되면 성공</li>
</ul>
</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "body-json": &#123;&#125;,</div><div class="line">    "params": &#123;</div><div class="line">      "path": &#123;</div><div class="line">        "name": "Luna"</div><div class="line">      &#125;,</div><div class="line">      "querystring": &#123;</div><div class="line">        "dept": "개발팀",</div><div class="line">        "id": "345"</div><div class="line">      &#125;,</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>POST로 배포</h2>
<ul>
<li><code>API Gateway</code>에 <code>testAPI-luna</code>로 이동</li>
<li><code>/{name}</code>이 선택된 상태에서 <code>Actions</code> -&gt; <code>Create Method</code> 선택
<ul>
<li><code>POST</code> 선택 후 확인
<ul>
<li>Lambda Region : 람다를 생성한 region 선택</li>
<li>Lambda Function : <code>testLambda-luna</code></li>
</ul>
</li>
<li>바로 <code>Test</code> 버튼을 눌러서 확인
<ul>
<li>Path {name} : 원하는 값 입력</li>
<li>Request Body에 아래 <strong>JSON</strong> 값 입력</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"id"</span>: <span class="string">"123"</span>,</div><div class="line">  <span class="attr">"age"</span>: <span class="string">"25"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>결과</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "id": "123",</div><div class="line">    "age": "25"</div><div class="line">  &#125;,</div><div class="line">  "context": &#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><code>name</code> 값이 정상적으로 전달되지 않았으므로 <code>GET</code> 작업한것 처럼 <strong>template</strong> 설정
<ul>
<li><code>Integration Request</code> 선택
<ul>
<li><code>Body Mapping Templates</code> 선택
<ul>
<li><code>Add mapping template</code> 선택
<ul>
<li><code>application/json</code> 입력
<ul>
<li><code>No, use current settings</code> 선택</li>
</ul>
</li>
<li>Generate template: <code>Method Request passthrough</code> 선택
<ul>
<li><code>Save</code> 선택</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>Test</code> 로 들어가서 위와 같은 <code>JSON</code> 입력</li>
</ul>
</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "body-json": &#123;</div><div class="line">      "id": "123",</div><div class="line">      "age": "25"</div><div class="line">    &#125;,</div><div class="line">    "params": &#123;</div><div class="line">      "path": &#123;</div><div class="line">        "name": "Luna"</div><div class="line">      &#125;,</div><div class="line">      "querystring": &#123;&#125;,</div><div class="line">      "header": &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>다시 배포</h2>
<ul>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택
<ul>
<li>Deployment Stage : <code>[New Stage]</code> 선택</li>
<li>Stage name : <code>prod</code> 입력</li>
<li><code>Deploy</code> 버튼 선택</li>
<li><code>Invoke URL</code> 복사</li>
</ul>
</li>
</ul>
<h2>Postman 을 통해서 테스트</h2>
<ul>
<li>만약 설치되지 않았다면, Chrome App <code>Postman</code> 설치 후 실행</li>
<li><code>POST</code> 메서드로 선택</li>
<li>주소에 <code>Invoke URL</code> + <code>/test/luna?id=345</code> 입력</li>
<li><code>Headers</code> 탭 선택
<ul>
<li><code>headerValue1</code> : <code>123</code> 입력</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.07.png?raw=true&quot;&gt;</p>
<ul>
<li><code>Body</code> 탭 선택
<ul>
<li>위 예제의 <strong>JSON</strong> 입력</li>
</ul>
</li>
</ul>
<p>&lt;img src=&quot;https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda_apigateway.08.png?raw=true&quot;&gt;</p>
<ul>
<li><code>Send</code> 선택</li>
<li>결과</li>
</ul>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "event": &#123;</div><div class="line">    "body-json": &#123;</div><div class="line">      "id": "123",</div><div class="line">      "age": "25"</div><div class="line">    &#125;,</div><div class="line">    "params": &#123;</div><div class="line">      "path": &#123;</div><div class="line">        "name": "luna"</div><div class="line">      &#125;,</div><div class="line">      "querystring": &#123;</div><div class="line">        "id": "345"</div><div class="line">      &#125;,</div><div class="line">      "header": &#123;</div><div class="line">        "Accept": "*/*",</div><div class="line">        "Accept-Encoding": "gzip, deflate, br",</div><div class="line">        "Accept-Language": "ko-KR,ko;q=0.8,en-US;q=0.6,en;q=0.4",</div><div class="line">        ...</div><div class="line">        "Content-Type": "application/json",</div><div class="line">        "headerValue1": "123",</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    "stage-variables": &#123;&#125;,</div><div class="line">    "context": &#123;</div><div class="line">      ...</div><div class="line">      "http-method": "POST",</div><div class="line">      ...</div><div class="line">      "source-ip": "112.217.228.202",</div><div class="line">      "user": "",</div><div class="line">      "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36",</div><div class="line">      ...</div><div class="line">      "resource-path": "/test/&#123;name&#125;"</div><div class="line">    &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  "context": &#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>활용</h2>
<ul>
<li><code>Lambda</code>에서 전달받은 값 활용
<ul>
<li><code>event</code>
<ul>
<li><code>body-json</code> : BODY에서 전달해온 값</li>
<li><code>params</code>
<ul>
<li><code>path</code> : URL 상에서 경로로 얻어오는 변수들</li>
</ul>
</li>
<li><code>header</code> : HEADER에서 전달해온 값</li>
<li><code>querystring</code> : URL 상의 QueryString로 전달된 변수들</li>
<li><code>context</code>
<ul>
<li><code>http-method</code> : 호출한 METHOD (GET, POST, ...)</li>
<li><code>resource-path</code> : 하나의 Lambda에서 여러 URL을 처리할 경우 경로 정보</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>참고</h2>
<ul>
<li>아웃사이더님 Blog : <a href="https://blog.outsider.ne.kr/1205" target="_blank" rel="external">https://blog.outsider.ne.kr/1205</a> , <a href="https://blog.outsider.ne.kr/1206" target="_blank" rel="external">https://blog.outsider.ne.kr/1206</a></li>
<li>AWS : <a href="http://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html" target="_blank" rel="external">http://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html</a></li>
</ul>
<ul>
<li>원문 : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md</a></li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="external">seokjoon.yun@gmail.com</a></p>
<h3>다음글</h3>
<ul>
<li>Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route) : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/22/Lambda+APIGateWay.01/" data-id="cjov28bph00545b7bmseazn6w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/APIGateway/">APIGateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AWS/">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lambda/">Lambda</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-JS/">Node.JS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JavaScript.Squel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/08/JavaScript.Squel/" class="article-date">
  <time datetime="2016-11-07T15:00:00.000Z" itemprop="datePublished">2016-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>►<a class="article-category-link" href="/categories/JavaScript/Node-JS/">Node.JS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/08/JavaScript.Squel/">Squel.js</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Squel.js</h1>
<p><strong>JavaScript</strong> 의 <code>SQL query string</code>의 작성을 도와주는 package 입니다.
<strong>C#</strong> 의 <code>LINQ</code>와 비슷한 형식으로 함수들의 체인을 이용해서 정의하면 해당 기능을 동작하는 <code>query string</code>을 작성해 줍니다.</p>
<p>단순히 <code>query string</code>만을 만들어 주는 역할만을 합니다.
이게 장점일수도 단점일수도 있는데, <strong>C#</strong> 의 <code>LINQ</code>의 경우에는 <code>Inline View</code>나 <code>Subquery</code>, <code>JOIN</code>을 표현하기가 상당히 복잡했습니다. 그래서 단순한 문장이 아닌 경우는 그냥 <code>raw query</code>로 작성하는게 더 편했습니다.
하지만 <code>squel</code>의 경우에는 어차피 결과물은 <code>String</code>이기 때문에 이것들을 잘 조합하면 얼마든지 복잡한 문장도 표현이 가능합니다.</p>
<p>여기에서는 자주 사용되는 간단한 예제들을 중심으로 소개를 드릴 예정이며,
자세한 내용은 공식 사이트 <a href="https://hiddentao.com/squel" target="_blank" rel="external">https://hiddentao.com/squel</a> 를 참조해주세요.</p>
<h2>설치</h2>
<h3>Node.js</h3>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install squel</div></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> squel = <span class="built_in">require</span>(<span class="string">"squel"</span>);</div></pre></td></tr></table></figure></p>
<h3>Browser</h3>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/your/path/to/squel.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="built_in">console</span>.log( squel.VERSION );    <span class="comment">/** version string **/</span></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2>사용법</h2>
<h3>SELECT 문장</h3>
<ul>
<li>
<p><code>select()</code> : <strong>SELECT</strong> 에 대한 query builder 인스턴스를 생성합니다.</p>
</li>
<li>
<p><code>from(&quot;table&quot;, alias = null)</code> : <strong>FROM</strong> 절에 해당하는 테이블을 지정합니다. <code>alias</code> 생략 가능</p>
</li>
<li>
<p><code>field(&quot;column&quot;)</code> : 읽어올 컬럼들을 지정합니다. <code>field</code>절을 실행한 순서대로 왼쪽부터 출력됩니다.</p>
</li>
<li>
<p><code>where(&quot;condition&quot;)</code> : <strong>WHERE</strong> 절 조건을 지정합니다.</p>
</li>
<li>
<p><code>distinct()</code> : <strong>DISTINCT</strong> 한 결과로 출력합니다. (중복제거)</p>
</li>
<li>
<p><code>order(&quot;column&quot;, ASC = true)</code> : <strong>ORDER BY</strong> 절에 해당하는 sorting연산을 수행합니다. <code>order</code>절을 수행한 순서대로 왼쪽부터 기술되며 <strong>ASC</strong>, <strong>DESC</strong> 여부를 2번째 인자에 <code>true</code>,<code>false</code>로 전달이 가능합니다.</p>
</li>
<li>
<p><code>group()</code> : <strong>GROUP BY</strong> 절에 해당하는 그룹화 기능을 수행합니다.</p>
</li>
<li>
<p><code>having(&quot;condition&quot;)</code> : <strong>HAVING</strong> 절에 해당하는 조건을 지정합니다.</p>
</li>
<li>
<p><code>limit(number)</code> : <strong>TOP-N</strong> query를 수행합니다. 앞서 지정한 <code>limit</code>기능을 제거하고 싶으면 <code>.limit(0)</code>을 수행하면 됩니다.</p>
</li>
<li>
<p><code>offset(number)</code> : <strong>SKIP</strong> 연산을 수행합니다. <code>limit</code>와 마찬가지로 <code>.offset(0)</code>을 수행하면 앞서 지정한 <code>offset</code>기능을 제거할 수 있습니다.</p>
</li>
<li>
<p><code>function('string')</code> : Scalar 값이나 DB Function 수행시 활용이 가능합니다.</p>
</li>
<li>
<p>JOIN</p>
<ul>
<li><code>join(&quot;table&quot;, alias = null, onCondition = null)</code> : INNER JOIN을 수행합니다. <code>alias</code>와 <code>ON절</code>은 필요 없을시 생략이 가능합니다.</li>
<li><code>outer_join(...)</code> : 해당 하수에서 지정한 테이블을 OUTER JOIN으로 지정</li>
<li><code>left_join(...)</code> : LEFT OUTER JOIN</li>
<li><code>right_join(...)</code> : RIGHT OUTER JOIN</li>
</ul>
</li>
<li>
<p><code>union('squel select instance')</code> : <strong>UNION</strong> 연산을 수행합니다.</p>
</li>
<li>
<p>모든 필요한 기능을 다 수행한 후 <code>toString()</code>를 실행하면 <code>query string</code>이 생성됩니다.</p>
</li>
<li>
<p><code>UNION ALL</code> 연산에 대한 대해서는 현재 제공되고 있지 않습니다. 필요할 경우 그냥 <code>string concatenation</code>을 해야합니다.</p>
</li>
<li>
<p>모든 조건(<code>condition</code>)에 대해서는 <code>string format</code>형식으로 입력이 가능합니다. (ex. <code>where('id = ?', 1)</code>)</p>
</li>
<li>
<p>관련 예제들</p>
</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> squel = <span class="built_in">require</span>(<span class="string">"squel"</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> q = squel.select()</div><div class="line">  .from(<span class="string">"emp"</span>, <span class="string">"e"</span>)</div><div class="line">  .field(<span class="string">"**"</span>)</div><div class="line">  .toString();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> ** <span class="keyword">FROM</span> emp <span class="string">`e`</span></div></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> s = squel.select()</div><div class="line">  .from(<span class="string">'emp'</span>, <span class="string">'e'</span>)</div><div class="line">  .where(<span class="string">'e.id IN ?'</span>, idList)</div><div class="line">  .where(<span class="string">'e.sal &gt; ?'</span>, <span class="number">2000</span>)</div><div class="line">  .join(<span class="string">'dept'</span>, <span class="string">'d'</span>, <span class="string">'e.deptno = d.id'</span>)</div><div class="line">  .field(<span class="string">'e.name'</span>)</div><div class="line">  .field(<span class="string">'d.name'</span>)</div><div class="line">  .toString();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> e.name, d.name  </div><div class="line">  <span class="keyword">FROM</span> emp <span class="string">`e`</span> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> dept <span class="string">`d`</span> <span class="keyword">ON</span> (e.deptno = d.id)  </div><div class="line"> <span class="keyword">WHERE</span> (e.id <span class="keyword">IN</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))  </div><div class="line">   <span class="keyword">AND</span> (e.sal &gt; <span class="number">2000</span>)</div></pre></td></tr></table></figure></p>
<h2>UPDATE / INSERT / DELETE</h2>
<p><strong>UPDATE</strong> 와 <strong>INSERT</strong>, <strong>DELETE</strong> 문장 작성에 대한 함수는 거의 비슷하므로 같이 다루겠습니다.
<strong>SELECT</strong> 에서 사용된 함수들에 대해서는 중복으로 설명 드리지 않겠습니다.</p>
<ul>
<li><code>update()</code> : <strong>UPDATE</strong> 에 대한 query builder 인스턴스를 생성합니다.
<ul>
<li><code>table(&quot;table&quot;, alias = null)</code> : 수행할 테이블을 지정합니다.</li>
</ul>
</li>
<li><code>insert()</code> : <strong>INSERT</strong> 에 대한 query builder 인스턴스를 생성합니다.
<ul>
<li><code>into(&quot;table&quot;, alias = null)</code> : 수행할 테이블을 지정합니다.</li>
</ul>
</li>
<li><code>delete()</code> : <strong>DELETE</strong> 에 대한 query builder 인스턴스를 생성합니다.
<ul>
<li><code>from(&quot;table&quot;, alias = null)</code> : 수행할 테이블을 지정합니다.</li>
</ul>
</li>
<li><code>set('field', value, options = null)</code> : <code>UPDATE</code>, <code>INSERT</code>에서 해당 컬럼에 저장할 값을 지정합니다.
<ul>
<li><code>value</code>에 함수를 지정할 경우 문자열로 인식하여 따옴표를 씌우게 되는데 그럼 함수로 동작하지 않습니다.</li>
<li>그럴 경우 options 란에 <code>{ dontQuote: true}</code>를 입력해주면 <code>value</code>에 따옴표 표시를 하지 않아서 함수로 동작하게 가능합니다.</li>
</ul>
</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> uf = squel.update()</div><div class="line">  .table(<span class="string">'emp'</span>)</div><div class="line">  .set(<span class="string">'hire_date'</span>, <span class="string">'GETDATE()'</span>, &#123; <span class="attr">dontQuote</span>: <span class="literal">true</span> &#125;)</div><div class="line">  .where(<span class="string">'dept = ?'</span>, <span class="number">10</span>)</div><div class="line">  .toString();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">UPDATE</span> emp <span class="keyword">SET</span> hire_date = <span class="keyword">GETDATE</span>() <span class="keyword">WHERE</span> (dept = <span class="number">10</span>)</div></pre></td></tr></table></figure></p>
<ul>
<li><code>setFields({JSON})</code> : 입력된 JSON의 key와 value로 <code>set()</code>함수를 수행합니다.</li>
<li><code>setFieldsRows([JSON LIST])</code> : <strong>INSERT</strong> 에서만 수행이 가능하며 여러 줄 입력으로 <code>setFields()</code> 함수를 수행합니다.</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> im = squel.insert()</div><div class="line">  .into(<span class="string">'emp'</span>)</div><div class="line">  .setFieldsRows([&#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">name</span>:<span class="string">"Luna"</span>&#125;, &#123;<span class="attr">id</span>:<span class="number">2</span>, <span class="attr">name</span>:<span class="string">"Star"</span>&#125;])</div><div class="line">  .toString();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp (<span class="keyword">id</span>, <span class="keyword">name</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'Luna'</span>), (<span class="number">2</span>, <span class="string">'Star'</span>)</div></pre></td></tr></table></figure></p>
<ul>
<li><code>fromQuery</code> : <strong>SELECT</strong> 수행 결과를 <strong>INSERT</strong> 합니다.</li>
</ul>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> is = squel.insert()</div><div class="line">  .into(<span class="string">'emp'</span>)</div><div class="line">  .fromQuery(</div><div class="line">    [<span class="string">'id'</span>, <span class="string">'name'</span>],</div><div class="line">    squel</div><div class="line">      .select()</div><div class="line">      .from(<span class="string">'candidates'</span>)</div><div class="line">      .field(<span class="string">'id'</span>)</div><div class="line">      .field(<span class="string">'name'</span>)</div><div class="line">  )</div><div class="line">  .toString();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp (<span class="keyword">id</span>, <span class="keyword">name</span>) (<span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> candidates)</div></pre></td></tr></table></figure></p>
<ul>
<li>나머지 함수들 <code>where()</code>, <code>limit()</code>, <code>order()</code>, <code>JOIN 연산</code> 등은 <strong>SELECT</strong> 와 동일합니다.</li>
</ul>
<h2>Parameters</h2>
<p>위에서 살펴본 예제들은 모두 <strong>Binding Parameters</strong> 를 사용하지 않고 query에 하드코딩 되어 있습니다.
<strong>parameterized query</strong> 로 생성하려면 <code>.toString()</code> 대신에 <code>.toParam()</code>을 실행하면 됩니다.</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> pq = squel.select()</div><div class="line">  .from(<span class="string">`emp`</span>)</div><div class="line">  .where(<span class="string">'id = ?'</span>, <span class="number">10</span>)</div><div class="line">  .where(<span class="string">'dept = ?'</span>, <span class="number">20</span>)</div><div class="line">  .field(<span class="string">'*'</span>)</div><div class="line">  .toParam();</div></pre></td></tr></table></figure></p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; text: 'SELECT * FROM emp WHERE (id = ?) AND (dept = ?)',</div><div class="line">  values: [ 10, 20 ] &#125;</div></pre></td></tr></table></figure></p>
<p><code>?</code>가 아니라 <strong>numbered parameter</strong> (<code>$1</code>, <code>$2</code>, ...)를 사용하려면 <code>toParam()</code>의 인자로 <code>{ numberedParameters: true, numberedParametersStartAt: 1 }</code> 을 전달하면 됩니다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/11/08/JavaScript.Squel/" data-id="cjov28bpg00505b7bo0pr2vkr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-JS/">Node.JS</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Drive" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/20/Drive/" class="article-date">
  <time datetime="2016-10-19T15:00:00.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Book/">Book</a>►<a class="article-category-link" href="/categories/Book/Review/">Review</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/Drive/">Drive 창조적인 사람들을 움직이는 자발적 동기부여의 힘</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Drive</h1>
<p>The Surprising Truth About What Motivates Us<br>
창조적인 사람들을 움직이는 자발적 동기부여의 힘</p>
<ul>
<li>지은이 : 다니엘 핑크</li>
<li>옮긴이 : 김주환</li>
</ul>
<p>그 동안 봐왔던 대중서적과는 조금 다른 분위기의 책이었습니다.
말로만 듣던 논문 형식의 책 느낌이 살짝 들었습니다.
하지만 거부감 없이 술술 읽혀 갔습니다.</p>
<p>읽기 시작한지 만 24시간도 안되서 다 읽었습니다.</p>
<p>인센티브를 지급할 경우 업무효율이 올라갈 거라고 보통 생각을 많이 하는데, 여기에 대한 실험을 했는 결과를 다루고 있습니다.
결과부터 얘기하자면 창조적인 일을 하는 사람에게는 오히려 효율을 떨어트리며, 집중력을 요구하는 일에 대해서는 어느 정도 효과가 있다고 얘기합니다.</p>
<p>마지막 챕터에서는 창조적인 사람들을 자발적으로 동기부여를 하게 하는 방법들에 대해서 구체적인 방법들을 제시해줍니다.</p>
<p>개발자 같이 창조적인 일을 하는 조직에서 어느 정도 중간급 매니저 이상 분들은 한번씩 읽어 보시길 추천드립니다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/10/20/Drive/" data-id="cjov28bpf004w5b7bhiiuqioq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Book/">Book</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Review/">Review</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ZeroToOne" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/20/ZeroToOne/" class="article-date">
  <time datetime="2016-10-19T15:00:00.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Book/">Book</a>►<a class="article-category-link" href="/categories/Book/Review/">Review</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/ZeroToOne/">Zero to One</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Zero to One</h1>
<p>경쟁하지 말고 독점하라</p>
<ul>
<li>지은이 : 피터 틸, 블레이크 매스터스</li>
<li>옮긴이 : 이지연</li>
</ul>
<p><code>페이팔</code>의 공동 창업자 피터 틸의 창업 마인드에 대해 알 수 있는 책입니다.</p>
<p><code>경쟁하지 말고 독점하라</code></p>
<p>이 한마디가 모든 걸 다 이야기 해주고 있습니다.</p>
<p>1에서 100으로 올리는거는 100배의 성과이지만,
0에서 1로 창조하는 거는 무한대의 성과라는 것이 그의 주장입니다.</p>
<p>이 내용을 시작으로 하여 스타트업 조직 운영 및 구성원들에 대한 지은이의 생각에 대한 내용이 나옵니다.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/10/20/ZeroToOne/" data-id="cjov28bqe007u5b7br9oq0wtb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Book/">Book</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Review/">Review</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Python.ThinkBayes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/21/Python.ThinkBayes/" class="article-date">
  <time datetime="2016-09-20T15:00:00.000Z" itemprop="datePublished">2016-09-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>►<a class="article-category-link" href="/categories/Python/DataScience/">DataScience</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/21/Python.ThinkBayes/">Think Bayes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1>Think Bayes (파이썬을 활용한 베이지안 통계)</h1>
<ul>
<li>원서명 : Think Bayes: First Principles with Python</li>
<li>지은이 : Allen B. Downey</li>
<li>원서 : <a href="http://greenteapress.com/wp/think-bayes/" target="_blank" rel="external">http://greenteapress.com/wp/think-bayes/</a></li>
<li>번역서 : <a href="http://www.hanbit.co.kr/store/books/look.php?p_code=B7186764823" target="_blank" rel="external">http://www.hanbit.co.kr/store/books/look.php?p_code=B7186764823</a></li>
</ul>
<p><img src="http://www.hanbit.co.kr/data/books/B7186764823_l.jpg" alt=""></p>
<ul>
<li>저자 ipynb 코드 :<a href="https://github.com/rlabbe/ThinkBayes" target="_blank" rel="external">https://github.com/rlabbe/ThinkBayes</a></li>
</ul>
<p>This posting is made in <code>.ipynb</code>, so the original file can be modified and executed in the <strong>Jupiter Notebook</strong>.</p>
<ul>
<li>Location : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes" target="_blank" rel="external">https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes</a></li>
</ul>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes/ch.01.Bayes.Example.md" target="_blank" rel="external">01. Bayes Theorem</a> - 2016-09-21</li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes/ch.02.Statistics.ipynb" target="_blank" rel="external">02. Computational Statistics</a> - 2016-09-21</li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes/ch.03.deduce.ipynb" target="_blank" rel="external">03. Estimation</a> - 2016-09-22</li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes/ch.04.deduce2.ipynb" target="_blank" rel="external">04. More Estimation</a> - 2016-09-22</li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Python/ThinkBayes/ch.05.Odds.ipynb" target="_blank" rel="external">05. Odds and Addends</a> - 2016-09-26</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://DevStarSJ.github.io/2016/09/21/Python.ThinkBayes/" data-id="cjov28bq700735b7b2ah1hato" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DataScience/">DataScience</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    <!-- Featured Tags -->

  
    <!-- Short About -->
<section class="visible-md visible-lg">
    <h5><a href="/about/">ABOUT ME</a></h5>
    <div class="short-about">

        

        

        <!-- SNS Link -->
        <ul class="list-inline">
            
            
            

            

            

            
            
            
            
        </ul>
    </div>
</section>

  
    
  <h5>RECENT POSTS</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="/2018/11/24/aws-batch-tutorial/">Introduce to AWS Batch</a>
        </li>
      
        <li>
          <a href="/2018/11/04/kaggle.coursera.competition.03.02/">Coursera Kaggle 강의(How to win a data science competition) week 3,4 Advanced Feature Engineering 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/kaggle.coursera.competition.04.02/">Coursera Kaggle 강의(How to win a data science competition) week 4-4 Ensemble 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/kaggle.coursera.competition.04.01/">Coursera Kaggle 강의(How to win a data science competition) week 4-1 Hyperparameter Tuning 요약</a>
        </li>
      
        <li>
          <a href="/2018/10/30/181030.data.philosophy/">데이터를 철학하다</a>
        </li>
      
    </ul>
  </div>

  
    <!-- Friends Blog -->

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">17</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Yun Seok-joon<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>