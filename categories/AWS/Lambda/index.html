
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Dev Star SJ">
    <title>Category: Lambda - Dev Star SJ</title>
    <meta name="author" content="Yun Seok-joon">
    
    
    
    <meta name="description" content="Sharing the common developer&apos;s try-on">
<meta property="og:type" content="blog">
<meta property="og:title" content="Dev Star SJ">
<meta property="og:url" content="http://DevStarSJ.github.io/categories/AWS/Lambda/index.html">
<meta property="og:site_name" content="Dev Star SJ">
<meta property="og:description" content="Sharing the common developer&apos;s try-on">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Dev Star SJ">
<meta name="twitter:description" content="Sharing the common developer&apos;s try-on">
    
    
        
    
    
        <meta property="og:image" content="http://DevStarSJ.github.io/assets/images/sjyun.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-eoqrdyagg8lofwhg4unnxmhyxznbkxgjkodxgdtletmltlwb2wgngdrld76m.min.css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Dev Star SJ</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/sjyun.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/sjyun.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Yun Seok-joon</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://DevLunaSJ.github.com/" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.facebook.com/seokjoon.yun.9" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://plus.google.com/u/1/108379332089647292574" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-google-plus"></i>
                        <span class="sidebar-button-desc">Google +</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/sjyun/" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:seokjoon.yun@gmail.com" target="_blank" rel="noopener">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/04/08/AWS-Lambda-BinaryResponse/">
                            AWS Lambda + API Gateway Binary Response 예제
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-04-08T00:00:00+09:00">
	
		    Apr 08, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="AWS-Lambda-API-Gateway-Binary-Response-예제"><a href="#AWS-Lambda-API-Gateway-Binary-Response-예제" class="headerlink" title="AWS Lambda + API Gateway Binary Response 예제"></a>AWS Lambda + API Gateway Binary Response 예제</h1><p><strong>API Gatewa</strong>y의 Binary Response가 가능하기 때문에 이미지 파일(png, jpg)나 pdf 다운로드 같은걸 <strong>Lambda</strong>를 이용해서 구현이 가능하다.<br>AWS 에서 제공해주는 예제는 AWS Compute Blog에 있는 <a href="https://aws.amazon.com/blogs/compute/binary-support-for-api-integrations-with-amazon-api-gateway" target="_blank" rel="external">Binary Support for API Integrations with Amazon API Gateway</a> 란 포스팅이 있는데 이것을 읽고 실제로 구현을 하기에는 조금 부족하다.</p>
<p>그래서 바로 사용 가능한 예제 코드를 작성해 보았다.</p>
<p>이번에 회사(직방)에서 <code>html to pdf</code> API 내재화 (예전에는 외부 유료 서비스 사용) 작업을 진행하면서 Binary Response에 대해서 경험을 하게 되었다.<br>그 과정에서 많은 삽질(?)을 하게 되었는데, 이런 예제 코드만 하나 검색으로 찾을 수 있었어도 시간을 많이 아낄수 있었을 꺼란 생각이 들었다.</p>
<h2 id="1-Lambda-코드-작성"><a href="#1-Lambda-코드-작성" class="headerlink" title="1. Lambda 코드 작성"></a>1. Lambda 코드 작성</h2><p>Node.JS를 이용해서 작성하였다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="meta">"use strict"</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</div><div class="line"><span class="keyword">const</span> qs = <span class="built_in">require</span>(<span class="string">"querystring"</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> FILE = &#123;</div><div class="line">    <span class="attr">JPG</span>: <span class="string">"test.jpg"</span>,</div><div class="line">    <span class="attr">PNG</span>: <span class="string">"test.png"</span>,</div><div class="line">    <span class="attr">PDF</span>: <span class="string">"test.pdf"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> CONTENT_TYPE = &#123;</div><div class="line">    <span class="attr">JPG</span>: <span class="string">"image/jpg"</span>,</div><div class="line">    <span class="attr">PNG</span>: <span class="string">"image/png"</span>,</div><div class="line">    <span class="attr">PDF</span>: <span class="string">"application/pdf"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line"></div><div class="line">    <span class="built_in">console</span>.info(<span class="built_in">JSON</span>.stringify(event,<span class="literal">null</span>,<span class="number">2</span>));</div><div class="line"></div><div class="line">    <span class="keyword">const</span> qs = event.queryStringParameters || &#123;&#125;;</div><div class="line">    <span class="keyword">const</span> path = event.pathParameters.proxy;</div><div class="line">    <span class="keyword">const</span> body = getBody(event);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> KEY = path.indexOf(<span class="string">"jpg"</span>) &gt;= <span class="number">0</span> ? <span class="string">"JPG"</span> :</div><div class="line">                path.indexOf(<span class="string">"png"</span>) &gt;= <span class="number">0</span> ? <span class="string">"PNG"</span> :</div><div class="line">                                           <span class="string">"PDF"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> content = fs.readFileSync(FILE[KEY]);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> response = &#123;</div><div class="line">        <span class="attr">statusCode</span>: <span class="number">200</span>,</div><div class="line">        <span class="attr">headers</span>: &#123;</div><div class="line">            <span class="string">"Content-Type"</span>: CONTENT_TYPE[KEY],</div><div class="line">            <span class="string">"Content-Disposition"</span>: <span class="string">`inline; filename="<span class="subst">$&#123;FILE[KEY]&#125;</span>"`</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">body</span>: <span class="keyword">new</span> Buffer(content).toString(<span class="string">"base64"</span>),</div><div class="line">        <span class="attr">isBase64Encoded</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    callback(<span class="literal">null</span>, response);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBody</span>(<span class="params">event</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!event.body)</div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> rawBody = event.isBase64Encoded ? <span class="keyword">new</span> Buffer(event.body, <span class="string">"base64"</span>).toString() : event.body;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> body = event.headers[<span class="string">"Content-Type"</span>] === <span class="string">"application/x-www-form-urlencoded"</span> ?</div><div class="line">        qs.parse(rawBody) : rawBody;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> body;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>코드 대해서는 간략하게만 설명하겠다.</p>
<p>경로상에 <code>pdf</code>, <code>png</code>, <code>jpg</code> 가 있는 경우 각각 그 예제 바이너리를 리턴해주는 간단한 API다.</p>
<p>API Gateway의 Lambda Proxy Integration를 이용해서 <code>event</code>를 받을 예정이다.<br>예전에는 <code>{proxy+}</code> 리소스를 사용해야지만 프락시 통합이 사용가능했지만, 이제는 각각의 리소스, 메서드를 직접 지정하더라도 프락스 통합 사용이 가능하므로 이걸 사용하지 않을 이유가 없다.</p>
<p>이번 예제에서 <code>body</code>를 사용하지는 않을 예정이라 <code>getBody</code> 함수가 사실상 필요는 없지만, 바이너리로 <code>body</code>를 받을 경우에는 해당 코드를 참고해서 처리하면 된다.</p>
<p><img src="/images/br1.png" alt=""></p>
<p>위 그림과 같이 <code>isBase64Encoded</code> 값을 보고 <code>body</code>를 인코딩 해줘야 한다.<br>인코딩 여부를 우리가 정할 수 있는지는 잘 모르겠지만, API Gateway에서 알아서 판단하여 인코딩 해주는것 같다.<br>여러 번의 테스트를 해보니 <code>isBase64Encoded</code>가 <em>false</em>로 계속 전달되다가 API Gateway deploy 이후 <em>true</em>로 바뀐적도 있다.</p>
<p>JavaScript에서의 switch-case 문에 대한 구현은 개인적으로 위와 같이 Object를 만들어서 key-value pair를 활용하는게 깔끔해 보인다.</p>
<h2 id="2-Lambda-배포"><a href="#2-Lambda-배포" class="headerlink" title="2. Lambda 배포"></a>2. Lambda 배포</h2><p>위 작성한 코드와 <code>test.jpg</code>, <code>test.png</code>, <code>test.pdf</code> 를 같은 폴더에 복사한 뒤 같이 압축해 주자.</p>
<p><img src="images/BinaryResponse.01.png" alt=""></p>
<blockquote>
<p>zip -r test.zip .</p>
</blockquote>
<p>그리고 AWS Lambda Console로 가서 <strong>binaryTest</strong> 란 이름으로 Function을 생성하자.</p>
<p>런타임은 <strong>Node.js 6.10</strong> 을 선택하고 해당 압축파일을 업로딩하자.</p>
<p>다른 설정은 적당히 알아서 하면 된다.</p>
<p>이 예제는 S3나 다른 AWS 상의 리소스를 사용하지 않으니 <strong>Role</strong> 설정도 따로 복잡하게 할 것이 없다.</p>
<p>단, 메모리와 타임아웃은 적당히 여유있게 주길 바란다.<br>바이너리 처리 자체가 파일을 읽고, 쓰는 작업이 필요하기 때문에 메모리가 많이 필요 할 수도 있고, 시간도 생각보다 오래 걸릴수 있기 때문이다.</p>
<h2 id="3-API-Gateway-생성-및-설정"><a href="#3-API-Gateway-생성-및-설정" class="headerlink" title="3. API Gateway 생성 및 설정"></a>3. API Gateway 생성 및 설정</h2><h3 id="3-1-일단-API-생성"><a href="#3-1-일단-API-생성" class="headerlink" title="3.1 일단 API 생성"></a>3.1 일단 API 생성</h3><p><img src="images/BinaryResponse.02.png" alt=""></p>
<p>그냥 <code>binaryTest</code>로 하나 생성한다.</p>
<h3 id="3-2-리소스-추가"><a href="#3-2-리소스-추가" class="headerlink" title="3.2 리소스 추가"></a>3.2 리소스 추가</h3><p><code>Action</code> -&gt; <code>Create Method</code> 를 누른 뒤 <code>proxy resource</code>를 체크하고 <code>Create Resource</code>를 눌러주자.</p>
<p><img src="images/BinaryResponse.03.png" alt=""></p>
<p>이번 예제에서는 모든 경로에 대해서 하나의 Lambda를 실행시킬 것이다.<br>단, 이 방법은 유효하지 않은 경로 등에 대해서도 모두 Lambda를 실행시키게 되므로 쓸데없는 비용이 발생 할 수도 있다는건 알아둬야 한다.<br>Lambda에서 처리 가능한 경로에 대해서만 호출을 할 것이라면 리소스를 유효한 것만 따로 생성하는게 좋다.</p>
<p>해당 프락시 리소스에서 실행시킬 Lambda를 설정해 주자.</p>
<p><img src="images/BinaryResponse.04.png" alt="image"></p>
<p>위에서 생성한 binaryTest Lambda Function으로 설정하자.</p>
<h3 id="3-3-Binary-Support-추가"><a href="#3-3-Binary-Support-추가" class="headerlink" title="3.3 Binary Support 추가"></a>3.3 Binary Support 추가</h3><p>API Gateway 상의 <code>Binary Support</code> 탭을 눌러서 들어가자.</p>
<p><img src="images/BinaryResponse.05.png" alt="image"></p>
<p>해당 API를 호출할 때 <code>headers</code>에서 <code>Accept</code>로 요청하는 형태들에 대해서 미리 정의해 줘야 한다.</p>
<p>만약 브라우저에서 url로 바로 호출할 것이라면 <code>*/*</code>를 추가해 줘야 한다.</p>
<p>그 밖의 다른 곳에서 요청시 <code>Accept</code>로 명시해주는 형태에 대해서 추가를 해줘야 <code>API Gateway</code>에서 바이너리 형태로 응답을 제공한다.</p>
<h3 id="3-4-배포"><a href="#3-4-배포" class="headerlink" title="3.4 배포"></a>3.4 배포</h3><p>다시 <code>Resources</code> 탭으로 가서 <code>Actions</code> -&gt; <code>Deploy API</code>를 눌러서 배포를 하자.</p>
<p><img src="images/BinaryResponse.06.png" alt=""></p>
<p>그냥 늘 하던데로 <code>prod</code>라는 이름으로 배포를 했다.</p>
<h2 id="4-테스트"><a href="#4-테스트" class="headerlink" title="4. 테스트"></a>4. 테스트</h2><p>배포를 하면 <strong>url</strong>이 생성된다.</p>
<p><img src="images/BinaryResponse.07.png" alt=""></p>
<p>이 url 뒤에 <code>/pdf</code> , <code>/png</code> , <code>/jpg</code>를 붙여서 호출하여 바이너리 다운로드가 정상적으로 되는지 확인해 보자.</p>
<p>브라우저에서 직접 호출하면 바로 화면에 나타나겠고, <code>curl</code> 이나 <code>POSTMAN</code>을 사용할려면 <code>header</code>에 <code>Accept</code>값을 넣어서 호출하면 된다.</p>
<blockquote>
<p>curl -X GET -H “{Accept:application/pdf}”  <a href="https://xxx/prod/pdf" target="_blank" rel="external">https://xxx/prod/pdf</a> &gt; test.pdf</p>
</blockquote>
<p>POSTMAN의 경우 이미지는 바로 화면에 보여주지만, pdf는 정상적으로 보여주지 못한다.</p>
<h1 id="Lambda-Binary-작업-Tip-Native-Module-사용"><a href="#Lambda-Binary-작업-Tip-Native-Module-사용" class="headerlink" title="Lambda Binary 작업 Tip(?) : Native Module 사용"></a>Lambda Binary 작업 Tip(?) : Native Module 사용</h1><p>Lambda로 binary response 작업을 할려면 몇가지만 미리 알아두더라도 삽질(?) 할 시간을 아낄 수 있다.</p>
<h3 id="Lambda가-실행되는-환경은-Linux-이다"><a href="#Lambda가-실행되는-환경은-Linux-이다" class="headerlink" title="Lambda가 실행되는 환경은 Linux 이다."></a>Lambda가 실행되는 환경은 Linux 이다.</h3><p><a href="http://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html" target="_blank" rel="external">Lambda Execution Environment and Available Libraries</a> 에서 정확한 정보를 확인할 수 있다.</p>
<h3 id="Lambda에-50mb-정도의-디스크-사용이-가능하다"><a href="#Lambda에-50mb-정도의-디스크-사용이-가능하다" class="headerlink" title="Lambda에 50mb 정도의 디스크 사용이 가능하다."></a>Lambda에 50mb 정도의 디스크 사용이 가능하다.</h3><p><code>/tmp</code> 폴더내에 파일을 임시로 저장하고 사용하는게 가능하다.<br>하지만 Lambda가 warm start로 실행될 경우 이미 만들어진 Lambda를 재사용하므로 해당 폴더에 임시로 만들어 놓은 파일은 계속 남아있게 된다.<br>임시로 파일을 만들어서 활용할 경우 동일한 이름을 사용해서 항상 덮어쓰거나 아니면 해당 파일을 다 사용한 후에는 지워주는 코드를 넣어주도록 하자.</p>
<h3 id="Native-Module을-사용할-경우"><a href="#Native-Module을-사용할-경우" class="headerlink" title="Native Module을 사용할 경우"></a>Native Module을 사용할 경우</h3><p>바이너리 응답을 주는 기능 구현을 위해서는 native module을 사용하는 경우가 많다.</p>
<p>native module를 사용한다면, 기본적으로 아래와 같은 과정으로 개발을 할 것이다.</p>
<ul>
<li>해당 native module을 설치한다. (macos의 경우 brew를 사용)</li>
<li>해당 모듈의 wrapper npm이 있는지 검색한다.</li>
<li>있다면 그걸 활용한다.</li>
<li>없다면 직접 shell에서 실행시켜주는 wrapper를 구현해서 사용한다.</li>
</ul>
<p>이걸 Lambda로 배포하려면 해당 native module을 같이 배포해야한다.<br>그래서 아래 과정이 추가된다.</p>
<ul>
<li>wrapper npm을 활용한 경우라면 그 소스코드를 살펴보면서 해당 모듈을 시스템 상에 설치된 것을 사용하는지, 아니면 npm으로 설치할때 같이 다운로드 되는지 살펴본다.</li>
<li>시스템상 설치된 것을 사용한다면 native module의 실행파일을 압축해 본다.</li>
<li>압축 후 용량이 50mb가 넘으면 포기한다. ㅠㅠ</li>
<li>50 mb 이하라면 Lambda 를 배포할 폴더 아래에 해당 파일을 복사한다.</li>
<li>옮긴 실행 파일을 실행하도록 wrapper를 수정한다.</li>
</ul>
<p>여기서 반드시 명싱해야 할것은 Lambda의 실행환경은 Linux이다.  </p>
<p>지금 내 개발환경이 macos인 경우 이것을 그대로 Lambda로 배포하면 실행이 안된다.  </p>
<p>해당 native module을 Linux용으로 바꿔서 배포해야한다.</p>
<ul>
<li>wrapper npm에서 native module을 같이 다운로드 받게 되어 있다면, 코드를 살펴보자.<ul>
<li>분명 OS 타입별로 각각 다른 파일을 다운로드 하는 분기 코드가 있을 것이다. 그걸 보고 Linux용 실행파일을 다운로드 받자.</li>
</ul>
</li>
<li>시스템 상에 설치된 실행파일을 사용하는 경우라면 따로 Linux용을 다운로드 받자.</li>
<li>로컬에서 테스트로 실행시켜볼 환경과 Lambda로 배포할 환경을 따로 만들어야 한다.<ul>
<li>배포 스크립트를 만들면 편하다.<ul>
<li>폴더 생성</li>
<li>Lambda 코드 복사</li>
<li><code>npm i --only=production</code></li>
<li>native module을 linux 용으로 복사</li>
<li>배포</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="OS에-따라-Native-Module의-결과가-다를-수-있다"><a href="#OS에-따라-Native-Module의-결과가-다를-수-있다" class="headerlink" title="OS에 따라 Native Module의 결과가 다를 수 있다."></a>OS에 따라 Native Module의 결과가 다를 수 있다.</h3><p>같은 native module이라도 각 OS별로 다르게 동작할 수 있다.<br>이 사실을 모르고 결과물을 개발 환경에 맞춰서 진행하다보면 Lambda 배포 후 결과가 다른걸 보고 또 다시 삽질을 해야할 수 있다.<br>그러니 일단 동작하는게 확인되면 Lambda로 배포한 후 그 결과를 확인해보고 진행하는게 좋다.</p>
<h2 id="마치며…"><a href="#마치며…" class="headerlink" title="마치며…"></a>마치며…</h2><p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="&#x6d;&#97;&#x69;&#108;&#x74;&#111;&#58;&#x73;&#x65;&#111;&#x6b;&#x6a;&#111;&#111;&#110;&#46;&#x79;&#x75;&#x6e;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#109;">&#x73;&#x65;&#111;&#x6b;&#x6a;&#111;&#111;&#110;&#46;&#x79;&#x75;&#x6e;&#x40;&#103;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#109;</a>  </p>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/04/08/AWS-Lambda-BinaryResponse/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/03/26/Lambda.Chatbot.01/">
                            AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-03-26T00:00:00+09:00">
	
		    Mar 26, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="AWS-Lambda에-Python-Slack-Chatbot을-통해서-미세먼지-대기정보-알림이-만들기"><a href="#AWS-Lambda에-Python-Slack-Chatbot을-통해서-미세먼지-대기정보-알림이-만들기" class="headerlink" title="AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기"></a>AWS Lambda에 Python Slack Chatbot을 통해서 미세먼지 대기정보 알림이 만들기</h1><p>Lambda를 이용해서 Slack용 Chatbot을 만들어 보았다.<br>개발언어로는 Python을 사용했다.<br>Lambda에는 Python 2.7만 지원되어서 작업하면서도 불편한 점이 많았다.<br>특히 챗봇이다보니 유니코드(한글) 처리가 필수여서다.<br>(Node.JS는 6.1까지 지원해주는데… Python도 3을 빨리 지원해주면 좋겠다.)  </p>
<p>예제로 만들어본 챗봇은 서울시 종로구의 대기상태를 알려주는 기능을 제공한다.<br>매일 아침 5시 20분(내 기상시간)과 오후 12시 20분(점심 먹으러 가기 전에 지하식당에서 먹을지 밖에 나가서 먹을지 생각하기 위해서)에 알려주도록 설정하였다.<br>솔직히 오후 12시에 굳이 20분을 한 이유는 CloudWatch의 event 생성을 편하게 하기위해서이다.<br>솔직히 12시 40분에 알려주는게 더 좋을것 같긴하지만, 그것 때문에 event를 추가로 생성하기엔 귀찮기도 하고, 관리포인트가 두군데가 생기기 때문에 그냥 20분으로 통일했다.</p>
<p>챗봇 구현을 위한 Lambda를 2개로 나누었다.</p>
<ul>
<li>Slack에 메세지를 전달해주는 Lambda</li>
<li>크롤링하여 대기상태 데이터를 뽑아내고 메세지를 만드는 Lambda</li>
</ul>
<p>크롤링 Lambda는 SNS를 통해서 메세지 전달 Lambda를 호출한다.<br>크롤링 Lambda는 CloudWatch의 event를 통해서 호출된다.  </p>
<p>그 과정을 그림으로 표현하면 아래와 같다.</p>
<p><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.01.png?raw=true"></p>
<p>이전에 표스팅한 내용에 있는 것에 대해서는 설명을 생략하겠다.<br>해당 내용에 대해서는 아래 링크를 참고하면 관련 내용이 있다.</p>
<ul>
<li>Python 코드를 Lambda에 배포하는 방법 : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
<li>Lambda -&gt; SNS -&gt; Lambda 로 호출하는 방법 : <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda/Lambda.invoke.Lambda.md" target="_blank" rel="external">Lambda에서 Lambda를 호출하는 방법</a></li>
</ul>
<h2 id="1-Slack에-메세지-보내기"><a href="#1-Slack에-메세지-보내기" class="headerlink" title="1. Slack에 메세지 보내기"></a>1. Slack에 메세지 보내기</h2><p>먼저 Slack Bot을 만들기 위해서는 API Token이 필요하다.<br>자세한 생성방법은 검색하면 많이 나오니깐 생략하겠다.<br>간략하게 설명없이 방법만 적겠다.  </p>
<ul>
<li>Slack에서 채널명 클릭해서 나오는 메뉴에서 <code>Apps &amp; intergrations</code> 클릭<ul>
<li><code>Bots</code> 검색해서 클릭</li>
<li><code>Add Configuration</code>클릭<ul>
<li>안내대로 쭉 설정하고 나오는 화면에서 <code>API Token</code>값을 보고 기록해 놓음</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>이제 Slack에 메세지를 보내는 Python 함수를 먼저 만들어 보자.</p>
<p>만약 Python 버전이 2.7이 아닌 경우에는 <code>virtualenv</code>를 통해서 2.7 환경으로 만들어 놓고 작업을 해야한다.<br>그 방법은 <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a> 링크를 통해서 확인하기 바란다.</p>
<p><code>slacker</code>라는 패키지를 이용하면 정말 쉽게 작성이 가능하다.  </p>
<p>우리는 Lambda에 배포해야하니 <code>pip</code>로 패키지를 설치할 때 해당 폴더에 설치해야 한다.</p>
<blockquote>
<p>pip install slacker -t .</p>
</blockquote>
<p>이제 <code>index.py</code>라는 파일명으로 아래 코드를 입력한다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> slacker <span class="keyword">import</span> Slacker</div><div class="line"></div><div class="line">token = <span class="string">'&#123;Slack Bot API Token&#125;'</span></div><div class="line">slack = Slacker(token)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    ch = event[<span class="string">"channel"</span>]</div><div class="line">    message = event[<span class="string">"message"</span>]</div><div class="line"></div><div class="line">    slack.chat.post_message(ch, msg)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    event= &#123;&#125;;</div><div class="line">    event[<span class="string">"channel"</span>] = <span class="string">"#general"</span>;</div><div class="line">    event[<span class="string">"message"</span>] = <span class="string">"메인 테스트"</span>;</div><div class="line">    </div><div class="line">    handler(event, <span class="keyword">None</span>);</div></pre></td></tr></table></figure>
<p>실행을 했을 때 Slack의 <code>#general</code> 채널에 메세지가 출력되면 정상적으로 동작하는 것이다.</p>
<blockquote>
<p>python index.py</p>
</blockquote>
<p> <img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.02.png?raw=true"></p>
<p> 이제 Lambda로 올려서 테스트 해보자.</p>
<blockquote>
<p>zip -r bot.zip .</p>
</blockquote>
<p> 위 명령어로 압축을 한 후에 Lambda에 올려서 배포를 한 후 테스트 데이터를 아래와 같은 형태로 넣은 후 실행해서 Slack에 메세지가 나오면 성공한 것이다.</p>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"channel"</span>: <span class="string">"#general"</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">"람다람다 테스트"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.03.png?raw=true"></p>
<h2 id="2-대기정보를-얻기위해서-웹-크롤링하기"><a href="#2-대기정보를-얻기위해서-웹-크롤링하기" class="headerlink" title="2. 대기정보를 얻기위해서 웹 크롤링하기"></a>2. 대기정보를 얻기위해서 웹 크롤링하기</h2><p>위에 작성한 코드와는 다른 폴더에서 작업하겠다.<br>왜냐면 다른 Lambda로 배포할 코드라 사용하지 않는 패키지까지 같이 포함되어 배포할 용량이 커지는걸 피하기 위해서다.</p>
<p>서울특별시 대기환경정보(<a href="http://cleanair.seoul.go.kr/air_city.htm?method=measure" target="_blank" rel="external">http://cleanair.seoul.go.kr/air_city.htm?method=measure</a>)에서 관련 데이터를 크롤링했다.<br>(네이버는 크롤링을 막아놔서… ㅠㅠ 아마 적절히 User-Agent값을 넣는다던지, headers 정보를 감쪽같이 속인다던지, 웹브라우저 엔진을 이용한다던지 하는 방법을 이용하면 되겠지만… 뭐 대단한 거라고 그냥 다른 곳을 선택했다. 최대한 쉽게 쉽게…)</p>
<p>웹페이지 소스를 가져오기 위해서 <code>requests</code>를 사용했으며 해당 소스를 분석하기 위해서 <code>beautifulsoup</code>를 사용하였다.<br>그동안 말로만 듣던 beautifulsoup를 처음 써봤는데, 100% 마음에 들지는 않았지만 그래도 원하는 기능들이 꽤 많이 구현되어 있었다.<br>텍스트를 한줄 한줄 읽어가면서 분석해야하는 일을 많이 줄여주었다.</p>
<blockquote>
<p>pip install requests beautifulsoup -t .</p>
</blockquote>
<p>위 페이지에서 개발자 도구를 열어서 소스도 살펴보고… 각 element 별로 클릭해서 적절한 id값도 찾아보고… 이래저래 해봤는데… 한방에 딱! 뽑아 낼 수 있는 구조가 아니다.<br>그냥 일단 받아놓고 노가다로 찾아야 겠다. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> BeautifulSoup <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line">URL = <span class="string">'http://cleanair.seoul.go.kr/air_city.htm?method=measure'</span></div><div class="line"></div><div class="line">response = requests.get(URL)</div><div class="line">html_doc = response.text</div><div class="line">soup = BeautifulSoup(html_doc)</div><div class="line"></div><div class="line"><span class="keyword">print</span> soup.prettify()</div></pre></td></tr></table></figure>
<p>로 일단 찍어보자.<br>여기서 뭘 보겠다는게 아니라 그냥 일단 잘 동작하나 보자.<br>겁나 길게 html이 우루루 출력되면 성공한 것이다.  </p>
<p>다시한번 개발자 도구로 해당페이지를 보니 아래쪽 표 부분에 서울시 각 도별로 대기상태 값들이 있다.<br><code>&lt;table&gt;</code> 태그 정보들에 대해서 값을 추출해 보자.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tables = soup.findAll(<span class="string">'table'</span>)</div><div class="line"><span class="keyword">print</span> tables</div></pre></td></tr></table></figure>
<p>3번째 테이블에 원하는 정보가 있다.</p>
<p>각 <code>&lt;tr&gt;</code>별로 살펴봐서 우리가 원하는 위치(<code>종로구</code>)에 관한 정보만 찾아보자.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">dataTable = tables[<span class="number">2</span>]</div><div class="line">trs = dataTable.findAll(<span class="string">'tr'</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> tr <span class="keyword">in</span> trs:</div><div class="line">    <span class="keyword">if</span> <span class="string">'종로구'</span> <span class="keyword">in</span> str(tr):</div><div class="line">        <span class="keyword">print</span> tr;</div></pre></td></tr></table></figure>
<p>우리가 원하는 정보는 저기에 다 있는게 확인되었다.<br>이제 이걸 이용해서 메세지를 만들어서 출력해 보겠다.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">dataTable = tables[<span class="number">2</span>]</div><div class="line">trs = dataTable.findAll(<span class="string">'tr'</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> tr <span class="keyword">in</span> trs:</div><div class="line">    <span class="keyword">if</span> <span class="string">'종로구'</span> <span class="keyword">in</span> str(tr):</div><div class="line">        tds = tr.findAll(<span class="string">'td'</span>)</div><div class="line"></div><div class="line">        message1 = <span class="string">u'종로구의 현재 통합대기환경지수는 &#123;&#125;(&#123;&#125;) 입니다.'</span>.format(tds[<span class="number">7</span>].getText(), tds[<span class="number">8</span>].getText())</div><div class="line">        message2 = <span class="string">u'미세먼지: &#123;&#125;㎍/㎥, 초미세먼지: &#123;&#125;㎍/㎥, 오존: &#123;&#125;ppm, 이산화질소: &#123;&#125;ppm, 일산화탄소: &#123;&#125;ppm, 아황산가스: &#123;&#125;ppm'</span>.format(tds[<span class="number">1</span>].getText(), tds[<span class="number">2</span>].getText(), tds[<span class="number">3</span>].getText(), tds[<span class="number">4</span>].getText(), tds[<span class="number">5</span>].getText(), tds[<span class="number">6</span>].getText())</div><div class="line"></div><div class="line">        messageTotal = message1 + <span class="string">u"("</span> + message2 + <span class="string">")"</span></div><div class="line">        <span class="keyword">print</span> messageTotal</div></pre></td></tr></table></figure>
<blockquote>
<p>종로구의 현재 통합대기환경지수는 보통(70) 입니다.(미세먼지: 44㎍/㎥, 초미세먼지: 25㎍/㎥, 오존: 0.036ppm, 이산화질소: 0.033ppm, 일산화탄소: 0.5ppm, 아황산가스: 0.004ppm)</p>
</blockquote>
<p>이제까지의 코드를 한번 정리해 보겠다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> BeautifulSoup <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line">URL = <span class="string">'http://cleanair.seoul.go.kr/air_city.htm?method=measure'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetInfo</span><span class="params">(gu)</span>:</span></div><div class="line">    response = requests.get(URL)</div><div class="line">    html_doc = response.text</div><div class="line">    soup = BeautifulSoup(html_doc)</div><div class="line"></div><div class="line">    tables = soup.findAll(<span class="string">'table'</span>);</div><div class="line">    dataTable = tables[<span class="number">2</span>]</div><div class="line">    trs = dataTable.findAll(<span class="string">'tr'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</div><div class="line">        <span class="keyword">if</span> gu <span class="keyword">in</span> str(tr):</div><div class="line">            <span class="keyword">return</span> tr;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">MakeMessage</span><span class="params">(data)</span>:</span></div><div class="line">    tds = data.findAll(<span class="string">'td'</span>)</div><div class="line"></div><div class="line">    message1 = <span class="string">u'종로구의 현재 통합대기환경지수는 &#123;&#125;(&#123;&#125;) 입니다.'</span>.format(tds[<span class="number">7</span>].getText(), tds[<span class="number">8</span>].getText())</div><div class="line">    message2 = <span class="string">u'미세먼지: &#123;&#125;㎍/㎥, 초미세먼지: &#123;&#125;㎍/㎥, 오존: &#123;&#125;ppm, 이산화질소: &#123;&#125;ppm, 일산화탄소: &#123;&#125;ppm, 아황산가스: &#123;&#125;ppm'</span>.format(tds[<span class="number">1</span>].getText(), tds[<span class="number">2</span>].getText(), tds[<span class="number">3</span>].getText(), tds[<span class="number">4</span>].getText(), tds[<span class="number">5</span>].getText(), tds[<span class="number">6</span>].getText())</div><div class="line"></div><div class="line">    messageTotal = message1 + <span class="string">u"("</span> + message2 + <span class="string">")"</span></div><div class="line">    <span class="keyword">return</span> messageTotal</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    <span class="keyword">print</span> MakeMessage(GetInfo(<span class="string">'종로구'</span>))</div></pre></td></tr></table></figure>
<h2 id="3-SNS을-통해서-Slack-Lambda-호출하기"><a href="#3-SNS을-통해서-Slack-Lambda-호출하기" class="headerlink" title="3. SNS을 통해서 Slack Lambda 호출하기"></a>3. SNS을 통해서 Slack Lambda 호출하기</h2><p>자세한 설명은 <a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda/Lambda.invoke.Lambda.md" target="_blank" rel="external">Lambda에서 Lambda를 호출하는 방법</a> 링크를 통해서 확인하기 바란다.</p>
<p>해당 SNS를 통해서 메세지를 보내기 위해서 SNS의 ARN 주소를 어디에 적어 놓아야 한다.</p>
<p>SNS 에서 Lambda 로 전달되는 메세지 형태를 처리하기 위해서는 위 코드를 수정해야 한다.<br>참고로 <code>Subject</code>로 채널명을 입력받고 <code>Message</code> 전달할 메세지를 입력받도록 설정하였다.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> slacker <span class="keyword">import</span> Slacker</div><div class="line"></div><div class="line">token = <span class="string">'&#123;Slack Bot API Token&#125;'</span></div><div class="line">slack = Slacker(token)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    keys = event.keys()</div><div class="line">    </div><div class="line">    ch = <span class="string">""</span></div><div class="line">    message = <span class="string">""</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="string">'channel'</span> <span class="keyword">in</span> keys:</div><div class="line">        ch = event[<span class="string">"channel"</span>]</div><div class="line">        msg = event[<span class="string">"message"</span>]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        ch = event[<span class="string">'Records'</span>][<span class="number">0</span>][<span class="string">'Sns'</span>][<span class="string">'Subject'</span>];</div><div class="line">        msg = event[<span class="string">'Records'</span>][<span class="number">0</span>][<span class="string">'Sns'</span>][<span class="string">'Message'</span>];</div><div class="line"></div><div class="line">    slack.chat.post_message(ch, msg)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    event= &#123;&#125;;</div><div class="line">    event[<span class="string">"channel"</span>] = <span class="string">"#general"</span>;</div><div class="line">    event[<span class="string">"message"</span>] = <span class="string">"메인 테스트"</span>;</div><div class="line">    </div><div class="line">    handler(event, <span class="keyword">None</span>);</div></pre></td></tr></table></figure>
<h3 id="4-대기정보-Lambda에서-SNS로-메세지-보내기"><a href="#4-대기정보-Lambda에서-SNS로-메세지-보내기" class="headerlink" title="4. 대기정보 Lambda에서 SNS로 메세지 보내기"></a>4. 대기정보 Lambda에서 SNS로 메세지 보내기</h3><p>2번 항목에서 만든 코드에 SNS를 통해서 메세지를 전달하는 코드를 추가해 보자.<br>먼저 AWS 서비스를 이용하기 위해 <code>boto</code>를 설치하자.</p>
<blockquote>
<p>pip install boto -t .</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> BeautifulSoup <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> boto.sns</div><div class="line"></div><div class="line">URL = <span class="string">'http://cleanair.seoul.go.kr/air_city.htm?method=measure'</span></div><div class="line"></div><div class="line">REGION = <span class="string">'&#123;리전&#125;'</span></div><div class="line">TOPIC  = <span class="string">'&#123;SNS ARN 주소&#125;'</span></div><div class="line"></div><div class="line">conn = boto.sns.connect_to_region( REGION )</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetInfo</span><span class="params">(gu)</span>:</span></div><div class="line">    response = requests.get(URL)</div><div class="line">    html_doc = response.text</div><div class="line">    soup = BeautifulSoup(html_doc)</div><div class="line"></div><div class="line">    tables = soup.findAll(<span class="string">'table'</span>);</div><div class="line">    dataTable = tables[<span class="number">2</span>]</div><div class="line">    trs = dataTable.findAll(<span class="string">'tr'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</div><div class="line">        <span class="keyword">if</span> gu <span class="keyword">in</span> str(tr):</div><div class="line">            <span class="keyword">return</span> tr;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">MakeMessage</span><span class="params">(data)</span>:</span></div><div class="line">    tds = data.findAll(<span class="string">'td'</span>)</div><div class="line"></div><div class="line">    message1 = <span class="string">u'종로구의 현재 통합대기환경지수는 &#123;&#125;(&#123;&#125;) 입니다.'</span>.format(tds[<span class="number">7</span>].getText(), tds[<span class="number">8</span>].getText())</div><div class="line">    message2 = <span class="string">u'미세먼지: &#123;&#125;㎍/㎥, 초미세먼지: &#123;&#125;㎍/㎥, 오존: &#123;&#125;ppm, 이산화질소: &#123;&#125;ppm, 일산화탄소: &#123;&#125;ppm, 아황산가스: &#123;&#125;ppm'</span>.format(tds[<span class="number">1</span>].getText(), tds[<span class="number">2</span>].getText(), tds[<span class="number">3</span>].getText(), tds[<span class="number">4</span>].getText(), tds[<span class="number">5</span>].getText(), tds[<span class="number">6</span>].getText())</div><div class="line"></div><div class="line">    messageTotal = message1 + <span class="string">u"("</span> + message2 + <span class="string">")"</span></div><div class="line">    <span class="keyword">return</span> messageTotal</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    msg = MakeMessage(GetInfo(<span class="string">'종로구'</span>))</div><div class="line"></div><div class="line">    pub = conn.publish( topic = TOPIC, subject =<span class="string">"#general"</span>  ,message = msg )</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    handler(<span class="keyword">None</span>, <span class="keyword">None</span>)</div></pre></td></tr></table></figure>
<p>Lambda로 올리기 전에 테스트로 실행해 본 후 정상적으로 실행되는지 확인해 보자.  </p>
<p><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.04.png?raw=true"></p>
<p>위 코드 실행 후 Slcak을 통해서 메세지가 전달되었다면 성공한 것이다.<br>위 코드도 폴더 전체를 압축해서 Lambda로 배포하자. </p>
<h2 id="5-CloudWatch를-통해서-event-생성하기"><a href="#5-CloudWatch를-통해서-event-생성하기" class="headerlink" title="5. CloudWatch를 통해서 event 생성하기"></a>5. CloudWatch를 통해서 event 생성하기</h2><p>CloudWatch의 event를 통해서 특정 시점에 Lambda 를 실행시킬 수 있다.</p>
<ul>
<li><code>CloudWatch</code> -&gt; <code>Events</code> -&gt; <code>Create rule</code><ul>
<li><code>Add taget</code>을 눌러서 위에 배포한 Lambda를 선택 : 별도로 인자로 받는게 없으므로 나머지 설정들은 기본 그대로 둠</li>
<li><code>Event Source</code>를 <code>Schedule</code>로 선택<ul>
<li><code>Cron Expression</code> : <code>20 3,20 * * ? *</code>로 입력 (UTC 기준 매일 3시 20분, 20시 20분에 실행을 시킨다는 뜻)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>저장을 하면 끝이다.</p>
<p>이제 설정한 시간에 Lambda가 실행되어서 Slack에 메세지를 전달해 줄 것이다.</p>
<p><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Chatbot.05.png?raw=true"></p>
<p>하루가 지난 시점에 확인해보니 설정한 시간에 꼬박꼬박 실행 중이다.</p>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/03/26/Lambda.Chatbot.01/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/03/19/Lambda.invoke.Lambda/">
                            Lambda에서 Lambda를 호출하는 방법
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-03-19T00:00:00+09:00">
	
		    Mar 19, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Lambda에서-Lambda를-호출하는-방법"><a href="#Lambda에서-Lambda를-호출하는-방법" class="headerlink" title="Lambda에서 Lambda를 호출하는 방법"></a>Lambda에서 Lambda를 호출하는 방법</h1><p>AWS Lambda에서 Lambda를 호출하는 방법들에 대해서 소개하겠다.</p>
<h2 id="언제-Lambda에서-Lambda를-호출하면-편리할까"><a href="#언제-Lambda에서-Lambda를-호출하면-편리할까" class="headerlink" title="언제 Lambda에서 Lambda를 호출하면 편리할까 ?"></a>언제 Lambda에서 Lambda를 호출하면 편리할까 ?</h2><p>첫째, 배치 성격의 작업을 여러 개로 나누어 병렬로 실행할 경우를 생각할 수 있다.<br>Lambda 내에서 배치작업을 모두 다 실행시키도록 작성 할 수도 있겠지만,<br>첫번째 Lambda에서 작업 전 필요한 준비작업을 한 후 이것을 다른 Lambda로 전달 할 수 있다.<br>그 과정에서 다음 Lambda 1개에게 전달할게 아니라 비동기 invoke로 한 번에 여러 개의 Lambda를 생성하여 작업하면 전체 실행 시간을 줄일수 있을 것이다.<br>(하지만 동시에 여러 Lambda가 실행될 경우 계정당 Lambda Limit 내에서 실행되도록 조정은 해야 한다.)</p>
<p>이 경우 <a href="https://aws.amazon.com/step-functions" target="_blank" rel="external">AWS Step Functions</a> 를 이용할 수도 있다.<br>Step Functions를 사용하려고 살펴봤는데 아직까진 사용 사례도 없고, 그 과정에서의 비용도 있고, API Gateway와의 연동에 대해서도 확신이 없다.<br><a href="https://aws.amazon.com/ko/about-aws/whats-new/2017/02/amazon-api-gateway-integration-with-aws-step-functions" target="_blank" rel="external">API Gateway에서 Step Function 호출을 지원</a>한다는 글이 2017.02.15 에 올라오긴 했다.</p>
<p>둘째, 빠른 API 응답을 위해서 사용할 수 있다.<br>Lambda를 만들었을 때의 원래 의도는 AWS 서비스 상에서의 event성 호출들에 대한 처리를 전적으로 할 목적이었다고 한다.<br>하지만 API Gateway가 나온 이후로 Lambda를 이용하여 Serverless API를 구축하는게 가능하다.<br>API를 호출한 사용자 입장에서 생각해 본다면 필요한 데이터를 빨리 응답해 주고, 나머지 작업들은 그 뒤에 따로 처리를 하는 방법이 있으면 좋을 것이다.<br>예를 들어서 사용자가 접속시 호출해야하는 API가 있다고 가정해보자.<br>이 API에서는 사용자가 이전에 어떤 작업을 하고 있었는지를 조회해서 알려줘야하며, 현재 시점의 접속 상태(시간, 위치, 접속한 기기정보 등)를 기록해야 한다면, 먼저 사용자에게 전달해야할 정보를 조회한 뒤, 기록해야 할 정보에 대해서 다른 Lambda를 비동기 invoke 한 후 응답을 하도록 설계가 가능하다.</p>
<p>Lambda에서 Lambda 를 호출하는 방법에는 동기 invoke와 비동기 invoke 2가지가 있다.</p>
<ul>
<li>동기 invoke : Lambda 호출 후 그 응답을 기다린다. 응답 결과를 보고 뭔가 처리를 해야할 경우에 사용된다.</li>
<li>비동기 invokde : Lambda 호출 후 응답을 기다리지 않고 지나간다.</li>
</ul>
<p>동기든 비동기든 둘 다 Lambda 비용에 대해서 생각을 한다면 Lambda 를 2개 이상으로 나누는 것이 무조건 손해이다.<br>Lambda는 과금이 <em>설정 메모리 x 수행시간(100 ms 단위)</em> 이다.<br>만약 평균 수행시간 199 ms 인 작업을 2개의 Lambda로 나뉠 경우 100 ms + 99 ms로 나뉜다면 1개로 하는 것과 같은 비용이 들겠지만 101ms + 98ms 로 나뉜다면 100ms 수행시간에 대한 비용을 더 지불해야 한다. 이건 비동기 호출의 경우이고, 동기 호출이라면 첫번째 Lambda가 2번째 Lambda를 기다려야 하므로 최선의 경우라도 300 ms 만큼의 요금이 부과될 것이다. 더군다나 2번째로 호출되는 Lambda가 cold start 될 경우 첫번째 Lambda가 그 응답을 기다려야 하므로 비용은 훨씬 더 늘 것이다.<br>이점을 충분히 고려해서 해당 비용을 감안하더라도 Lambda를 나누는것이 유리하다고 판단이 되는 작업을 나누길 바란다.</p>
<p>이제부터 Lambda에서 Lambda를 호출하는 방법들에 대해서 하나 하나씩 살펴보도록 하자.</p>
<p>예제는 <strong>Node.JS</strong>로 작업하겠다.<br>AWS내의 event를 <strong>JSON Object</strong>로 전달하므로 Node.JS로 작업하는게 가장 편하다.<br>다른 언어로 하려면 event 모양별로 model을 미리 선언해 주거나 stream을 이용해서 해당 언어별 JSON을 지원해주는 라이브러리로 전달하는 방법을 사용하여야 한다. 응답해야할 결과가 있고, 그것이 JSON Object일 경우에는 응답에도 똑같은 처리를 해줘야 한다. Python의 경우는 그나마 JSON 친화적(?) 이어서 Node.JS 다음으로 편한 것 같다.</p>
<h2 id="Lambda에서-Lambda를-호출하는-방법-1"><a href="#Lambda에서-Lambda를-호출하는-방법-1" class="headerlink" title="Lambda에서 Lambda를 호출하는 방법"></a>Lambda에서 Lambda를 호출하는 방법</h2><h3 id="1-Lambda를-직접-invoke"><a href="#1-Lambda를-직접-invoke" class="headerlink" title="1. Lambda를 직접 invoke"></a>1. Lambda를 직접 invoke</h3><p>유일하게 Lambda 간의 동기 invoke가 가능한 방법이다.<br>가장 쉬운 방법이기도 하다.</p>
<p>먼저 호출 될 Lambda를 먼저 등록하자.<br>Lambda 등록에 대한 설명은 생략하겠다.<br>이전에 포스팅한 글을 참조하길 바란다.</p>
<blockquote>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">AWS Lambda와 API Gateway를 이용해서 Serverless Web API 만들기</a></p>
</blockquote>
<h4 id="1-1-호출될-Lambda-등록"><a href="#1-1-호출될-Lambda-등록" class="headerlink" title="1.1 호출될 Lambda 등록"></a>1.1 호출될 Lambda 등록</h4><p>아래 코드로 <code>echoTest</code>란 이름으로 Lambda를 등록한다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">  <span class="built_in">console</span>.info(util.inspect(event, &#123;<span class="attr">depth</span>:<span class="literal">null</span>&#125;));</div><div class="line">  callback(<span class="literal">null</span>, event);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>등록 후 오른쪽 위를 보면 <code>ARN (Amazon Resource Name)</code>을 볼 수 있다.</p>
<blockquote>
<p><code>ARN</code> - arn:aws:lambda:{region}:{id}:function:echoTest</p>
</blockquote>
<p>이걸 이용해서 <code>aws-sdk</code>를 사용해서 Lambda를 호출할 것이다.</p>
<h4 id="1-2-동기-호출-코드"><a href="#1-2-동기-호출-코드" class="headerlink" title="1.2 동기 호출 코드"></a>1.2 동기 호출 코드</h4><p>이제 호출 할 Lambda를 작성해보록 하자.</p>
<p>먼저 local에서 테스트해보기 위해서는 <code>aws-sdk</code>를 설치해야 한다.<br>Lambda 상에는 설치가 되어 있으므로 같이 올릴 필요가 없다.</p>
<blockquote>
<p>npm install aws-sdk –save</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> aws = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</div><div class="line"><span class="keyword">const</span> lambda = <span class="keyword">new</span> aws.Lambda(&#123;</div><div class="line">  <span class="attr">region</span>: <span class="string">'ap-northeast-1'</span> <span class="comment">//change to your region</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> event = &#123; <span class="attr">id</span>: <span class="string">"1"</span>, <span class="attr">name</span>:<span class="string">"Luna"</span>&#125;;</div><div class="line">lambda.invoke(&#123;</div><div class="line">  <span class="attr">FunctionName</span>: <span class="string">'echoTest'</span>,</div><div class="line">  <span class="attr">Payload</span>: <span class="built_in">JSON</span>.stringify(event, <span class="literal">null</span>, <span class="number">2</span>) <span class="comment">// pass params</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (error) &#123;</div><div class="line">    <span class="built_in">console</span>.info(error);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">console</span>.info(data);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>만약 위 코드를 <code>index.js</code>로 저장했다면 아래와 같이 실행하면 결과를 확인할 수 있다.</p>
<blockquote>
<p>node index.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">StatusCode</span>: <span class="number">200</span>, <span class="attr">Payload</span>: <span class="string">'&#123;"id":"1","name":"Luna"&#125;'</span> &#125;</div></pre></td></tr></table></figure>
<h4 id="1-3-비동기-호출-코드"><a href="#1-3-비동기-호출-코드" class="headerlink" title="1.3 비동기 호출 코드"></a>1.3 비동기 호출 코드</h4><p>위 코드는 동기 invoke 하였다.<br>비동기로 하기 위해서는 예전에는 <code>InvokeAsync()</code> 함수를 사용했는데 이 방법은 <em>deprecated</em> 되었다.<br>지금은 <code>InvocationType</code>이란 인자에 <code>Event</code>값을 추가해주면 된다.<br>참고로 default인 동기 호출의 설정값은 <code>InvocationType: &#39;RequestResponse&#39;</code>이다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> aws = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</div><div class="line"><span class="keyword">const</span> lambda = <span class="keyword">new</span> aws.Lambda(&#123;</div><div class="line">  <span class="attr">region</span>: <span class="string">'ap-northeast-1'</span> <span class="comment">//change to your region</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> event = &#123; <span class="attr">id</span>: <span class="string">"1"</span>, <span class="attr">name</span>:<span class="string">"Luna"</span>&#125;;</div><div class="line">lambda.invoke(&#123;</div><div class="line">  <span class="attr">FunctionName</span>: <span class="string">'echoTest'</span>,</div><div class="line">  <span class="attr">InvocationType</span>: <span class="string">'Event'</span>,</div><div class="line">  <span class="attr">Payload</span>: <span class="built_in">JSON</span>.stringify(event, <span class="literal">null</span>, <span class="number">2</span>) <span class="comment">// pass params</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (error) &#123;</div><div class="line">    <span class="built_in">console</span>.info(error);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">console</span>.info(data);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>위와 같이 코드를 수정 후 호출하면 응답코드가 다르게 전달되는걸 확인할 수 있다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">StatusCode</span>: <span class="number">202</span>, <span class="attr">Payload</span>: <span class="string">''</span> &#125;</div></pre></td></tr></table></figure>
<p>앞의 동기 invoke의 경우 <code>200(성공)</code>으로 서버가 요청을 정상적으로 처리했다는 코드를 보내왔지만,<br>아래 비동기 invoke의 경우 <code>202(허용됨)</code>으로 서버가 요청을 접수했지만 아직 처리하지 않았다는 응답을 보내왔다.</p>
<p>Lambda 상에서 제대로 처리된지 볼려면 echoTest에 <code>console.info</code>로 출력한 내용을 보면 된다.</p>
<p>&gt;</p>
<ul>
<li>11:52:05<br>START RequestId: 094d4d3e-0c4f-11e7-ab68-a96f2d3f979f Version: $LATEST  </li>
<li>11:52:05<br>2017-03-19T02:52:05.890Z    094d4d3e-0c4f-11e7-ab68-a96f2d3f979f    { id: ‘1’, name: ‘Luna’ }  </li>
<li>11:52:05<br>END RequestId: 094d4d3e-0c4f-11e7-ab68-a96f2d3f979f  </li>
<li>11:52:05<br>REPORT RequestId: 094d4d3e-0c4f-11e7-ab68-a96f2d3f979f    Duration: 208.59 ms    Billed Duration: 300 ms Memory Size: 128 MB    Max Memory Used: 15 MB  </li>
<li>11:58:09<br>START RequestId: e23bf84a-0c4f-11e7-81f6-25e9632564aa Version: $LATEST  </li>
<li>11:58:09<br>2017-03-19T02:58:09.644Z    e23bf84a-0c4f-11e7-81f6-25e9632564aa    { id: ‘1’, name: ‘Luna’ }  </li>
<li>11:58:09<br>END RequestId: e23bf84a-0c4f-11e7-81f6-25e9632564aa  </li>
<li>11:58:09<br>REPORT RequestId: e23bf84a-0c4f-11e7-81f6-25e9632564aa    Duration: 23.59 ms    Billed Duration: 100 ms Memory Size: 128 MB    Max</li>
</ul>
<p>위 11:52에 수행된게 동기로 호출한 결과이며 아래 11:58에 수행된게 비동기로 호출한 결과이다. 둘 다 똑같이 <code>console.info</code>로 출력한 결과가 있는걸로 봐서 정상적으로 수행되었다고 판단할 수 있다. 수행시간이 다른건 앞에껀 cold start가 되었고, 뒤에껀 warm start가 된 결과로 보인다.</p>
<p>위 테스트 코드를 Lambda로 올리는 과정은 생략하겠다.<br>수행할 코드들을 <code>exports.handler = (event, context, callback) =&gt; { }</code>로 감싸서 올리면 된다.</p>
<h3 id="2-SNS의-Subscription으로-Lambda를-등록"><a href="#2-SNS의-Subscription으로-Lambda를-등록" class="headerlink" title="2. SNS의 Subscription으로 Lambda를 등록"></a>2. SNS의 Subscription으로 Lambda를 등록</h3><p><a href="https://aws.amazon.com/sns" target="_blank" rel="external">AWS SNS (Simple Notification Service)</a>는 간단한 푸시 알림 서비스이다.<br>SNS를 하나 만들어서 실행할 Lambda를 구독자로 등록해 놓고, 해당 SNS에 publish하는 방법으로 연동을 생각해 볼 수 있다.</p>
<h4 id="2-1-SNS-생성-및-Lambda를-subscription으로-등록"><a href="#2-1-SNS-생성-및-Lambda를-subscription으로-등록" class="headerlink" title="2.1 SNS 생성 및 Lambda를 subscription으로 등록"></a>2.1 SNS 생성 및 Lambda를 subscription으로 등록</h4><p>먼저 SNS를 생성한다.</p>
<ol>
<li>SNS dashboard에서 <code>Create topic</code>을 누름 (Topics에서 <code>Create new topic</code>를 눌러도 됨)</li>
<li>Topic 생성<ul>
<li>Topic name : testSns</li>
<li>Display name : testSns</li>
</ul>
</li>
</ol>
<p><code>Actions</code>를 눌러서 <code>Edit topic policy</code>나 <code>Edit topic delivery policy</code>를 눌러서 각종 설정이 가능하다.<br>여기에서는 그 내용에 대해서는 다루지 않겠다.<br>별로 어렵지 않으니 필요할 경우 직접 해보길 바란다.</p>
<p>이제 해당 SNS에 Lambda를 등록할건데,<br>앞에서 작성한 <code>testEcho</code>를 등록하도록 하자.</p>
<ol>
<li>생성된 SNS의 ARN링크  <code>arn:aws:sns:{region}:{id}:testSns</code>를 눌러서 <code>Topic details</code>로 들어감</li>
<li><code>Create subscription</code>을 누름<ul>
<li>Protocol : <code>AWS Lambda</code>를 선택</li>
<li>Endpoint : 실행할 Lambda의 ARN을 선택</li>
<li>Version or alias : 일단 default 그대로 둠 (실제 서비스 할 경우에는 alias로 설정을 해야 편함)</li>
</ul>
</li>
</ol>
<p>Version을 <strong>$LASTEST</strong>로 설정을 하면 관련 권한이 없다고 오류가 발생한다.<br>일단은 그냥 넘어가자.<br>실제 서비스 하는 경우라도 <strong>$LASTEST</strong>는 상당히 위험한 방법이다.<br>Lambda 배포 후 테스트 과정을 거쳐서 검증되기 전까지는 <code>alias</code>를 사용해서 믿을만한 버전으로 서비스하는게 좋다.</p>
<h4 id="2-2-SNS에서-Lambda-호출-테스트"><a href="#2-2-SNS에서-Lambda-호출-테스트" class="headerlink" title="2.2 SNS에서 Lambda 호출 테스트"></a>2.2 SNS에서 Lambda 호출 테스트</h4><p>SNS 콘솔에서 Lambda를 제대로 호출하는지 테스트 해보자.</p>
<ul>
<li><code>Topic details</code> 화면에서 <code>Publish to topic</code>를 누름<ul>
<li>Subject : <code>test subject</code></li>
<li>Message format : <code>JSON</code></li>
<li><code>JSON message generator</code>를 눌러서 Message에 입력 : <code>지켜보고 있다.</code></li>
<li><code>Generate JSON</code> 을 누름</li>
<li><code>Publish message</code> 누름</li>
</ul>
</li>
</ul>
<p>이제 Lambda 의 CloudFront로 가서 제대로 호출되었는지 살펴보자.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">Records</span>: </div><div class="line">[ &#123; <span class="attr">EventSource</span>: <span class="string">'aws:sns'</span>,</div><div class="line"><span class="attr">EventVersion</span>: <span class="string">'1.0'</span>,</div><div class="line"><span class="attr">EventSubscriptionArn</span>: <span class="string">'arn:aws:sns&#123;region&#125;:&#123;id&#125;:testSns:1009056c-eb87-4f68-9cb1-de50b0024b90'</span>,</div><div class="line"><span class="attr">Sns</span>: </div><div class="line">&#123; <span class="attr">Type</span>: <span class="string">'Notification'</span>,</div><div class="line"><span class="attr">MessageId</span>: <span class="string">'d0e91f46-c46c-5ead-9633-4e013fb6c04d'</span>,</div><div class="line"><span class="attr">TopicArn</span>: <span class="string">'arn:aws:sns&#123;region&#125;:&#123;id&#125;:testSns'</span>,</div><div class="line"><span class="attr">Subject</span>: <span class="string">'test subject'</span>,</div><div class="line"><span class="attr">Message</span>: <span class="string">'지켜보고 있다.'</span>,</div><div class="line"><span class="attr">Timestamp</span>: <span class="string">'2017-03-19T03:23:06.272Z'</span>,</div><div class="line"><span class="attr">SignatureVersion</span>: <span class="string">'1'</span>,</div><div class="line"><span class="attr">Signature</span>: <span class="string">'...'</span>,</div><div class="line"><span class="attr">SigningCertUrl</span>:  <span class="string">'https://...'</span>,</div><div class="line"><span class="attr">UnsubscribeUrl</span>: <span class="string">'https://...'</span>,</div><div class="line"><span class="attr">MessageAttributes</span>: &#123;&#125; &#125; &#125; ] &#125;</div></pre></td></tr></table></figure>
<p>위의 결과가 출력된걸로 봐서 제대로 호출되었다고 판단이 가능하다.</p>
<h4 id="2-3-코드에서-SNS를-호출하기"><a href="#2-3-코드에서-SNS를-호출하기" class="headerlink" title="2.3 코드에서 SNS를 호출하기"></a>2.3 코드에서 SNS를 호출하기</h4><p>아래와 같이 코드를 작성하자.<br>그냥 <code>sns.js</code>로 저장하도록 하겠다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</div><div class="line"></div><div class="line">AWS.config.update(&#123;</div><div class="line">  <span class="attr">accessKeyId</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">secretAccessKey</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">region</span>: <span class="string">'...'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> sns = <span class="keyword">new</span> AWS.SNS();</div><div class="line"><span class="keyword">const</span> params = &#123;</div><div class="line">  <span class="attr">TargetArn</span>:<span class="string">'arn:aws:&#123;region&#125;:&#123;id&#125;:testSns'</span>,</div><div class="line">  <span class="attr">Message</span>:<span class="string">'&#123;"id":"snsFromNodeJS", "name":"Luna"&#125;&#125;'</span>,</div><div class="line">  <span class="attr">Subject</span>: <span class="string">'TestSNS'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">sns.publish(params, <span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Error sending a message'</span>, err);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Sent message:'</span>, data.MessageId);</div><div class="line">    <span class="built_in">console</span>.info(data);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>실행하면 다음과 같은 응답을 얻을 수 있다.</p>
<blockquote>
<p>node sns.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">ResponseMetadata</span>: &#123; <span class="attr">RequestId</span>: <span class="string">'64efe66a-abfa-5a12-8abd-b72d55ebe4ce'</span> &#125;,</div><div class="line">  <span class="attr">MessageId</span>: <span class="string">'207e6adf-277a-5191-a94b-3b98d96b3f4d'</span> &#125;</div></pre></td></tr></table></figure>
<p>Lambda 의 CloudFront로 가서 제대로 호출되었는지 살펴보자.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[ &#123; <span class="attr">EventSource</span>: <span class="string">'aws:sns'</span>,</div><div class="line"><span class="attr">EventVersion</span>: <span class="string">'1.0'</span>,</div><div class="line"><span class="attr">EventSubscriptionArn</span>: <span class="string">'arn:aws:sns:&#123;region&#125;:&#123;id&#125;:testSns:1009056c-eb87-4f68-9cb1-de50b0024b90'</span>,</div><div class="line"><span class="attr">Sns</span>: </div><div class="line">&#123; <span class="attr">Type</span>: <span class="string">'Notification'</span>,</div><div class="line"><span class="attr">MessageId</span>: <span class="string">'207e6adf-277a-5191-a94b-3b98d96b3f4d'</span>,</div><div class="line"><span class="attr">TopicArn</span>: <span class="string">'arn:aws:sns:&#123;region&#125;:&#123;id&#125;:testSns'</span>,</div><div class="line"><span class="attr">Subject</span>: <span class="string">'TestSNS'</span>,</div><div class="line"><span class="attr">Message</span>: <span class="string">'&#123;"id":"snsFromNodeJS", "name":"Luna"&#125;&#125;'</span>,</div><div class="line"><span class="attr">Timestamp</span>: <span class="string">'2017-03-19T03:32:33.996Z'</span>,</div><div class="line"><span class="attr">SignatureVersion</span>: <span class="string">'1'</span>,</div><div class="line"><span class="attr">Signature</span>: <span class="string">'...'</span>,</div><div class="line"><span class="attr">SigningCertUrl</span>: <span class="string">'https://...'</span>,</div><div class="line"><span class="attr">UnsubscribeUrl</span>: <span class="string">'https://...'</span>,</div><div class="line"><span class="attr">MessageAttributes</span>: &#123;&#125; &#125; &#125; ] &#125;</div></pre></td></tr></table></figure>
<p>위 출력문으로 봐서 제대로 호출된게 확인 된다.</p>
<h3 id="3-Kinesis로-Lambda-호출하기"><a href="#3-Kinesis로-Lambda-호출하기" class="headerlink" title="3. Kinesis로 Lambda 호출하기"></a>3. Kinesis로 Lambda 호출하기</h3><p><a href="hhttps://aws.amazon.com/kinesis/streams" target="_blank" rel="external">AWS Kinesis</a> 는 스트리밍 데이터들을 처리하기 위한 용도로 만들어 졌다.<br>입력받은 데이터들을 100개 단위(설정에서 변경 가능)로 묶어서 처리한다던지 그런 용도로 많이 사용한다.<br>Kinesis를 Lambda에서 Lambda 호출용으로 사용하는건 좀 오바스럽긴 하지만 일단 한번 해보자.</p>
<h4 id="3-1-Kinesis-Stream-생성"><a href="#3-1-Kinesis-Stream-생성" class="headerlink" title="3.1 Kinesis Stream 생성"></a>3.1 Kinesis Stream 생성</h4><ul>
<li>Kinesis Streams 콘솔로 들어가서 <code>Create stream</code>를 누름<ul>
<li>Stream name : <code>testKinesis</code> 입력</li>
<li>Number of shards : <code>1</code>입력</li>
<li><code>Create stream</code>을 누름 (나머지 설정은 그냥 건드리지 않음)</li>
</ul>
</li>
</ul>
<p>Kinesis Stream이 만들어지고 난 다음 Details 탭으로 들어가서 ARN을 확인한다.</p>
<blockquote>
<p>arn:aws:kinesis:{region}:{id}:stream/testKinesis</p>
</blockquote>
<h4 id="3-2-Lambda에서-trggier로-Kinesis-등록하기"><a href="#3-2-Lambda에서-trggier로-Kinesis-등록하기" class="headerlink" title="3.2 Lambda에서 trggier로 Kinesis 등록하기"></a>3.2 Lambda에서 trggier로 Kinesis 등록하기</h4><p>먼저 Lambda의 Role에 Kinesis 관련 권한이 있는지 확인하고 없으면 추가해 준다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;kinesis:GetRecords&quot;,</div><div class="line">&quot;kinesis:GetShardIterator&quot;,</div><div class="line">&quot;kinesis:DescribeStream&quot;,</div><div class="line">&quot;kinesis:ListStreams&quot;</div></pre></td></tr></table></figure>
<p>위에 나열한 권한이 필요하다.</p>
<ol>
<li><code>echoTest</code> Lambda 설정으로 이동</li>
<li><code>Add trigger</code>를 누름<ul>
<li><code>Kinesis</code> 선택<ul>
<li>Kinesis stream : <code>testKinesis</code> 선택</li>
<li>Batch size : <code>1</code> 입력</li>
<li>Start position : <code>Trim horizon</code>을 선택</li>
<li><code>Submit</code> 누름</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="3-3-코드에서-Kinesis-호출하기"><a href="#3-3-코드에서-Kinesis-호출하기" class="headerlink" title="3.3 코드에서 Kinesis 호출하기"></a>3.3 코드에서 Kinesis 호출하기</h4><p>아래와 같이 코드를 작성하자.<br>그냥 <code>kinesis.js</code>로 저장하도록 하겠다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</div><div class="line"></div><div class="line">AWS.config.update(&#123;</div><div class="line">  <span class="attr">accessKeyId</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">secretAccessKey</span>: <span class="string">"..."</span>,</div><div class="line">  <span class="attr">region</span>: <span class="string">'...'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">const</span> kinesis = <span class="keyword">new</span> AWS.Kinesis();</div><div class="line"></div><div class="line"><span class="keyword">const</span> KinesisData = &#123;</div><div class="line">  <span class="attr">event_name</span>: <span class="string">"Kinesis 예제"</span>,</div><div class="line">  <span class="attr">event_created_at</span>: <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">const</span> params = &#123;</div><div class="line">  <span class="attr">Data</span>: <span class="built_in">JSON</span>.stringify(KinesisData),</div><div class="line">  <span class="attr">PartitionKey</span>: <span class="string">'partition'</span>,</div><div class="line">  <span class="attr">StreamName</span>: <span class="string">'testKinesis'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">kinesis.putRecord(params, <span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span> (err) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Error sending a message'</span>, err);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">console</span>.info(data);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>이제 실행해보자.</p>
<blockquote>
<p>node kinesis.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">ShardId</span>: <span class="string">'shardId-000000000000'</span>,</div><div class="line">  <span class="attr">SequenceNumber</span>: <span class="string">'49571470617410410658004564491315382019801680888626937858'</span> &#125;</div></pre></td></tr></table></figure>
<p>Lambda쪽 실행 결과를 살펴보자.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">Records</span>: </div><div class="line">[ &#123; <span class="attr">kinesis</span>: </div><div class="line">&#123; <span class="attr">kinesisSchemaVersion</span>: <span class="string">'1.0'</span>,</div><div class="line"><span class="attr">partitionKey</span>: <span class="string">'partition'</span>,</div><div class="line"><span class="attr">sequenceNumber</span>: <span class="string">'49571470617410410658004564491315382019801680888626937858'</span>,</div><div class="line"><span class="attr">data</span>: <span class="string">'eyJldmVudF9uYW1lIjoiS2luZXNpcyDsmIjsoJwiLCJldmVudF9jcmVhdGVkX2F0IjoiMjAxNy0wMy0xOVQwNDo0ODo0My4xOTlaIn0='</span>,</div><div class="line"><span class="attr">approximateArrivalTimestamp</span>: <span class="number">1489898923.642</span> &#125;,</div><div class="line"><span class="attr">eventSource</span>: <span class="string">'aws:kinesis'</span>,</div><div class="line"><span class="attr">eventVersion</span>: <span class="string">'1.0'</span>,</div><div class="line"><span class="attr">eventID</span>: <span class="string">'shardId-000000000000:49571470617410410658004564491315382019801680888626937858'</span>,</div><div class="line"><span class="attr">eventName</span>: <span class="string">'aws:kinesis:record'</span>,</div><div class="line"><span class="attr">invokeIdentityArn</span>: <span class="string">'arn:aws:iam::768556645518:role/lambda2'</span>,</div><div class="line"><span class="attr">awsRegion</span>: <span class="string">'ap-northeast-1'</span>,</div><div class="line"><span class="attr">eventSourceARN</span>: <span class="string">'arn:aws:kinesis:ap-northeast-1:768556645518:stream/testKinesis'</span> &#125; ] &#125;</div></pre></td></tr></table></figure>
<p>살펴보니 data의 값이 누가봐도 암호화 된 것으로 보인다.</p>
<blockquote>
<p>eyJldmVudF9uYW1lIjoiS2luZXNpcyDsmIjsoJwiLCJldmVudF9jcmVhdGVkX2F0IjoiMjAxNy0wMy0xOVQwNDo0ODo0My4xOTlaIn0=</p>
</blockquote>
<p><a href="http://docs.aws.amazon.com/kinesis/latest/APIReference/API_PutRecord.html" target="_blank" rel="external">Amazon Kinesis Streams Service API Reference</a> 를 보면 <code>base64</code>로 암호화 되었다고 나온다.</p>
<h4 id="3-4-Lambda-코드에서-Kinesis-Data-복호화"><a href="#3-4-Lambda-코드에서-Kinesis-Data-복호화" class="headerlink" title="3.4 Lambda 코드에서 Kinesis Data 복호화"></a>3.4 Lambda 코드에서 Kinesis Data 복호화</h4><p><code>echoTest</code> Lambda 코드를 아래와 같이 수정한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&apos;use strict&apos;;</div><div class="line"></div><div class="line">const util = require(&apos;util&apos;);</div><div class="line"></div><div class="line">exports.handler = (event, context, callback) =&gt; &#123;</div><div class="line">  const records = event.Records;</div><div class="line">  console.log(&quot;records =&quot;, records);</div><div class="line">  </div><div class="line">  records.forEach(r =&gt; &#123;</div><div class="line">    const data = new Buffer(r.kinesis.data, &apos;base64&apos;).toString(&apos;utf-8&apos;);</div><div class="line">    console.info(data);</div><div class="line">  &#125;);</div><div class="line">  </div><div class="line">  callback(null, event);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>다시 Kinesis 호출하는 코드를 실행해 보자.</p>
<blockquote>
<p>node kinesis.js</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123; <span class="attr">ShardId</span>: <span class="string">'shardId-000000000000'</span>,</div><div class="line">  <span class="attr">SequenceNumber</span>: <span class="string">'49571470617410410658004564491322635574719439376016736258'</span> &#125;</div></pre></td></tr></table></figure>
<p>Lambda쪽 실행 결과를 살펴보자.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"event_name"</span>: <span class="string">"Kinesis 예제"</span>,</div><div class="line">    <span class="string">"event_created_at"</span>: <span class="string">"2017-03-19T05:05:52.273Z"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>데이터가 잘 전달된 것을 확인할 수 있다.</p>
<p>Kinesis에서 받은 event를 보면 <strong>Records</strong>란 Key에 대해서 배열로 생성되어 있다.<br>Kinesis에서 Data들을 설정된 값 단위로 배열을 전달해 준다.<br>만약 100개로 선언되었다고 해서 항상 100개 단위로 주는건 아니다.<br>그 갯수 이하라도 데이터를 전달해주니 그걸 고려해서 코드를 작성해야 한다.</p>
<h3 id="4-그-밖에-방법들"><a href="#4-그-밖에-방법들" class="headerlink" title="4. 그 밖에 방법들"></a>4. 그 밖에 방법들</h3><p>앞의 Kinesis 연동 방법을 설정하는 중 Lambda의 Triggers 탭에서 본 것처럼 AWS 상의 여러 서비스에서 Lambda 수행이 가능하다.<br>그걸 이용해서 호출하려는 Lambda에서 해당 서비스에 데이터를 전달하고 Lambda를 호출하는 방법으로의 설정이 얼마든지 가능하다.<br>하지만 단순히 Lambda to Lambda 호출을 위해서 그런 방법을 사용하는건 비효율적인듯하다.</p>
<p>대신, 원래 하려는 작업이 S3나 DynamoDB에 데이터를 쌓는게 목적이라면 거기에 데이터를 저장하고 해당 작업에 대한 Trigger로 Lambda를 수행하도록 설정하는건 괜찮을것 같다.</p>
<p>이 내용에 대해서는 따로 다루지 않겠다.<br>AWS 공식문서 상에 자습서를 참고해서 따라해보면 금방 익힐 수 있을 것이다.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.Lambda.Tutorial.html" target="_blank" rel="external">자습서: DynamoDB 테이블에서 새 항목 처리</a></li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/03/19/Lambda.invoke.Lambda/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/03/11/Lambda.Tips.01/">
                            AWS Lambda 사용에 관련된 Tip
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-03-11T00:00:00+09:00">
	
		    Mar 11, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="AWS-Lambda-사용에-관련된-Tip"><a href="#AWS-Lambda-사용에-관련된-Tip" class="headerlink" title="AWS Lambda 사용에 관련된 Tip"></a>AWS Lambda 사용에 관련된 Tip</h1><p>그동안 AWS Lambda를 사용하면서 알게된 내용들과 최근 읽은 Lambda 관련 포스팅 내용들을 정리해 보았다.</p>
<h2 id="1-Memory-Configuration"><a href="#1-Memory-Configuration" class="headerlink" title="1. Memory Configuration"></a>1. Memory Configuration</h2><p><a href="https://aws.amazon.com/lambda/pricing" target="_blank" rel="external">Lambda의 과금</a>은 <code>실행 시간 x 사용한 메모리</code>에 의해 결정된다.</p>
<p>Lambda 실행에 메모리를 얼마나 사용하지는지를 볼려면 Lambda 내의 <code>Test</code>기능을 이용하면 확인이 가능하다.</p>
<p><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Tips.01.01.png?raw=true"></p>
<p>위 그림을 보면 <strong>1024 MB</strong>로 설정되어 있으며, 실제 사용량은 <strong>29 MB</strong>란 것을 알 수 있다.</p>
<p>Lambda가 실행하는 인스턴스의 성능은 메모리 설정값에 비례해서 CPU 성능도 결정되기 때문에 메모리 사용량이 적다고 무조건 거기에 맞게 설정을 하면 당연히 그만큼 수행시간이 길어 질 수가 있다.</p>
<p><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Tips.01.02.png?raw=true"><br><img src="https://github.com/DevStarSJ/Study/raw/master/Blog/Cloud/AWS/Lambda/images/Lambda.Tips.01.03.png?raw=true"></p>
<p>메모리를 1/10 정도로 줄이니 수행시간도 10배 정도로 더 늘어난 것을 확인할 수 있다.<br>그러므로 최소 과금으로 설정을 하기위해서 메모리를 무조건 수행가능한 최소로 설정하는 것보다는 설정값을 바꿔가면서 테스트를 해보고 결정을 하면 된다.<br>이렇게 미리 테스트를 해보면 이왕이면 같은 금액이면서 좀 더 빠르게 수행하는 방향으로 설정하는게 가능하다.</p>
<p>과금보다 빠른 서비스가 더 중요한 경우라면 메모리를 무조건 최대로 설정하는게 좋다.<br>하지만 메모리를 높인다고 해서 무조건 그만큼 더 빨리지는건 아니다. Lambda에서 동작하는 작업 성격에 따라 메모리 설정을 더 늘려도 더 이상 수행시간이 줄어들지 않거나 줄어드는 비중이 급격히 낮아지는 구간이 있으니 테스트 해본 후 적절히 설정하면 된다.</p>
<h2 id="2-Warm-Start"><a href="#2-Warm-Start" class="headerlink" title="2. Warm Start"></a>2. Warm Start</h2><p>Lambda를 실행하면 해당 코드를 컨테이너 같은데 할당하여 EC2 instance 형식으로 수행하는 것으로 알려져 있다.<br>그래서 최초 수행시 cold start(해당 자원을 할당받는 시간) 때문에 수행시간이 좀 더 걸린다.<br>위에 그림을 보더라도 첫번째 그림과 두번째 그림의 메모리 설정값이 같은데 수행시간이 다르다.</p>
<p>그걸 방지하는 방법으로 <a href="http://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/events/ScheduledEvents.html" target="_blank" rel="external">CloudWatch Schedule Event</a>를 이용해서 5분 간격으로 Lambda를 한번씩 호출해주면 늘 warm start(바로 수행이 가능한 상태)로 유지가 가능하다.<br>실제로 Lambda가 수행되면 안될 경우에 호출되었을 때를 대비해서 따로 ping 같은 요청에 대해서 아무 일도 하지 않도록 코드를 추가해 주어야 한다.</p>
<p>하지만 이것이 모든것을 해결해주는 것 같지는 않다.<br>회사에서 다른 동료분이 테스트 해본 결과를 보니 이미 warm start 가능한 Lambda가 떠있는 상태에서 호출이 많아져서 새로운 인스턴스로 Lambda를 올려야 하는 경우를 보니 cold start로 수행되는 것 같다는 결론에 도달했다.<br>아직 정확히 어떻게 동작하는지에 대해서 알려진바가 없으니 테스트를 수행하면서 응답시간이 얼마나 걸리는지를 가지고 추측할 뿐이다.</p>
<h2 id="3-Re-use-Lambda"><a href="#3-Re-use-Lambda" class="headerlink" title="3. Re-use Lambda"></a>3. Re-use Lambda</h2><p>위 항목에서 얘기했드시 Lambda가 warm start되는 경우 기존에 실행한 컨테이너를 재사용해서 수행한다.<br>이를 이용해서 Lambda 수행시간을 짧게 할 수 있도록 코드 작성이 가능하다.</p>
<p>전역 변수를 선언해 놓고 그 값으로 테스트 해보니 warm start되는 Lambda의 경우 그 값을 계속해서 가지고 있다.</p>
<p>이를 이용해서 각종 라이브러리(npm 포함)들에 대한 초기화 코드를 handler 안에서가 아니라 전역에서 수행해두면 warm start의 경우 다시 초기화 코드를 수행하지 않아도 된다. 단, 이로 인해 발생하는 사이드 이펙트가 있는 경우에는 그것에 대한 방어코드가 추가되어야 한다.</p>
<p>DB 커넥션 역시도 매번 <code>연결 -&gt; 쿼리수행 -&gt; 종료</code>를 수행하는것 보다는 전역에 커넥션 객체를 두고 연결이 안된 경우에만 연결을 수행하고 계속해서 재사용하는 것도 가능하다.<br>이 경우 재사용되는 Lambda에서는 다시 연결할 필요가 없으니 빨라진다.<br>하지만 자주 사용되지 않은 Lambda에 대해서는 DB 입장에서 비효율적이니 사용하면 안좋을 것이다.</p>
<p>그리고 필요없이 DB 커넥션이 오랫동안 유지될 수 있다는 단점도 있다.<br>예를 들어 평균 초당 100번 수행되며 평균 수행시간이 100ms인 Lambda의 경우 10개의 인스턴스가 활성화되어 있을 것이다.<br>그런데 갑자기 1초에 200개의 요청이 오고, 그 다음부터 다시 1초당 100번의 요청이 오는 경우를 생각해보자.<br>갑자기 200개의 요청이 온 것 때문에 10개의 인스턴스가 추가로 할당될 것이다. 그 다음부터는 다시 10개의 인스턴스만 있어도 수행이 되기 때문에 나머지 10개의 인스턴스에서는 15분 가량동안 사용하지 않는 DB 커넥션을 끊지 않고 계속 가지고있게 된다.</p>
<p>장점과 단점을 같이 가지고 있는 방법이므로 판단은 각자 알아서 하길 바란다. </p>
<h2 id="4-Lambda-Limit"><a href="#4-Lambda-Limit" class="headerlink" title="4. Lambda Limit"></a>4. Lambda Limit</h2><p>각 리젼별로 Lambda가 100개 동시 수행이 가능한 것으로 기본설정 되어 있다.<br>이를 넘길 경우 Lambda가 수행되지 않는다.<br>그래서 동시 수행되는 Lambda수를 제어하기 위해서 SQS를 활용하는 방법이 있다.<br>Lambda를 바로 요청하지 않고 해당 요청을 SQS로 보내고 SQS에서 동시 실행되는 Lambda 수를 고려해서 호출을 하는 방법이다.</p>
<p><a href="http://docs.aws.amazon.com/ko_kr/lambda/latest/dg/concurrent-executions.html" target="_blank" rel="external">관련 수식</a>에 따르면 아래와 같이 계산이 가능하다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Concurrent Invocations = events (or requests) per second * function duration (in secs)</div></pre></td></tr></table></figure>
<p>하지만 API Gateway + Lambda를 활용한 Web API Service와 같이 요청시간이 늘어나는 것이 안되는 경우도 있다.<br>이 경우에는 AWS에 요청하면 늘려준다.<br>이 경우 Lambda 뿐만 아니라 EC2의 Network Interface (350이 MAX)과 API Gateway (초당 1000번)의 리미트도 같이 늘려야 할수 있으니 잘 계산해서 같이 요청을 해야 한다.<br>참고로 현재 회사에서 사용중인 리미트는 Lambda 6000, Network Interface 4000, API Gateway 6000 per second 로 늘려놓은 상태이다. </p>
<h2 id="5-Devide-Batch-Task-for-Lambda"><a href="#5-Devide-Batch-Task-for-Lambda" class="headerlink" title="5. Devide Batch Task for Lambda"></a>5. Devide Batch Task for Lambda</h2><p>참고로 이 내용은 직접 겪은게 아니라 <a href="https://medium.com/@tjholowaychuk/dos-and-don-ts-of-aws-lambda-7dfcab7ad115#.xm94uvr5l" target="_blank" rel="external">Do’s and Don’ts of AWS Lambda</a>를 참고한 내용이다.</p>
<p>Lambda로 Batch 작업을 나눠서 작업해야 할 경우 해당 작업을 얼마나 잘게 나눠서 각 Lambda로 할당을 해야하는지에 대해서 고민을 해야한다.<br>대체적으로 연산이 많아서 CPU 사용량이 많은 경우는 최대한 Lambda로 잘게 나누는게 좋다.<br>반면 Lambda 자체의 연산보다는 외부 I/O 작업이 많은 경우는 Lambda 하나의 수행시간을 길게 가져가는게 좋다.</p>
<p>어찌보면 당연한 말같다.<br>CPU 연산이 많으면 최대한 병렬로 나누어서 CPU를 많이 사용하는 것이 당연히 좋을 것이다.<br>반면, DB 연결, SQS, Kinesis 등 다른 서비스 호출 등의 통신이 필요한 경우 커넥션을 맺는 오버해드가 있으니 한 번 연결을 맺고 계속해서 수행하는게 좋을 것이다.</p>
<h2 id="6-Logging-in-Lambda"><a href="#6-Logging-in-Lambda" class="headerlink" title="6. Logging in Lambda"></a>6. Logging in Lambda</h2><p>Lambda 수행 중 로그를 수집하기 위해서 외부 서비스를 사용하면 그만큼 Lambda 성능에 영향을 미치게 된다.</p>
<p>코드에서 <strong>Node.JS</strong>의 경우 <code>console.log, console.info</code>, <strong>.NET core</strong>의 경우 <code>Console.Writeline</code>로 출력을 하면 CloudWatch에서 확인이 가능하다.<br>이 방법을 이용하면 Lambda 성능에는 거의 영향을 미치지 않고 로그를 남길 수 있다.</p>
<p>하지만, CloudWatch 사용 또한 유료이기 때문에 무한정 쌓아둘수는 없다. 특정 기간 이후에 것을 S3로 보관하는 것도 가능하며, CloudWatch에 쌓인 로그를 다른 방법으로 별도 로그 시스템으로 저장을하면 원래 수행중인 Lambda 성능에는 영향을 주지 않고도 로그 수집이 가능하다.</p>
<hr>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li>Do’s and Don’ts of AWS Lambda : <a href="&#109;&#x61;&#x69;&#108;&#116;&#111;&#x3a;&#x68;&#116;&#x74;&#x70;&#x73;&#58;&#x2f;&#x2f;&#x6d;&#101;&#x64;&#x69;&#x75;&#x6d;&#x2e;&#99;&#x6f;&#109;&#x2f;&#64;&#116;&#x6a;&#x68;&#111;&#108;&#x6f;&#119;&#97;&#121;&#x63;&#104;&#117;&#107;&#x2f;&#x64;&#111;&#115;&#x2d;&#x61;&#x6e;&#100;&#x2d;&#100;&#x6f;&#110;&#45;&#x74;&#115;&#45;&#x6f;&#x66;&#x2d;&#97;&#119;&#x73;&#45;&#x6c;&#x61;&#x6d;&#98;&#100;&#97;&#x2d;&#x37;&#100;&#x66;&#99;&#x61;&#98;&#x37;&#97;&#100;&#49;&#49;&#x35;&#x23;&#x2e;&#120;&#x6d;&#x39;&#x34;&#x75;&#x76;&#x72;&#x35;&#x6c;">&#x68;&#116;&#x74;&#x70;&#x73;&#58;&#x2f;&#x2f;&#x6d;&#101;&#x64;&#x69;&#x75;&#x6d;&#x2e;&#99;&#x6f;&#109;&#x2f;&#64;&#116;&#x6a;&#x68;&#111;&#108;&#x6f;&#119;&#97;&#121;&#x63;&#104;&#117;&#107;&#x2f;&#x64;&#111;&#115;&#x2d;&#x61;&#x6e;&#100;&#x2d;&#100;&#x6f;&#110;&#45;&#x74;&#115;&#45;&#x6f;&#x66;&#x2d;&#97;&#119;&#x73;&#45;&#x6c;&#x61;&#x6d;&#98;&#100;&#97;&#x2d;&#x37;&#100;&#x66;&#99;&#x61;&#98;&#x37;&#97;&#100;&#49;&#49;&#x35;&#x23;&#x2e;&#120;&#x6d;&#x39;&#x34;&#x75;&#x76;&#x72;&#x35;&#x6c;</a></li>
<li>Best practices – AWS Lambda function : <a href="https://cloudncode.blog/2017/03/02/best-practices-aws-lambda-function" target="_blank" rel="external">https://cloudncode.blog/2017/03/02/best-practices-aws-lambda-function</a></li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/03/11/Lambda.Tips.01/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/02/26/MonolithToServerless.03/">
                            Monolith to Serverless using AWS Lambda (3)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-02-26T00:00:00+09:00">
	
		    Feb 26, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Monolith-to-Serverless-using-AWS-Lambda"><a href="#Monolith-to-Serverless-using-AWS-Lambda" class="headerlink" title="Monolith to Serverless using AWS Lambda"></a>Monolith to Serverless using AWS Lambda</h1><h2 id="기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기"><a href="#기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기" class="headerlink" title="기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기"></a>기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기</h2><p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.01.md" target="_blank" rel="external">이전글 : 1편. 서버리스를 하려는 이유</a><br><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.02.md" target="_blank" rel="external">이전글 : 2편. 장애 대응 플랜</a></p>
<h3 id="3편-Lambda-배포-후-겪게되는-일들"><a href="#3편-Lambda-배포-후-겪게되는-일들" class="headerlink" title="3편. Lambda 배포 후 겪게되는 일들"></a>3편. Lambda 배포 후 겪게되는 일들</h3><p>서버리스를 가능하게 해주는 서비스 중 가장 많이 알려진게 AWS <a href="https://aws.amazon.com/lambda" target="_blank" rel="external">Lambda</a>이다.<br>간단하게 설명하자면 서버를 실행해 놓는게 아니라 실행될 코드를 올려놓고 해당 코드를 실행시킬 이벤트를 발생시키면 코드가 동작하는 것이다.<br>코드가 어느 PC에서 동작하는지에 대해서는 우리가 신경쓸 필요없이 AWS에 전적으로 맡겨놓는다.<br>과금은 Lambda 실행시간(100ms 단위)으로 한다.<br>1편 글에서 얘기했듯, EC2 서버로 운영할때는 갑자기 요청이 몰리는 경우 서버에 장애가 발생할 수 있는데 Lambda의 경우는 그런 상황자체를 전부 AWS에서 알아서 해달라고 위임하는게 된다.<br>이렇게 생각하는게 보다는 AWS에서 많은 사용자가 공통으로 사용할 굉장히 큰 서버를 띄워놓고 우리는 거기에서 우리 코드가 실제로 실행되는 시간만큼만 과금을 한다라고 생각하는게 더 쉬운가 ?</p>
<p>Lambda를 수행하기 위해서는 <code>aws-sdk</code>를 이용해서 호출을 하거나, AWS 내의 각종 서비스들 CloudWatch, SQS, SNS, Kinesis, DynamoDB 등에서 트리거를 통해서 실행되게 할 수 있다.<br>Lambda를 API로 사용하기 위해서는 API Gateway를 통해서 url 형식으로 외부 요청을 받아서 Lambda 실행이 가능하다.<br>서버리스를 구현하기 위해서는 주로 이 방법을 사용한다. </p>
<h2 id="API-요청-정보-분석"><a href="#API-요청-정보-분석" class="headerlink" title="API 요청 정보 분석"></a>API 요청 정보 분석</h2><p>기존의 EC2로 수행하던 API 서버를 CloudFront를 통해서 수행되도록 설정하였다.<br>CloudFront에서는 요청들에 대해서 S3로 로그를 생성해주는 기능을 제공한다.<br>2편에서 설명한 장애 대응 플랜을 수행하는 동안 로그를 계속 쌓아두어서 이걸 분석하여 Lambda로 옮길 API의 순서를 정했다.</p>
<p>전체적으로 옮길 API수는 100개가 살짝 넘는 수였다.<br>하지만 로그를 보니 이전체가 지금 사용되는 것은 아니었다.<br>3주 동안 호출된 API의 수는 50 정도가 되었으며, 이 중 많이 호출되고 내부 코드가 비교적 간단한 것부터 작업을 시작했다.</p>
<p>S3에 쌓아둔 로그는 python의 boto3를 이용해서 그냥 노트북으로 다운받아서 gz 압축을 풀고 내가 필요한 정보만 따로 추려서 csv로 만들어서 각 url path 별로 호출 빈도를 카운팅하였다.<br>그런데 path를 인자로 사용하는 경우는 전부 다른 path url로 인식되어서 간단하게 그런 경우만 따로 path pattern을 만들어서 csv 파일을 만들도록 수정했다.</p>
<p>S3에 쌓아둔 로그를 보니 querystring 정보는 볼 수 있었지만, POST 요청에 대한 body 정보는 없었다. headers의 정보가 전부 다 있는건 아니었지만 중요한 몇가지는 제공해주고 있었다.</p>
<p>첫번째로 옮길 API는 네번째로 자주 요청되는 사용자 정보를 JSON 형식으로 보내주는 API(/user/{id})로 정했다.<br>Lambda 명칭도 그냥 <code>api-user-id</code>로 지었다.  </p>
<h2 id="첫번째-리미트-Lambda-리미트"><a href="#첫번째-리미트-Lambda-리미트" class="headerlink" title="첫번째 리미트 : Lambda 리미트"></a>첫번째 리미트 : Lambda 리미트</h2><p>AWS Lambda 리미트의 기본값은 각 리젼 당 <strong>100</strong>번이다.<br>동시에 수행가능한 Lambda의 수를 뜻한다.<br>대략적으로 수행시간이 100ms인 Lambda인 경우 초당 1천번까지 호출해도 괜찮다.<br>물로 이 수치는 평균적인 것이지 이런 요청이 순간적으로 100번 이상 호출되면 실패가 발생한다.<br>Lambda 리미트가 발생한 것은 Lambda쪽 CloudWatch 로그에서는 확인이 되지 않는다.<br>왜냐면 수행 자체가 안되었기 때문에 Lambda에 로그가 발생하지 않는다.<br>해당 Lambda로 연결된 API Gateway의 오류를 CloudWatch로 로그를 남기도록 설정하면 확인이 가능하다.<br>정확인 오류 메세지는 기억이 나지 않지만 <code>exceed</code>로 검색을 한것 같다.</p>
<p>현재 회사 계정에서는 도쿄 리젼에 Lambda 리미트를 <strong>200</strong>개로 늘려놓은 상태였다.</p>
<p><code>api-user-id</code>를 배포한 후 얼마 지나지 않아서 5XX 오류가 분당 150번 정도 계속 발생하였다.<br>일단 API를 원래대로 롤백한 후 로그를 보니 Lambda 리미트에 걸렸다.<br>처음부터 너무 요청이 많은 API를 옮긴것 같다.<br>AWS에 요청을 했다.<br>EC2로 되어있는 서버를 Lambda로 옮기고 있다.<br>100개가 넘는걸 모두 옮길려고 하는데 그 중 1개만 옮겼는데도 Lambda 리미트가 발생했다.<br>1 ~ 2k 정도로 좀 올려달라고 요청을 했더니 이틀 뒤 아침에 출근해서 확인하니 <strong>2000</strong>개로 리미트를 올렸다는 내용을 확인 할 수 있었다.</p>
<h2 id="두번째-리미트-Subnet-Limit"><a href="#두번째-리미트-Subnet-Limit" class="headerlink" title="두번째 리미트 : Subnet Limit"></a>두번째 리미트 : Subnet Limit</h2><p>Lambda 리미트가 2000개로 증가되었다는 소식을 듣고 API를 다시 배포하였다.<br>아침 일찍 배포했는데 정상적으로 잘 동작하고 있었다.<br>오후 4시에 앱 푸시가 나간 뒤 Lambda 수행이 분당 1만번을 넘기면서 5XX 오류가 지속적으로 발생했다.</p>
<p>다시 API를 롤백하고 API Gateway쪽 오류를 살펴보니 처음보는 메세지 였다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Endpoint response body before transformations:</div><div class="line">&#123;</div><div class="line">    &quot;Message&quot;: &quot;Lambda was not able to create an ENI in the VPC of the Lambda function because the limit for Network Interfaces has been reached.&quot;,</div><div class="line">    &quot;Type&quot;: &quot;User&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Execution failed due to configuration error: Malformed Lambda proxy response</div><div class="line"></div><div class="line">Method completed with status: 502</div></pre></td></tr></table></figure>
<p>VPC에서 ENI를 만들지 못했단다.<br>Lambda를 VPC에서 수행되도록 설정할 필요는 없다.<br>하지만 보안을 위해서 그렇게 설정해 놓는 경우가 많다.<br>MySQL의 경우 사용자 ID, 비밀번호로만 보안을 설정해 놓는것 보다는 특정 대역대의 IP들만 접속을 허용해 놓는게 더 안전하다.<br>Lambda 같은 경우는 어떤 IP로 생성되는지 우리가 알 수가 없으므로 VPC 설정을 통해서 특정 대역대의 subnet 안에서 생성되도록 설정이 가능하다.<br><strong>AWS VPC</strong> 서비스를 이용하여 생성된 VPC와 subnet을 설정해 두었다. subnet은 4000개짜리 2개를 설정했다.<br>합이 8000개인데, 동시 수행수가 2000개짜리 Lambda가 리미트에 걸려서 생성되지 않았다니…</p>
<p>그래서 16000개짜리 subnet을 하나 더 생성하였다.<br>기존에 수행중이던 Lambda도 많이 있었으므로, 이번에 새로 만든 api-user-id에는 기존의 4000개 subnet 하나와 새로만든 16000개 하나를 설정해 두었다.<br>합이 2만개인데 당연히 부족하지 않으리라 판단했다.</p>
<h2 id="세번째-리미트-Network-Interface-리미트"><a href="#세번째-리미트-Network-Interface-리미트" class="headerlink" title="세번째 리미트 : Network Interface 리미트"></a>세번째 리미트 : Network Interface 리미트</h2><p>사실상 두번째 리미트는 VPC 리미트가 아니라 Network Interface 리미트 였다.</p>
<p>이틀 뒤에 해당 API를 다시 배포했다.<br>그런데 비슷한 시기에 비슷한 빈도로 5XX 오류가 발생하였다.<br>분명 subnet의 수가 2배 이상으로 늘렸는데도 계속 오류가 발생하였다.<br>왜 그럴까 생각을 해봤는데, subnet 2개 (4000개, 16000개)를 합쳐서 2만개 중에 1개로 할당하는게 아니라 2개의 subnet 중 하나를 선택해서 거기에 할당을 하는 식을 동작하는게 아닌가라 판단된다.<br>그래서 바로 4000개의 subnet을 설정에서 삭제하였다.<br>삭제하자마자 요청 대비 오류가 50% 가까이로 발생했다.<br>다시 해당 API를 롤백했다.<br>그 뒤에 생각해보니 요청을 삭제한 subnet쪽 주소로 계속해서 보냈던 것으로 추정된다.<br>2개 중 1개를 삭제했으니 50% 정도의 오류가 발생한게 아닌가 생각된다.</p>
<p>그런데 문제는 subnet의 갯수가 부족해서가 아니라 다른 곳이었다.<br>AWS에 문의를 하니 <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html#vpc-limits-enis" target="_blank" rel="external">http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html#vpc-limits-enis</a> 링크를 보내주었다.<br>리전당 Network Interface가 최대 350개라고 설명이 되어 있다. 더 늘리고 싶으면 문의를 하라고 되어있다.<br>회사 동료분이 저 정보를 어디서 확인 가능한지 찾아주었다.</p>
<p>EC2로 들어가서 왼쪽에 보면 Network Interface라는 탭이 있다.<br>거기에 들어가보니 현재 사용중인 Network Interface가 341개 였고, 그중 Description이 AWS Lambda 로 시작하는게 240개가 넘었다.<br>다시 AWS에 문의를 하여 해당 리미트를 늘려달라고 하였더니 2000개로 늘려줬다는 답변이 왔다.</p>
<p>일단 subnet을 4000개 6개로 다시 할당을 하여서 배포를 했는데, 그 뒤로는 해당 오류가 더 이상 발생하지 않고 정상적으로 동작하였다.</p>
<h2 id="네번째-리미트-API-Gateway-리미트"><a href="#네번째-리미트-API-Gateway-리미트" class="headerlink" title="네번째 리미트 : API Gateway 리미트"></a>네번째 리미트 : API Gateway 리미트</h2><p>API Gateway에도 리미트가 있다.<br>기본적으로는 평균 초당 1000번, 최대 1초당 2000번의 요청을 처리 가능하도록 되어있다.</p>
<p>CloudWatch를 통해서 살펴보던 중 특정 시간대에 5XX 오류가 발생되었길래 그때를 살펴보니 1분에 2만번 정도의 요청이 있었다.<br>초당 요청으로 계산하면 API Gateway의 리미트보다 작았지만, 혹시 짧은 시간에 2000번 이상의 요청이 있지 않았나 판단되어 AWS에 요청하였으나,<br>API Gateway의 문제는 아니었고, Lambda 리미트가 발생한 것으로 판단되었다면서 Lambda 리미트를 3000개로 늘려주었다.</p>
<h2 id="그-이후…"><a href="#그-이후…" class="headerlink" title="그 이후…"></a>그 이후…</h2><p>그 뒤 해당 API는 잘 동작하고 있다.<br>다른 API들도 작업해서 배포를 했는데 아무런 문제가 없다.<br>하지만 앞으로 몇 개의 API를 더 배포하면 현재의 리미트를 다시 넘기지 않을까 걱정이 된다.<br>그걸 미리 예측해서 AWS에 요청을 하면 과연 들어줄지 모르겠다.<br>그래서 항상 API를 배포하고는 Lambda 실행수, Network Interface 수 등에 대해서 모니터링을 하고 있다.</p>
<h2 id="기타-작업하면서-겪은-일들"><a href="#기타-작업하면서-겪은-일들" class="headerlink" title="기타 작업하면서 겪은 일들"></a>기타 작업하면서 겪은 일들</h2><h3 id="1-CloudFront"><a href="#1-CloudFront" class="headerlink" title="1. CloudFront"></a>1. CloudFront</h3><p>CloudFront에서 캐시설정 할 때 headers에 토큰 같은것을 전달하여 그것에 대해서 다른 값을 줘야할 경우에는 사용하면 안된다.<br>headers에 다른 정보를 전달하더라도 쿼리스트링이 동일한 경우 캐시에서 같은 값으로 응답한다.</p>
<p>CloudFront에서 API Gateway로 headers의 정보 중 포워드 할게 있는 경우 host 정보를 넘겨주면 CloudFront 오류가 발생한다.</p>
<h3 id="2-Lambda"><a href="#2-Lambda" class="headerlink" title="2. Lambda"></a>2. Lambda</h3><p>Lambda 작업시 <code>console.log</code> 같이 출력문을 넣어주면 해당 Lambda의 CloudWatch에서 출력문을 볼 수 있다.<br>이걸 이용해서 초반에 테스트 할 때는 필요한 모든 곳에 <code>console.log, console.info, console.dir</code> 등을 이용해서 확인이 가능하며,<br>서비스용으로 올릴때도 <code>event</code> 정보는 <code>console.info</code>로 출력을 해 놓으면 오류 발생시 뭐 때문이지 확인할때 편리하다.<br>API Gateway의 로그를 보면 event정보가 짤려서 출력되기 때문에 전체 다를 볼려면 Lambda쪽에서 출력해줘야 한다.<br>당연히 이렇게 하면 성능에 영향을 미치므로 그게 걱정스럽다면 최소한 <code>try-catch</code>를 이용해서 오류 상황에서만이라도 출력해 놓으면 나중에 디버깅 할 때 좋다.</p>
<p>TypeScript로 작업할 경우 Node 4.3에서 정상적으로 동작하는 코드라도 Lambda에 올렸을 경우 동작하지 않을 수도 있으니 꼭 테스트를 먼저 해보고 작업을 하는게 좋다.<br>class, async/await 등은 제대로 되지만 static, default parameter 등에 대해서는 제대로 동작하지 않는다.</p>
<h3 id="3-API-Gateway"><a href="#3-API-Gateway" class="headerlink" title="3. API Gateway"></a>3. API Gateway</h3><p>API Gateway는 Lambda 호출후 30초 동안만 기다린다.<br>그러니 해당 Lambda 실행시간을 30초 이상으로 설정할 필요가 없다.</p>
<p>API Gateway를 {proxy+} 설정으로 사용하고, 1개의 Lambda에서 2가지 이상의 API 코드가 들어있더라도, Lambda를 다른 이름으로 배포하여 각 API별로 할당하는게 좋다.<br>만약 1개의 Lambda에 2개 이상의 API가 같이 처리 될 경우 오류 발생 상황에서 로그로 확인하는게 힘들다.<br>이게 맘에 안든다면 더 이상 오류가 발생하지 않고 안정적으로 서비스되고 있는 상황에서 Lambda 및 API Gateway의 {proxy+} 설정을 합치면 된다.</p>
<p>API Gateway에는 쿼리스트링을 파싱하여 JSON 형태로 Lambda에 전달된다.<br>그런데 그 과정에서 기존의 다른 웹 프레임워크랑 다르게 동작한다.<br>대표적인 예가 쿼리스트링의 경우 구분자로 <code>&amp;</code>를 사용하는데 API Gateway에서는 <code>;</code>도 구분자로 인식은 한다.<br>그렇기 때문에 <code>?idList=1;2;3&amp;filter=name;phone&amp;flag=1;2</code>로 전달할 때 API Gateway는 <code>{IdList: 1, 2: , 3: , filter:name, phone: , flag: 1}</code> 식으로 해석을 해버린다.<br>저런 모양이라도 억지로 해석해서 사용하는 방법도 있지만 그 과정에서 idList의 2와 flag의 2개 같은 key로 인식이 되어서 해석이 애매모호해진다.<br>배열값을 <code>?id=1&amp;id=2&amp;id=3</code>의 모양으로 전달할 경우에도 <code>{id:3}</code>으로 마지막값 하나만 남겨두고 다 사라진다.<br>현재로서는 제대로 처리되도록 하는 방법을 찾지 못했다.<br>CloudFront상의 리퀘스트 로그를 살펴보면 쿼리스트링의 모양이 그대로 남아있는 것으로 봐서는 LambdaEdge를 사용해서 쿼리스트링을 수정한 뒤 API Gateway로 전달하여 처리하는 방법도 있겠지만,<br>현시점(2017년 2월) LambdaEdge는 프리뷰인데다가 리젼당 100개의 리미트 밖에 허용하지 않아서 실제 서비스에 사용하기에는 망설여진다.<br>당연한 이야기지만 요청하는 쪽에서 <code>;</code>를 인코딩하여 <code>%3B</code>로 전달하면 정상적으로 처리가 가능하다.</p>
<h2 id="Lambda와-API-Gateway를-이용해서-Serverless-Web-API-만들기"><a href="#Lambda와-API-Gateway를-이용해서-Serverless-Web-API-만들기" class="headerlink" title="Lambda와 API Gateway를 이용해서 Serverless Web API 만들기"></a>Lambda와 API Gateway를 이용해서 Serverless Web API 만들기</h2><ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.CSharp.md" target="_blank" rel="external">Lambda C# Handler 만들기</a></li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/02/26/MonolithToServerless.03/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/02/25/MonolithToServerless.02/">
                            Monolith to Serverless using AWS Lambda (2)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-02-25T00:00:00+09:00">
	
		    Feb 25, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Monolith-to-Serverless-using-AWS-Lambda"><a href="#Monolith-to-Serverless-using-AWS-Lambda" class="headerlink" title="Monolith to Serverless using AWS Lambda"></a>Monolith to Serverless using AWS Lambda</h1><h2 id="기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기"><a href="#기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기" class="headerlink" title="기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기"></a>기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기</h2><p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.01.md" target="_blank" rel="external">이전글 : 1편. 서버리스를 하려는 이유</a></p>
<h3 id="2편-장애-대응-플랜"><a href="#2편-장애-대응-플랜" class="headerlink" title="2편. 장애 대응 플랜"></a>2편. 장애 대응 플랜</h3><p>기존에 잘 돌아가고 있는 API 서버 (EC2)를 서버리스(Lambda)로 변경하고자 한다.<br>만약 람다로 구현한 API가 정상동작하지 않는 경우 기존의 EC2 서버로 되돌리면 된다.<br>이게 끝. 심플하지 않은가 ?<br>이 심플함을 구현하기 위해 얼마나 컴플랙스한 일들이 필요한지에 대한 것이 2편의 전반적인 내용이다.</p>
<h2 id="기존-API-서버에-대한-정보"><a href="#기존-API-서버에-대한-정보" class="headerlink" title="기존 API 서버에 대한 정보"></a>기존 API 서버에 대한 정보</h2><p>만약 <code>api.luna.com</code>이란 이름의 API 서버를 EC2에 올려놓고 오토 스케일링 (<a href="https://aws.amazon.com/elasticbeanstalk" target="_blank" rel="external">AWS의 Elastic Beanstalk</a> 을 통해 서비스하고 있는 경우라면,<br>ELB에서 제공해 주는 url은 <code>api-luna.elasticbeanstalk.com</code>과 같은 이름이 된다. 이것을 <code>api.luna.com</code>란 이름의 도메인을 쓰기 위해서는 <strong>DNS</strong> 서비스를 이용해야 한다.<br>회사에서는 <a href="https://www.cloudflare.com" target="_blank" rel="external">CloudFlare</a>라는 서비스를 이용하는데 <strong>CDN</strong>은 거의 사용하지 않고 <strong>DNS</strong>로만 사용한다.</p>
<p>즉, 아래와 같은 모양으로 되어 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- C#으로 되어 있는 API Server : ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api.luna.com)</div></pre></td></tr></table></figure>
<p>만약 API의 url이나 파라메터 정보들을 수정하게 된다면, 해당 API를 사용하는 웹, 앱(안드로이드, 아이폰)도 함께 수정해서 배포를 해야하니 일이 커진다.<br>그리고 만약 장애시 다시 되돌리지도 못한다.<br>그래서 기존 url은 바꾸지 않고 가야한다.<br>같은 url에 path 정보가 다른 것들에 대해서 서로 다른 엔드포인트로 보낼려면 어떻게 해야할까 ? (람다는 서버가 아니므로 그냥 엔드포인트(endpoint)로 하겠다.)</p>
<p><a href="https://aws.amazon.com/cloudfront" target="_blank" rel="external">AWS CloudFront</a>라는 <strong>CDN</strong>을 사용하면 각 path 별로 캐시 정책, 엔드포인트 등의 설정을 다르게 할 수 있다.<br>일단 기존에 ELB에서 돌아가는 서버를 CloudFront를 통해서 서비스 되도록 설정을 변경하였다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- 기존 API Server의 DNAME 변경 : ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)</div><div class="line">- 기존 주소를 CloudFront로 연결 : CloudFront(cf1.cloudfront.net) &lt;- DNS(api.luna.com)</div><div class="line">- CF의 Default(*) Origin을 api-origin.luna.com 으로 설정</div></pre></td></tr></table></figure>
<p>하나의 흐름으로 그려보면 아래와 같이 된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com) &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api.luna.com)</div></pre></td></tr></table></figure>
<p>새로만드는 람다를 API Gateway를 통해서 서비스 할 경우 CloudFront에서 해당 path에 대해서만 람다를 보도록 설정을 붙이기만 하면 된다.<br>(람다로 만든 API의 path가 <code>api.luan.com/user/{id}</code>라고 가정하고, 람다명칭을 <code>api-user-id</code>라고 할 경우)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api.luna.com)</div><div class="line">Lambda(api-user-id) &lt;- API Gateway(exec-api.amazonaws.com/service) &lt;-</div></pre></td></tr></table></figure>
<p>이런 모양으로 구성이 된다.<br>이건 API를 어떻게 구상하냐는 것에 대한 것이고 장애대응에 대한건 아직 고려되지 않은 형태이다.</p>
<h2 id="장애대응"><a href="#장애대응" class="headerlink" title="장애대응"></a>장애대응</h2><p>앞에서 얘기했듯이 API가 정상적으로 동작하지 않아서 장애가 났을 때는 해당 API 대신 그냥 기존의 EC2(api-origin.luna.com)을 바라보게하면 된다.<br>아주 심플하다.<br>그럼 이 심플함을 어떻게 구성해야 할까.</p>
<h3 id="첫번째-생각-CloudFront에서-Behavior-삭제"><a href="#첫번째-생각-CloudFront에서-Behavior-삭제" class="headerlink" title="첫번째 생각 : CloudFront에서 Behavior 삭제"></a>첫번째 생각 : CloudFront에서 Behavior 삭제</h3><p>CloudFront에서 람다로 향하는 <strong>Behavior</strong>를 삭제한다.<br>그러면 <strong>api-origin</strong>을 바라볼 것이다. 끝 ?</p>
<p>하지만…<br>CloudFront는 특정 지역(region)별로 서비스되는게 아니라 글로벌로 서비스된다.<br>그리고 설정을 변경하면 전체적으로 반영되는데 40분 정도의 시간이 걸린다.<br>40분동안 장애난 상황을 멀뚱멀뚱 지켜만 봐도 될까 ?<br>당연히 난리난다.<br>일단 이 방법은 안된다.</p>
<p>테스트 해볼 가치도 없다.<br>그냥 패스하자.</p>
<h3 id="두번째-생각-DNS만-살짝-바꿔서-다른-CloudFront를-바라보게-설정"><a href="#두번째-생각-DNS만-살짝-바꿔서-다른-CloudFront를-바라보게-설정" class="headerlink" title="두번째 생각 : DNS만 살짝 바꿔서 다른 CloudFront를 바라보게 설정"></a>두번째 생각 : DNS만 살짝 바꿔서 다른 CloudFront를 바라보게 설정</h3><p>CloudFront를 2개를 만든다.<br>위에서 설정한 <strong>cf1</strong> 과 api-origin만 바라보는 <strong>cf2</strong>.<br><code>api.luna.com</code>은 <strong>cf1</strong>을 향하게 하다가 장애 발생시 <strong>cf2</strong>를 바라보게 설정하면 된다.<br>DNS 바꾸는건 바로 반영되기 때문에 장애 대응 시간을 2분 정도로 줄일 수 있다.</p>
<p>일정 기간동안 정상적으로 서비스되었다고 판단이 되는 api에 대해서는 <strong>cf2</strong>의 behavior에도 추가를 해놓으면 된다.<br>그러면 장애 발생시 <strong>cf2</strong>로 되돌리더라도 새로 추가한 api에 대해서만 롤백이 된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api.luna.com)</div><div class="line">Lambda(api-user-id) &lt;- API Gateway(exec-api.amazonaws.com/service) &lt;-</div><div class="line"></div><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf2.cloudfront.net)</div></pre></td></tr></table></figure>
<p>위 그림과 같이 서비스하다가 장애 발생시 <code>api.luna.com</code>의 주소만 <strong>cf2</strong>로 변경하면 된다.<br>일단 <strong>cf2</strong>를 만들어 보았다.<br>안만들어진다.<br>CloudFront에서 DNS를 사용하기 위해서는 <strong>CNAMEs</strong>를 설정해야 한다.<br>그런데 서로 다른 CloudFront가 같은 CNAME을 가지도록 설정이 안된다.<br>왜 안된다는 건지 이해가 안된다.<br>어차피 실제로 같은 DNS가 동시에 2개의 CloudFront를 바라보고 있다는거 자체가 말이 안되는데 그렇게 설정하게 좀 해줘도 상관없지 않나 ?<br>일단 안된다니깐 이 방법은 사용할 수 없다.</p>
<h3 id="세번째-생각-그럼-DNS를-여러개-설정"><a href="#세번째-생각-그럼-DNS를-여러개-설정" class="headerlink" title="세번째 생각 : 그럼 DNS를 여러개 설정"></a>세번째 생각 : 그럼 DNS를 여러개 설정</h3><p>CloudFront가 같은 CNAME으로 설정이 안되니 DNS를 여러개 만들어서 DNS단에서 스와핑을 하면 해결되지 않을까 ?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api1.luna.com)</div><div class="line">Lambda(api-user-id) &lt;- API Gateway(exec-api.amazonaws.com/service) &lt;-</div><div class="line"></div><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf2.cloudfront.net) &lt;- DNS(api2.luna.com)</div><div class="line"></div><div class="line">DNS(api1.luna.com) &lt;- DNS(api.luna.com)</div></pre></td></tr></table></figure>
<p>이렇게 DNS 끼리 연결해두고 장애 발생시 api.luna.com 이 api2.luna.com 을 바라보게 설정하면 된다.<br>너무 쉽다.</p>
<p>그런데…<br>CloudFront의 CNAME에 <code>api1.luna.com</code> 이라 설정해두고, <code>api1.luna.com &lt;- api.luna.com</code>으로 설정을 하면 <code>api.luna.com</code>은 CNAME으로 설정되어 있지 않다고 오류가 발생한다.<br>음… 어쨌든 안된단다. 다른 방법을 또 생각해 봐야지.</p>
<h3 id="네번째-생각-API-Gateway에서-EC2를-바라보게-설정"><a href="#네번째-생각-API-Gateway에서-EC2를-바라보게-설정" class="headerlink" title="네번째 생각 : API Gateway에서 EC2를 바라보게 설정"></a>네번째 생각 : API Gateway에서 EC2를 바라보게 설정</h3><p>이 방법만은 사용하지 않으려 했는데…<br>이 방법 밖에 없는것 같다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api1.luna.com)</div><div class="line">Lambda(api-user-id) &lt;- API Gateway(exec-api.amazonaws.com/service) &lt;-</div></pre></td></tr></table></figure>
<p>위의 형태로 서비스를 하다가 <code>api-user-id</code>에 장애가 발생한 경우</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- DNS(api-origin.luna.com)     &lt;- CloudFront(cf1.cloudfront.net) &lt;- DNS(api1.luna.com)</div><div class="line">ELB(api-luna.elasticbeanstalk.com) &lt;- API Gateway(exec-api.ama...) &lt;-</div></pre></td></tr></table></figure>
<p>이렇게 API Gateway에서 람다 대신에 <code>api-origin</code>을 바라보게 설정을 변경한다.<br>먼저 이렇게 해서 장애 상황을 일단 해결한 후 CloudFront에서 behavior를 삭제하고 40분뒤에 적용되면 다시 API Gateway를 람다를 바라보도록 수정하고 API를 수정하는 식으로 작업을 진행하면 된다.</p>
<h3 id="네번째-생각의-보완점들"><a href="#네번째-생각의-보완점들" class="headerlink" title="네번째 생각의 보완점들"></a>네번째 생각의 보완점들</h3><p>테스트해보니 원하는대로 동작한다.<br>하지만 뭔가 찜찜한게 몇 가지 있다.</p>
<p>그 중 첫번째는 장애 발생시 마우스 클릭이나 미리 설정해놓은 스크립트 실행 같은 방법이 아니라 AWS 콘솔로 접속해서 설정을 하나하나 바꿔주면서 <code>api-luna.elasticbeanstalk.com/user/{proxy}</code> 또는 <code>api-origin.luna.com/user/{proxy}</code> 이렇게 입력해줘야 한다.<br>완벽한 해결방법은 아니지만, API Gateway를 발행할때 먼저 <code>api-origin</code>을 바라보게 배포하고, 다시 수정해서 람다를 바라보게 배포하면 된다.<br>그럼 해당 스테이징에 가보면 2가지 경우가 모두 <code>Deployment History</code>에 남아있어서 과거 버전을 선택한 후 <code>Change Deployment</code> 버튼을 누르면 된다.</p>
<p>두번째는 API Gateway url끝에 스테이지명을 항상 붙여줘야 한다.<br>만약 스테이지를 <code>service</code>로 설정했다면 <code>exec-api.amazonaws.com/service</code>이런식의 url을 가지게 된다.<br>url을 줄여주기 위해서 DNS를 설정하려고 해도 <code>/service</code> 때문에 원하는대로 설정이 안된다.<br>그렇다고 DNS에서 주는 이름 뒤에  <code>/service</code>를 붙이는 것으로 <code>CloudFront</code>에서 behavior를 설정하려는 순간 막막해진다.</p>
<p>API Gateway에 <code>Custom Domain Names</code> 탭으로 가면 이름을 이쁘게 지어줄수 있다.<br>하지만 SSL용 인증서를 등록해야 하는데, AWS의 인증서는 또 지원을 해주지 않는다.<br>그래서 무료 인증서인 <a href="https://letsencrypt.org" target="_blank" rel="external">Lets’ Encrypt</a>에서 발급받으면 된다.<br>발급받는것도 쉽지는 않다. 인증서 발급을 위해서 현재 해당 주소의 서버를 사용중이라 것을 증명해야하는데 API Gateway에서 그 인증을 해줄수가 있나 ?<br>발급받은 방법이 여러가지 있는데…<br>그 중 하나를 대충 설명하자면 <code>nginx</code>를 이용해서 임시로 서버를 하나 띄워서 DNS에서 그 서버를 바라보게 설정한 후 인증서를 발급받아서 사용하면 된다.<br>구글에서 검색해보면 관련 방법 및 코드들이 쭉 나온다. 회사 동료분중 이미 해당 작업을 위한 코드를 만들어두고 발급받고 계신분이 있어서 그 분 도움을 받아서 쉽게 발급 받을 수 있었다.</p>
<p>처음엔 SSL 인증서 발급받는게 귀찮아서, <strong>Custom Domain Name</strong>을 사용하지 않을려고 그 과정 자체를 <code>API Gateway &lt;- CloudFront &lt;- DNS</code> 식으로 몇 단계를 더 거치게 했었는데<br>그 과정에서도 CloudFront에서 SSL 인증서를 써야하고… (기존 서비스에 쓰던걸 같이쓰면 되긴 했다.) 설정 자체도 너무 복잡해져서 다시 <strong>Custom Domain Name</strong>을 사용하기로 결정했다.</p>
<h3 id="실제로-적용"><a href="#실제로-적용" class="headerlink" title="실제로 적용"></a>실제로 적용</h3><p>처음 API를 배포할때는 네번째 방법(장애발생시 API Gateway에서 EC2를 바라보게 설정)을 사용했지만, 지금은 그냥 첫번째 방법(CloudFront에서 behavior를 삭제)을 사용한다.<br>사실 삭제도 아니고 그냥 url 앞에 <code>/test</code> 이런걸 붙여서 주소만 바꿔버린다.<br>40분동안 장애가 나도록 그냥 내버려 두고 있냐고 ?<br>그건 당연히 아니다.<br>CloudFront의 설정을 수정하면 그게 완벽하게 적용되었다고 콘솔상에 표시되는건 40분 정도가 걸리지만, 실제로 적용되는건 평균 1분 정도, 아무리 길어도 3분 이내에는 바뀌는게 확인되었다.<br>내부적으로 어떻게 동작하는지 알 수는 없지만 현재 AWS 도쿄 리전만 사용을 하다보니 CloudFront에서도 일단 가장 많이 사용하는 도쿄 리전부터 적용해주는 것으로 보인다.</p>
<p>어떻게 이 사실을 알수가 있었냐면 새로운 API 배포시 해당 람다, API Gateway에 대한 주요 수치들에 대해서 <strong>CloudWatch Metrics</strong>에 미리 등록해두고 모니터링을 했다.<br>배포전에 먼저 CloudWatch부터 띄워둔체로 배포를 하고 계속 수치 및 그래프를 확인하고 있으니깐 거의 바로 람다로 호출이 들어오는 것이 확인되었다.<br>API 배포 초반에는 거의 배포하자마자 바로 장애가 났었다. 그래서 2주 동안은 배포, 롤백을 몇 번씩 겪었다. 그러면서 CloudWatch 상의 각종 수치들을 보고 어떻게 해석해야하는지에 대해서 자연스럽게 잘 알게 되었다.<br>네번째 방법이 아무래도 첫번째 방법보다는 손이 많이 간다. 그렇게 해서 되돌리는 시간과 그냥 첫번째 방법으로 behavior만 삭제한 후 적용되는 시간의 차이가 거의 없었다. 오히려 첫번째 방법이 더 빠르게 적용되 되는 것으로 판단되었다.</p>
<h4 id="다음-글에-계속…"><a href="#다음-글에-계속…" class="headerlink" title="다음 글에 계속…"></a>다음 글에 계속…</h4><p>다음 글에는 람다 배포 후 들이닥치게 되는 각종 리미트들… 리미트 뒤에 숨어있는 또 다른 리미트들에 대한 이야기를 쓸 예정이다.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.03.md" target="_blank" rel="external">다음글 : 3편. Lambda 배포 후 겪게되는 일들</a></p>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/02/25/MonolithToServerless.02/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/02/23/MonolithToServerless.01/">
                            Monolith to Serverless using AWS Lambda (1)
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-02-23T00:00:00+09:00">
	
		    Feb 23, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Monolith-to-Serverless-using-AWS-Lambda"><a href="#Monolith-to-Serverless-using-AWS-Lambda" class="headerlink" title="Monolith to Serverless using AWS Lambda"></a>Monolith to Serverless using AWS Lambda</h1><h2 id="기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기"><a href="#기존-모노리스-API-서버를-AWS-Lambda를-이용하여-서버리스로-변경하기" class="headerlink" title="기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기"></a>기존 모노리스 API 서버를 AWS Lambda를 이용하여 서버리스로 변경하기</h2><h3 id="1편-서버리스를-하려는-이유"><a href="#1편-서버리스를-하려는-이유" class="headerlink" title="1편. 서버리스를 하려는 이유"></a>1편. 서버리스를 하려는 이유</h3><p>최근 새로 입사한 곳에서 하고 있는 작업이 기존의 모노리스로 운영중이던 API Server를 서버리스로 옮겨가는 작업을 하고 있다.<br>그 과정에서 겪었던 여러가지 일들과 나의 생각들을 공유하고자 하는 차원에서 포스팅을 결심했다.</p>
<p>요즘 유행중인 단어 중에 Serverless Architecture 란 말이 있다.<br>위키피디아에는 <a href="https://en.wikipedia.org/wiki/Serverless_computing" target="_blank" rel="external">Serverless computing</a>으로 들어가보면 잘 설명되어 있다.<br>서버리스가 어떤 장점이 있길래 다들 서버리스, 서버리스 노래를 부를까 ?</p>
<h2 id="서버리스의-장점-모노리스의-단점"><a href="#서버리스의-장점-모노리스의-단점" class="headerlink" title="서버리스의 장점 = 모노리스의 단점"></a>서버리스의 장점 = 모노리스의 단점</h2><h3 id="1-서버-스케일링이-필요없다"><a href="#1-서버-스케일링이-필요없다" class="headerlink" title="1. 서버 스케일링이 필요없다."></a>1. 서버 스케일링이 필요없다.</h3><p>요즘 서버를 직접 운영하는 경우는 잘 없고 대부분 클라우드 서비스를 이용한다. (ex. <a href="https://aws.amazon.com/ec2" target="_blank" rel="external">AWS의 EC2</a>)<br>서버가 죽는 대부분의 경우는 서버가 감당가능한 통신 대역폭, 메모리 용량, 컴퓨팅 능력을 넘어서는 요청이 들어오는 경우이다.<br>대부분의 경우는 그렇게 요청이 많이 들어오는 것에 대해서 어느 정도 알 수 있으므로, 미리 서버를 많이 늘려놓으면 된다.<br>그리고 요즘은 클라우드 서비스 상에 컨테이너를 이용해서 스케일링해주는 서비스를 대부분 제공해주므로, 오토 스케일링을 설정해 놓으면 해결된다.<br>그렇게 하더라도 장애가 발생한다.</p>
<p>그럼 언제 엄청난 양의 요청이 갑자기 들어올까 ?<br>대부분의 경우는 중요한 시점이다.<br>여기서 말하는 중요한 시점은 서비스에 대한 홍보가 나갔을 경우를 말한다.<br>지금 접속하면 선착순 몇명에게 쿠폰 증정, PPL을 통해 해당 서비스에 대한 홍보가 방송에 나간 경우, 앱에 푸시를 발송한 경우 등이 있을 것이다.<br>만약 오늘 밤에 하는 드라마에 PPL로 우리 서비스가 소개될 예정이다. 드라마가 10시에 시작하고, PPL이 나갈 시간이 대략 10시 40분쯤 될것 같다고 한다면 ???<br>관련자들은 퇴근을 못한다. 그 시간 이전에 서버를 충분히 늘려놓고, 계속 서버 상태를 모니터링 하고 있다가, 요청수가 줄어들면 서버를 다시 줄이던지 아니면 오토 스케일링 설정을 조정해줘야 한다.<br>오토 스케일링 ? 그럼 자동으로 되어야 하는것 아닌가 ? 하지만 컨테이너에 서버 이미지를 복사해서 가동하는데 대략 15분의 시간이 걸린다고 가정했을 때,<br>15분동안 기존에 실행하고 있던 서버들이 죽지않고 요청들을 잘 처리해 준다면 문제가 되지 않지만 그러지 못할 경우에는 바로 장애가 발생하는거다.</p>
<p>그럼 그게 무슨 오토 스케일링이냐 ? 라고 생각할 수 있지만, 그럼 현재 서비스되고 있는 서버수를 어떻게 설정할 것인가 ? 언제 서버를 더 늘릴것인가 ? 에 대한 고민을 서버 관리자는 항상해야하는데,<br>그 고민에서 어쩌면 가장 중요한 포인트는 비용이다. 서버가 죽지 않으면서 최적의 비용으로 운영을 하는게 최대한의 이익이 나는 것이기에 그 설정을 최대한 타이트하게 하는게 좋다.<br>만약 설정을 장애에 죽지 않는것이 최고라고 생각하고 늘 많이 띄워놓으면 그만큼 과금은 많이되고 서버는 많은 시간을 놀고 있게 된다.<br>요청에 대해서 스케일링하는 정책 자체를 느슨하게 하면 평소라도 한순간 요청이 몰릴 경우 바로 서버를 새로 올리게 되고, 올리는데 15분이 걸리는데 막상 15분 뒤에는 그 서버가 필요없게 되는 경우가 많이 발생할 것이다.</p>
<p>서버리스로 간다면 실질적인 서버 운영을 클라우드 서비스 업체에게 완전 넘길수 있으므로, 이런 고통에서 벗어날 수 있다.<br>(하지만, 실제로는 이것도 모니터링해야 한다. 그 이유는 뒤에 따로 설명하겠다. 아주 간략하게만 얘기하자면 클라우드 서비스에게 사용자에게 서버리스에서 사용될 자원을 무한히 주지않고 제한하기 때문이다.)</p>
<h3 id="2-비용"><a href="#2-비용" class="headerlink" title="2. 비용"></a>2. 비용</h3><p>싸다. 다른 말이 더 필요한가 ?<br>AWS EC2 서버로 운영하는것 보다 <a href="https://aws.amazon.com/lambda" target="_blank" rel="external">Lambda</a> + <a href="https://aws.amazon.com/api-gateway" target="_blank" rel="external">API Gateway</a>를 이용해서 API를 서비스 해보니 훨씬 더 싸다.<br>EC2의 경우에는 운영중인 서버수 x 서버 인스턴스의 비용 x 서버가 운영중인 기간 (1시간 단위)로 과금이 이루어 진다.<br>Lambda의 경우는 코드가 수행된 시간을 100ms 단위로 올림하여 과금한다. API Gateway의 경우 100만 요청 당 3.5 USD가 과금된다.<br>이렇게 봐서는 과연 더 싼지 바로 판단이 안되겠지만, 실제로 운영해보니 훨씬 더 싸다. 비교도 안되게 싸다.</p>
<p>일단 이 두가지가 직접 겪었던 큰 이유다.<br>이것 말고도 여러가지 발표자료들을 찾아보면 다른 장점들이 많다.<br>하지만 그건 옵션 사항인듯 하다.</p>
<h3 id="3-폴리그랏이-가능"><a href="#3-폴리그랏이-가능" class="headerlink" title="3. 폴리그랏이 가능"></a>3. 폴리그랏이 가능</h3><p>각 API 기능별로 다른 언어로 개발이 가능하다.<br>당연히 그렇겠지. 각각 따로 디플로이 되어서 관리되니깐…<br>하지만 그렇게 각각의 API를 서로 다른 언어로 서로 다른 프레임워크를 써서 만들어 올리면 관리는 누가하나 ?<br>정말 급하게 서비스해야 되어서 아웃소싱으로 가장 자신있는 언어로 최대한 빨리 해주세요. 가 아닌 이상 한 조직에서 이렇게 했을때 과연 장점이 더 클지 단점이 더 클지…<br>아니면 개발 조직이 엄청나게 크고, API 개발자가 수십명 있을 경우라면 나름 괜찮을것 같기도 하다.<br>당장 나의 경우만 보더라도 가장 자신있고 가장 빨리 개발이 가능한 언어는 C# 이다.<br>하지만 Node.JS 로 API를 개발 중이다.<br>(여기에는 다른 이유도 있긴있다. 아직 AWS Lambda에서 .Net CORE 지원이 믿을만한 수준은 아니라서…)</p>
<p>이 쯤되면 서버리스를 안 할 이유가 없어보인다.<br>정말로 그렇게 생각이 든다면… 일단 서버리스 약을 파는데 조금은 성공했단 생각이 든다. 으흐흐….</p>
<h2 id="Serverless로-갈아타기-위한-조건"><a href="#Serverless로-갈아타기-위한-조건" class="headerlink" title="Serverless로 갈아타기 위한 조건"></a>Serverless로 갈아타기 위한 조건</h2><p>이미 정상적으로 서비스되고 있는 API를 옮겨야 하는 작업이다보니 가장 중요한 것은 서비스에 지장을 주지 않아야 한다는 점이다.<br>그걸 어떻게 확신 할 수 있을까 ?</p>
<ol>
<li>테스트를 완벽하게 꼼꼼하게 잘 해서 기존 API와 똑같이 동작하는 것을 증명해 낸다.</li>
<li>새로 올린 API가 잘못되었을 때 (한마디로 장애가 났을 때) 다시 되돌리는데 걸리는 시간을 최소화 한다.</li>
</ol>
<p>이 두 가지 점에 대해서 확실한 계획을 세워서 결정권자를 설득시켜야 한다.<br>완벽한 테스트는 일단 포기했다.<br>포기한 가장 큰 이유는 일단 시간이다.<br>이 작업은 사업적인 측면에서 봤을땐 전혀 필요없는 작업일 수도 있기 때문에 긴 시간을 들여서 작업하기 힘들다.<br>사실상 회사내의 개발팀이 아닌 다른 사람들이 봤을 땐 그냥 사업적인 영역 하나를 맡아서 진행하는게 아니라서, 그냥 아무것도 안하고 놀고 있는 걸로 보일 수도 있다.<br>그리고 아무리 테스트를 완벽하게 한다고 한들 그렇다고 장애 대응에 대해서 전혀 생각을 안해도 되는게 아니기 때문에 완벽한 테스트는 포기하고 장애 대응 시간 최소화에 좀 더 촛점을 맞춰서 준비를 시작했다.<br>(실제 작업에 들어간 뒤에 알게된 점이지만, 장애 포인트가 API를 잘못 옮긴 것보다는 AWS 내부적인 문제가 훨씬 더 컸었다. 망할놈의 리미트… 끊임없는 리미트… 리미트 뒤에 숨어있는 다른 리미트…)</p>
<p>장애 대응 플랜에 대해서는 다음 글에서 좀 더 자세히 설명하겠다.</p>
<p><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.02.md" target="_blank" rel="external">다음글 : 2편. 장애 대응 플랜</a><br><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Serverless/MonolithToServerless.03.md" target="_blank" rel="external">다음글 : 3편. Lambda 배포 후 겪게되는 일들</a></p>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/02/23/MonolithToServerless.01/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2016/12/03/Lambda.CSharp/">
                            AWS Lambda에 C# Handler 만들기
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2016-12-03T00:00:00+09:00">
	
		    Dec 03, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="AWS-Lambda에-C-Handler-만들기"><a href="#AWS-Lambda에-C-Handler-만들기" class="headerlink" title="AWS Lambda에 C# Handler 만들기"></a>AWS Lambda에 C# Handler 만들기</h1><p><strong>AWS Lambda</strong>에 대해 다루는 7번째 글입니다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Python.md" target="_blank" rel="external">Lambda Python Packaging</a></li>
</ul>
<p>2016년 12월 1일부터 (글쓴 날 기준으로 이틀 전) <strong>AWS Lambda</strong>에서 <strong>C#</strong>을 지원해 줍니다.<br>(관련글 : <a href="https://aws.amazon.com/about-aws/whats-new/2016/12/aws-lambda-supports-c-sharp" target="_blank" rel="external">https://aws.amazon.com/about-aws/whats-new/2016/12/aws-lambda-supports-c-sharp</a>)</p>
<p><strong>.NET Framework</strong>를 사용할리는 없겠구요.(그 무거운 프레임워크 위에서 돌리는 버전은 당연히 아니겠죠.)<br><strong>.NET Core 1.0 runtime</strong> 을 이용하여 <strong>C#</strong> 코드를 컴파일하고 실행해 줍니다.<br><strong>AWS</strong>에서 지원해준다니깐 잘되는지 직접 한 번 해봤습니다.</p>
<h2 id="개발-환경"><a href="#개발-환경" class="headerlink" title="개발 환경"></a>개발 환경</h2><p>현재 <strong>macOS</strong>를 사용중이지만, <strong>C#</strong> 개발 환경으로 가장 쾌적하고 좋은건 역시 <strong>Windows</strong>에서 실행시키는 <strong>Visual Studio</strong> 입니다.<br><a href="https://www.visualstudio.com/vs/visual-studio-mac" target="_blank" rel="external">Visual Studio for Mac</a> 이 출시되긴 했으나, 사용해보니 너무나도 느리고 답답하더라구요.<br>차라리 <strong>Parallels Desktop</strong>에 <strong>Windows 10</strong>을 띄우고 거기서 <strong>Visual Studio Community 2015</strong>로 하는게 훨씬 더 빠르고 편했습니다.</p>
<p>아래의 개발도구들을 사용했습니다.</p>
<ul>
<li><strong>Visual Studio 2015 Community with Update 3</strong> , <strong>.NET Core 1.0.1 tools Preview 2</strong> : <a href="https://www.microsoft.com/net/core" target="_blank" rel="external">https://www.microsoft.com/net/core</a></li>
<li><strong>AWS Toolkit for Visual Studio</strong> : <a href="https://aws.amazon.com/visualstudio" target="_blank" rel="external">https://aws.amazon.com/visualstudio</a></li>
</ul>
<h2 id="Project-생성"><a href="#Project-생성" class="headerlink" title="Project 생성"></a>Project 생성</h2><ul>
<li><p><strong>Visual Studio</strong> 실행한 뒤 <strong>File</strong> -&gt; <strong>New</strong> -&gt; <strong>Project</strong> 선택</p>
</li>
<li><p><strong>Visual C#</strong> -&gt; <strong>AWS Lambda</strong> -&gt; <strong>AWS Lambda Project (.NET Core)</strong> 선택</p>
<ul>
<li><strong>Name</strong> : <code>AWSLambdaTest</code> 라고 입력한 후 <strong>OK</strong> 버튼 클릭</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.01.png?raw=true"></p>
<ul>
<li><strong>Select Blueprint</strong> 창에서 <strong>Empty Function</strong>을 선택한 후 <strong>Finish</strong> 버튼 클릭</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.02.png?raw=true"></p>
<p>이제 테스트 프로젝트가 완성되었습니다.</p>
<h2 id="AWS-Explorer-에-로그인"><a href="#AWS-Explorer-에-로그인" class="headerlink" title="AWS Explorer 에 로그인"></a>AWS Explorer 에 로그인</h2><p><strong>AWS Lambda</strong> 배포를 좀 더 편하게 하기위해서 미리 <strong>AWS Explorer</strong>에 로그인해 두도록 하겠습니다.<br>화면에 <strong>AWS Explorer</strong>가 없다면, <strong>View</strong> -&gt; <strong>AWS Explorer</strong>를 선택하시면 됩니다.<br>만약 해당 메뉴가 나오지 않는다면 <strong>AWS Toolkit for Visual Studio</strong>를 설치하지 않은 것이므로 위 링크에서 설치를 하신 뒤 진행해 주세요.<br>이미 로그인 된 상태라면 아래 과정을 진행 할 필요가 없습니다.</p>
<ul>
<li><strong>New Account Profile</strong> 선택<ul>
<li><strong>Profile Name</strong> : 아무거나 입력. 화면에 표시될 내용이므로 구분하기 쉽게</li>
<li><strong>Access Key ID</strong> , <strong>Secret Access Key</strong> : AWS에서 발급받은 값으로 입력</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.03.png?raw=true"></p>
<p>로그인이 제대로 되었다면 아래 그림과 같이 <strong>AWS Service</strong> 목록이 나옵니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.05.png?raw=true"></p>
<h2 id="Projeject-코드-설명"><a href="#Projeject-코드-설명" class="headerlink" title="Projeject 코드 설명"></a>Projeject 코드 설명</h2><p>먼저 빌드를 한 번 해보세요.<br>만약 빌드가 안된다면 <strong>Solution Explorer</strong>를 열어서 Project 내의 <strong>References</strong>를 열어봐 주세요.<br>설치된 어셈블리 중에 잘못 된게 있으면 노란색 느낌표가 뜹니다.<br>그럴 경우 우클릭하여서 <strong>Restore Packages</strong>를 선택해 주세요.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.04.png?raw=true"></p>
<p>자동 생성된 <strong>Function.cs</strong> 파일을 열어보겠습니다.</p>
<p>눈여겨 볼 부분이 두 곳 정도 있네요.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Assembly attribute to enable the Lambda function's JSON input to be converted into a .NET class.</span></div><div class="line">[assembly: LambdaSerializerAttribute(<span class="keyword">typeof</span>(Amazon.Lambda.Serialization.Json.JsonSerializer))]</div></pre></td></tr></table></figure>
<p>주석에 적혀있는 대로 라면 <strong>JSON</strong>으로 입력된 것에 대해서 자동으로 <strong>.NET class</strong>로 변경해준다는 말이네요.<br><strong>AWS Lambda</strong>에 <strong>Java</strong> 코드를 올릴 경우에도 입력이 <strong>JSON</strong>일 경우 해당 <strong>JSON</strong>내용이랑 똑같은 <strong>class</strong>를 생성해야만 했습니다.<br>더군다나 <strong>Java</strong>에서는 <strong>setter</strong> , <strong>getter</strong> 매서드 들도 다 만들어 줘야 했습니다.<br>다행히 <strong>C#</strong>에서는 <strong>attribute</strong>로 선언시 오른쪽에 <code>{ get; set; }</code>만 적어주면 되기 때문에 <strong>Java</strong>보다는 훨씬 편하지만,<br>그래도 여간 귀찮은 일이 아닙니다.</p>
<p>관련 내용으로 <strong>Facebook</strong>애서 좀 장장댔더니 고수이신 패친분들이 <strong>JSON</strong>을 읽어서 <strong>class</strong>를 만들어주는 방법들에 대해서 소개를 해 주셨습니다.<br>(엯촋 이규원님, 이종인님 감사드립니다.)<br>보니깐 <strong>Visual Studio</strong>에는 이미 그런 기능이 있군요.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.15.png?raw=true"></p>
<p>저렇게 <strong>class</strong>로 만들기 싫다면, 그냥 <code>Stream</code>으로 주고 받는 방법도 있습니다.<br>아래 내용에서는 <code>Stream</code>으로 주고 받는 방법으로 진행하도록 하겠습니다.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">FunctionHandler</span>(<span class="params"><span class="keyword">string</span> input, ILambdaContext context</span>)</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> input?.ToUpper();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>string</strong>을 입력받아서 대문자로 변경한 뒤에 <strong>string</strong> 타입으로 응답해주는 핸들러입니다.</p>
<p>일단은 이 코드 그대로 배포해 보도록 하겠습니다.</p>
<h2 id="Lambda-배포-및-테스트"><a href="#Lambda-배포-및-테스트" class="headerlink" title="Lambda 배포 및 테스트"></a><strong>Lambda</strong> 배포 및 테스트</h2><p><strong>Visual Studio</strong> 내에서 배포 및 테스트가 바로 되기 떄문에 편리합니다.</p>
<ul>
<li><strong>Solution Explorer</strong>상의 Project(<strong>AWSLambdaTest</strong>)에서 마우스 우 클릭<ul>
<li><strong>Publish to AWS Lambda…</strong> 선택</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.06.png?raw=true"></p>
<ul>
<li><strong>Function Name:</strong> 새로 생성할 (또는 기존에 생성되어 있는 것 중 덮어 쓸) Lambda Function 명칭을 입력</li>
</ul>
<p><strong>Assembly Name</strong> (Project 명), <strong>Type Name</strong> (핸들러가 포함되어 있는 class명을 namespace 포함한 값), <strong>Method Name</strong> (핸들러 이름)이 제대로 되어 있는지 확인합니다.</p>
<ul>
<li><strong>Next</strong> 버튼 클릭</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.07.png?raw=true"></p>
<ul>
<li><strong>Role Name:</strong> 기존에 만들어 놓은 <strong>role</strong>또는 새로 만들어서 선택</li>
</ul>
<p>참고로 <strong>role</strong>은 <strong>AWS</strong>내의 다른 서비스 들과의 연계에서 필요한 권한 등을 설정해 놓는 것입니다.</p>
<ul>
<li><strong>Upload</strong> 버튼 클릭</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.08.png?raw=true"></p>
<p>이제 기다리면 업로딩이 끝난 뒤 해당 <strong>Lambda</strong>의 설정창이 뜹니다.<br>기본적으로 <strong>Test Function</strong> 탭이 선택된 상태인데 <strong>Sample Input</strong>란에 아무거나 입력한 뒤 <strong>Invoke</strong> 버튼을 누르면 입력한 값들이 모두 대문자로 변한 값으로 응답이 오는 것을 확인 할 수 있습니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.09.png?raw=true"></p>
<p>만약 입력하는 문자열이 <strong>JSON</strong> 형식일 경우에는 오류가 발생합니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.10.png?raw=true"></p>
<p>앞에서 살펴 본 코드에 따르면 <strong>JSON</strong>을 읽어서 자동으로 <strong>.NET class</strong>로 변경해주는 작업을 해준다고 했는데, 아마 그 작업을 시도하는 모양입니다.</p>
<h2 id="JSON으로-입력-받기"><a href="#JSON으로-입력-받기" class="headerlink" title="JSON으로 입력 받기"></a>JSON으로 입력 받기</h2><p>그럼 <strong>JSON</strong>을 <strong>Stream</strong>을 이용해서 입력받아 보도록 하겠습니다.</p>
<p>2개의 <code>using</code>문을 위에 써주세요.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System.IO;</div><div class="line"><span class="keyword">using</span> System.Text;</div></pre></td></tr></table></figure>
<p><code>FunctionHandler</code> 메서드를 아래와 같이 수정해 주세요.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">FunctionHandler</span>(<span class="params">Stream stream, ILambdaContext context</span>)</span></div><div class="line">&#123;</div><div class="line">	List&lt;<span class="keyword">byte</span>&gt; bytes = <span class="keyword">new</span> List&lt;<span class="keyword">byte</span>&gt;();</div><div class="line">	<span class="keyword">while</span> (stream.CanRead)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">int</span> readByte = stream.ReadByte();</div><div class="line">		<span class="keyword">if</span> (readByte != <span class="number">-1</span>)</div><div class="line">			bytes.Add((<span class="keyword">byte</span>)readByte);</div><div class="line">		<span class="keyword">else</span></div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">string</span> text = Encoding.UTF8.GetString(bytes.ToArray());</div><div class="line">	<span class="keyword">return</span> text;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Stream</code>으로 입력받아서 <code>string</code>으로 변환하여 그래도 응답하도록 수정하였습니다.</p>
<p>위 다시 배포한 뒤 위에서 오류난 <strong>JSON</strong>으로 테스트 하니 입력한 값을 그대로 문자열로 응답해 줍니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.11.png?raw=true"></p>
<p>하지만 출력한 값이 string라서 이상한 <code>\r\n</code>등도 포함되어 있으며 바로 <strong>JSON</strong>으로 파싱도 안됩니다.</p>
<h2 id="JSON으로-응답-하기위해서"><a href="#JSON으로-응답-하기위해서" class="headerlink" title="JSON으로 응답 하기위해서"></a>JSON으로 응답 하기위해서</h2><p>이제 응답도 <code>string</code>이 아니라 <code>Stream</code>으로 해보겠습니다.<br>받은 값을 그래도 응답만 하는건 재미없자나요.<br>그래도 <strong>JSON</strong>에 항목 한 개 만이라도 추가해서 보내겠습니다.</p>
<p><strong>C#</strong>에서 <strong>JSON Obejct</strong>관련 작업에 가장 많이 사용하는 건  <strong>Newtonsoft.Json</strong>이라는 <strong>nuget package</strong>입니다.</p>
<p><strong>Solution Explorer</strong>에서 <strong>Project</strong> 선택한 뒤 우클릭하여 뜬 메뉴에서 <strong>Manage nuget packages…</strong>를 눌러줍니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.12.png?raw=true"></p>
<p><code>json</code>만 입력해도 바로 가장 위에 <strong>Newtonsoft.Json</strong>이 나옵니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.13.png?raw=true"></p>
<p>선택하여 설치해 줍니다.</p>
<p><code>using</code>문에 다음을 추가해 주세요.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> Newtonsoft.Json.Linq;</div></pre></td></tr></table></figure>
<p><code>FunctionHandler</code> 메서드를 아래와 같이 수정해 주세요.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Stream <span class="title">FunctionHandler</span>(<span class="params">Stream stream, ILambdaContext context</span>)</span></div><div class="line">&#123;</div><div class="line">    List&lt;<span class="keyword">byte</span>&gt; bytes = <span class="keyword">new</span> List&lt;<span class="keyword">byte</span>&gt;();</div><div class="line">    <span class="keyword">while</span> (stream.CanRead)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> readByte = stream.ReadByte();</div><div class="line">        <span class="keyword">if</span> (readByte != <span class="number">-1</span>)</div><div class="line">            bytes.Add((<span class="keyword">byte</span>)readByte);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">string</span> text = Encoding.UTF8.GetString(bytes.ToArray());</div><div class="line"></div><div class="line">    <span class="keyword">var</span> json = JObject.Parse(text);</div><div class="line">    json[<span class="string">"name"</span>] = <span class="string">"LunaSter"</span>;</div><div class="line"></div><div class="line">    text = json.ToString();</div><div class="line"></div><div class="line">    MemoryStream stream1 = <span class="keyword">new</span> MemoryStream(Encoding.UTF8.GetBytes(text));</div><div class="line">    <span class="keyword">return</span> stream1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>위 코드에서 <code>text</code>를 <code>JObject</code>로 변경한 다음 항목을 하나 추가해서 <code>MemoryStream</code>으로 응답하는게 추가되었습니당.</p>
<p>다시 배포한 뒤 테스트 해보니 이쁘게 <strong>JSON</strong> 형식으로 응답이 옵니다.<br>추가한 항목에 대해서도 확인됩니다.</p>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/aws.lambda.csharp.14.png?raw=true"></p>
<h3 id="마치며…"><a href="#마치며…" class="headerlink" title="마치며…"></a>마치며…</h3><p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 <strong>C#</strong> 코드 작업에 필요한 도구들 (설치법은 셀프!)</li>
<li>Project 생성</li>
<li><strong>Visual Studio</strong>에서 <strong>Lambda</strong> 배포 및 테스트</li>
<li><strong>JSON Object</strong>로 입력 및 응답을 주고 받는 방법</li>
</ul>
<p><strong>API Gateway</strong>와의 연동 및 <strong>path</strong>, <strong>querystring</strong>, <strong>HTTP Method</strong>에 따라 다른 작업 및 응답을 발성하는 방법에 대해서는 제가 앞서 작성한 <strong>Node.JS</strong>로 <strong>AWS Lambda</strong> 올리는 곳의 코드와 구조가 똑같습니다.<br>그래서 이 부분에 대해서는 따로 다루지 않겠습니다.</p>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="&#109;&#97;&#x69;&#x6c;&#x74;&#111;&#x3a;&#x73;&#x65;&#x6f;&#x6b;&#106;&#111;&#x6f;&#110;&#46;&#x79;&#x75;&#x6e;&#x40;&#103;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#109;">&#x73;&#x65;&#x6f;&#x6b;&#106;&#111;&#x6f;&#110;&#46;&#x79;&#x75;&#x6e;&#x40;&#103;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#111;&#109;</a>  </p>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li>AWS 공식 문서들<ul>
<li><a href="https://aws.amazon.com/about-aws/whats-new/2016/12/aws-lambda-supports-c-sharp/" target="_blank" rel="external">https://aws.amazon.com/about-aws/whats-new/2016/12/aws-lambda-supports-c-sharp/</a></li>
<li><a href="http://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/getting-set-up.html" target="_blank" rel="external">http://docs.aws.amazon.com/toolkit-for-visual-studio/latest/user-guide/getting-set-up.html</a></li>
<li><a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-dotnet-how-to-create-deployment-package.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/lambda-dotnet-how-to-create-deployment-package.html</a></li>
<li><a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-dotnet-create-deployment-package-toolkit.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/lambda-dotnet-create-deployment-package-toolkit.html</a></li>
<li><a href="http://docs.aws.amazon.com/lambda/latest/dg/dotnet-programming-model.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/dotnet-programming-model.html</a></li>
<li><a href="http://docs.aws.amazon.com/lambda/latest/dg/dotnet-programming-model-handler-types.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/dotnet-programming-model-handler-types.html</a></li>
</ul>
</li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2016/12/03/Lambda.CSharp/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2016/11/27/Lambda.Packaging.Node/">
                            Lambda Node.JS Packaging
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2016-11-27T15:54:51+09:00">
	
		    Nov 27, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Lambda-Node-JS-Packaging"><a href="#Lambda-Node-JS-Packaging" class="headerlink" title="Lambda Node.JS Packaging"></a>Lambda Node.JS Packaging</h1><p><strong>Labmda</strong>에 <strong>Node.JS</strong>로 구현하는 내용에 대해서는 아래 3개의 Link를 참고해 주세요.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
</ul>
<p>이제껏 1개의 <strong>Node.JS</strong> 파일에 <strong>npm module</strong>을 하나도 사용하지 않은 예제만 살펴보았는데,<br>실제로 개발할 상황에서는 파일도 여러 개로 나눠서 개발하고 <strong>npm module</strong>도 많이 사용할 경우가 많습니다.<br>이렇게 개발한 코드들을 어떻게 Lambda로 올리는지 이번 포스팅에서 살펴보도록 하겠습니다.</p>
<p><strong>Lambda 와 API Gateway 연동 #3</strong>까지 구현되어 있다는 가정하에서 진행하겠습니다.</p>
<h2 id="Node-JS-코드에-npm-사용"><a href="#Node-JS-코드에-npm-사용" class="headerlink" title="Node.JS 코드에 npm 사용"></a>Node.JS 코드에 npm 사용</h2><ul>
<li>이전까지 작업한 코드를 <code>index.js</code>란 이름으로 작업할 폴더에 저장</li>
<li><strong>npm</strong>으로 <strong>lodash</strong> 설치 : <code>npm install lodash</code></li>
<li>코드를 아래와 같이 수정</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">userId</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params">userId, header, body</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/test'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">return</span> get(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(_.get(event,<span class="string">'body'</span>));</div><div class="line">      <span class="keyword">const</span> header =  event.headers;</div><div class="line">      <span class="keyword">return</span> post(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">router</span>(<span class="params">event, context</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.path][event.httpMethod];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>routeMap</strong> 내부에 <code>lodash.get</code> 함수를 사용하는 것으로 코드를 변경하였습니다.</p>
<ul>
<li>zip 파일로 압축 : <code>zip -r ./sample.zip ./</code></li>
</ul>
<h2 id="Lambda에-zip-파일로-배포"><a href="#Lambda에-zip-파일로-배포" class="headerlink" title="Lambda에 zip 파일로 배포"></a>Lambda에 zip 파일로 배포</h2><p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li><code>Code</code> 탭<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택<ul>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/images/lambda.packaging.node.01.png?raw=true"></p>
<h2 id="확인"><a href="#확인" class="headerlink" title="확인"></a>확인</h2><p><strong>API Gateway</strong>는 변경사항이 없으므로 결과는 <strong>3장</strong>과 똑같이 나옵니다.</p>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="여러-파일을-함께-배포"><a href="#여러-파일을-함께-배포" class="headerlink" title="여러 파일을 함께 배포"></a>여러 파일을 함께 배포</h2><p>이미 <strong>npm module</strong>을 포함하여 베포하였으므로 여러 파일을 묶어서 배포하는게 확인되었지만, 우리가 작성한 소스코드 자체도 나눠서 배포해 보도록 하겠습니다.<br>위에 작성한 코드를 4개의 파일로 나눠서 올려보겠습니다.</p>
<ul>
<li><code>index.js</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./router'</span>);</div><div class="line"></div><div class="line">exports.handler = <span class="function">(<span class="params">event, context, callback</span>) =&gt;</span> &#123;</div><div class="line">   <span class="keyword">let</span> result = router(event, context);</div><div class="line">   callback(<span class="literal">null</span>, &#123;<span class="attr">body</span>:<span class="built_in">JSON</span>.stringify(result)&#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>router.js</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> routeMap = &#123;</div><div class="line">  <span class="string">'/test'</span>: &#123;</div><div class="line">    <span class="string">'GET'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'./controllers/test/get'</span>)(userId);</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'POST'</span>: <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> userId = _.get(event,<span class="string">'queryStringParameters.id'</span>);</div><div class="line">      <span class="keyword">const</span> body = <span class="built_in">JSON</span>.stringify(_.get(event,<span class="string">'body'</span>));</div><div class="line">      <span class="keyword">const</span> header =  event.headers;</div><div class="line">      <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">'./controllers/test/post'</span>)(userId, header, body);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">event, context</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> controller = routeMap[event.path][event.httpMethod];</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(!controller) &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">body</span>: &#123; <span class="attr">Error</span>: <span class="string">"Invalid Path"</span> &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> controller(event, context);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><code>/controllers/test/get.js</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">userId</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">name</span>: <span class="string">"test"</span> &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><code>/controllers/test/post.js</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">userId, header, body</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">body</span>: &#123; <span class="attr">id</span>: userId, <span class="attr">header</span>: header, <span class="attr">body</span>: body &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><strong>npm</strong>으로 <strong>lodash</strong> 설치 : <code>npm install lodash</code></li>
<li>zip 파일로 압축 : <code>zip -r ./sample.zip ./</code></li>
</ul>
<p>위에서와 같은 방법으로 <strong>Lambda</strong>에 배포 후 확인을 해보면 같은 결과가 출력됩니다.</p>
<h2 id="Lambda에-zip-파일로-배포-1"><a href="#Lambda에-zip-파일로-배포-1" class="headerlink" title="Lambda에 zip 파일로 배포"></a>Lambda에 zip 파일로 배포</h2><p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li><code>Code</code> 탭<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택<ul>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="확인-1"><a href="#확인-1" class="headerlink" title="확인"></a>확인</h2><p><strong>API Gateway</strong>는 변경사항이 없으므로 결과는 <strong>3장</strong>과 똑같이 나옵니다.</p>
<ul>
<li><strong>GET</strong> 요청 : <code>https://.../prod/test?id=2</code></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>POST</strong> 요청 : URL은 <strong>GET</strong>과 동일</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="마치며…"><a href="#마치며…" class="headerlink" title="마치며…"></a>마치며…</h3><p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 여러 파일을 <code>.zip</code>으로 묶어서 함께 배포<ul>
<li><strong>npm module</strong>을 함께 배포</li>
<li>여러 파일로 작성된 소스코드들을 함께 배포 </li>
</ul>
</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="&#109;&#97;&#105;&#x6c;&#x74;&#111;&#58;&#115;&#x65;&#x6f;&#107;&#x6a;&#111;&#x6f;&#x6e;&#46;&#121;&#x75;&#x6e;&#64;&#103;&#109;&#x61;&#105;&#108;&#46;&#99;&#111;&#109;">&#115;&#x65;&#x6f;&#107;&#x6a;&#111;&#x6f;&#x6e;&#46;&#121;&#x75;&#x6e;&#64;&#103;&#109;&#x61;&#105;&#108;&#46;&#99;&#111;&#109;</a>  </p>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li>AWS 공식 가이드 : <a href="http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/nodejs-create-deployment-pkg.html</a></li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2016/11/27/Lambda.Packaging.Node/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2016/11/24/Lambda.Packaging.Python/">
                            Lambda Python Packaging
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2016-11-24T16:54:51+09:00">
	
		    Nov 24, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/AWS/">AWS</a>, <a class="category-link" href="/categories/AWS/Lambda/">Lambda</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="Lambda-Python-Packaging"><a href="#Lambda-Python-Packaging" class="headerlink" title="Lambda Python Packaging"></a>Lambda Python Packaging</h1><p><strong>AWS Lambda</strong>에 대해 다루는 6번째 글입니다.</p>
<ul>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateWay.01.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #1 (GET, POST)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.02.Route.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #2 (ANY, Deploy Staging, Node.JS Route)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda%2BAPIGateway.03.Proxy.md" target="_blank" rel="external">Lambda 와 API Gateway 연동 #3 (Proxy Resource)</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Packaging.Node.md" target="_blank" rel="external">Lambda Node.JS Packaging</a></li>
<li><a href="https://github.com/DevStarSJ/Study/blob/master/Blog/Cloud/AWS/Lambda.Python.md" target="_blank" rel="external">AWS Lambda에 Python Handler 만들기</a></li>
</ul>
<p>지난번 글에서 1개의 <strong>Python</strong> 파일로 구현하여 <strong>AWS Lambda</strong>에 올리는 방법에 대해서 다뤘는데,<br>이번 글에서는 여러 개의 파일로 나뉘어서 구현한 경우와 외부 라이브러리를 <strong>pip</strong>로 설치할 경우 어떻게 해야하는지에 대해서 다뤄보겠습니다.</p>
<h2 id="Previously-on-Lambda-series"><a href="#Previously-on-Lambda-series" class="headerlink" title="Previously on Lambda series"></a>Previously on Lambda series</h2><p><strong>Lambda</strong>의 생성 및 <strong>API Gateway</strong>와의 연결은 되어 있다는 가정하에 진행하겠습니다.<br>관련 내용들은 앞의 글들에 다 있지만 읽기 귀찮으시다는 분들을 위해 간략한 따라하기를 살없이 뼈만 추려서 먼저 소개하고 시작하겠습니다.</p>
<h3 id="Create-Lambda"><a href="#Create-Lambda" class="headerlink" title="Create Lambda"></a>Create Lambda</h3><ul>
<li><code>AWS</code> 로그인 후 <code>Lambda</code> 탭으로 이동</li>
<li><code>Create a Lambda Function</code> 선택</li>
<li>Select blueprint에서 <code>Blank Function</code> 선택</li>
<li>Configure function 에서 일단 바로 <code>Next</code> 선택 (미리 연결할 API Gateway가 있다면 여기서 연결하면 됨)</li>
<li><code>Configure function</code>에서 함수 정의<ul>
<li>Name : <code>testLambda-luna</code></li>
<li>Runtime : <code>Python 2.7</code></li>
<li>Code : 아래 소개되어 있는 <code>Python Lambda Code</code>를 입력</li>
<li>Role &amp; Existing role : 일단은 적당히 선택 (만약 Lambda에서 다른 AWS 서비스 RDS, S3 등을 연동할려면 필요)</li>
<li>아래 코드 입력 후 <code>Next</code> 선택</li>
</ul>
</li>
<li><code>Create Function</code> 선택</li>
</ul>
<h3 id="Set-API-Gateway"><a href="#Set-API-Gateway" class="headerlink" title="Set API Gateway"></a>Set API Gateway</h3><ul>
<li><code>AWS</code> 메인 화면으로 이동 후 <code>API Gateway</code> 탭으로 이동</li>
<li><code>Create API</code> 선택<ul>
<li>API name : <code>testAPI-luna</code></li>
<li><code>Create API</code> 선택</li>
</ul>
</li>
<li><code>/</code>에서 <code>Actions</code> -&gt; <code>Create Resource</code>를 선택<ul>
<li><code>Configure as proxy resource</code> 를 체크한 후 <code>Create Resource</code>를 누름</li>
</ul>
</li>
<li><code>ANY</code> 선택<ul>
<li><code>Integration Request</code> 선택<ul>
<li><strong>Integration type</strong> : <code>Lambda Function</code><ul>
<li><strong>Lambda Region</strong> : 람다를 생성한 지역 서버 선택</li>
<li><strong>Lambda Function</strong> : 람다 명칭 기입</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>Actions</code> -&gt; <code>Deploy API</code> 선택 후 그냥 <code>prod</code>로 스테이징</li>
</ul>
<h3 id="Python-Lambda-Code"><a href="#Python-Lambda-Code" class="headerlink" title="Python Lambda Code"></a>Python Lambda Code</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<h2 id="Python-Code-패키징-연습"><a href="#Python-Code-패키징-연습" class="headerlink" title="Python Code 패키징 연습"></a>Python Code 패키징 연습</h2><p>새로운 코드를 만드는것 보다는 일단 정상적으로 동작하는 것이 확인된 코드를 파일로 나눠가면서 진행하겠습니다.</p>
<h3 id="Step-1-통파일을-그냥-zip으로-압축하여-올리기"><a href="#Step-1-통파일을-그냥-zip으로-압축하여-올리기" class="headerlink" title="Step 1. 통파일을 그냥 .zip으로 압축하여 올리기"></a>Step 1. 통파일을 그냥 .zip으로 압축하여 올리기</h3><p>작업할 폴더를 하나 만듭니다. 일단 <code>packaging.test</code> 라는 이름으로 만들어 보겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir packaging.test</div><div class="line">cd packaging.test</div></pre></td></tr></table></figure>
<p>그 안에 원래 <strong>Lambda</strong>에 올려놓은 코드를 그대로 복사하여 <code>index.py</code>로 생성합니다.</p>
<h4 id="index-py"><a href="#index-py" class="headerlink" title="index.py"></a>index.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<p><code>.zip</code>파일로 압축할 때 해당 <code>index.py</code> 파일이 루트에 위치해야 합니다.<br>즉, <code>packaging.test</code> 폴더를 압축하는게 아니라 그 안에 들어와서 압축을 해야 합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip sample.zip index.py</div></pre></td></tr></table></figure>
<p>이제 <strong>Lambda</strong>에 올리신 후 테스트 해보면 됩니다.<br>올리는 방법과 테스트 방법은 계속 동일하기 때문에 여기서 한 번만 소개하고 밑에서는 따로 소개하지 않겠습니다.</p>
<p>먼저 해당 <strong>Lambda</strong> 설정으로 이동합니다.</p>
<ul>
<li><p><code>Code</code> 탭</p>
<ul>
<li>Code entry type : <code>Upload a .ZIP file</code> 선택<ul>
<li><code>Upload</code> 버튼을 눌러서 위에서 생성한 <code>sample.zip</code>을 올림</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>GET</strong> 요청 (브라우저에서 주소 입력) : <code>https://.../prod/test?id=2</code></p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"body"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"2"</span>,<span class="attr">"name"</span>:<span class="string">"test"</span>&#125;&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>POST</strong> 요청 (<strong>POSTMAN</strong>이나 <strong>curl</strong>등을 활용) : URL은 <strong>GET</strong>과 동일</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "body": &#123;</div><div class="line">    "id": "2",</div><div class="line">    "header": &#123;</div><div class="line">      ...</div><div class="line">    &#125;,</div><div class="line">    "body": "\"&#123;\\n  \"id\": \"123\",\\n  \"age\": \"25\"\\n&#125;\""</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Step-2-파일-나누기"><a href="#Step-2-파일-나누기" class="headerlink" title="Step 2. 파일 나누기"></a>Step 2. 파일 나누기</h3><p>위의 파일을 2개로 나누어서 올려보겠습니다.<br>같은 폴더에 <code>router.py</code>파일을 하나 생성 한 후 파일 내용을 아래와 같이 수정해 주세요.</p>
<h4 id="index-py-1"><a href="#index-py-1" class="headerlink" title="index.py"></a>index.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<h4 id="router-py"><a href="#router-py" class="headerlink" title="router.py"></a>router.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: get,</div><div class="line">        <span class="string">'POST'</span>: post</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div></pre></td></tr></table></figure>
<p><code>.zip</code> 파일로 압축합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip sample.zip .</div></pre></td></tr></table></figure>
<p>코드를 올린 후 테스트 했을 때 똑같은 결과가 나와야 합니다.</p>
<h3 id="Step-3-폴더로-나누기"><a href="#Step-3-폴더로-나누기" class="headerlink" title="Step 3. 폴더로 나누기"></a>Step 3. 폴더로 나누기</h3><p>작업 중인 폴더에 <code>/controllers/test</code>의 2단계의 폴더를 추가 합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir controllers</div><div class="line">cd controllers</div><div class="line">mkdir test</div></pre></td></tr></table></figure>
<p>그런 다음 2개의 폴더에 각각 <code>__init__.py</code>라는 파일을 만듭니다.<br>내용은 아무것도 없는 빈 파일로 생성합니다.<br>앞으로 작성할 2개의 파일도 미리 생성해 놓겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">touch __init__.py</div><div class="line">cd test</div><div class="line">touch __init__.py</div><div class="line">touch post.py</div><div class="line">touch get.py</div></pre></td></tr></table></figure>
<p><code>/controllers/test/</code>안에 <code>post.py</code>, <code>get.py</code>에 기존에 있던 <code>router.py</code>의 내용을 나눠서 수정합니다.</p>
<h4 id="index-py-2"><a href="#index-py-2" class="headerlink" title="index.py"></a>index.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<h4 id="router-py-1"><a href="#router-py-1" class="headerlink" title="router.py"></a>router.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> controllers.test.get</div><div class="line"><span class="keyword">import</span> controllers.test.post</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: controllers.test.get.handler,</div><div class="line">        <span class="string">'POST'</span>: controllers.test.post.handler</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(event);</div></pre></td></tr></table></figure>
<h4 id="controllers-test-post-py"><a href="#controllers-test-post-py" class="headerlink" title="controllers/test/post.py"></a>controllers/test/post.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div></pre></td></tr></table></figure>
<h4 id="controllers-test-get-py"><a href="#controllers-test-get-py" class="headerlink" title="controllers/test/get.py"></a>controllers/test/get.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'name'</span>: <span class="string">"test"</span> &#125; &#125;</div></pre></td></tr></table></figure>
<p><code>index.py</code>가 위치한 폴더로 이동하여 압축을 합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure>
<p>코드를 올린 후 테스트 했을 때 똑같은 결과가 나와야 합니다.</p>
<h3 id="Step-4-외부-라이브러리를-pip로-설치하여-같이-올리기"><a href="#Step-4-외부-라이브러리를-pip로-설치하여-같이-올리기" class="headerlink" title="Step 4. 외부 라이브러리를 pip로 설치하여 같이 올리기"></a>Step 4. 외부 라이브러리를 pip로 설치하여 같이 올리기</h3><p>외부 라이브러리 설치를 하기위해서는 주의해야 할 사항들이 몇가지 있습니다.</p>
<p>외부 라이브러리를 해당 폴더 내에 설치하기 위해서는 <code>virtualenv</code>를 사용하여 가상환경을 구성해주는게 편합니다.<br>그렇지 않으면 이미 해당 라이브러리가 설치된 경우 충돌이 일어 날수가 있어서 설치 자체가 쉽지 않습니다.<br>그리고 현재 기본적으로 실행되는 <strong>Python</strong>의 버전이 <strong>3.x.x</strong> 버전일 경우에도 문제가 됩니다.<br>현재 <strong>AWS Lambda</strong>에서 지원하는 <strong>Python</strong>이 <strong>2.7</strong>버전이기 때문입니다.</p>
<p><strong>Python 3</strong>에서도 <code>virtualenv</code> 환경으로 <strong>Python 2.7</strong>로 생성이 가능합니다만, 필자는 구글에서 찾아봐서 몇 번 시도를 해봤는데 계속 실패하더라구요.<br>그래서 그냥 과감하게 그 당시 기본으로 설치된 <strong>Python 3.5.12 (Conda)</strong>를 날려버렸습니다.<br>그리고 따로 <strong>Python 공식 페이지</strong>에 들어가서 <strong>2.7.12</strong>와 <strong>3.5.12</strong>를 설치했습니다.<br><strong>Python</strong> 설치는 <strong>homebrew</strong> 같은것으로 설치하는 것보다는 그냥 공홈에서 <strong>.pkg</strong> 같은걸로 다운받아서 설치하는게 정신 건강에 좋습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ python -V</div><div class="line">Python 2.7.12</div></pre></td></tr></table></figure>
<p>기본 버전이 <strong>2.7.12</strong> 라는 것이 확인되었으니 그냥 <code>virtualenv</code>로 가상환경을 만들면 되겠네요.<br>먼저 <code>index.py</code>가 위치한 곳으로 이동 후 다음과 같이 입력하여 실행해주세요.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virtualenv myvenv</div></pre></td></tr></table></figure>
<p>이제 가상 환경으로 활성화 합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source myvenv/bin/activate</div></pre></td></tr></table></figure>
<p>이제 원하는 라이브러리를 로컬로 해당 폴더에 설치하면 됩니다.</p>
<p>예제로 작성할 코드라 가볍고 사용하기 쉬운 <code>requests</code>를 설치해 보도록 하겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install requests -t .</div></pre></td></tr></table></figure>
<p>일단은 단순하게 그냥 <code>index.py</code>만 수정해서 <code>requests</code>가 동작하는 코드로 수정 후 올려보도록 하죠.</p>
<h4 id="index-py-3"><a href="#index-py-3" class="headerlink" title="index.py"></a>index.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    result = router(event);</div><div class="line"></div><div class="line">    URL = <span class="string">'http://www.tistory.com'</span></div><div class="line">    response = requests.get(URL)</div><div class="line"></div><div class="line">    result[<span class="string">'request_data'</span>] = response.text</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<p>해당 폴더 이하를 몽땅 압축하여 올립니다. (<strong>myvenv</strong> 는 제외하고 싶은데… 어떻게 하는지 잘 모르겠습니다.)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure>
<p>테스트를 하면 <code>request_data</code>안에 데이터들이 추가된 것을 확인 할 수 있습니다.</p>
<h3 id="Step-5-좀-더-새련된-패키징-처리"><a href="#Step-5-좀-더-새련된-패키징-처리" class="headerlink" title="Step 5. 좀 더 새련된 패키징 처리"></a>Step 5. 좀 더 새련된 패키징 처리</h3><p><strong>Step 4</strong>에서 살펴본 내용만으로는 실제 서비스 가능한 수준의 코드를 만드는데는 몇가지 문제가 있습니다.</p>
<ol>
<li>압축파일의 크기가 너무 크다. <code>virtualenv</code>용 파일은 제외하고 압축하고 싶다.</li>
<li><strong>pip</strong>를 이용한 모듈을 로컬에 설치했는데, 그럼 <code>index.py</code>와 <code>router.py</code>같이 루트폴더에 있는 파일들말고 <code>get.py</code>나 <code>post.py</code>같이 서브폴더에 있는 파일에서는 어떻게 모듈들을 사용해야 할까 ?</li>
</ol>
<p>첫번째 문제에 대해서는 저도 맥에서 <code>zip</code>명령어를 사용해서 어떻게 특정 파일/폴더를 빼고 압축을 할수 있는지에 대해서 못찾았습니다.<br>그래서 그냥 <code>src</code>라는 폴더를 하나 만들어 그 안에서 작업을 하고 해당 폴더 안에서 <code>.zip</code>파일로 패키징해서 올리니 <code>virtualenv</code>관련 파일들은 자연스럽게 빠지게 되었습니다.</p>
<p>두번째 문제에 대해서 부모디렉토리의 모듈에 대해서 접근하는 여러가지 방법을 시도해 봤는데 코드가 많이 지저분해더군요.<br>코드를 깔끔하게 유지하면서 해결가능한 방법으로는 2가지 정도가 있습니다.</p>
<p><strong>해당 모듈이 사용되는 최하위 폴더에 설치한다.</strong><br>이 경우에는 해당 폴더의 상위에서는 모두 사용이 가능합니다.<br>하지만 그 상위 폴더와 같은 레벨의 다른 폴더에서의 접근은 힘듭니다.<br>그 폴더에서도 사용하려면 그 폴더내의 어딘가에 또 설치를 하는 방법으로 해결을 해야 합니다.<br>이 방법은 별로 좋은 방법 같지 않으니 패스하기로 합니다.</p>
<p><strong>최상위 모듈에서 하위 폴더내 모듈에게 전달한다.</strong><br>개인적으로 추천하는 방법입니다.<br><strong>index.py</strong> 같이 프로그램 내의 시작점에 해당되는 곳에서 사용되는 모든 모듈들의 객체를 선언하여 이것을 하위 폴더내의 모듈을 호출할 때 같이 전달하는 방식입니다.<br>설명으로만 느낌이 잘 안오실수 있으니 예제 코드로 살펴보겠습니다.</p>
<p>위 <strong>Step 4</strong> 예제를 조금 변경하여 <code>/test</code>경로로 <code>GET</code>방식으로 요청한 경우 쿼리 스트링으로 <code>url</code>값을 받아서 해당 사이트의 내용을 <code>requests</code> 모듈을 이용해서 가져오는 코드로 변경해 보겠습니다.</p>
<p><strong>Step 4</strong>까지 진행되었다는 가정하에 진행할 경우에는 바로 하면 되지만 새로운 폴더에 작업을 하는 경우라면 아래와 같이 <code>virtualenv</code>를 이용한 가상환경으로 들어가서 <code>pip</code>를 로컬로 설치해 주신뒤 코드를 작성해 주세요.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">virtualenv myvenv</div><div class="line">source myvenv/bin/activate</div><div class="line">mkdir src</div><div class="line">cd src</div></pre></td></tr></table></figure>
<p>압축할 때 <strong>myvenv</strong>내의 파일들이 같이 압축되지 않도록 작업을 <strong>src</strong>폴더 내에서 하겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir modules</div><div class="line">touch modules/__init__.py</div><div class="line">pip install requests -t modules/</div></pre></td></tr></table></figure>
<p>modules을 다른 폴더에서 불러오기 위해서는 해당 폴더내에 <code>__init__.py</code> 파일이 있어야 합니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mkdir controllers</div><div class="line">cd controllers</div><div class="line">mkdir test</div><div class="line">touch __init__.py</div><div class="line">cd test</div><div class="line">touch __init__.py</div><div class="line">cd ..</div><div class="line">cd ..</div></pre></td></tr></table></figure>
<p><code>index.py</code>에서 <code>requests</code> 모듈에 대한 객체를 선언하여 그것을 <code>/controllers/test/get.py</code>까지 전달하는 코드를 작성해 보겠습니다.</p>
<h4 id="index-py-4"><a href="#index-py-4" class="headerlink" title="index.py"></a>index.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> modules.requests</div><div class="line"></div><div class="line"><span class="keyword">from</span> router <span class="keyword">import</span> router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(event, context)</span>:</span></div><div class="line">    </div><div class="line">    packages = &#123;&#125;</div><div class="line">    packages[<span class="string">'requests'</span>] = modules.requests</div><div class="line">    </div><div class="line">    result = router(packages, event);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span> : json.dumps(result) &#125;</div></pre></td></tr></table></figure>
<p><code>router.py</code>에서는 전달받은 <code>packages</code>를 그대로 전달해주는 코드만 추가했습니다.</p>
<h4 id="router-py-2"><a href="#router-py-2" class="headerlink" title="router.py"></a>router.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> controllers.test.get</div><div class="line"><span class="keyword">import</span> controllers.test.post</div><div class="line"></div><div class="line">route_map = &#123;</div><div class="line">    <span class="string">'/test'</span>: &#123;</div><div class="line">        <span class="string">'GET'</span>: controllers.test.get.handler,</div><div class="line">        <span class="string">'POST'</span>: controllers.test.post.handler</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">router</span><span class="params">(packages, event)</span>:</span></div><div class="line">    controller = route_map[event[<span class="string">'path'</span>]][event[<span class="string">'httpMethod'</span>]];</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> controller:</div><div class="line">        <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'Error'</span>: <span class="string">"Invalid Path"</span> &#125; &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> controller(packages, event);</div></pre></td></tr></table></figure>
<p><code>post.py</code>에서 외부 모듈을 사용하지는 않지만, 일단 받아줍시다. 공짠데요.</p>
<h4 id="controllers-test-post-py-1"><a href="#controllers-test-post-py-1" class="headerlink" title="controllers/test/post.py"></a>controllers/test/post.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(packages, event)</span>:</span></div><div class="line">    user_id = event[<span class="string">'queryStringParameters'</span>][<span class="string">'id'</span>]</div><div class="line">    body = event[<span class="string">'body'</span>]</div><div class="line">    header = event[<span class="string">'headers'</span>]</div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'id'</span>: user_id, <span class="string">'header'</span>: header, <span class="string">'body'</span>: body &#125; &#125;</div></pre></td></tr></table></figure>
<p><code>get.py</code>에서는 전달받은 <code>packages</code>에서 <code>requests</code> 객체를 가져와서 사용하는 코드가 추가되었습니다.</p>
<h4 id="controllers-test-get-py-1"><a href="#controllers-test-get-py-1" class="headerlink" title="controllers/test/get.py"></a>controllers/test/get.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">(packages, event)</span>:</span></div><div class="line">    requests = packages[<span class="string">'requests'</span>]</div><div class="line">    </div><div class="line">    request_url = event[<span class="string">'queryStringParameters'</span>][<span class="string">'url'</span>]</div><div class="line">    response = requests.get(<span class="string">'http://'</span> + request_url)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123; <span class="string">'body'</span>: &#123; <span class="string">'url'</span>: request_url, <span class="string">'text'</span>: response.text &#125; &#125;</div></pre></td></tr></table></figure>
<p>이제 <code>index.py</code>가 있는 위치로 와서 압축한 뒤에 <strong>Lambda</strong>에 올려 놓고 테스트 해 보겠습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">zip -r sample.zip .</div></pre></td></tr></table></figure>
<p><code>https://본인 Lambda 주소.../prod/test?url=www.naver.com</code> 식으로 브라우저에서 입력하여 결과가 제대로 오는지 확인하시면 됩니다.</p>
<h3 id="마치며…"><a href="#마치며…" class="headerlink" title="마치며…"></a>마치며…</h3><p>이번 포스팅에서 알아본 내용들은 다음과 같습니다.</p>
<ul>
<li><strong>Lambda</strong>에 <strong>Python</strong> 코드를 패키징해서 올리는 방법</li>
<li><strong>vitrualenv</strong>를 활용해서 원하는 폴더에 <strong>pip</strong>로 모듈을 설치하는 방법</li>
<li>로컬에 <strong>pip</strong>로 설치한 모듈들을 서브 폴더내에서도 활용하는 방법</li>
</ul>
<p>잘못되었거나, 변경된 점, 기타 추가 사항에 대한 피드백은 언제나 환영합니다. - <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#x65;&#x6f;&#x6b;&#106;&#111;&#x6f;&#110;&#x2e;&#121;&#117;&#x6e;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;">&#115;&#x65;&#x6f;&#x6b;&#106;&#111;&#x6f;&#110;&#x2e;&#121;&#117;&#x6e;&#x40;&#103;&#x6d;&#x61;&#x69;&#108;&#x2e;&#99;&#x6f;&#x6d;</a>  </p>
<h3 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h3><ul>
<li>AWS 공식 가이드 : <a href="http://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html" target="_blank" rel="external">http://docs.aws.amazon.com/lambda/latest/dg/lambda-python-how-to-create-deployment-package.html</a></li>
</ul>

                    
                        
                    
                    
                        <p>
                            <a href="/2016/11/24/Lambda.Packaging.Python/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/categories/AWS/Lambda/page/2/">
                    <span>OLDER POSTS</span>
                <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
        </li>
        
        <li class="pagination-number">page 1 of 2</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 Yun Seok-joon. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/sjyun.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Yun Seok-joon</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Seoul, South Korea
            </div>
        
    </div>
</div>

        <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2015/11/10/Devops.Jenkins/">
                            <h3 class="media-heading">Install Jenkins</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Nov 10, 2015
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/20/01.01.modeling/">
                            <h3 class="media-heading">SQLP 1-1 데이터 모델링</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 20, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/20/01.02.modeling_performance/">
                            <h3 class="media-heading">SQLP 1-2 데이터 모델과 성능</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 20, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/21/02.01.sql.basic/">
                            <h3 class="media-heading">SQLP 2-1 SQL 기본</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 21, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/23/02.02.sql.adv/">
                            <h3 class="media-heading">SQLP 2-2-1 SET, Hierarchical Query, Sub-query</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 23, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/25/02.03.group/">
                            <h3 class="media-heading">SQLP 2-2-2 GROUP function</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 25, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/25/02.04.window/">
                            <h3 class="media-heading">SQLP 2-2-3 Window function</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 25, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/26/02.05.dcl/">
                            <h3 class="media-heading">SQLP 2-2-4 DCL</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 26, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/26/02.06.plsql/">
                            <h3 class="media-heading">SQLP 2-2-5 PL/SQL</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 26, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="http://DevStarSJ.github.io/2016/01/27/02.07.optimizer/">
                            <h3 class="media-heading">SQLP 2-3 Optimizing SQL</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 27, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                59 posts found
            </p>
        </div>
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-kbuclmtqrwfmqogitsifpjr2mdxgukkqucv5th9u0chgrdjqgqfxwhpjxejt.min.js"></script>
<!--SCRIPTS END-->


    </body>
</html>
